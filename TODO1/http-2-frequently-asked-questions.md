> - åŸæ–‡åœ°å€ï¼š[HTTP/2 Frequently Asked Questions](https://http2.github.io/faq/)
> - åŸæ–‡ä½œè€…ï¼š[HTTP/2](https://http2.github.io)
> - è¯‘æ–‡å‡ºè‡ªï¼š[æ˜é‡‘ç¿»è¯‘è®¡åˆ’](https://github.com/xitu/gold-miner)
> - æœ¬æ–‡æ°¸ä¹…é“¾æ¥ï¼š[https://github.com/xitu/gold-miner/blob/master/TODO1/http-2-frequently-asked-questions.md](https://github.com/xitu/gold-miner/blob/master/TODO1/http-2-frequently-asked-questions.md)
> - è¯‘è€…ï¼š[YueYong](https://github.com/YueYongDev)
> - æ ¡å¯¹è€…ï¼š[Ranjay](https://github.com/jerryOnlyZRJ)

# HTTP/2 å¸¸è§é—®é¢˜è§£ç­”

ä»¥ä¸‹æ˜¯æœ‰å…³ HTTP/2 çš„å¸¸è§é—®é¢˜è§£ç­”ã€‚

- [ä¸€èˆ¬é—®é¢˜](#ä¸€èˆ¬é—®é¢˜)
  - [ä¸ºä»€ä¹ˆè¦ä¿®è®¢ HTTP ?](#ä¸ºä»€ä¹ˆè¦ä¿®è®¢-HTTP?)
  - [è°åˆ¶å®šäº† HTTP/2??](#è°åˆ¶å®šäº†-HTTP/2?)
  - [HTTP/2 ä¸ SPDY çš„å…³ç³»æ˜¯ä»€ä¹ˆï¼Ÿ](#HTTP/2-ä¸-SPDY-çš„å…³ç³»æ˜¯ä»€ä¹ˆï¼Ÿ)
  - [ç©¶ç«Ÿæ˜¯ HTTP/2.0 è¿˜æ˜¯ HTTP/2ï¼Ÿ](#ç©¶ç«Ÿæ˜¯-HTTP/2.0-è¿˜æ˜¯-HTTP/2ï¼Ÿ)
  - [å’Œ HTTP/1.x ç›¸æ¯” HTTP/2 çš„å…³é”®åŒºåˆ«æ˜¯ä»€ä¹ˆ?](#å’Œ-HTTP/1.x-ç›¸æ¯”-HTTP/2-çš„å…³é”®åŒºåˆ«æ˜¯ä»€ä¹ˆ?)
  - [ä¸ºä»€ä¹ˆ HTTP/2 æ˜¯äºŒè¿›åˆ¶çš„?](#ä¸ºä»€ä¹ˆ-HTTP/2-æ˜¯äºŒè¿›åˆ¶çš„?)
  - [ä¸ºä»€ä¹ˆ HTTP/2 éœ€è¦å¤šè·¯ä¼ è¾“?](#ä¸ºä»€ä¹ˆ-HTTP/2-éœ€è¦å¤šè·¯ä¼ è¾“?)
  - [ä¸ºä»€ä¹ˆåªéœ€è¦ä¸€ä¸ª TCP è¿æ¥?](#ä¸ºä»€ä¹ˆåªéœ€è¦ä¸€ä¸ª-TCP-è¿æ¥?)
  - [æœåŠ¡å™¨æ¨é€çš„å¥½å¤„æ˜¯ä»€ä¹ˆï¼Ÿ](#æœåŠ¡å™¨æ¨é€çš„å¥½å¤„æ˜¯ä»€ä¹ˆï¼Ÿ)
  - [æ¶ˆæ¯å¤´ä¸ºä½•éœ€è¦å‹ç¼©ï¼Ÿ](#æ¶ˆæ¯å¤´ä¸ºä½•éœ€è¦å‹ç¼©ï¼Ÿ)
  - [ä¸ºä»€ä¹ˆé€‰æ‹© HPACKï¼Ÿ](#ä¸ºä»€ä¹ˆé€‰æ‹©-HPACKï¼Ÿ)
  - [HTTP/2 å¯ä»¥è®© cookies ï¼ˆæˆ–è€…å…¶ä»–æ¶ˆæ¯å¤´ï¼‰å˜å¾—æ›´å¥½å—ï¼Ÿ](#HTTP/2-å¯ä»¥è®©-cookies-ï¼ˆæˆ–è€…å…¶ä»–æ¶ˆæ¯å¤´ï¼‰å˜å¾—æ›´å¥½å—ï¼Ÿ)
  - [éæµè§ˆå™¨ç”¨æˆ·çš„ HTTP æ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿ](#éæµè§ˆå™¨ç”¨æˆ·çš„-HTTP-æ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿ)
  - [HTTP/2 éœ€è¦åŠ å¯†å—ï¼Ÿ](#HTTP/2-éœ€è¦åŠ å¯†å—ï¼Ÿ)
  - [HTTP/2 æ˜¯æ€ä¹ˆæé«˜å®‰å…¨æ€§çš„å‘¢ï¼Ÿ](#HTTP/2-æ˜¯æ€ä¹ˆæé«˜å®‰å…¨æ€§çš„å‘¢ï¼Ÿ)
  - [æˆ‘ç°åœ¨å¯ä»¥ä½¿ç”¨ HTTP/2 å—ï¼Ÿ](#æˆ‘ç°åœ¨å¯ä»¥ä½¿ç”¨-HTTP/2-å—ï¼Ÿ)
  - [HTTP/2 å°†ä¼šå–ä»£ HTTP/1.x å—ï¼Ÿ](#HTTP/2-å°†ä¼šå–ä»£-HTTP/1.x-å—ï¼Ÿ)
  - [HTTP/3 ä¼šå‡ºç°å—ï¼Ÿ](#HTTP/3-ä¼šå‡ºç°å—ï¼Ÿ)
- [å®ç°è¿‡ç¨‹ä¸­çš„é—®é¢˜](#å®ç°è¿‡ç¨‹ä¸­çš„é—®é¢˜)
  - [ä¸ºä»€ä¹ˆè§„åˆ™ä¼šå›´ç»•æ¶ˆæ¯å¤´å¸§çš„æ•°æ®æ¥ç»­ï¼Ÿ](#ä¸ºä»€ä¹ˆè§„åˆ™ä¼šå›´ç»•æ¶ˆæ¯å¤´å¸§çš„æ•°æ®æ¥ç»­ï¼Ÿ)
  - [HPACK çŠ¶æ€çš„æœ€å°å’Œæœ€å¤§å°ºå¯¸æ˜¯å¤šå°‘ï¼Ÿ](#HPACK-çŠ¶æ€çš„æœ€å°å’Œæœ€å¤§å°ºå¯¸æ˜¯å¤šå°‘ï¼Ÿ)
  - [æˆ‘æ€æ ·æ‰èƒ½é¿å…ä¿æŒ HPACK çŠ¶æ€ï¼Ÿ](#æˆ‘æ€æ ·æ‰èƒ½é¿å…ä¿æŒ-HPACK-çŠ¶æ€ï¼Ÿ)
  - [ä¸ºä»€ä¹ˆä¼šæœ‰ä¸€ä¸ªå•ç‹¬çš„å‹ç¼©/æµç¨‹æ§åˆ¶ä¸Šä¸‹æ–‡ï¼Ÿ](#ä¸ºä»€ä¹ˆä¼šæœ‰ä¸€ä¸ªå•ç‹¬çš„å‹ç¼©/æµç¨‹æ§åˆ¶ä¸Šä¸‹æ–‡ï¼Ÿ)
  - [ä¸ºä»€ä¹ˆåœ¨ HPACK ä¸­æœ‰ EOS çš„ç¬¦å·ï¼Ÿ](#ä¸ºä»€ä¹ˆåœ¨-HPACK-ä¸­æœ‰-EOS-çš„ç¬¦å·ï¼Ÿ)
  - [å®ç° HTTP/2 çš„æ—¶å€™æˆ‘å¯ä»¥ä¸ç”¨å»å®ç° HTTP/1.1 å—ï¼Ÿ](#å®ç°-HTTP/2-çš„æ—¶å€™æˆ‘å¯ä»¥ä¸ç”¨å»å®ç°-HTTP/1.1-å—ï¼Ÿ)
  - [5.3.2èŠ‚ä¸­çš„ä¼˜å…ˆçº§ç¤ºä¾‹æ˜¯å¦æ­£ç¡®ï¼Ÿ](#5.3.2èŠ‚ä¸­çš„ä¼˜å…ˆçº§ç¤ºä¾‹æ˜¯å¦æ­£ç¡®ï¼Ÿ)
  - [HTTP/2 è¿æ¥ä¸­éœ€è¦ TCP_NODELAY å—ï¼Ÿ](#HTTP/2-è¿æ¥ä¸­éœ€è¦-TCP_NODELAY-å—ï¼Ÿ)
- [éƒ¨ç½²é—®é¢˜](#éƒ¨ç½²é—®é¢˜)
  - [æˆ‘è¯¥æ€ä¹ˆè°ƒè¯•åŠ å¯†è¿‡çš„ HTTP/2 ï¼Ÿ](#æˆ‘è¯¥æ€ä¹ˆè°ƒè¯•åŠ å¯†è¿‡çš„-HTTP/2-ï¼Ÿ)
  - [æˆ‘è¯¥æ€ä¹ˆä½¿ç”¨ HTTP/2 çš„æœåŠ¡ç«¯æ¨é€ï¼Ÿ](#æˆ‘è¯¥æ€ä¹ˆä½¿ç”¨-HTTP/2-çš„æœåŠ¡ç«¯æ¨é€ï¼Ÿ)

## ä¸€èˆ¬é—®é¢˜

### ä¸ºä»€ä¹ˆè¦ä¿®è®¢ HTTP?

HTTP / 1.1 å·²ç»åœ¨ Web ä¸Šæœå½¹äº†åäº”å¹´ä»¥ä¸Šï¼Œä½†å…¶åŠ£åŠ¿ä¹Ÿå¼€å§‹æ˜¾ç°ã€‚

åŠ è½½ä¸€ä¸ªç½‘é¡µæ¯”ä»¥å¾€æ›´åŠ è€—è´¹èµ„æºï¼ˆè¯¦è§  [HTTP Archiveâ€™s page size statistics](http://httparchive.org/trends.php#bytesTotal&reqTotal)ï¼‰ã€‚ä¸æ­¤åŒæ—¶ï¼Œæœ‰æ•ˆåœ°åŠ è½½æ‰€æœ‰è¿™äº›é™æ€èµ„æºå˜å¾—éå¸¸å›°éš¾ï¼Œå› ä¸ºäº‹å®ä¸Šï¼ŒHTTP åªå…è®¸æ¯ä¸ª TCP è¿æ¥æœ‰ä¸€ä¸ªæœªå®Œæˆçš„è¯·æ±‚ã€‚

åœ¨è¿‡å»ï¼Œæµè§ˆå™¨ä½¿ç”¨å¤šä¸ª TCP è¿æ¥æ¥å‘å‡ºå¹¶è¡Œè¯·æ±‚ã€‚ç„¶è€Œè¿™ç§åšæ³•æ˜¯æœ‰é™åˆ¶çš„ã€‚å¦‚æœä½¿ç”¨äº†å¤ªå¤šçš„è¿æ¥ï¼Œå°±ä¼šäº§ç”Ÿç›¸åçš„æ•ˆæœï¼ˆ TCP æ‹¥å¡æ§åˆ¶è¢«é˜»æ­¢ï¼Œå› ä¸ºè¿™ä¼šå¼•å‘æ€§èƒ½å—æŸå’Œç½‘ç»œé˜»å¡ç­‰äº‹æƒ…çš„å‘ç”Ÿï¼‰ã€‚è€Œä¸”ä»æ ¹æœ¬ä¸Šè®²è¿™å¯¹å…¶ä»–ç¨‹åºæ¥è¯´ä¹Ÿæ˜¯ä¸å…¬å¹³çš„(å› ä¸ºæµè§ˆå™¨ä¼šå ç”¨è®¸å¤šæœ¬ä¸è¯¥å±äºä»–çš„èµ„æº)ã€‚

åŒæ—¶ï¼Œå¤§é‡çš„è¯·æ±‚æ„å‘³ç€â€œåœ¨çº¿ä¸Šâ€æœ‰å¤§é‡é‡å¤çš„æ•°æ®ã€‚

è¿™ä¸¤ä¸ªå› ç´ éƒ½æ„å‘³ç€ HTTP/1.1 è¯·æ±‚æœ‰å¾ˆå¤šä¸ä¹‹ç›¸å…³çš„å¼€é”€;å¦‚æœè¯·æ±‚å¤ªå¤šï¼Œåˆ™ä¼šå½±å“æ€§èƒ½ã€‚

è¿™ä½¿å¾—è¯¥è¡Œä¸šæˆä¸ºäº†ä¸€ä¸ªå…¬è®¤çš„ã€è¿›è¡Œå„ç§å®è·µçš„æœ€ä½³åœºæ‰€ï¼Œæ¯”å¦‚ï¼ŒSpritingï¼ˆå›¾ç‰‡åˆå¹¶ï¼‰ã€dataï¼šInliningï¼ˆæ•°æ®å†…åµŒï¼‰ã€Domain Shardingï¼ˆåŸŸååˆ†ç‰‡ï¼‰å’Œ Concatenationï¼ˆæ–‡ä»¶åˆå¹¶ï¼‰ç­‰ã€‚è¿™äº›ä¸è§„èŒƒçš„è§£å†³æ–¹æ¡ˆè¯´æ˜äº†åè®®æœ¬èº«å­˜åœ¨ä¸€äº›æ½œåœ¨é—®é¢˜ï¼Œå¹¶ä¸”åœ¨ä½¿ç”¨çš„æ—¶å€™ä¼šå‡ºç°å¾ˆå¤šé—®é¢˜ã€‚

### è°åˆ¶å®šäº† HTTP/2?

HTTP/2 æ˜¯ç”± [IETF](http://www.ietf.org/) çš„ [HTTP å·¥ä½œç»„](https://httpwg.github.io/)å¼€å‘çš„ï¼Œè¯¥ç»„ç»‡è´Ÿè´£ç»´æŠ¤ HTTP åè®®ã€‚è¯¥ç»„ç»‡ç”±ä¼—å¤š HTTP å®ç°è€…ã€ç”¨æˆ·ã€ç½‘ç»œè¿è¥å•†å’Œ HTTP ä¸“å®¶ç»„æˆã€‚

å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œè™½ç„¶[å·¥ä½œç»„çš„é‚®ä»¶åˆ—è¡¨](http://lists.w3.org/Archives/Public/ietf-http-wg/) æ‰˜ç®¡åœ¨ W3C ç½‘ç«™ä¸Šï¼Œä¸è¿‡è¿™å¹¶ä¸æ˜¯ W3C çš„åŠŸåŠ³ã€‚ä½†æ˜¯ï¼Œ Tim Berners-Lee å’Œ W3C TAGä¸ WG çš„è¿›åº¦ä¿æŒä¸€è‡´ã€‚

è®¸å¤šäººä¸ºè¿™é¡¹å·¥ä½œåšå‡ºäº†è‡ªå·±çš„è´¡çŒ®ï¼Œå°¤å…¶æ˜¯ä¸€äº›æ¥è‡ªâ€œå¤§â€é¡¹ç›®çš„å·¥ç¨‹å¸ˆï¼Œä¾‹å¦‚ Firefoxï¼Œ Chromeï¼Œ Twitterï¼ŒMicrosoft çš„ HTTP stackï¼Œ Curl å’Œ Akamaiã€‚ä»¥åŠè‹¥å¹² Pythonã€Ruby å’Œ NodeJS çš„ HTTP å®ç°è€…ã€‚

ä¸ºäº†æ›´å¥½çš„äº†è§£æœ‰å…³ IETF çš„ä¿¡æ¯ï¼Œä½ å¯ä»¥è®¿é—®  [Tao of the IETF](http://www.ietf.org/tao.html)ï¼›ä½ ä¹Ÿå¯ä»¥åœ¨ [Github çš„è´¡çŒ®è€…å›¾è¡¨](https://github.com/http2/http2-spec/graphs/contributors)ä¸ŠæŸ¥çœ‹æœ‰å“ªäº›äººä¸ºè¯¥é¡¹ç›®åšå‡ºäº†è´¡çŒ®ï¼ŒåŒæ ·çš„ï¼Œä½ ä¹Ÿå¯ä»¥åœ¨ [implementation list](https://github.com/http2/http2-spec/wiki/Implementations) ä¸ŠæŸ¥çœ‹è°æ­£åœ¨å‚ä¸è¯¥é¡¹ç›®ã€‚

### HTTP/2 ä¸ SPDY çš„å…³ç³»æ˜¯ä»€ä¹ˆï¼Ÿ

HTTP/2 ç¬¬ä¸€æ¬¡å‡ºç°å¹¶è¢«è®¨è®ºçš„æ—¶å€™ï¼Œ SPDY æ­£å¾—åˆ°å‚å•† (åƒ Mozilla å’Œ nginx)çš„é’çå’Œæ”¯æŒï¼Œ å¹¶è¢«çœ‹æˆæ˜¯ HTTP/1.x åŸºç¡€ä¸Šçš„é‡å¤§æ”¹å–„ã€‚

åœ¨ä¸æ–­çš„å¾æ±‚å»ºè®®ä»¥åŠæŠ•ç¥¨é€‰æ‹©ä¹‹åï¼Œ[SPDY/2](http://tools.ietf.org/html/draft-mbelshe-httpbis-spdy-00)  è¢«é€‰ä¸º HTTP/2 çš„åŸºç¡€ã€‚ä»é‚£æ—¶èµ·ï¼Œ æ ¹æ®å·¥ä½œç»„çš„è®¨è®ºå’Œå‚å•†çš„åé¦ˆï¼Œå®ƒå·²ç»æœ‰äº†å¾ˆå¤šå˜åŒ–ã€‚

åœ¨æ•´ä¸ªè¿‡ç¨‹ä¸­ï¼ŒSPDY çš„æ ¸å¿ƒå¼€å‘äººå‘˜å‚ä¸äº† HTTP/2 çš„å¼€å‘ï¼Œå…¶ä¸­åŒ…æ‹¬ Mike Belshe å’Œ Roberto Peonã€‚

2015 å¹´ 2 æœˆï¼Œè°·æ­Œ[å®£å¸ƒè®¡åˆ’](https://blog.chromium.org/2015/02/hello-http2-goodbye-spdy.html)å–æ¶ˆå¯¹ SPDY çš„æ”¯æŒï¼Œè½¬è€Œæ”¯æŒ HTTP/2 ã€‚

### ç©¶ç«Ÿæ˜¯ HTTP/2.0 è¿˜æ˜¯ HTTP/2ï¼Ÿ

å·¥ä½œç»„å†³å®šåˆ é™¤æ¬¡è¦ç‰ˆæœ¬ (â€œ.0â€) ï¼Œå› ä¸ºå®ƒåœ¨ HTTP/1.x ä¸­é€ æˆäº†å¾ˆå¤šæ··ä¹±ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œ HTTP çš„ç‰ˆæœ¬ä»…ä»£è¡¨å®ƒçš„å…¼å®¹æ€§ï¼Œä¸è¡¨ç¤ºå®ƒçš„ç‰¹æ€§å’Œ â€œäº®ç‚¹â€ã€‚

### å’Œ HTTP/1.x ç›¸æ¯” HTTP/2 çš„å…³é”®åŒºåˆ«æ˜¯ä»€ä¹ˆ?

åœ¨é«˜ç‰ˆæœ¬ HTTP/2 ä¸­:

- æ˜¯äºŒè¿›åˆ¶çš„ï¼Œä»£æ›¿åŸæœ‰çš„æ–‡æœ¬
- æ˜¯å¤šè·¯å¤ç”¨çš„ï¼Œ ä»£æ›¿åŸæ¥çš„åºåˆ—å’Œé˜»å¡æœºåˆ¶
- æ‰€ä»¥å¯ä»¥åœ¨ä¸€ä¸ªè¿æ¥ä¸­å¹¶è¡Œå¤„ç†
- å‹ç¼©å¤´éƒ¨ä¿¡æ¯å‡å°å¼€é”€
- å…è®¸æœåŠ¡å™¨ä¸»åŠ¨æ¨é€åº”ç­”åˆ°å®¢æˆ·ç«¯çš„ç¼“å­˜ä¸­

### ä¸ºä»€ä¹ˆ HTTP/2 æ˜¯äºŒè¿›åˆ¶çš„?

å’Œ HTTP/1.x è¿™æ ·çš„æ–‡æœ¬åè®®ç›¸æ¯”ï¼ŒäºŒè¿›åˆ¶åè®®è§£æèµ·æ¥æ›´é«˜æ•ˆã€â€œçº¿ä¸Šâ€æ›´ç´§å‡‘ï¼Œæ›´é‡è¦çš„æ˜¯é”™è¯¯æ›´å°‘ã€‚å› ä¸ºå®ƒä»¬å¯¹å¦‚ç©ºç™½å­—ç¬¦çš„å¤„ç†ã€å¤§å°å†™ã€è¡Œå°¾ã€ç©ºé“¾æ¥ç­‰çš„å¤„ç†å¾ˆæœ‰å¸®åŠ©ã€‚

ä¸¾ä¸ªæ —å­ğŸŒ°ï¼ŒHTTP/1.1 å®šä¹‰äº†[å››ç§ä¸åŒçš„æ–¹æ³•æ¥è§£æä¸€æ¡æ¶ˆæ¯](http://www.w3.org/Protocols/rfc2616/rfc2616-sec4.html#sec4.4)ï¼›è€Œåœ¨HTTP/2ä¸­ï¼Œä»…éœ€ä¸€ä¸ªä»£ç è·¯å¾„å³å¯ã€‚

HTTP/2 åœ¨ telnet ä¸­ä¸å¯ç”¨ï¼Œä½†æ˜¯æˆ‘ä»¬å·²ç»æœ‰ä¸€äº›å·¥å…·å¯ä»¥æä¾›æ”¯æŒï¼Œä¾‹å¦‚ [Wireshark plugin](https://bugs.wireshark.org/bugzilla/show_bug.cgi?id=9042)ã€‚

### ä¸ºä»€ä¹ˆ HTTP/2 éœ€è¦å¤šè·¯ä¼ è¾“?

HTTP/1.x æœ‰ä¸ªé—®é¢˜å«â€œé˜Ÿå¤´é˜»å¡(head-of-line blocking)â€œï¼Œå®ƒæ˜¯æŒ‡åœ¨ä¸€æ¬¡è¿æ¥(connection)ä¸­ï¼Œåªæäº¤ä¸€ä¸ªè¯·æ±‚çš„æ•ˆç‡æ¯”è¾ƒé«˜ï¼Œ å¤šäº†å°±ä¼šå˜æ…¢ã€‚

HTTP/1.1 å°è¯•ä½¿ç”¨ç®¡çº¿åŒ–( pipelining )æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œ ä½†æ˜¯æ•ˆæœå¹¶ä¸ç†æƒ³(æ•°æ®é‡è¾ƒå¤§æˆ–è€…é€Ÿåº¦è¾ƒæ…¢çš„å“åº”ï¼Œ ä¼šé˜»ç¢æ’åœ¨ä»–åé¢çš„è¯·æ±‚)ã€‚æ­¤å¤–ï¼Œç”±äºè®¸å¤šç½‘ç»œåª’ä»‹(intermediary )å’ŒæœåŠ¡å™¨ä¸èƒ½å¾ˆå¥½çš„æ”¯æŒç®¡çº¿åŒ–ï¼Œ å¯¼è‡´å…¶éƒ¨ç½²èµ·æ¥ä¹Ÿæ˜¯å›°éš¾é‡é‡ã€‚

è¿™ä¹Ÿå°±è¿«ä½¿å®¢æˆ·ç«¯ä½¿ç”¨ä¸€äº›å¯å‘å¼çš„æ–¹æ³•(åŸºæœ¬é çŒœ) æ¥å†³å®šé€šè¿‡å“ªäº›è¿æ¥æäº¤å“ªäº›è¯·æ±‚; ç”±äºä¸€ä¸ªé¡µé¢åŠ è½½çš„æ•°æ®é‡ï¼Œ å¾€å¾€æ¯”å¯ç”¨è¿æ¥èƒ½å¤„ç†çš„æ•°æ®é‡çš„10å€è¿˜å¤šï¼Œ å¯¹æ€§èƒ½äº§ç”Ÿæå¤§çš„è´Ÿé¢å½±å“ï¼Œ ç»“æœç»å¸¸å¼•èµ·ç€‘å¸ƒå¼é˜»å¡(waterfall of blocked requests)ã€‚

è€Œå¤šè·¯ä¼ è¾“( Multiplexing )èƒ½å¾ˆå¥½çš„è§£å†³è¿™äº›é—®é¢˜ï¼Œ å› ä¸ºå®ƒèƒ½åŒæ—¶å¤„ç†å¤šä¸ªæ¶ˆæ¯çš„è¯·æ±‚å’Œå“åº”; ç”šè‡³å¯ä»¥åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­å°†ä¸€ä¸ªæ¶ˆæ¯è·Ÿå¦å¤–ä¸€ä¸ªæºæ‚åœ¨ä¸€èµ·ã€‚

æ‰€ä»¥åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå®¢æˆ·ç«¯åªéœ€è¦ä¸€ä¸ªè¿æ¥å°±èƒ½åŠ è½½ä¸€ä¸ªé¡µé¢ã€‚

### ä¸ºä»€ä¹ˆåªéœ€è¦ä¸€ä¸ª TCP è¿æ¥?

å¦‚æœä½¿ç”¨ HTTP/1ï¼Œæµè§ˆå™¨æ‰“å¼€æ¯ä¸ªç‚¹ (origin) å°±éœ€è¦ 4 åˆ° 8 ä¸ªè¿æ¥(Connection). è€Œç°åœ¨å¾ˆå¤šç½‘ç«™éƒ½ä½¿ç”¨å¤šç‚¹ä¼ è¾“( multiple origins )ï¼Œ ä¹Ÿå°±æ˜¯è¯´ï¼Œ å…‰åŠ è½½ä¸€ä¸ªç½‘é¡µï¼Œ æ‰“å¼€çš„è¿æ¥æ•°é‡å°±è¶…è¿‡ 30 ä¸ªã€‚

ä¸€ä¸ªåº”ç”¨åŒæ—¶æ‰“å¼€è¿™ä¹ˆå¤šè¿æ¥ï¼Œ å·²ç»è¿œè¿œè¶…å‡ºäº†å½“åˆè®¾è®¡ TCP æ—¶çš„é¢„æƒ³ï¼›åŒæ—¶ï¼Œå› ä¸ºæ¯ä¸ªè¿æ¥éƒ½ä¼šå“åº”å¤§é‡çš„æ•°æ®ï¼Œä½¿å…¶å¯ä»¥é€ æˆç½‘ç»œç¼“å­˜æº¢å‡ºçš„é£é™©ï¼Œç»“æœå¯èƒ½å¯¼è‡´ç½‘ç»œå µå¡å’Œæ•°æ®é‡ä¼ ã€‚

æ­¤å¤–ï¼Œ ä½¿ç”¨è¿™ä¹ˆå¤šè¿æ¥è¿˜ä¼šå¼ºå è®¸å¤šç½‘ç»œèµ„æº. è¿™äº›èµ„æºéƒ½æ˜¯ä»é‚£äº›â€œéµçºªå®ˆæ³•â€œçš„åº”ç”¨é‚£ â€œå·â€ æ¥çš„ ( VoIP å°±æ˜¯ä¸ªå¾ˆå¥½çš„ä¾‹å­).

### æœåŠ¡å™¨æ¨é€çš„å¥½å¤„æ˜¯ä»€ä¹ˆï¼Ÿ

å½“æµè§ˆå™¨è¯·æ±‚é¡µé¢æ—¶ï¼ŒæœåŠ¡å™¨å‘é€ HTML ä½œä¸ºå“åº”ï¼Œç„¶åéœ€è¦ç­‰å¾…æµè§ˆå™¨è§£æ HTML å¹¶å‘å‡ºå¯¹æ‰€æœ‰åµŒå…¥èµ„æºçš„è¯·æ±‚ï¼Œç„¶åæ‰èƒ½å¼€å§‹å‘é€ JavaScript ï¼Œå›¾åƒå’Œ CSS ã€‚

æœåŠ¡å™¨æ¨é€æœåŠ¡é€šè¿‡â€œæ¨é€â€é‚£äº›å®ƒè®¤ä¸ºå®¢æˆ·ç«¯å°†ä¼šéœ€è¦çš„å†…å®¹åˆ°å®¢æˆ·ç«¯çš„ç¼“å­˜ä¸­ï¼Œä»¥æ­¤æ¥é¿å…å¾€è¿”çš„å»¶è¿Ÿã€‚

ä½†æ˜¯ï¼Œæ¨é€çš„å“åº”å¹¶ä¸æ˜¯â€œä¸‡é‡‘æ²¹â€ï¼Œå¦‚æœä½¿ç”¨ä¸å½“ï¼Œå¯èƒ½ä¼šæŸå®³æ€§èƒ½ã€‚ æ­£ç¡®ä½¿ç”¨æœåŠ¡å™¨æ¨é€æ˜¯ä¸€ä¸ªé•¿æœŸçš„å®éªŒåŠç ”ç©¶é¢†åŸŸã€‚

### æ¶ˆæ¯å¤´ä¸ºä½•éœ€è¦å‹ç¼©ï¼Ÿ

æ¥è‡ª Mozilla çš„ Patrick McManus é€šè¿‡è®¡ç®—æ¶ˆæ¯å¤´å¯¹å¹³å‡é¡µé¢è´Ÿè½½çš„å°è±¡ï¼Œå¯¹æ­¤è¿›è¡Œäº†å½¢è±¡ä¸”å……åˆ†çš„è¯´æ˜ã€‚

å‡å®šä¸€ä¸ªé¡µé¢æœ‰80ä¸ªèµ„æºéœ€è¦åŠ è½½ï¼ˆè¿™ä¸ªæ•°é‡å¯¹äºä»Šå¤©çš„ Web è€Œè¨€è¿˜æ˜¯æŒºä¿å®ˆçš„ï¼‰ï¼Œ è€Œæ¯ä¸€æ¬¡è¯·æ±‚éƒ½æœ‰ 1400 å­—èŠ‚çš„æ¶ˆæ¯å¤´ï¼ˆè¿™åŒæ ·ä¹Ÿå¹¶ä¸å°‘è§ï¼Œå› ä¸º Cookie å’Œå¼•ç”¨ç­‰ä¸œè¥¿çš„å­˜åœ¨ï¼‰ï¼Œ è‡³å°‘è¦ 7 åˆ° 8 ä¸ªæ¥å›å»â€œåœ¨çº¿â€è·å¾—è¿™äº›æ¶ˆæ¯å¤´ã€‚è¿™è¿˜ä¸åŒ…æ‹¬å“åº”æ—¶é—´â€”â€”é‚£åªæ˜¯ä»å®¢æˆ·ç«¯é‚£é‡Œè·å–åˆ°å®ƒä»¬æ‰€èŠ±çš„æ—¶é—´è€Œå·²ã€‚

è¿™å…¨éƒ½ç”±äº TCP çš„[æ…¢å¯åŠ¨](http://en.wikipedia.org/wiki/Slow-start)æœºåˆ¶ï¼Œå®ƒæ ¹æ®å·²ç¡®è®¤çš„æ•°æ®åŒ…æ•°é‡åœ¨æ–°è¿æ¥ä¸Šå¯¹æ•°æ®åŒ…è¿›è¡Œæ£€æµ‹â€”â€”è¿™æœ‰æ•ˆåœ°é™åˆ¶äº†æœ€åˆçš„å‡ æ¬¡æ¥å›å¯ä»¥å‘é€çš„æ•°æ®åŒ…æ•°é‡ã€‚

ç›¸æ¯”ä¹‹ä¸‹ï¼Œå³ä½¿æ˜¯å¤´éƒ¨è½»å¾®çš„å‹ç¼©ä¹Ÿå¯ä»¥æ˜¯è®©é‚£äº›è¯·æ±‚åªéœ€ä¸€ä¸ªæ¥å›å°±èƒ½æå®šâ€”â€”æœ‰æ—¶å€™ç”šè‡³ä¸€ä¸ªåŒ…å°±å¯ä»¥äº†ã€‚

è¿™ç§å¼€é”€æ˜¯å¯ä»¥è¢«èŠ‚çœä¸‹æ¥çš„ï¼Œç‰¹åˆ«æ˜¯å½“ä½ è€ƒè™‘ç§»åŠ¨å®¢æˆ·ç«¯åº”ç”¨çš„æ—¶å€™ï¼Œå³ä½¿æ˜¯è‰¯å¥½æ¡ä»¶ä¸‹ï¼Œä¸€èˆ¬ä¹Ÿä¼šçœ‹åˆ°å‡ ç™¾æ¯«ç§’çš„å¾€è¿”å»¶è¿Ÿã€‚

### ä¸ºä»€ä¹ˆé€‰æ‹© HPACKï¼Ÿ

SPDY/2 æå‡ºåœ¨æ¯ä¸€æ–¹éƒ½ä½¿ç”¨ä¸€ä¸ªå•ç‹¬çš„ GZIP ä¸Šä¸‹æ–‡ç”¨äºæ¶ˆæ¯å¤´å‹ç¼©ï¼Œè¿™å®ç°èµ·æ¥å¾ˆå®¹æ˜“ï¼Œä¹Ÿå¾ˆé«˜æ•ˆã€‚

ä»é‚£æ—¶å€™å¼€å§‹ï¼Œå°±æœ‰äº†ä¸€ä¸ªè¢«è¯æ˜èƒ½é’ˆå¯¹ç®—æ³•ä¸­ä½¿ç”¨æµå‹ç¼©ï¼ˆå¦‚GZIPï¼‰çš„é‡è¦æ”»å‡»æ–¹å¼ CRIMEã€‚

ä»é‚£æ—¶èµ·ï¼Œä¸€ä¸ªé‡è¦çš„æ”»å‡»æ–¹å¼ [CRIME](http://en.wikipedia.org/wiki/CRIME) è¯ç”Ÿäº†ï¼Œè¿™ç§æ–¹å¼å¯ä»¥æ”»å‡»åŠ å¯†æ–‡ä»¶å†…éƒ¨çš„æ‰€ä½¿ç”¨çš„å‹ç¼©æµï¼ˆå¦‚GZIPï¼‰ã€‚

CRIME è®©é‚£äº›èƒ½å‘åŠ å¯†æµä¸­è¯¸å¦‚æ•°æ®çš„æ”»å‡»è€…è·å¾—äº†â€œæ¢æµ‹â€åŸæ–‡å¹¶è¿›è¡Œè¿˜åŸçš„å¯èƒ½æ€§ã€‚å› ä¸ºæ˜¯ Webï¼ŒJavaScript ä½¿å…¶æˆä¸ºäº†å¯èƒ½ï¼Œè€Œä¸”å·²ç»æœ‰äº†ä½¿ç”¨é’ˆå¯¹å—åˆ° TLS ä¿æŠ¤çš„ HTTP èµ„æºçš„ CRIME æ¢å¤ cookie å’Œè®¤è¯ä»¤ç‰Œä¿¡æ¯çš„è¯æ˜ã€‚

å› æ­¤ï¼Œæˆ‘ä»¬ä¸åº”è¯¥ä½¿ç”¨ GZIP è¿›è¡Œå‹ç¼©ã€‚ç”±äºæ‰¾ä¸åˆ°å…¶å®ƒé€‚åˆåœ¨è¿™ç§ç”¨ä¾‹ä¸‹ä½¿ç”¨çš„å®‰å…¨æœ‰æ•ˆçš„ç®—æ³•ï¼Œæˆ‘ä»¬åˆ›é€ äº†ä¸€ç§æ–°çš„ï¼Œç‰¹åˆ«é’ˆå¯¹æ¶ˆæ¯å¤´çš„å‹ç¼©æ–¹æ¡ˆï¼Œå®ƒèƒ½è¿›è¡Œç²—ç²’åº¦çš„æ“ä½œï¼›å› ä¸ºHTTPæ¶ˆæ¯å¤´å¹¶ä¸å¸¸å¸¸éœ€è¦æ”¹å˜ï¼Œæˆ‘ä»¬ä»ç„¶å¯ä»¥å¾—åˆ°å¾ˆå¥½çš„å‹ç¼©æ•ˆç‡ï¼Œè€Œä¸”æ›´åŠ çš„å®‰å…¨.

### HTTP/2 å¯ä»¥è®© cookies ï¼ˆæˆ–è€…å…¶ä»–æ¶ˆæ¯å¤´ï¼‰å˜å¾—æ›´å¥½å—ï¼Ÿ

è¿™ä¸€å°è¯•è¢«è®¸å¯åœ¨ç½‘ç»œåè®®çš„ä¸€ä¸ªä¿®è®¢ç‰ˆæœ¬ä¸Šè¿è¡Œ â€“ ä¾‹å¦‚ï¼ŒHTTPæ¶ˆæ¯å¤´ã€æ–¹æ³•ç­‰ç­‰å¦‚ä½•æ‰èƒ½åœ¨ä¸æ”¹å˜ HTTP è¯­ä¹‰çš„å‰æä¸‹æ”¾åˆ°"ç½‘ç»œä¸Šâ€œã€‚

è¿™æ˜¯å› ä¸º HTTP çš„åº”ç”¨éå¸¸å¹¿æ³›ã€‚å¦‚æœæˆ‘ä»¬ä½¿ç”¨äº†è¿™ä¸ªç‰ˆæœ¬çš„ HTTP ï¼Œå®ƒå°±ä¼šå¼•å…¥ä¸€ç§æ–°çš„çŠ¶æ€æœºåˆ¶ï¼ˆä¾‹å¦‚ä¹‹å‰è®¨è®ºè¿‡çš„ä¾‹å­ï¼‰æˆ–è€…æ”¹å˜å…¶æ ¸å¿ƒæ–¹æ³•(å¹¸å¥½ï¼Œè¿™è¿˜æ²¡æœ‰å‘ç”Ÿè¿‡)ï¼Œè¿™å¯èƒ½å°±æ„å‘³ç€æ–°çš„åè®®å°†ä¸ä¼šå…¼å®¹ç°æœ‰çš„ Web å†…å®¹ã€‚

å…·ä½“åœ°ï¼Œæˆ‘ä»¬æ˜¯æƒ³è¦èƒ½å¤Ÿä» HTTP/1 è½¬ç§»åˆ° HTTP/2 ï¼Œå¹¶ä¸”ä¸ä¼šæœ‰ä¿¡æ¯çš„ä¸¢å¤±ã€‚å¦‚æœæˆ‘ä»¬å¼€å§‹â€æ¸…ç†â€æ¶ˆæ¯å¤´ï¼ˆå¤§å¤šæ•°äººéƒ½è®¤ä¸ºç°åœ¨çš„ HTTP æ¶ˆæ¯å¤´ç®€ç›´æ˜¯ä¸€å›¢ç³Ÿ)ï¼Œæˆ‘ä»¬å°±ä¸å¾—ä¸å»é¢å¯¹ç°æœ‰ Web çš„è¯¸å¤šé—®é¢˜ã€‚

è¿™æ ·åšåªä¼šå¯¹æ–°åè®®çš„æ™®åŠé€ æˆéº»çƒ¦ã€‚

æ€»è€Œè¨€ä¹‹ï¼Œ[å·¥ä½œç»„](https://httpwg.github.io/) ä¼šå¯¹æ‰€æœ‰çš„ HTTP è´Ÿè´£ï¼Œè€Œä¸ä»…ä»…åªæ˜¯ HTTP/2 ã€‚å› æ­¤ï¼Œæˆ‘ä»¬æ‰å¯ä»¥åœ¨ç‰ˆæœ¬ç‹¬ç«‹çš„æ–°æœºåˆ¶ä¸‹è¿ä½œï¼Œåªè¦å®ƒä»¬ä¹Ÿèƒ½åŒç°æœ‰çš„ç½‘ç»œå‘ä¸‹å…¼å®¹ã€‚

### éæµè§ˆå™¨ç”¨æˆ·çš„ HTTP æ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿ

å¦‚æœéæµè§ˆå™¨åº”ç”¨å·²ç»ä½¿ç”¨è¿‡ HTTP çš„è¯ï¼Œé‚£ä»–ä»¬ä¹Ÿåº”è¯¥å¯ä»¥ä½¿ç”¨ HTTP/2 ã€‚

å…ˆå‰æ”¶åˆ°è¿‡ HTTP â€œAPIsâ€ åœ¨ HTTP/2 ä¸­å…·æœ‰è‰¯å¥½æ€§èƒ½ç­‰ç‰¹ç‚¹è¿™æ ·çš„åé¦ˆï¼Œé‚£æ˜¯å› ä¸º API çš„è®¾è®¡ä¸éœ€è¦è€ƒè™‘ç±»ä¼¼è¯·æ±‚å¼€é”€è¿™æ ·ä¸€äº›äº‹æƒ…ã€‚

è¯è™½å¦‚æ­¤ï¼Œæˆ‘ä»¬æ­£åœ¨è€ƒè™‘çš„æ”¹è¿›é‡ç‚¹æ˜¯å…¸å‹çš„æµè§ˆç”¨ä¾‹ï¼Œå› ä¸ºè¿™æ˜¯åè®®ä¸»è¦çš„ä½¿ç”¨åœºæ™¯ã€‚

æˆ‘ä»¬çš„ç« ç¨‹é‡Œé¢æ˜¯è¿™æ ·è¯´çš„ï¼š

æ­£åœ¨ç»„ç»‡çš„è§„èŒƒèƒ½æ»¡è¶³ç°åœ¨å·²ç»æ™®ééƒ¨ç½²äº†çš„ HTTP çš„åŠŸèƒ½è¦æ±‚; å…·ä½“æ¥è¯´ä¸»è¦åŒ…æ‹¬ï¼ŒWeb æµè§ˆï¼ˆæ¡Œé¢ç«¯å’Œç§»åŠ¨ç«¯ï¼‰ï¼Œéæµè§ˆå™¨ï¼ˆâ€œ HTTP API â€å½¢å¼çš„ï¼‰ï¼Œ Web æœåŠ¡ï¼ˆå¤§èŒƒå›´çš„ï¼‰ï¼Œè¿˜æœ‰å„ç§ç½‘ç»œä¸­ä»‹ï¼ˆå€ŸåŠ©ä»£ç†ï¼Œä¼ä¸šé˜²ç«å¢™ï¼Œåå‘ä»£ç†ä»¥åŠå†…å®¹åˆ†å‘ç½‘ç»œå®ç°çš„ï¼‰ã€‚åŒæ ·çš„ï¼Œå¯¹ HTTP/1.x å½“å‰å’Œæœªæ¥çš„è¯­ä¹‰æ‰©å±• (ä¾‹å¦‚ï¼Œæ¶ˆæ¯å¤´ï¼Œæ–¹æ³•ï¼ŒçŠ¶æ€ç ï¼Œç¼“å­˜æŒ‡ä»¤) éƒ½åº”è¯¥åœ¨æ–°çš„åè®®ä¸­æ”¯æŒã€‚
    
å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œæ²¡æœ‰åŒ…æ‹¬å°† HTTP ç”¨äºéç‰¹å®šè¡Œä¸ºæ‰€ä¾èµ–çš„åœºæ™¯ä¸­ï¼ˆä¾‹å¦‚è¶…æ—¶ï¼Œè¿æ¥çŠ¶æ€ä»¥åŠæ‹¦æˆªä»£ç†ï¼‰ã€‚è¿™äº›å¯èƒ½å¹¶ä¸ä¼šè¢«æœ€ç»ˆçš„äº§å“å¯ç”¨ã€‚

### HTTP/2 éœ€è¦åŠ å¯†å—ï¼Ÿ

ä¸éœ€è¦ã€‚åœ¨æ¿€çƒˆçš„è®¨è®ºåï¼Œå·¥ä½œç»„æ²¡æœ‰å°±æ–°åè®®æ˜¯å¦ä½¿ç”¨åŠ å¯†ï¼ˆå¦‚TLSï¼‰è€Œè¾¾æˆå…±è¯†ã€‚

ä¸è¿‡ï¼Œæœ‰äº›è§‚ç‚¹è®¤ä¸ºåªæœ‰åœ¨åŠ å¯†è¿æ¥ä¸Šä½¿ç”¨æ—¶æ‰ä¼šæ”¯æŒ HTTP/2 ï¼Œè€Œç›®å‰è¿˜æ²¡æœ‰æµè§ˆå™¨æ”¯æŒæœªåŠ å¯†çš„HTTP/2ã€‚

### HTTP/2 æ˜¯æ€ä¹ˆæé«˜å®‰å…¨æ€§çš„å‘¢ï¼Ÿ

HTTP/2 å®šä¹‰äº†æ‰€éœ€çš„ TLS æ–‡æ¡£ï¼ŒåŒ…æ‹¬ç‰ˆæœ¬ï¼Œå¯†ç å¥—ä»¶é»‘åå•å’Œä½¿ç”¨çš„æ‰©å±•ã€‚

ç»†èŠ‚è¯¦è§[ç›¸å…³è§„èŒƒ](http://http2.github.io/http2-spec/#TLSUsage)ã€‚

é™¤æ­¤ä¹‹å¤–ï¼ŒåŒæ ·å¯¹é¢å¤–çš„æœºåˆ¶è¿›è¡Œäº†è®¨è®ºï¼Œä¾‹å¦‚å¯¹ HTTP:// URLs (æ‰€è°“çš„â€œæœºä¼šä¸»ä¹‰åŠ å¯†â€)ä½¿ç”¨ TLS ï¼›è¯¦è§ [RFC 8164](https://tools.ietf.org/html/rfc8164)ã€‚

### æˆ‘ç°åœ¨å¯ä»¥ä½¿ç”¨ HTTP/2 å—ï¼Ÿ

æµè§ˆå™¨ä¸­ï¼Œæœ€æ–°ç‰ˆæœ¬çš„ Edgeã€Safariã€Firefox å’Œ Chromeéƒ½æ”¯æŒ HTTP/2 ã€‚å…¶ä»–åŸºäº Blink çš„æµè§ˆå™¨ä¹Ÿå°†æ”¯æŒHTTP/2 ï¼ˆä¾‹å¦‚ Opera å’Œ Yandex æµè§ˆå™¨ï¼‰ã€‚è¯¦è§ [caniuse](http://caniuse.com/#feat=http2)ã€‚

### HTTP/2 å°†ä¼šå–ä»£ HTTP/1.x å—ï¼Ÿ

å·¥ä½œç»„çš„ç›®çš„æ˜¯è®©é‚£äº›ä½¿ç”¨ HTTP/1.x çš„äººä¹Ÿå¯ä»¥ä½¿ç”¨ HTTP/2 ï¼Œå¹¶èƒ½æ„Ÿå—åˆ° HTTP/2 æ‰€å¸¦æ¥çš„å¥½å¤„ã€‚ä»–ä»¬è¯´è¿‡ï¼Œç”±äºäººä»¬éƒ¨ç½²ä»£ç†å’ŒæœåŠ¡å™¨çš„æ–¹å¼ä¸åŒï¼Œæˆ‘ä»¬ä¸èƒ½å¼ºè¿«æ•´ä¸ªä¸–ç•Œè¿›è¡Œè¿ç§»ï¼Œæ‰€ä»¥ HTTP/1.x ä»æœ‰å¯èƒ½è¦ä½¿ç”¨äº†ä¸€æ®µæ—¶é—´ã€‚

### HTTP/3 ä¼šå‡ºç°å—ï¼Ÿ

å¦‚æœé€šè¿‡ HTTP/2 å¼•å…¥çš„æ²Ÿé€šåä½œæœºåˆ¶è¿è¡Œè‰¯å¥½ï¼Œæ”¯æŒæ–°ç‰ˆæœ¬çš„ HTTP å°±ä¼šæ¯”è¿‡å»æ›´åŠ å®¹æ˜“ã€‚

## å®ç°è¿‡ç¨‹ä¸­çš„é—®é¢˜

### ä¸ºä»€ä¹ˆè§„åˆ™ä¼šå›´ç»•æ¶ˆæ¯å¤´å¸§çš„æ•°æ®æ¥ç»­ï¼Ÿ

æ•°æ®æ¥ç»­çš„å­˜åœ¨æ˜¯ç”±äºä¸€ä¸ªå€¼ï¼ˆä¾‹å¦‚ cookie )å¯ä»¥è¶…è¿‡ 16kbï¼Œè¿™æ„å‘³ç€å®ƒä¸å¯èƒ½å…¨éƒ¨è£…è¿›ä¸€ä¸ªå¸§é‡Œé¢ã€‚

æ‰€ä»¥å°±å†³å®šä»¥æœ€ä¸å®¹æ˜“å‡ºé”™çš„æ–¹å¼è®©æ‰€æœ‰çš„æ¶ˆæ¯å¤´æ•°æ®ä»¥ä¸€ä¸ªæ¥ä¸€ä¸ªå¸§çš„æ–¹å¼ä¼ é€’ï¼Œ è¿™æ ·å°±ä½¿å¾—å¯¹æ¶ˆæ¯å¤´çš„è§£ç å’Œç¼“å†²åŒºçš„ç®¡ç†å˜å¾—æ›´åŠ å®¹æ˜“ã€‚

### HPACK çŠ¶æ€çš„æœ€å°å’Œæœ€å¤§å°ºå¯¸æ˜¯å¤šå°‘ï¼Ÿ

æ¥æ”¶ä¸€æ–¹æ€»æ˜¯ä¼šæ§åˆ¶ HPACK ä¸­å†…å­˜çš„ä½¿ç”¨é‡, å¹¶ä¸”æœ€å°èƒ½è®¾ç½®åˆ° 0 ï¼Œæœ€å¤§åˆ™è¦çœ‹ SETTING å¸§ä¸­èƒ½è¡¨ç¤ºçš„æœ€å¤§æ•´å‹æ•°æ˜¯å¤šå°‘ï¼Œç›®å‰æ˜¯ 2^32 - 1.

### æˆ‘æ€æ ·æ‰èƒ½é¿å…ä¿æŒ HPACK çŠ¶æ€ï¼Ÿ

å‘é€ä¸€ä¸ª SETTINGS å¸§ï¼Œå°†çŠ¶æ€å°ºå¯¸ ( SETTINGS_HEADER_TABLE_SIZE ) è®¾ç½®åˆ°0, ç„¶å RST æ‰€æœ‰çš„æµï¼Œç›´åˆ°ä¸€ä¸ªå¸¦æœ‰ ACT è®¾ç½®ä½çš„ SETTINGS å¸§è¢«æ¥æ”¶ã€‚

### ä¸ºä»€ä¹ˆä¼šæœ‰ä¸€ä¸ªå•ç‹¬çš„å‹ç¼©/æµç¨‹æ§åˆ¶ä¸Šä¸‹æ–‡ï¼Ÿ

ç®€å•è¯´ä¸€ä¸‹ã€‚

åŸæ¥çš„ææ¡ˆé‡Œé¢æåˆ°äº†æµåˆ†ç»„è¿™ä¸ªæ¦‚å¿µï¼Œå®ƒå¯ä»¥å…±äº«ä¸Šä¸‹æ–‡ï¼Œè¿›è¡Œæµæ§åˆ¶ç­‰ç­‰ã€‚é‚£æ ·æœ‰åˆ©äºä»£ç† (ä¹Ÿæœ‰åˆ©äºç”¨æˆ·ä½“éªŒ)ï¼Œè€Œè¿™æ ·åšç›¸åº”ä¹Ÿä¼šå¢åŠ ä¸€ç‚¹å¤æ‚åº¦ã€‚æ‰€ä»¥æˆ‘ä»¬å°±å†³å®šå…ˆä»¥ä¸€ä¸ªç®€å•çš„ä¸œè¥¿å¼€å§‹ï¼Œçœ‹çœ‹å®ƒä¼šæœ‰å¤šç³Ÿç³•çš„é—®é¢˜ï¼Œå¹¶ä¸”åœ¨æœªæ¥çš„åè®®ç‰ˆæœ¬ä¸­è§£å†³è¿™äº›é—®é¢˜ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰.

### ä¸ºä»€ä¹ˆåœ¨ HPACK ä¸­æœ‰ EOS çš„ç¬¦å·ï¼Ÿ

 ç”±äº CPU æ•ˆç‡å’Œå®‰å…¨çš„åŸå› ï¼ŒHPACK çš„éœå¤«æ›¼ç¼–ç å¡«å……äº†éœå¤«æ›¼ç¼–ç å­—ç¬¦ä¸²çš„ä¸‹ä¸€ä¸ªå­—èŠ‚è¾¹ç•Œã€‚å› æ­¤å¯¹äºä»»ä½•ç‰¹å®šçš„å­—ç¬¦ä¸²å¯èƒ½éœ€è¦0-7ä¸ªæ¯”ç‰¹çš„å¡«å……ã€‚

å¦‚æœå•ç‹¬è€ƒè™‘éœå¤«æ›¼è§£ç ï¼Œä»»ä½•æ¯”æ‰€éœ€è¦çš„å¡«å……é•¿çš„ç¬¦å·éƒ½å¯ä»¥æ­£å¸¸å·¥ä½œã€‚ä½†æ˜¯ï¼ŒHPACK çš„è®¾è®¡å…è®¸æŒ‰å­—èŠ‚å¯¹æ¯”éœå¤«æ›¼ç¼–ç çš„å­—ç¬¦ä¸²ã€‚é€šè¿‡å¡«å…… EOS ç¬¦å·éœ€è¦çš„æ¯”ç‰¹ï¼Œæˆ‘ä»¬ç¡®ä¿ç”¨æˆ·åœ¨åšéœå¤«æ›¼ç¼–ç å­—ç¬¦ä¸²å­—èŠ‚çº§æ¯”è¾ƒæ—¶æ˜¯ç›¸ç­‰çš„ã€‚åä¹‹ï¼Œè®¸å¤š headers å¯ä»¥åœ¨ä¸éœ€è¦éœå¤«æ›¼è§£ç çš„æƒ…å†µä¸‹è¢«è§£æã€‚

### å®ç° HTTP/2 çš„æ—¶å€™æˆ‘å¯ä»¥ä¸ç”¨å»å®ç° HTTP/1.1 å—ï¼Ÿ

æ˜¯çš„ï¼Œå®Œå…¨å¯ä»¥.

å¯¹äºè¿è¡Œåœ¨ TLS (`h2`)  ä¹‹ä¸Šçš„ HTTP/2 è€Œè¨€, å¦‚æœä½ æ²¡æœ‰å®ç° `http1.1` çš„ ALPN æ ‡è¯†, é‚£ä½ å°±ä¸éœ€è¦æ”¯æŒä»»ä½• HTTP/1.1 çš„ç‰¹æ€§ã€‚

å¯¹äºè¿è¡Œåœ¨ TCP (`h2c`) ä¹‹ä¸Šçš„ HTTP/2 è€Œè¨€, ä½ éœ€è¦å®ç°æœ€åŸå§‹çš„å‡çº§ï¼ˆUpgradeï¼‰è¯·æ±‚ã€‚

åªæ”¯æŒ `h2c` çš„å®¢æˆ·ç«¯éœ€è¦ç”Ÿæˆä¸€ä¸ªè¯·æ±‚ OPTIONS çš„è¯·æ±‚ï¼Œå› ä¸º â€œ*â€ æˆ–è€…ä¸€ä¸ªé’ˆå¯¹â€œ/â€çš„ HEAD è¯·æ±‚å·²ç»ç›¸å½“å®‰å…¨ï¼Œå¹¶ä¸”ä¹Ÿå¾ˆå®¹æ˜“æ„å»ºã€‚å¯»æ±‚å®ç° HTTP/2 çš„å®¢æˆ·ç«¯åªéœ€è¦æŠŠæ²¡æœ‰å¸¦ä¸Š 101 çŠ¶æ€ç çš„ HTTP/1.1 å“åº”çœ‹åšä¸€ä¸ªé”™è¯¯å°±è¡Œäº†ã€‚

åªæ”¯æŒ `h2c` çš„æœåŠ¡å™¨å¯ä»¥ä½¿ç”¨ä¸€ä¸ªå›ºå®šçš„ 101 å“åº”æ¥æ¥æ”¶ä¸€ä¸ªåŒ…å«å‡çº§ï¼ˆUpgradeï¼‰æ¶ˆæ¯å¤´å­—æ®µçš„è¯·æ±‚ã€‚æ²¡æœ‰ `h2c` çš„å‡çº§ä»¤ç‰Œçš„è¯·æ±‚å¯ä»¥ä½¿ç”¨ä¸€ä¸ªåŒ…å«äº† Upgrade æ¶ˆæ¯å¤´å­—æ®µçš„ 505 ï¼ˆ HTTP ç‰ˆæœ¬ä¸æ”¯æŒï¼‰çŠ¶æ€ç æ¥æ‹’ç»ã€‚é‚£äº›ä¸å¸Œæœ›å¤„ç† HTTP/1.1 å“åº”çš„æœåŠ¡å™¨åº”è¯¥åœ¨å‘é€äº†å¸¦æœ‰é¼“åŠ±ç”¨æˆ·åœ¨å‡çº§äº†çš„ HTTP/2 è¿æ¥ä¸Šé‡è¯•çš„è¿æ¥åºè¨€ä¹‹åç«‹å³ç”¨å¸¦æœ‰ REFUSED_STREAM é”™è¯¯ç æ‹’ç»è¯¥è¯·æ±‚çš„ç¬¬ä¸€ä»½æ•°æ®æµ.

### 5.3.2èŠ‚ä¸­çš„ä¼˜å…ˆçº§ç¤ºä¾‹æ˜¯å¦æ­£ç¡®ï¼Ÿ

ä¸æ­£ç¡®ã€‚æµ B çš„æƒé‡ä¸º 4 ï¼Œæµ Cçš„æƒé‡ä¸º 12ã€‚ä¸ºäº†ç¡®å®šæ¯ä¸ªæµæ¥æ”¶çš„å¯ç”¨èµ„æºçš„æ¯”ä¾‹ï¼Œå°†æ‰€æœ‰æƒé‡ï¼ˆ16ï¼‰ç›¸åŠ å¹¶å°†æ¯ä¸ªæµæƒé‡é™¤ä»¥æ€»æƒé‡ã€‚å› æ­¤ï¼Œæµ B æ¥æ”¶å››åˆ†ä¹‹ä¸€çš„å¯ç”¨èµ„æºï¼Œæµ C æ¥æ”¶å››åˆ†ä¹‹ä¸‰ã€‚å› æ­¤ï¼Œæ­£å¦‚è§„èŒƒæ‰€è¿°ï¼š[æµ B ç†æƒ³åœ°æ¥æ”¶åˆ†é…ç»™æµ C çš„èµ„æºçš„ä¸‰åˆ†ä¹‹ä¸€](http://http2.github.io/http2-spec/#rfc.section.5.3.2)ã€‚

### HTTP/2 è¿æ¥ä¸­éœ€è¦ TCP_NODELAY å—ï¼Ÿ

æ˜¯çš„,æœ‰å¯èƒ½ã€‚å³ä½¿å¯¹äºä»…ä½¿ç”¨å•ä¸ªæµä¸‹è½½å¤§é‡æ•°æ®çš„å®¢æˆ·ç«¯ï¼Œä»ç„¶éœ€è¦ä¸€äº›æ•°æ®åŒ…ä»¥ç›¸åçš„æ–¹å‘å‘å›ä»¥å®ç°æœ€å¤§ä¼ è¾“é€Ÿåº¦ã€‚åœ¨æ²¡æœ‰è®¾ç½® TCP_NODELAYï¼ˆä»ç„¶å…è®¸ Nagle ç®—æ³•ï¼‰çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥å°†è¾“å‡ºåˆ†ç»„ä¿æŒä¸€æ®µæ—¶é—´ä»¥å…è®¸å®ƒä»¬ä¸åç»­åˆ†ç»„åˆå¹¶ã€‚

ä¾‹å¦‚ï¼Œå¦‚æœè¿™æ ·ä¸€ä¸ªæ•°æ®åŒ…å‘Šè¯‰å¯¹ç­‰ç«¯æœ‰æ›´å¤šå¯ç”¨çš„çª—å£æ¥å‘é€æ•°æ®ï¼Œé‚£ä¹ˆå°†å…¶å‘é€å»¶è¿Ÿæ•°æ¯«ç§’(æˆ–æ›´é•¿æ—¶é—´)ä¼šå¯¹é«˜é€Ÿè¿æ¥é€ æˆä¸¥é‡å½±å“ã€‚

## éƒ¨ç½²é—®é¢˜

### æˆ‘è¯¥æ€ä¹ˆè°ƒè¯•åŠ å¯†è¿‡çš„ HTTP/2 ï¼Ÿ

å­˜å–åº”ç”¨ç¨‹åºæ•°æ®çš„æ–¹æ³•å¾ˆå¤š, æœ€ç®€å•çš„æ–¹æ³•æ˜¯ä½¿ç”¨ [NSS keylogging](https://developer.mozilla.org/en-US/docs/Mozilla/Projects/NSS/Key_Log_Format) é…ä¸Š Wireshark æ’ä»¶ (åŒ…å«åœ¨æœ€æ–°å¼€å‘ç‰ˆä¸­). è¿™ç§æ–¹æ³•å¯¹ Firefox å’Œ Chrome éƒ½é€‚ç”¨.

### æˆ‘è¯¥æ€ä¹ˆä½¿ç”¨ HTTP/2 çš„æœåŠ¡ç«¯æ¨é€ï¼Ÿ

HTTP/2 æœåŠ¡å™¨æ¨é€å…è®¸æœåŠ¡å™¨å‘å®¢æˆ·ç«¯æä¾›å†…å®¹è€Œæ— éœ€ç­‰å¾…è¯·æ±‚ã€‚è¿™å¯ä»¥æé«˜æ£€ç´¢èµ„æºçš„æ—¶é—´ï¼Œç‰¹åˆ«æ˜¯å¯¹äºå…·æœ‰å¤§[å¸¦å®½å»¶è¿Ÿäº§å“](https://en.wikipedia.org/wiki/Bandwidth-delay_product)çš„è¿æ¥ï¼Œå…¶ä¸­ç½‘ç»œå¾€è¿”æ—¶é—´å äº†åœ¨èµ„æºä¸ŠèŠ±è´¹çš„å¤§éƒ¨åˆ†æ—¶é—´ã€‚

æ¨é€åŸºäºè¯·æ±‚å†…å®¹è€Œå˜åŒ–çš„èµ„æºå¯èƒ½æ˜¯ä¸æ˜æ™ºçš„ã€‚ç›®å‰ï¼Œæµè§ˆå™¨åªä¼šæ¨é€è¯·æ±‚ï¼Œå¦‚æœä»–ä»¬ä¸è¿™æ ·åšï¼Œå°±ä¼šæå‡ºåŒ¹é…çš„è¯·æ±‚ï¼ˆè¯¦è§[Section 4 of RFC 7234](https://tools.ietf.org/html/rfc7234#section-4)ï¼‰ã€‚

æœ‰äº›ç¼“å­˜ä¸è€ƒè™‘æ‰€æœ‰è¯·æ±‚å¤´å­—æ®µçš„å˜åŒ–ï¼Œå³ä½¿å®ƒä»¬åˆ—åœ¨  `Vary` header å­—æ®µä¸­ã€‚ä¸ºäº†ä½¿æ¨é€èµ„æºè¢«æ¥æ”¶çš„å¯èƒ½æ€§æœ€å¤§åŒ–ï¼Œå†…å®¹åå•†æ˜¯æœ€å¥½çš„é€‰æ‹©ã€‚åŸºäº `accept-encoding` æŠ¥å¤´å­—æ®µçš„å†…å®¹åå•†å—åˆ°ç¼“å­˜çš„å¹¿æ³›å°Šé‡ï¼Œä½†æ˜¯å…¶ä»–æŠ¥å¤´å­—æ®µå¯èƒ½ä¸å—æ”¯æŒã€‚

> å¦‚æœå‘ç°è¯‘æ–‡å­˜åœ¨é”™è¯¯æˆ–å…¶ä»–éœ€è¦æ”¹è¿›çš„åœ°æ–¹ï¼Œæ¬¢è¿åˆ° [æ˜é‡‘ç¿»è¯‘è®¡åˆ’](https://github.com/xitu/gold-miner) å¯¹è¯‘æ–‡è¿›è¡Œä¿®æ”¹å¹¶ PRï¼Œä¹Ÿå¯è·å¾—ç›¸åº”å¥–åŠ±ç§¯åˆ†ã€‚æ–‡ç« å¼€å¤´çš„ **æœ¬æ–‡æ°¸ä¹…é“¾æ¥** å³ä¸ºæœ¬æ–‡åœ¨ GitHub ä¸Šçš„ MarkDown é“¾æ¥ã€‚

------

> [æ˜é‡‘ç¿»è¯‘è®¡åˆ’](https://github.com/xitu/gold-miner) æ˜¯ä¸€ä¸ªç¿»è¯‘ä¼˜è´¨äº’è”ç½‘æŠ€æœ¯æ–‡ç« çš„ç¤¾åŒºï¼Œæ–‡ç« æ¥æºä¸º [æ˜é‡‘](https://juejin.im) ä¸Šçš„è‹±æ–‡åˆ†äº«æ–‡ç« ã€‚å†…å®¹è¦†ç›– [Android](https://github.com/xitu/gold-miner#android)ã€[iOS](https://github.com/xitu/gold-miner#ios)ã€[å‰ç«¯](https://github.com/xitu/gold-miner#å‰ç«¯)ã€[åç«¯](https://github.com/xitu/gold-miner#åç«¯)ã€[åŒºå—é“¾](https://github.com/xitu/gold-miner#åŒºå—é“¾)ã€[äº§å“](https://github.com/xitu/gold-miner#äº§å“)ã€[è®¾è®¡](https://github.com/xitu/gold-miner#è®¾è®¡)ã€[äººå·¥æ™ºèƒ½](https://github.com/xitu/gold-miner#äººå·¥æ™ºèƒ½)ç­‰é¢†åŸŸï¼Œæƒ³è¦æŸ¥çœ‹æ›´å¤šä¼˜è´¨è¯‘æ–‡è¯·æŒç»­å…³æ³¨ [æ˜é‡‘ç¿»è¯‘è®¡åˆ’](https://github.com/xitu/gold-miner)ã€[å®˜æ–¹å¾®åš](http://weibo.com/juejinfanyi)ã€[çŸ¥ä¹ä¸“æ ](https://zhuanlan.zhihu.com/juejinfanyi)ã€‚
