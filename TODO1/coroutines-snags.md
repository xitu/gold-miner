> * åŸæ–‡åœ°å€ï¼š[Advanced Kotlin Coroutines tips and tricks](https://proandroiddev.com/coroutines-snags-6bf6fb53a3d1)
> * åŸæ–‡ä½œè€…ï¼š[Alex Saveau](https://proandroiddev.com/@SUPERCILEX?source=post_header_lockup)
> * è¯‘æ–‡å‡ºè‡ªï¼š[æ˜é‡‘ç¿»è¯‘è®¡åˆ’](https://github.com/xitu/gold-miner)
> * æœ¬æ–‡æ°¸ä¹…é“¾æ¥ï¼š[https://github.com/xitu/gold-miner/blob/master/TODO1/coroutines-snags.md](https://github.com/xitu/gold-miner/blob/master/TODO1/coroutines-snags.md)
> * è¯‘è€…ï¼š[nanjingboy](https://github.com/nanjingboy)
> * æ ¡å¯¹è€…ï¼š

# Kotlin åç¨‹é«˜çº§ä½¿ç”¨æŠ€å·§

## å­¦ä¹ ä¸€äº›éšœç¢ä»¥åŠå¦‚ä½•ç»•è¿‡å®ƒä»¬

![](https://cdn-images-1.medium.com/max/800/1*xGP1VG9jCjZN1VqFKgrL9A.png)

åç¨‹ä» 1.3 å¼€å§‹æˆä¸ºç¨³å®šç‰ˆï¼

å¼€å§‹ Kotlin åç¨‹éå¸¸ç®€å•ï¼šåªéœ€å°†ä¸€äº›è€—æ—¶æ“ä½œæ”¾åœ¨ `launch` ä¸­å³å¯ï¼Œä½ åšåˆ°äº†ï¼Œå¯¹ä¸ï¼Ÿå½“ç„¶ï¼Œè¿™æ˜¯é’ˆå¯¹ç®€å•çš„æƒ…å†µã€‚ä½†å¾ˆå¿«ï¼Œå¹¶å‘ä¸å¹¶è¡Œçš„å¤æ‚æ€§ä¼šæ…¢æ…¢å †ç§¯èµ·æ¥ã€‚

å½“ä½ æ·±å…¥ç ”ç©¶åç¨‹æ—¶ï¼Œä»¥ä¸‹æ˜¯ä¸€äº›ä½ éœ€è¦çŸ¥é“çš„äº‹æƒ…ã€‚

### å–æ¶ˆ + é˜»å¡æ“ä½œ = ğŸ˜ˆ

æ²¡æœ‰åŠæ³•ç»•è¿‡å®ƒï¼šåœ¨æŸäº›æ—¶å€™ï¼Œä½ ä¸å¾—ä¸ç”¨çº¯ Java æµã€‚è¿™é‡Œçš„é—®é¢˜ï¼ˆå¾ˆå¤šæƒ…å†µä¸‹ ğŸ˜‰ï¼‰æ˜¯ä½¿ç”¨æµå°†ä¼šå µå¡å½“å‰çº¿ç¨‹ã€‚è¿™åœ¨åç¨‹ä¸­æ˜¯ä¸€ä¸ªåæ¶ˆæ¯ã€‚ç°åœ¨ï¼Œå¦‚æœä½ æƒ³è¦å–æ¶ˆä¸€ä¸ªåç¨‹ï¼Œåœ¨èƒ½å¤Ÿç»§ç»­æ‰§è¡Œä¹‹å‰ï¼Œä½ ä¸å¾—ä¸ç­‰å¾…è¯»å†™æ“ä½œå®Œæˆã€‚

ä½œä¸ºä¸€ä¸ªç®€å•å¯é‡å¤çš„ä¾‹å­ï¼Œè®©æˆ‘ä»¬æ‰“å¼€ `ServerSocket` å¹¶ä¸”ç­‰å¾… 1 ç§’çš„è¶…æ—¶è¿æ¥ï¼š

```
runBlocking(Dispatchers.IO) {
    withTimeout(1000) {
        val socket = ServerSocket(42)

         // æˆ‘ä»¬å°†å¡åœ¨è¿™é‡Œç›´åˆ°æœ‰äººæ¥æ”¶è¯¥è¿æ¥ã€‚éš¾é“ä½ ä¸æƒ³çŸ¥é“ä¸ºä»€ä¹ˆå—ï¼ŸğŸ˜œ
        socket.accept()
    }
}
```

åº”è¯¥å·¥ä½œï¼Œå¯¹å—ï¼Ÿä¸ã€‚

ç°åœ¨ä½ çš„æ„Ÿå—æœ‰ç‚¹åƒï¼šğŸ˜–ã€‚ é‚£ä¹ˆæˆ‘ä»¬å¦‚ä½•è§£å†³å‘¢ï¼Ÿ

å½“ `Closeable` APIs æ„å»ºè‰¯å¥½æ—¶ï¼Œå®ƒä»¬æ”¯æŒä»ä»»ä½•çº¿ç¨‹å…³é—­æµå¹¶é€‚å½“åœ°å¤±è´¥ã€‚

> æ³¨æ„ï¼šé€šå¸¸æƒ…å†µä¸‹ï¼ŒJDK ä¸­çš„ APIs éµå¾ªäº†è¿™äº›æœ€ä½³å®è·µï¼Œä½†éœ€æ³¨æ„ç¬¬ä¸‰æ–¹ `Closeable` APIs å¯èƒ½å¹¶æ²¡æœ‰éµå¾ªã€‚ ä½ è¢«æé†’è¿‡äº†ã€‚

æ„Ÿè°¢ `suspendCancellableCoroutine` å‡½æ•°ï¼Œå½“ä¸€ä¸ªåç¨‹è¢«å–æ¶ˆæ—¶æˆ‘ä»¬å¯ä»¥å…³é—­ä»»ä½•æµï¼š

```
public suspend inline fun <T : Closeable?, R> T.useCancellably(
        crossinline block: (T) -> R
): R = suspendCancellableCoroutine { cont ->
    cont.invokeOnCancellation { this?.close() }
    cont.resume(use(block))
}
```

ç¡®ä¿è¿™é€‚ç”¨äºä½ æ­£åœ¨ä½¿ç”¨çš„ API ï¼

ç°åœ¨é˜»å¡çš„ `accept` è°ƒç”¨è¢« `useCancellably` åŒ…è£¹ï¼Œè¯¥åç¨‹ä¼šåœ¨è¶…æ—¶è§¦å‘çš„æ—¶å€™å¤±è´¥ã€‚

```
runBlocking(Dispatchers.IO) {
    withTimeout(1000) {
        val socket = ServerSocket(42)

        // æŠ›å‡º `SocketException: socket closed` å¼‚å¸¸ã€‚å¥½æäº†ï¼
        socket.useCancellably { it.accept() }
    }
}
```

æˆåŠŸï¼

å¦‚æœä½ ä¸æ”¯æŒå–æ¶ˆæ€ä¹ˆåŠï¼Ÿä»¥ä¸‹æ˜¯ä½ éœ€è¦æ³¨æ„çš„äº‹é¡¹ï¼š

*   å¦‚æœä½ ä½¿ç”¨åç¨‹å°è£…ç±»ä¸­çš„ä»»ä½•å±æ€§æˆ–æ–¹æ³•ï¼Œå³ä½¿å–æ¶ˆäº†åç¨‹ä¹Ÿä¼šå­˜åœ¨æ³„æ¼ã€‚å¦‚æœä½ è®¤ä¸ºä½ æ­£åœ¨ `onDestroy` ä¸­æ¸…ç†èµ„æºï¼Œè¿™å°¤å…¶é‡è¦ã€‚**è§£å†³æ–¹æ³•:** å°†ååŒç¨‹åºç§»åŠ¨åˆ° `ViewModel` æˆ–å…¶ä»–ä¸Šä¸‹æ–‡æ— å…³çš„ç±»ä¸­å¹¶è®¢é˜…å®ƒçš„å¤„ç†ç»“æœã€‚
*   ç¡®ä¿ä½¿ç”¨ `Dispatchers.IO` æ¥å¤„ç†é˜»å¡æ“ä½œï¼Œå› ä¸ºè¿™å¯ä»¥è®© Kotlin ç•™å‡ºä¸€äº›çº¿ç¨‹æ¥è¿›è¡Œæ— é™ç­‰å¾…ã€‚
*   å°½å¯èƒ½ä½¿ç”¨ `suspendCancellableCoroutine` æ›¿æ¢ `suspendCoroutine`ã€‚

### `launch` vs. `async`

ç”±äºä¸Šé¢å…³äºè¿™ä¸¤ä¸ªç‰¹æ€§çš„å›ç­”å·²ç»è¿‡æ—¶ï¼Œæˆ‘æƒ³æˆ‘ä¼šå†æ¬¡åˆ†æå®ƒä»¬çš„å·®å¼‚ã€‚

#### `launch` å¼‚å¸¸å†’æ³¡

å½“ä¸€ä¸ªåç¨‹å´©æºƒæ—¶ï¼Œå®ƒçš„çˆ¶èŠ‚ç‚¹å°†è¢«å–æ¶ˆï¼Œä»è€Œå–æ¶ˆæ‰€æœ‰çˆ¶èŠ‚ç‚¹çš„å­èŠ‚ç‚¹ã€‚ä¸€æ—¦æ•´ä¸ªæ ‘èŠ‚ç‚¹ä¸­çš„åç¨‹å®Œæˆå–æ¶ˆæ“ä½œï¼Œå¼‚å¸¸å°†ä¼šå‘é€åˆ°å½“å‰ä¸Šçº¿æ–‡çš„å¼‚å¸¸å¤„ç†ç¨‹åºã€‚åœ¨ Android ä¸­ï¼Œè¿™æ„å‘³ç€ _ä½ çš„_ ç¨‹åºå°†ä¼š _å´©æºƒ_ï¼Œè€Œä¸ç®¡ä½ ä½¿ç”¨ä»€ä¹ˆæ¥è¿›è¡Œè°ƒåº¦ã€‚

#### `async` æŒæœ‰è‡ªå·±çš„å¼‚å¸¸

è¿™æ„å‘³ç€ `await()` æ˜¾å¼å¤„ç†æ‰€æœ‰å¼‚å¸¸ï¼Œå®‰è£… `CoroutineExceptionHandler` å°†æ— ä»»ä½•æ•ˆæœã€‚

#### `launch` â€œblocksâ€ çˆ¶ä½œç”¨åŸŸ

è™½ç„¶è¯¥å‡½æ•°ä¼šç«‹å³è¿”å›ï¼Œä½†å…¶çˆ¶ä½œç”¨åŸŸå°† _ä¸ä¼š_ ç»“æŸï¼Œç›´åˆ°ä½¿ç”¨ `launch` æ„å»ºçš„æ‰€æœ‰åç¨‹ä»¥æŸç§æ–¹å¼å®Œæˆã€‚å› æ­¤å¦‚æœä½ åªæ˜¯æƒ³ç­‰å¾…æ‰€æœ‰åç¨‹å®Œæˆï¼Œåœ¨çˆ¶ä½œç”¨åŸŸæœ«å°¾è°ƒç”¨æ‰€æœ‰å­ä½œä¸šçš„ `join()` å°±æ²¡æœ‰å¿…è¦äº†ã€‚

ä¸ä½ æœŸæœ›çš„å¯èƒ½ä¸åŒï¼Œå³ä½¿æœªè°ƒç”¨ `awaitï¼ˆï¼‰`ï¼Œå¤–éƒ¨ä½œç”¨åŸŸä»å°†ç­‰å¾…`async`åç¨‹å®Œæˆã€‚

#### `async` è¿”å›å€¼

è¿™ä¸€éƒ¨åˆ†ç›¸å½“ç®€å•ï¼šå¦‚æœä½ éœ€è¦åç¨‹çš„è¿”å›å€¼ï¼Œ`async` æ˜¯å”¯ä¸€çš„é€‰æ‹©ã€‚å¦‚æœä½ ä¸éœ€è¦è¿”å›å€¼ï¼Œä½¿ç”¨ `launch` æ¥åˆ›å»ºå‰¯ä½œç”¨ã€‚å¹¶ä¸”åœ¨ç»§ç»­æ‰§è¡Œä¹‹å‰éœ€è¦å®Œæˆè¿™äº›å‰¯ä½œç”¨æ‰éœ€è¦ä½¿ç”¨ `join()`ã€‚

#### `join()` vs. `await()`

`join()` åœ¨ `await()` æ—¶ _ä¸ä¼š_ é‡æ–°æŠ›å‡ºå¼‚å¸¸ã€‚ä½†å¦‚æœå‘ç”Ÿé”™è¯¯ï¼Œ `join()` ä¼šå–æ¶ˆä½ çš„åç¨‹ï¼Œè¿™æ„å‘³ç€åœ¨ `join()` æŒ‚èµ·åè°ƒç”¨ä»»ä½•ä»£ç éƒ½ä¸ä¼šèµ·ä½œç”¨ã€‚

### è®°å½•å¼‚å¸¸

ç°åœ¨ä½ äº†è§£äº†ä½ æ‰€ä½¿ç”¨ä¸åŒæ„é€ å™¨å¼‚å¸¸å¤„ç†æœºåˆ¶çš„å·®å¼‚ï¼Œä½ ä¼šé™·å…¥ä¸¤éš¾å¢ƒåœ°ï¼šä½ æƒ³è®°å½•å¼‚å¸¸è€Œä¸å´©æºƒï¼ˆæ‰€ä»¥æˆ‘ä»¬ä¸èƒ½ä½¿ç”¨ `launch`ï¼‰ï¼Œä½†æ˜¯ä½ ä¸æƒ³æ‰‹åŠ¨è°ƒç”¨ `try`/`catch` ï¼ˆæ‰€ä»¥æˆ‘ä»¬ä¸èƒ½ä½¿ç”¨ `async`ï¼‰ã€‚æ‰€ä»¥è¿™è®©æˆ‘ä»¬æ— æ‰€é€‚ä»ï¼Ÿè°¢å¤©è°¢åœ°ã€‚

è®°å½•å¼‚å¸¸æ˜¯  `CoroutineExceptionHandler` æ´¾ä¸Šç”¨åœºçš„åœ°æ–¹ã€‚ä½†é¦–å…ˆï¼Œè®©æˆ‘ä»¬èŠ±ç‚¹æ—¶é—´äº†è§£åœ¨åç¨‹ä¸­æŠ›å‡ºå¼‚å¸¸æ—¶ç©¶ç«Ÿå‘ç”Ÿäº†ä»€ä¹ˆï¼š

1.  æ•è·å¼‚å¸¸ï¼Œç„¶åé€šè¿‡ `Continuation` æ¢å¤ã€‚
2.  å¦‚æœä½ çš„ä»£ç æ²¡æœ‰å¤„ç†å¼‚å¸¸å¹¶ä¸”è¯¥å¼‚å¸¸ä¸æ˜¯ `CancellationException`ï¼Œé‚£ä¹ˆå°†é€šè¿‡å½“å‰çš„ `CoroutineContext` è¯·æ±‚ç¬¬ä¸€ä¸ª `CoroutineExceptionHandler`ã€‚
3.  å¦‚æœæœªæ‰¾åˆ°å¤„ç†ç¨‹åºæˆ–å¤„ç†ç¨‹åºæœ‰é”™è¯¯ï¼Œé‚£ä¹ˆå¼‚å¸¸å°†å‘é€åˆ°å¹³å°ä¸­çš„ç‰¹å®šä»£ç ã€‚
4.  åœ¨ JVM ä¸Šï¼Œ`ServiceLoader` ç”¨äºå®šä½å…¨å±€å¤„ç†ç¨‹åºã€‚
5.  ä¸€æ—¦è°ƒç”¨äº†æ‰€æœ‰å¤„ç†ç¨‹åºæˆ–æœ‰ä¸€ä¸ªå¤„ç†ç¨‹åºå‡ºç°é”™è¯¯ï¼Œå°±ä¼šè°ƒç”¨å½“å‰çº¿ç¨‹çš„å¼‚å¸¸å¤„ç†ç¨‹åºã€‚
6.  å¦‚æœå½“å‰çº¿ç¨‹æ²¡æœ‰å¤„ç†è¯¥å¼‚å¸¸ï¼Œå®ƒä¼šå†’æ³¡åˆ°çº¿ç¨‹ç»„å¹¶æœ€ç»ˆåˆ°è¾¾é»˜è®¤å¼‚å¸¸å¤„ç†ç¨‹åºã€‚
7.  å´©æºƒï¼

è€ƒè™‘åˆ°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬æœ‰ä»¥ä¸‹å‡ ä¸ªé€‰æ‹©ï¼š

*   ä¸ºæ¯ä¸ªçº¿ç¨‹å®‰è£…ä¸€ä¸ªå¤„ç†ç¨‹åºï¼Œä½†è¿™æ˜¯ä¸ç°å®çš„ã€‚
*   å®‰è£…é»˜è®¤å¤„ç†ç¨‹åºï¼Œä½†ä¸»çº¿ç¨‹ä¸­çš„é”™è¯¯ä¸ä¼šè®©ä½ çš„åº”ç”¨å´©æºƒï¼Œå¹¶ä¸”ä½ å°†å¤„äºæ½œåœ¨çš„ä¸è‰¯çŠ¶æ€ã€‚
*   [å°†å¤„ç†ç¨‹åºæ·»åŠ ä¸ºæœåŠ¡](https://gist.github.com/SUPERCILEX/f4b01ccf6fd4ef7ec0a85dbd59c89d6c) å½“ä½¿ç”¨ `launch` çš„ä»»ä½•åç¨‹å´©æºƒæ—¶éƒ½ä¼šè°ƒç”¨å®ƒï¼ˆhackyï¼‰ã€‚
*   ä½¿ç”¨ä½ è‡ªå·±çš„è‡ªå®šä¹‰åŸŸä¸é™„åŠ çš„å¤„ç†ç¨‹åºæ¥æ›¿æ¢ `GlobalScope`ï¼Œæˆ–å°†å¤„ç†ç¨‹åºæ·»åŠ åˆ°ä½ ä½¿ç”¨çš„æ¯ä¸ªä½œç”¨åŸŸï¼Œä½†è¿™å¾ˆçƒ¦äººå¹¶ä½¿æ—¥å¿—è®°å½•ç”±é»˜è®¤å˜æˆäº†å¯é€‰ã€‚

æœ€åä¸€ä¸ªæ˜¯é¦–é€‰è§£å†³æ–¹æ¡ˆï¼Œå› ä¸ºå®ƒå…·æœ‰çµæ´»æ€§å¹¶ä¸”éœ€è¦æœ€å°‘çš„ä»£ç å’Œhacksã€‚

å¯¹äºåº”ç”¨ç¨‹åºèŒƒå›´å†…çš„ä½œä¸šï¼Œä½ å°†ä½¿ç”¨å¸¦æœ‰æ—¥å¿—è®°å½•å¤„ç†ç¨‹åºçš„ `AppScope`ã€‚å¯¹äºå…¶ä»–ä½œä¸šï¼Œä½ å¯ä»¥åœ¨æ—¥å¿—è®°å½•å´©æºƒçš„é€‚å½“ä½ç½®æ·»åŠ å¤„ç†ç¨‹åºã€‚

```
val LoggingExceptionHandler = CoroutineExceptionHandler { _, t ->
    Crashlytics.logException(t)
}
val AppScope = GlobalScope + LoggingExceptionHandler
```

```
class ViewModelBase : ViewModel(), CoroutineScope {
    override val coroutineContext = Job() + LoggingExceptionHandler

    override fun onCleared() = coroutineContext.cancel()
}
```

ä¸æ˜¯å¾ˆç³Ÿç³•

### æœ€åçš„æ€è€ƒ

ä»»ä½•æ—¶å€™æˆ‘ä»¬å¿…é¡»å¤„ç†è¾¹ç¼˜æƒ…å†µï¼Œäº‹æƒ…å¾€å¾€ä¼šå¾ˆå¿«å˜å¾—æ··ä¹±ã€‚æˆ‘å¸Œæœ›è¿™ç¯‡æ–‡ç« èƒ½å¤Ÿå¸®åŠ©ä½ äº†è§£åœ¨éæ ‡å‡†æ¡ä»¶ä¸‹å¯èƒ½é‡åˆ°çš„å„ç§é—®é¢˜ï¼Œä»¥åŠä½ å¯ä»¥ä½¿ç”¨çš„è§£å†³æ–¹æ¡ˆã€‚

Happy Kotlining!

* [**Alex Saveau (@SUPERCILEX) | Twitter**: The latest Tweets from Alex Saveau (@SUPERCILEX). All things ğŸ”¥base, Android, and open-source. Also, ğŸ¤ builds...](https://twitter.com/SUPERCILEX "https://twitter.com/SUPERCILEX")

> å¦‚æœå‘ç°è¯‘æ–‡å­˜åœ¨é”™è¯¯æˆ–å…¶ä»–éœ€è¦æ”¹è¿›çš„åœ°æ–¹ï¼Œæ¬¢è¿åˆ° [æ˜é‡‘ç¿»è¯‘è®¡åˆ’](https://github.com/xitu/gold-miner) å¯¹è¯‘æ–‡è¿›è¡Œä¿®æ”¹å¹¶ PRï¼Œä¹Ÿå¯è·å¾—ç›¸åº”å¥–åŠ±ç§¯åˆ†ã€‚æ–‡ç« å¼€å¤´çš„ **æœ¬æ–‡æ°¸ä¹…é“¾æ¥** å³ä¸ºæœ¬æ–‡åœ¨ GitHub ä¸Šçš„ MarkDown é“¾æ¥ã€‚


---

> [æ˜é‡‘ç¿»è¯‘è®¡åˆ’](https://github.com/xitu/gold-miner) æ˜¯ä¸€ä¸ªç¿»è¯‘ä¼˜è´¨äº’è”ç½‘æŠ€æœ¯æ–‡ç« çš„ç¤¾åŒºï¼Œæ–‡ç« æ¥æºä¸º [æ˜é‡‘](https://juejin.im) ä¸Šçš„è‹±æ–‡åˆ†äº«æ–‡ç« ã€‚å†…å®¹è¦†ç›– [Android](https://github.com/xitu/gold-miner#android)ã€[iOS](https://github.com/xitu/gold-miner#ios)ã€[å‰ç«¯](https://github.com/xitu/gold-miner#å‰ç«¯)ã€[åç«¯](https://github.com/xitu/gold-miner#åç«¯)ã€[åŒºå—é“¾](https://github.com/xitu/gold-miner#åŒºå—é“¾)ã€[äº§å“](https://github.com/xitu/gold-miner#äº§å“)ã€[è®¾è®¡](https://github.com/xitu/gold-miner#è®¾è®¡)ã€[äººå·¥æ™ºèƒ½](https://github.com/xitu/gold-miner#äººå·¥æ™ºèƒ½)ç­‰é¢†åŸŸï¼Œæƒ³è¦æŸ¥çœ‹æ›´å¤šä¼˜è´¨è¯‘æ–‡è¯·æŒç»­å…³æ³¨ [æ˜é‡‘ç¿»è¯‘è®¡åˆ’](https://github.com/xitu/gold-miner)ã€[å®˜æ–¹å¾®åš](http://weibo.com/juejinfanyi)ã€[çŸ¥ä¹ä¸“æ ](https://zhuanlan.zhihu.com/juejinfanyi)ã€‚
