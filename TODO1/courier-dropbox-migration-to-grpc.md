> * åŸæ–‡åœ°å€ï¼š[Courier: Dropbox migration to gRPC](https://blogs.dropbox.com/tech/2019/01/courier-dropbox-migration-to-grpc/)
> * åŸæ–‡ä½œè€…ï¼š[blogs.dropbox.com](https://blogs.dropbox.com)
> * è¯‘æ–‡å‡ºè‡ªï¼š[æ˜é‡‘ç¿»è¯‘è®¡åˆ’](https://github.com/xitu/gold-miner)
> * æœ¬æ–‡æ°¸ä¹…é“¾æ¥ï¼š[https://github.com/xitu/gold-miner/blob/master/TODO1/courier-dropbox-migration-to-grpc.md](https://github.com/xitu/gold-miner/blob/master/TODO1/courier-dropbox-migration-to-grpc.md)
> * è¯‘è€…ï¼š[kasheemlew](https://github.com/kasheemlew)
> * æ ¡å¯¹è€…ï¼š

# Courier: Dropbox çš„ gRPC è¿ç§»åˆ©å™¨

![](https://dropboxtechblog.files.wordpress.com/2019/01/01-screenshot2018-12-0516.35.14-black.png?w=650&h=352)

Dropbox è¿è¡Œç€å‡ ç™¾ä¸ªæœåŠ¡ï¼Œå®ƒä»¬ç”±ä¸åŒçš„è¯­è¨€ç¼–å†™ï¼Œæ¯ç§’ä¼šäº¤æ¢å‡ ç™¾ä¸‡ä¸ªè¯·æ±‚ã€‚åœ¨æˆ‘ä»¬é¢å‘æœåŠ¡æ¶æ„çš„ä¸­å¿ƒå°±æ˜¯ Courierï¼Œå®ƒæ˜¯æˆ‘ä»¬åŸºäº gRPC çš„è¿œè¿‡ç¨‹è°ƒç”¨ï¼ˆRPCï¼‰æ¡†æ¶ã€‚åœ¨å¼€å‘ Courier çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å­¦åˆ°äº†å¾ˆå¤šæ‰©å±• RPC å¹¶ä¼˜åŒ–æ€§èƒ½å’Œè¡”æ¥åŸæœ‰ RPC ç³»ç»Ÿçš„ä¸œè¥¿ã€‚

_æ³¨é‡Šï¼šæœ¬æ–‡åªå±•ç¤ºäº† Python å’Œ Go ç”Ÿæˆä»£ç çš„ä¾‹å­ã€‚æˆ‘ä»¬ä¹Ÿæ”¯æŒ Rust å’Œ Javaã€‚_

## The road to gRPC

Courier ä¸æ˜¯ Dropbox çš„ç¬¬ä¸€ä¸ª RPC æ¡†æ¶ã€‚åœ¨æˆ‘ä»¬æ­£å¼å¼€å§‹å°†åºå¤§çš„çš„ Python ç¨‹åºæ‹†æˆå¤šä¸ªæœåŠ¡ä¹‹å‰ï¼Œæˆ‘ä»¬å°±è®¤è¯†åˆ°æœåŠ¡ä¹‹é—´çš„é€šä¿¡éœ€è¦æœ‰ç‰¢å›ºçš„åŸºç¡€ï¼Œæ‰€ä»¥é€‰æ‹©ä¸€ä¸ªé«˜å¯é æ€§çš„ RPC æ¡†æ¶å°±æ˜¾å¾—å°¤å…¶å…³é”®ã€‚

å¼€å§‹ä¹‹å‰ï¼ŒDropbox è°ƒç ”äº†å¤šä¸ª RPC æ¡†æ¶ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬ä»ä¼ ç»Ÿçš„æ‰‹åŠ¨åºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„åè®®ç€æ‰‹ï¼Œæ¯”å¦‚æˆ‘ä»¬ç”¨ [Apache Thrift](https://github.com/apache/thrift) æ­å»ºçš„[åŸºäº Scribe çš„æ—¥å¿—ç®¡é“](https://blogs.dropbox.com/tech/2015/05/how-to-write-a-better-scribe/)ä¹‹ç±»çš„æœåŠ¡ã€‚ä½†æˆ‘ä»¬ä¸»è¦çš„ RPC æ¡†æ¶ï¼ˆä¼ ç»Ÿçš„ RPCï¼‰æ˜¯åŸºäº HTTP/1.1 åè®®å¹¶ä½¿ç”¨ protobuf ç¼–ç æ¶ˆæ¯ã€‚

æˆ‘ä»¬çš„æ–°æ¡†æ¶æœ‰å‡ ä¸ªå€™é€‰é¡¹ã€‚æˆ‘ä»¬å¯ä»¥å‡çº§é—ç•™çš„ RPC æ¡†æ¶ä½¿å…¶å…¼å®¹ Swaggerï¼ˆç°åœ¨å« [OpenAPI](https://github.com/OAI/OpenAPI-Specification)ï¼‰ï¼Œæˆ–è€…[å»ºç«‹æ–°æ ‡å‡†](https://xkcd.com/927/)ï¼Œä¹Ÿå¯ä»¥è€ƒè™‘åœ¨ Thrift å’Œ gRPC çš„åŸºç¡€ä¸Šå¼€å‘ã€‚

æˆ‘ä»¬æœ€ç»ˆé€‰æ‹© gRPC ä¸»è¦æ˜¯å› ä¸ºå®ƒå…è®¸æˆ‘ä»¬æ²¿ç”¨ protobufã€‚å¯¹äºæˆ‘ä»¬çš„æƒ…å†µï¼Œå¤šè·¯ HTTP/2 ä¼ è¾“å’ŒåŒå‘æµä¹Ÿå¾ˆæœ‰å¸å¼•åŠ›ã€‚

> å¦‚æœé‚£æ—¶å€™æœ‰ [fbthrift](https://github.com/facebook/fbthrift) çš„è¯ï¼Œæˆ‘ä»¬ä¹Ÿè®¸ä¼šä»”ç»†ç§ç§åŸºäº Thrift çš„è§£å†³æ–¹æ¡ˆã€‚

## Courier ç»™ gRPC å¸¦æ¥äº†ä»€ä¹ˆ

Courier ä¸æ˜¯ä¸€ä¸ªæ–°çš„ RPC åè®® â€”â€” å®ƒåªæ˜¯ Dropbox ç”¨æ¥å…¼å®¹ gRPC å’ŒåŸæœ‰åŸºç¡€è®¾æ–½çš„è§£å†³æ–¹æ¡ˆã€‚ä¾‹å¦‚ï¼Œåªæœ‰ä½¿ç”¨æŒ‡å®šç‰ˆæœ¬çš„éªŒè¯ã€æˆæƒå’ŒæœåŠ¡å‘ç°æ—¶å®ƒæ‰èƒ½å·¥ä½œã€‚å®ƒè¿˜å¿…é¡»å…¼å®¹æˆ‘ä»¬çš„ç»Ÿè®¡ã€äº‹ä»¶æ—¥å¿—å’Œè¿½è¸ªå·¥å…·ã€‚æ»¡è¶³æ‰€æœ‰è¿™äº›æ¡ä»¶æ‰æ˜¯æˆ‘ä»¬æ‰€è¯´çš„ Courierã€‚

> å°½ç®¡æˆ‘ä»¬æ”¯æŒåœ¨ä¸€äº›ç‰¹æ®Šæƒ…å†µä¸‹ä½¿ç”¨ [Bandaid](https://blogs.dropbox.com/tech/2018/03/meet-bandaid-the-dropbox-service-proxy/) ä½œä¸º gRPC ä»£ç†ï¼Œä½†ä¸ºäº†å‡å° RPC çš„å»¶è¿Ÿï¼Œå¤§å¤šæ•°æœåŠ¡é—´çš„é€šä¿¡å¹¶ä¸ä½¿ç”¨ä»£ç†ã€‚

æˆ‘ä»¬æƒ³å‡å°‘éœ€è¦ç¼–å†™çš„æ ·æ¿æ–‡ä»¶çš„æ•°é‡ã€‚ä½œä¸ºæˆ‘ä»¬æœåŠ¡å¼€å‘çš„é€šç”¨æ¡†æ¶ï¼ŒCourier æ‹¥æœ‰æ‰€æœ‰æœåŠ¡éœ€è¦çš„ç‰¹æ€§ã€‚å¤§å¤šæ•°ç‰¹æ€§éƒ½æ˜¯é»˜è®¤å¼€å¯çš„ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡å‘½ä»¤è¡Œå‚æ•°è¿›è¡Œæ§åˆ¶ã€‚æœ‰äº›è¿˜å¯ä»¥ä½¿ç”¨ç‰¹æ€§æ ‡è¯†åŠ¨æ€å¼€å¯ã€‚

### å®‰å…¨æ€§ï¼šæœåŠ¡èº«ä»½å’Œ TLS ç›¸äº’è®¤è¯

Courier å®ç°äº†æˆ‘ä»¬çš„æ ‡å‡†æœåŠ¡èº«ä»½æœºåˆ¶ã€‚æˆ‘ä»¬çš„æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯éƒ½æœ‰å„è‡ªçš„ TLS è¯ä¹¦ï¼Œè¿™äº›è¯ä¹¦ç”±æˆ‘ä»¬å†…éƒ¨çš„æƒå¨æœºæ„é¢å‘ã€‚æ¯ä¸ªæœåŠ¡å™¨å’Œå®¢æˆ·ç«¯è¿˜æœ‰ä¸€ä¸ªä½¿ç”¨è¿™ä¸ªè¯ä¹¦åŠ å¯†çš„èº«ä»½ï¼Œç”¨äºä»–ä»¬ä¹‹é—´çš„åŒå‘éªŒè¯ã€‚

> æˆ‘ä»¬åœ¨ TLS ä¾§æ§åˆ¶é€šä¿¡çš„ä¸¤ç«¯ï¼Œå¹¶å¼ºåˆ¶è¿›è¡Œä¸€äº›é»˜è®¤çš„é™åˆ¶ã€‚å†…éƒ¨çš„ RPC é€šä¿¡éƒ½å¼ºåˆ¶ä½¿ç”¨ [PFS](https://scotthelme.co.uk/perfect-forward-secrecy/) åŠ å¯†ã€‚TLS çš„ç‰ˆæœ¬å›ºå®šä¸º 1.2+ã€‚æˆ‘ä»¬è¿˜é™åˆ¶ä½¿ç”¨å¯¹ç§°/éå¯¹ç§°ç®—æ³•çš„å®‰å…¨çš„å­é›†è¿›è¡ŒåŠ å¯†ï¼Œè¿™é‡Œæ¯”è¾ƒå€¾å‘äºä½¿ç”¨ `ECDHE-ECDSA-AES128-GCM-SHA256`ã€‚

å®Œæˆèº«ä»½è®¤è¯å’Œè¯·æ±‚çš„è§£ç ä¹‹åï¼ŒæœåŠ¡å™¨ä¼šå¯¹å®¢æˆ·ç«¯è¿›è¡Œæƒé™éªŒè¯ã€‚åœ¨æœåŠ¡å±‚å’Œç‹¬ç«‹çš„æ–¹æ³•ä¸­éƒ½å¯ä»¥è®¾ç½®è®¿é—®æ§åˆ¶è¡¨(ACL) å’Œé™åˆ¶é€Ÿç‡ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨æˆ‘ä»¬çš„åˆ†å¸ƒå¼é…ç½®ç³»ç»Ÿï¼ˆAFSï¼‰è¿›è¡Œæ›´æ–°ã€‚è¿™æ ·å°±ç®—æœåŠ¡ç®¡ç†è€…ä¸é‡å¯è¿›ç¨‹ï¼Œä¹Ÿèƒ½åœ¨å‡ ç§’ä¹‹å†…å®Œæˆåˆ†æµã€‚è®¢é˜…é€šçŸ¥å’Œæ›´æ–°é…ç½®ç”± Courier æ¡†æ¶å®Œæˆã€‚

> æœåŠ¡ â€œèº«ä»½â€ æ˜¯ç”¨äº ACLã€é€Ÿç‡é™åˆ¶ã€ç»Ÿè®¡ç­‰çš„å…¨å±€æ ‡è¯†ç¬¦ã€‚å¦å¤–ï¼Œå®ƒä¹Ÿæ˜¯åŠ å¯†å®‰å…¨çš„ã€‚

æˆ‘ä»¬çš„[å…‰å­¦å­—ç¬¦è¯†åˆ«ï¼ˆOCRï¼‰](https://blogs.dropbox.com/tech/2018/10/using-machine-learning-to-index-text-from-billions-of-images/)æœåŠ¡ä¸­æœ‰è¿™æ ·ä¸€ä¸ª Courier ACL/é€Ÿç‡é™åˆ¶é…ç½®å®šä¹‰çš„ä¾‹å­ï¼š

```
limits:
  dropbox_engine_ocr:
    # æ‰€æœ‰çš„ RPC æ–¹æ³•ã€‚
    default:
      max_concurrency: 32
      queue_timeout_ms: 1000

      rate_acls:
        # OCR å®¢æˆ·ç«¯æ— é™åˆ¶ã€‚
        ocr: -1
        # æ²¡æœ‰å…¶ä»–äººä¸æˆ‘ä»¬é€šä¿¡ã€‚
        authenticated: 0
        unauthenticated: 0
```

![](https://dropboxtechblog.files.wordpress.com/2019/01/02-screenshot2018-12-0317.31.03.png?w=650&h=358)

> æˆ‘ä»¬åœ¨è€ƒè™‘ä½¿ç”¨[æ¯ä¸ªäººéƒ½è¯¥ç”¨çš„å®‰å…¨ç”Ÿäº§æ ‡è¯†æ¡†æ¶](https://spiffe.io/) (SPIFFE)ä¸­çš„ SPIFFE å¯éªŒè¯æ ‡è¯†è¯ä»¶ã€‚è¿™å°†ä½¿æˆ‘ä»¬çš„ RPC æ¡†æ¶ä¸ä¼—å¤šå¼€æºé¡¹ç›®å…¼å®¹ã€‚

### å¯è§‚å¯Ÿæ€§ï¼šç»Ÿè®¡å’Œè¿½è¸ª

æœ‰äº†æ ‡è¯†ï¼Œæˆ‘ä»¬å¾ˆå®¹æ˜“å°±èƒ½å®šä½åˆ°å¯¹åº” Courier æœåŠ¡çš„æ ‡å‡†æ—¥å¿—ã€ç»Ÿè®¡ã€è®°å½•ç­‰æœ‰ç”¨çš„ä¿¡æ¯ã€‚

![](https://dropboxtechblog.files.wordpress.com/2019/01/03-screenshot2018-12-0518.03.17.png?w=650&h=249)

æˆ‘ä»¬çš„ä»£ç ç”Ÿæˆç»™å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯çš„æ¯ä¸ªæœåŠ¡å’Œæ–¹æ³•éƒ½æ·»åŠ äº†ç»Ÿè®¡ã€‚æœåŠ¡ç«¯çš„ç»Ÿè®¡æ•°æ®æŒ‰å®¢æˆ·ç«¯çš„æ ‡è¯†ç¬¦åˆ†ç±»ã€‚æ¯ä¸ª Courier æœåŠ¡çš„è´Ÿè½½ã€é”™è¯¯å’Œå»¶è¿Ÿéƒ½è¿›è¡Œäº†ç»†ç²’åº¦çš„å½’å› ï¼Œç”±æ­¤å®ç°äº†å¼€ç®±å³ç”¨ã€‚

![](https://dropboxtechblog.files.wordpress.com/2019/01/gw1uztwk.png?w=650&h=379)

Courier çš„ç»Ÿè®¡åŒ…æ‹¬å®¢æˆ·ç«¯çš„å¯ç”¨æ€§ã€å»¶è¿Ÿå’ŒæœåŠ¡ç«¯è¯·æ±‚ç‡å’Œé˜Ÿåˆ—å¤§å°ã€‚è¿˜æœ‰å„è¯·æ±‚å»¶è¿Ÿç›´æ–¹å›¾ã€å„å®¢æˆ·ç«¯ TLS æ¡æ‰‹ç­‰å„ç§åˆ†ç±»ã€‚

> æ‹¥æœ‰è‡ªå·±çš„ä»£ç ç”Ÿæˆçš„ä¸€ä¸ªå¥½å¤„æ˜¯æˆ‘ä»¬å¯ä»¥é™æ€åœ°åˆå§‹åŒ–è¿™äº›æ•°æ®ç»“æ„ï¼ŒåŒ…æ‹¬ç›´æ–¹å›¾å’Œè¿½è¸ªèŒƒå›´ã€‚è¿™å‡å°äº†æ€§èƒ½çš„å½±å“ã€‚

![](https://dropboxtechblog.files.wordpress.com/2019/01/05-screenshot2018-12-0516.44.06.png?w=650&h=271)

æˆ‘ä»¬ä¼ ç»Ÿçš„ RPC åœ¨ API è¾¹ç•Œåªä¼ é€ `request_id`ï¼Œå› æ­¤å¯ä»¥ä»ä¸åŒçš„æœåŠ¡ä¸­åŠ å…¥æ—¥å¿—ã€‚åœ¨ Courier ä¸­ï¼Œæˆ‘ä»¬é‡‡ç”¨äº†åŸºäº [OpenTracing](https://opentracing.io/) è§„èŒƒçš„ä¸€ä¸ªå­é›†çš„ APIã€‚åœ¨å®¢æˆ·ç«¯ï¼Œæˆ‘ä»¬ç¼–å†™äº†è‡ªå·±çš„åº“ï¼›åœ¨æœåŠ¡ç«¯ï¼Œæˆ‘ä»¬åŸºäº Cassandra å’Œ [Jaeger](https://github.com/jaegertracing/jaeger) è¿›è¡Œå¼€å‘ã€‚å…³äºå¦‚ä½•ä¼˜åŒ–è¿™ä¸ªè¿½è¸ªç³»ç»Ÿçš„æ€§èƒ½ï¼Œæˆ‘ä»¬æœ‰å¿…è¦ç”¨ä¸€ç‰‡ä¸“é—¨çš„æ–‡ç« æ¥è®²è§£ã€‚

![](https://dropboxtechblog.files.wordpress.com/2019/01/06-screenshot2018-12-0516.35.14.png?w=650&h=352)

è¿½è¸ªè®©æˆ‘ä»¬å¯ä»¥ç”Ÿæˆä¸€ä¸ªè¿è¡Œæ—¶æœåŠ¡çš„ä¾èµ–å›¾ï¼Œç”¨äºå¸®åŠ©å·¥ç¨‹å¸ˆç†è§£ä¸€ä¸ªæœåŠ¡æ‰€æœ‰çš„ä¼ é€’ä¾èµ–ï¼Œä¹Ÿå¯ä»¥åœ¨å®Œæˆéƒ¨ç½²åç”¨äºæ£€æŸ¥å’Œé¿å…ä¸å¿…è¦çš„ä¾èµ–ã€‚

### å¯é æ€§ï¼šæˆªæ­¢æœŸé™å’Œæ–­è·¯é™åˆ¶

Courier é›†ä¸­ç®¡ç†æ‰€æœ‰çš„å®¢æˆ·ç«¯çš„åŸºäºç‰¹å®šè¯­è¨€å®ç°çš„åŠŸèƒ½ï¼Œä¾‹å¦‚è¶…æ—¶ã€‚éšç€æ—¶é—´çš„æ¨ç§»ï¼Œæˆ‘ä»¬è¿˜åœ¨è¿™ä¸€å±‚åŠ å…¥äº†åƒæ£€è§†çš„ä»»åŠ¡é¡¹ä¹‹ç±»çš„åŠŸèƒ½ã€‚

**æˆªæ­¢æœŸé™**

æ¯ä¸ª [gRPC](https://grpc.io/blog/deadlines) [è¯·æ±‚éƒ½åŒ…å«ä¸€ä¸ª](https://grpc.io/blog/deadlines) [æˆªæ­¢æœŸé™](https://grpc.io/blog/deadlines)ï¼Œ ç”¨æ¥è¡¨ç¤ºå®¢æˆ·ç«¯ç­‰å¾…å›å¤çš„æ—¶é•¿ã€‚ ç”±äº Courier è‡ªåŠ¨ä¼ é€å…¨éƒ¨å·²çŸ¥çš„å…ƒæ•°æ®ï¼Œæˆªæ­¢æœŸé™ä¼šä¸€åªå­˜åœ¨äºè¯·æ±‚ä¸­ï¼Œç”šè‡³è·¨è¶Š API è¾¹ç•Œã€‚åœ¨è¿›ç¨‹ä¸­ï¼Œæˆªæ­¢æœŸé™è¢«è½¬æ¢æˆäº†ç‰¹å®šçš„è¡¨ç¤ºã€‚ä¾‹å¦‚åœ¨ Go ä¸­ä¼šä½¿ç”¨ `WithDeadline` æ–¹æ³•çš„è¿”å›ç»“æ„ `context.Context` è¿›è¡Œè¡¨ç¤ºã€‚

åœ¨å®è·µè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬è¦æ±‚å·¥ç¨‹å¸ˆä»¬åœ¨æœåŠ¡çš„å®šä¹‰ä¸­åˆ¶å®šæˆªæ­¢æœŸé™ï¼Œä»è€Œä½¿æ‰€æœ‰çš„ç±»éƒ½æ˜¯å¯é çš„ã€‚

> è¿™ä¸ªä¸Šä¸‹æ–‡ç”šè‡³å¯ä»¥è¢«ä¼ é€åˆ° RPC å±‚ä¹‹å¤–ï¼ä¾‹å¦‚ï¼Œæˆ‘ä»¬ä¼ ç»Ÿçš„ MySQL ORM å°† RPC çš„ä¸Šä¸‹æ–‡å’Œæˆªæ­¢æœŸé™åºåˆ—åŒ–ï¼Œæ”¾å…¥ SQL æŸ¥è¯¢çš„æ³¨é‡Šä¸­ï¼Œæˆ‘ä»¬çš„ SQLProxy å°±å¯ä»¥è§£æè¿™äº›è¯„è®ºï¼Œå¹¶åœ¨è¶…è¿‡æˆªæ­¢æœŸé™å `æ€æ­»` è¿™äº›æŸ¥è¯¢ ã€‚é™„å¸¦çš„å¥½å¤„æ˜¯æˆ‘ä»¬åœ¨è°ƒè¯•æ•°æ®åº“æŸ¥è¯¢çš„æ—¶å€™èƒ½å¤Ÿæ‰¾åˆ°æ¯ä¸ªè¯·æ±‚çš„åŸå› ã€‚

**æ–­è·¯é™åˆ¶**

å¦ä¸€ä¸ªå¸¸è§çš„é—®é¢˜æ˜¯ä¼ ç»Ÿçš„ RPC å®¢æˆ·ç«¯éœ€è¦åœ¨é‡è¯•æ—¶å®ç°è‡ªå®šä¹‰æŒ‡æ•°è¡¥å¿å’ŒæŠ–åŠ¨ã€‚

åœ¨ Courier ä¸­ï¼Œæˆ‘ä»¬å¸Œæœ›ç”¨ä¸€ç§æ›´é€šç”¨çš„æ–¹æ³•è§£å†³æ–­è·¯é™åˆ¶çš„é—®é¢˜ï¼Œäºæ˜¯åœ¨ç›‘å¬å™¨å’Œå·¥ä½œæ± ä¹‹é—´é‡‡ç”¨äº†ä¸€ä¸ª LIFO é˜Ÿåˆ—ã€‚

![](https://dropboxtechblog.files.wordpress.com/2019/01/07-screenshot2018-12-0521.54.58.png?w=650&h=342)

åœ¨æœåŠ¡è¿‡è½½çš„æ—¶å€™ï¼Œè¿™ä¸ª LIFO é˜Ÿåˆ—å°±ä¼šåƒä¸€ä¸ªè‡ªåŠ¨æ–­è·¯å™¨ä¸€æ ·å·¥ä½œã€‚è¿™ä¸ªé˜Ÿåˆ—ä¸ä»…æœ‰å¤§å°çš„é™åˆ¶ï¼Œè¿˜æœ‰æ›´ä¸¥æ ¼çš„**æ—¶é—´é™åˆ¶**ã€‚ä¸€ä¸ªè¯·æ±‚åªèƒ½åœ¨è¯¥é˜Ÿåˆ—ä¸­å­˜åœ¨æŒ‡å®šçš„æ—¶é—´ã€‚

> LIFO åœ¨å¯¹è¯·æ±‚æ’åºæ—¶æœ‰ç¼ºé™·ã€‚å¦‚æœæƒ³ç»´æŒé¡ºåºï¼Œä½ å¯ä»¥è¯•è¯• [CoDel](https://queue.acm.org/detail.cfm?id=2209336)ã€‚å®ƒä¹Ÿæœ‰æ–­è·¯é™åˆ¶çš„åŠŸèƒ½ï¼Œä¸”ä¸ä¼šæ‰“ä¹±è¯·æ±‚çš„é¡ºåº

![](https://dropboxtechblog.files.wordpress.com/2019/01/08-screenshot2018-12-0521.54.48.png?w=650&h=342)

### è‡ªçœï¼šè°ƒè¯•ç«¯ç‚¹

è°ƒè¯•ç«¯ç‚¹å°½ç®¡ä¸æ˜¯ Courier æœ¬èº«çš„ä¸€éƒ¨åˆ†ï¼Œä½†åœ¨ Dropbox ä¸­å¾—åˆ°äº†å¹¿æ³›çš„ä½¿ç”¨ã€‚å®ƒä»¬å¤ªæœ‰ç”¨äº†ï¼Œæˆ‘ä¸èƒ½ä¸æï¼è¿™é‡Œæœ‰äº›æœ‰ç”¨çš„è‡ªçœçš„ä¾‹å­ã€‚

> ä¸ºäº†å®‰å…¨è€ƒè™‘ï¼Œä½ å¯èƒ½æƒ³å°†è¿™äº›æš´éœ²åˆ°ä¸€ä¸ªå•ç‹¬çš„ç«¯å£ï¼ˆä¹Ÿè®¸åªæ˜¯ä¸€ä¸ªå›ç¯æ¥å£ï¼‰ç”šè‡³æ˜¯ä¸€ä¸ª Unix å¥—æ¥å­—ï¼ˆå¯ä»¥ç”¨ Unix æ–‡ä»¶ç³»ç»Ÿè¿›è¡Œæ§åˆ¶ã€‚ï¼‰ä½ ä¹Ÿä¸€å®šè¦è€ƒè™‘ä½¿ç”¨åŒå‘ TLS éªŒè¯ï¼Œè¦æ±‚å¼€å‘è€…åœ¨è®¿é—®è°ƒè¯•ç«¯ç‚¹æ—¶æä¾›ä»–ä»¬çš„è¯ä¹¦ï¼ˆç‰¹åˆ«æ˜¯éåªè¯»çš„é‚£äº›ã€‚ï¼‰

**è¿è¡Œæ—¶**

èƒ½åœ¨çœ‹åˆ°è¿è¡Œæ—¶çš„çŠ¶æ€æ˜¯éå¸¸æœ‰ç”¨çš„ã€‚ä¾‹å¦‚ [å †å’Œ CPU æ–‡ä»¶å¯ä»¥æš´éœ²ä¸º HTTP æˆ– gRPC ç«¯ç‚¹](https://golang.org/pkg/net/http/pprof/).

> æˆ‘ä»¬æ‰“ç®—åœ¨ç°åº¦éªŒè¯çš„é˜¶æ®µç”¨è¿™ä¸ªæ–¹æ³•è‡ªåŠ¨åŒ–æ–°æ—§ç‰ˆæœ¬ä»£ç é—´çš„å¯¹æ¯”ã€‚

è¿™äº›è°ƒè¯•ç«¯ç‚¹å…è®¸åœ¨ä¿®æ”¹è¿è¡Œæ—¶çš„çŠ¶æ€ï¼Œä¾‹å¦‚ï¼Œä¸€ä¸ªç”¨ golang å¼€å‘çš„æœåŠ¡å¯ä»¥åŠ¨æ€è®¾ç½® [GCPercent](https://golang.org/pkg/runtime/debug/#SetGCPercent) ã€‚

**åº“**

åŠ¨æ€å¯¼å‡ºæŸäº›ç‰¹å®šåº“çš„æ•°æ®ä½œä¸º RPC ç«¯ç‚¹å¯¹äºåº“çš„ä½œè€…æ¥è¯´å¾ˆæœ‰ç”¨ã€‚[malloc åº“è½¬å‚¨å†…éƒ¨çŠ¶æ€](http://jemalloc.net/jemalloc.3.html#malloc_stats_print_opts)å°±æ˜¯ä¸ªå¾ˆå¥½çš„ä¾‹å­ã€‚

**RPC**  
è€ƒè™‘åˆ°å¯¹åŠ å¯†çš„å’ŒäºŒè¿›åˆ¶ç¼–ç çš„åè®®è¿›è¡Œæ•…éšœè¯Šæ–­æœ‰ç‚¹å¤æ‚ï¼Œå› æ­¤åº”è¯¥åœ¨æ€§èƒ½å…è®¸çš„æƒ…å†µä¸‹å‘ RPC å±‚åŠ å…¥å°½å¯èƒ½å¤šçš„å·¥å…·ã€‚æœ€è¿‘æœ‰ä¸ªè¿™æ ·çš„è‡ªçœ API çš„ä¾‹å­ï¼Œå°±æ˜¯[gRPC çš„ channelz ææ¡ˆ](https://github.com/grpc/proposal/blob/master/A14-channelz.md)ã€‚

**åº”ç”¨**

æŸ¥çœ‹ API çº§åˆ«çš„å‚æ•°ä¹Ÿå¾ˆæœ‰ç”¨ã€‚å°†æ„å»º/åŸåœ°å€æ•£åˆ—ã€å‘½ä»¤è¡Œç­‰ç”¨äºé€šç”¨åº”ç”¨ä¿¡æ¯ç«¯ç‚¹å°±æ˜¯å¾ˆå¥½çš„ä¾‹å­ã€‚ç¼–æ’ç³»ç»Ÿå¯ä»¥é€šè¿‡è¿™äº›ä¿¡æ¯éªŒè¯æœåŠ¡éƒ¨ç½²çš„ä¸€è‡´æ€§ã€‚

## æ€§èƒ½ä¼˜åŒ–

åœ¨æ‰©å±• Dropbox çš„ gRPC è§„æ¨¡çš„æ—¶å€™ï¼Œæˆ‘ä»¬å‘ç°äº†å¾ˆå¤šæ€§èƒ½ç“¶é¢ˆã€‚

### TLS æ¡æ‰‹å¼€é”€

ç”±äºæœåŠ¡è¦å¤„ç†å¤§é‡çš„è¿æ¥ï¼Œç´¯ç§¯èµ·æ¥çš„ TLS æ¡æ‰‹å¼€é”€æ˜¯ä¸å¯å¿½è§†çš„ã€‚åœ¨å¤§è§„æ¨¡æœåŠ¡é‡å¯æ—¶è¿™ä¸€ç‚¹å°¤å…¶çªå‡ºã€‚

ä¸ºäº†æå‡ç­¾çº¦æ“ä½œçš„æ€§èƒ½ï¼Œæˆ‘ä»¬å°† RSA 2048 å¯†é’¥å¯¹æ¢æˆäº† ECDSA P-256ã€‚ä¸‹é¢æ˜¯ BoringSSL æ€§èƒ½çš„ä¾‹å­ï¼ˆå°½ç®¡ RSA æ¯”ç­¾åéªŒè¯è¿˜æ˜¯è¦å¿«ä¸€äº›ï¼‰ï¼š

RSA:

```
ğ›Œ ~/c0d3/boringssl bazel run -- //:bssl speed -filter 'RSA 2048'
Did ... RSA 2048 signing operations in ..............  (1527.9 ops/sec)
Did ... RSA 2048 verify (same key) operations in .... (37066.4 ops/sec)
Did ... RSA 2048 verify (fresh key) operations in ... (25887.6 ops/sec)
```

ECDSA:

```
ğ›Œ ~/c0d3/boringssl bazel run -- //:bssl speed -filter 'ECDSA P-256'
Did ... ECDSA P-256 signing operations in ... (40410.9 ops/sec)
Did ... ECDSA P-256 verify operations in .... (17037.5 ops/sec)
```

> ä»æ€§èƒ½ä¸Šè¯´ï¼ŒRSA 2048 éªŒè¯æ¯” ECDSA P-256 å¤§çº¦å¿«äº† 3 å€ï¼Œå› æ­¤ä½ å¯ä»¥è€ƒè™‘ç”¨ RSA ä½œä¸ºæ ¹/å¶çš„è¯ä¹¦ã€‚ä½†æ˜¯ä»å®‰å…¨æ–¹é¢è€ƒè™‘ï¼Œåˆ‡æ¢å®‰å…¨åŸè¯­å¯èƒ½æœ‰äº›å›°éš¾ï¼Œå†µä¸”è¿™æ ·ä¼šå¸¦æ¥æœ€å°çš„å®‰å…¨å±æ€§ã€‚
> åŒæ ·è€ƒè™‘æ€§èƒ½å› ç´ ï¼Œä½ åœ¨ä½¿ç”¨ RSA 4096ï¼ˆæˆ–æ›´é«˜ï¼‰è¯ä¹¦ä¹‹å‰åº”è¯¥ä¸‰æ€ã€‚

æˆ‘ä»¬è¿˜å‘ç° TLS åº“ï¼ˆä»¥åŠç¼–è¯‘æ ‡è¯†ï¼‰åœ¨æ€§èƒ½å’Œå®‰å…¨æ–¹é¢æœ‰å¾ˆå¤§çš„å½±å“ã€‚ä¾‹å¦‚ï¼Œä¸‹é¢æ¯”è¾ƒäº†ç›¸åŒç¡¬ä»¶ç¯å¢ƒä¸‹ MacOS X Mojave çš„ LibreSSL æ„å»ºå’Œ homebrewed OpenSSLï¼š

LibreSSL 2.6.4:

```
ğ›Œ ~ openssl speed rsa2048
LibreSSL 2.6.4
...
                  sign    verify    sign/s verify/s
rsa 2048 bits 0.032491s 0.001505s     30.8    664.3
```

OpenSSL 1.1.1a:

```
ğ›Œ ~ openssl speed rsa2048
OpenSSL 1.1.1a  20 Nov 2018
...
                  sign    verify    sign/s verify/s
rsa 2048 bits 0.000992s 0.000029s   1208.0  34454.8
```

ä½†æ˜¯æœ€å¿«çš„æ–¹æ³•å°±æ˜¯ä¸ä½¿ç”¨ TLS æ¡æ‰‹ï¼ä¸ºäº†æ”¯æŒä¼šè¯æ¢å¤ï¼Œ[æˆ‘ä»¬ä¿®æ”¹äº† gRPC-core å’Œ gRPC-python](https://github.com/grpc/grpc/issues/14425)ï¼Œé™ä½äº†æœåŠ¡å¯åŠ¨æ—¶çš„ CPU å ç”¨ã€‚

### åŠ å¯†å¼€é”€å¹¶ä¸é«˜

äººä»¬æœ‰ä¸ªæ™®éçš„è¯¯è§£ï¼Œè®¤ä¸ºåŠ å¯†å¼€é”€å¾ˆé«˜ã€‚äº‹å®ä¸Šï¼Œå¯¹ç§°åŠ å¯†åœ¨ç°ä»£ç¡¬ä»¶ä¸Šç›¸å½“å¿«ã€‚æ¡Œé¢çº§çš„å¤„ç†å™¨ä½¿ç”¨å•æ ¸å°±èƒ½ä»¥ 40Gbps çš„é€Ÿç‡è¿›è¡ŒåŠ å¯†å’ŒéªŒè¯ã€‚

```
ğ›Œ ~/c0d3/boringssl bazel run -- //:bssl speed -filter 'AES'
Did ... AES-128-GCM (8192 bytes) seal operations in ... 4534.4 MB/s
```

å°½ç®¡å¦‚æ­¤ï¼Œæˆ‘ä»¬æœ€ç»ˆè¿˜æ˜¯è¦ä½¿ gRPC é€‚é…æˆ‘ä»¬çš„ [50Gb/s å‚¨å­˜ç®±](https://blogs.dropbox.com/tech/2018/06/extending-magic-pocket-innovation-with-the-first-petabyte-scale-smr-drive-deployment/)ã€‚æˆ‘ä»¬äº†è§£åˆ°ï¼Œå½“åŠ å¯†é€Ÿåº¦å¯ä»¥å’Œå†…å­˜æ‹·è´é€Ÿåº¦ç›¸æå¹¶è®ºçš„æ—¶å€™ï¼Œé™ä½ `memcpy` æ“ä½œçš„æ¬¡æ•°è‡³å…³é‡è¦ã€‚æ­¤å¤–ï¼Œæˆ‘ä»¬[å¯¹ gRPC æœ¬èº«ä¹Ÿåšäº†ä¿®æ”¹](https://github.com/grpc/grpc/issues/14058)

> éªŒè¯å’ŒåŠ å¯†åè®®æœ‰ä¸€äº›å¾ˆæ£˜æ‰‹çš„é—®é¢˜ã€‚ä¾‹å¦‚ï¼Œå¤„ç†å™¨ã€DMA å’Œ ç½‘ç»œæ•°æ®æŸåã€‚å³ä¾¿ä½ ä¸ç”¨ gRPCï¼Œä½¿ç”¨ TLS è¿›è¡Œå†…éƒ¨é€šä¿¡ä¹Ÿæ˜¯ä¸ªå¥½ä¸»æ„ã€‚

### é«˜æ—¶å»¶å¸¦å®½ç§¯é“¾æ¥

Dropbox æ‹¥æœ‰ [å¤§é‡é€šè¿‡éª¨å¹²ç½‘ç»œè¿æ¥çš„æ•°æ®ä¸­å¿ƒ](https://blogs.dropbox.com/tech/2017/09/infrastructure-update-evolution-of-the-dropbox-backbone-network/)ã€‚æœ‰æ—¶å€™ä¸åŒåŒºåŸŸçš„èŠ‚ç‚¹å¯èƒ½éœ€è¦ä½¿ç”¨ RPC è¿›è¡Œé€šä¿¡ï¼Œä¾‹å¦‚ä¸ºäº†å¤åˆ¶ã€‚ ä½¿ç”¨ TCP çš„å†…æ ¸æ˜¯ä¸ºäº†é™åˆ¶æŒ‡å®šè¿æ¥ï¼ˆé™åˆ¶åœ¨ `/proc/sys/net/ipv4/tcp_{r,w}mem`ï¼‰çš„ä¼ è¾“ä¸­æ•°æ®çš„æ•°é‡ã€‚ç”±äº gRPC æ˜¯åŸºäº HTTP/2 çš„ï¼Œåœ¨ TCP ä¹‹ä¸Šè¿˜æœ‰å…¶ç‰¹æœ‰çš„æµæ§åˆ¶ã€‚[BDP çš„ä¸Šé™ç¡¬ç¼–ç äº](https://github.com/grpc/grpc-go/issues/2400) [grpc-go ä¸º 16Mb](https://github.com/grpc/grpc-go/issues/2400)ï¼Œè¿™å¯èƒ½ä¼šæˆä¸ºå•ä¸€çš„é«˜ BDP è¿æ¥çš„ç“¶é¢ˆã€‚

### Golang çš„ net.Server å’Œ grpc.Server å¯¹æ¯”

åœ¨æˆ‘ä»¬çš„ Go ä»£ç ä¸­ï¼Œæˆ‘ä»¬èµ·åˆæ”¯æŒ HTTP/1.1 å’Œ gRPC ä½¿ç”¨ç›¸åŒçš„ [net.Server](https://golang.org/pkg/net/http/#Server)ã€‚ è¿™ä»é€»è¾‘ä¸Šè®²å¾—é€šï¼Œä½†æ˜¯åœ¨æ€§èƒ½ä¸Šè¡¨ç°ä¸ä½³ã€‚ å°† HTTP/1.1 å’Œ gRPC æ‹†åˆ†åˆ°ä¸åŒçš„è·¯å¾„ã€ç”¨ä¸åŒçš„æœåŠ¡å™¨ç®¡ç†å¹¶ä¸”å°† gRPC æ¢æˆ [grpc.Server](https://godoc.org/google.golang.org/grpc#Server) å¤§å¤§æ”¹è¿›äº† Courier æœåŠ¡çš„ååé‡å’Œå†…å­˜å ç”¨ã€‚

### golang/protobuf å’Œ gogo/protobuf å¯¹æ¯”

å¦‚æœä½ ä½¿ç”¨ gRPC çš„è¯ï¼Œç¼–ç»„å’Œè§£ç»„å¼€é”€ä¼šå¾ˆå¤§ã€‚å¯¹äºæˆ‘ä»¬çš„ Go ä»£ç ï¼Œ æˆ‘ä»¬ä½¿ç”¨äº† [gogo/protobuf](https://github.com/gogo/protobuf)ï¼Œå®ƒæ˜¾è‘—é™ä½äº†å¯¹æˆ‘ä»¬æœ€å¿™ç¢Œçš„ Courier æœåŠ¡å™¨çš„ CPU ä½¿ç”¨ã€‚

> åŒæ ·çš„ï¼Œ[ä½¿ç”¨ gogo/protobuf ä¹Ÿæœ‰ä¸€äº›æ³¨æ„äº‹é¡¹](https://jbrandhorst.com/post/gogoproto/)ï¼Œä½†åšæŒä½¿ç”¨ä¸€ä¸ªæ­£å¸¸çš„åŠŸèƒ½å­é›†çš„è¯åº”è¯¥æ²¡é—®é¢˜ã€‚

## å®ç°ç»†èŠ‚

ä»è¿™é‡Œå¼€å§‹ï¼Œæˆ‘ä»¬å°†ä¼šæ·±æŒ– Courier çš„å†…éƒ¨ï¼Œçœ‹çœ‹ä¸åŒè¯­è¨€ä¸‹çš„ protobuf æ¨¡å¼å’Œå­˜æ ¹çš„ä¾‹å­ã€‚ä¸‹é¢æ‰€æœ‰çš„ä¾‹å­éƒ½ä¼šç”¨æˆ‘ä»¬çš„ `Test` æœåŠ¡ï¼ˆæˆ‘ä»¬åœ¨ Courier ä¸­ç”¨è¿™ä¸ªè¿›è¡Œé›†æˆæµ‹è¯•ï¼‰

### æœåŠ¡æè¿°

```
service Test {
    option (rpc_core.service_default_deadline_ms) = 1000;

    rpc UnaryUnary(TestRequest) returns (TestResponse) {
        option (rpc_core.method_default_deadline_ms) = 5000;
    }

    rpc UnaryStream(TestRequest) returns (stream TestResponse) {
        option (rpc_core.method_no_deadline) = true;
    }
    ...
}
```

åœ¨å¯ç”¨æ€§ç« èŠ‚ï¼Œæˆ‘ä»¬æåˆ°äº†æ‰€æœ‰çš„ Courier æ–¹æ³•éƒ½å¿…é¡»æ‹¥æœ‰æˆªæ­¢æœŸé™ã€‚é€šè¿‡ä¸‹é¢çš„ protobuf é€‰é¡¹å¯ä»¥å¯¹æ•´ä¸ªæœåŠ¡è¿›è¡Œè®¾ç½®ã€‚

```
option (rpc_core.service_default_deadline_ms) = 1000;
```

ä¹Ÿå¯ä»¥å¯¹æ¯ä¸ªæ–¹æ³•å•ç‹¬è®¾ç½®æˆªæ­¢æœŸé™ï¼Œå¹¶è¦†ç›–æœåŠ¡èŒƒå›´çš„è®¾ç½®ï¼ˆå¦‚æœå­˜åœ¨çš„è¯ï¼‰ã€‚

```
option (rpc_core.method_default_deadline_ms) = 5000;
```

åœ¨æå°‘æƒ…å†µä¸‹ï¼Œæˆªæ­¢æœŸé™ç¡®å®æ²¡ç”¨ï¼ˆä¾‹å¦‚ç›‘è§†èµ„æºçš„æ–¹æ³•ï¼‰ï¼Œè¿™æ—¶ä¾¿å…è®¸å¼€å‘è€…æ˜¾å¼ç¦ç”¨å®ƒï¼š

```
option (rpc_core.method_no_deadline) = true;
```

çœŸæ­£çš„æœåŠ¡å®šä¹‰å°†ä¼šæœ‰è¯¦ç»†çš„ API æ–‡æ¡£ï¼Œç”šè‡³ä¼šæœ‰ä½¿ç”¨çš„ä¾‹å­ã€‚

### å­˜æ ¹ç”Ÿæˆ

Courier ä¸ä¾èµ–æ‹¦æˆªå™¨ï¼ˆJava é™¤å¤–ï¼Œå®ƒçš„æ‹¦æˆªå™¨ API å·²ç»è¶³å¤Ÿå¼ºå¤§äº†ï¼‰ï¼Œå®ƒä¼šç”Ÿæˆç‰¹æœ‰çš„å­˜æ ¹ï¼Œè¿™è®©æˆ‘ä»¬ç”¨èµ·æ¥å¾ˆçµæ´»ã€‚æˆ‘ä»¬æ¥æ¯”è¾ƒä¸‹ä¸‹æˆ‘ä»¬çš„å­˜æ ¹å’Œ Golang é»˜è®¤çš„å­˜æ ¹ã€‚

è¿™æ˜¯é»˜è®¤çš„ gRPC æœåŠ¡å™¨å­˜æ ¹ï¼š

```
func _Test_UnaryUnary_Handler(srv interface{}, ctx context.Context, dec func(interface{}) error, interceptor grpc.UnaryServerInterceptor) (interface{}, error) {
        in := new(TestRequest)
        if err := dec(in); err != nil {
                return nil, err
        }
        if interceptor == nil {
                return srv.(TestServer).UnaryUnary(ctx, in)
        }
        info := &grpc.UnaryServerInfo{
                Server:     srv,
                FullMethod: "/test.Test/UnaryUnary",
        }
        handler := func(ctx context.Context, req interface{}) (interface{}, error) {
                return srv.(TestServer).UnaryUnary(ctx, req.(*TestRequest))
        }
        return interceptor(ctx, in, info, handler)
}
```

è¿™é‡Œæ‰€æœ‰çš„å¤„ç†è¿‡ç¨‹éƒ½åœ¨ä¸€è¡Œå†…å®Œæˆï¼šè§£ç  protobufã€è¿è¡Œæ‹¦æˆªå™¨ã€è°ƒç”¨ `UnaryUnary` å¤„ç†å™¨ã€‚

æˆ‘ä»¬å†çœ‹çœ‹ Courier çš„å­˜æ ¹ï¼š

```
func _Test_UnaryUnary_dbxHandler(
        srv interface{},
        ctx context.Context,
        dec func(interface{}) error,
        interceptor grpc.UnaryServerInterceptor) (
        interface{},
        error) {

        defer processor.PanicHandler()

        impl := srv.(*dbxTestServerImpl)
        metadata := impl.testUnaryUnaryMetadata

        ctx = metadata.SetupContext(ctx)
        clientId = client_info.ClientId(ctx)
        stats := metadata.StatsMap.GetOrCreatePerClientStats(clientId)
        stats.TotalCount.Inc()

        req := &processor.UnaryUnaryRequest{
                Srv:            srv,
                Ctx:            ctx,
                Dec:            dec,
                Interceptor:    interceptor,
                RpcStats:       stats,
                Metadata:       metadata,
                FullMethodPath: "/test.Test/UnaryUnary",
                Req:            &test.TestRequest{},
                Handler:        impl._UnaryUnary_internalHandler,
                ClientId:       clientId,
                EnqueueTime:    time.Now(),
        }

        metadata.WorkPool.Process(req).Wait()
        return req.Resp, req.Err
}
```

è¿™é‡Œä»£ç æœ‰ç‚¹å¤šï¼Œæˆ‘ä»¬ä¸€è¡Œä¸€è¡Œæ¥çœ‹ã€‚

é¦–å…ˆï¼Œæˆ‘ä»¬æ¨è¿Ÿç”¨äºé”™è¯¯æ”¶é›†çš„åº”æ€¥å¤„ç†å™¨ã€‚è¿™æ ·å°±å¯ä»¥å°†æœªæ•è·çš„å¼‚å¸¸å‘é€åˆ°é›†ä¸­çš„ä½ç½®ï¼Œç”¨äºåé¢çš„èšåˆå’ŒæŠ¥å‘Šï¼š

```
defer processor.PanicHandler()
```

> è®¾ç½®è‡ªå®šä¹‰åº”æ€¥å¤„ç†å™¨çš„å¦ä¸€ä¸ªåŸå› æ˜¯ä¸ºäº†ä¿è¯æˆ‘ä»¬åœ¨å‡ºé”™æ—¶ç»ˆæ­¢åº”ç”¨ã€‚é»˜è®¤ golang/net HTTP å¤„ç†å™¨çš„è¡Œä¸ºæ˜¯å¿½ç•¥è¿™äº›é”™è¯¯å¹¶ç»§ç»­å¤„ç†æ–°çš„è¯·æ±‚ï¼ˆè¿™æœ‰å´©æºƒå’ŒçŠ¶æ€ä¸ä¸€è‡´çš„é£é™©ï¼‰

ç„¶åæˆ‘ä»¬ä½¿ç”¨è¦†ç›–è¯·æ±‚å…ƒæ•°æ®ä¸­çš„å€¼çš„æ–¹å¼ä¼ é€’ä¸Šä¸‹æ–‡ï¼š

```
ctx = metadata.SetupContext(ctx)
clientId = client_info.ClientId(ctx)
```

æˆ‘ä»¬è¿˜åœ¨æœåŠ¡ç«¯ç»™æ¯ä¸ªå®¢æˆ·ç«¯æ·»åŠ äº†ç»Ÿè®¡ï¼Œç”¨äºæ›´ç»†ç²’åº¦çš„å½’å› ï¼š

```
stats := metadata.StatsMap.GetOrCreatePerClientStats(clientId)
```

> è¿™åœ¨è¿è¡Œæ—¶ç»™æ¯ä¸ªå®¢æˆ·ç«¯ï¼ˆå°±æ˜¯æ¯ä¸ª TLS èº«ä»½ï¼‰åŠ¨æ€æ·»åŠ äº†ç»Ÿè®¡ã€‚æ¯ä¸ªæœåŠ¡çš„æ¯ä¸ªæ–¹æ³•ä¹Ÿä¼šæœ‰ç»Ÿè®¡ï¼Œå¹¶ä¸”ç”±äºå­˜æ ¹ç”Ÿæˆå™¨åœ¨ç”Ÿæˆä»£ç çš„æ—¶å€™æ‹¥æœ‰æ‰€æœ‰æ–¹æ³•çš„æƒé™ï¼Œæˆ‘ä»¬å¯ä»¥é™æ€æ·»åŠ ï¼Œä»¥é¿å…è¿è¡Œæ—¶çš„å¼€é”€ã€‚

ç„¶åæˆ‘ä»¬åˆ›å»ºè¯·æ±‚ç»“æ„ï¼Œå°†å®ƒä¼ å…¥å·¥ä½œæ± ï¼Œç­‰å¾…å®Œæˆã€‚

    req := &processor.UnaryUnaryRequest{
            Srv:            srv,
            Ctx:            ctx,
            Dec:            dec,
            Interceptor:    interceptor,
            RpcStats:       stats,
            Metadata:       metadata,
            ...
    }
    metadata.WorkPool.Process(req).Wait()
    

è¯·æ³¨æ„ï¼Œç°åœ¨æ‰€æœ‰çš„å·¥ä½œéƒ½è¿˜æ²¡å®Œæˆï¼šæ²¡æœ‰è§£ç  protobufï¼Œæ²¡æœ‰æ‰§è¡Œæ‹¦æˆªå™¨ç­‰ç­‰ã€‚åœ¨å·¥ä½œæ± ä¸­ä½¿ç”¨ ACLï¼Œä¼˜å…ˆåŒ–å’Œé€Ÿç‡é™åˆ¶éƒ½åœ¨è¿™äº›ä¹‹å‰å‘ç”Ÿã€‚

> æ³¨æ„ï¼Œ[golang gRPC åº“æ”¯æŒ](https://godoc.org/google.golang.org/grpc/tap)[è¿™ä¸ª](https://godoc.org/google.golang.org/grpc/tap) [Tap æ¥å£](https://godoc.org/google.golang.org/grpc/tap)ï¼Œè¿™ä½¿å¾—åˆæœŸçš„è¯·æ±‚æ‹¦æˆªæˆä¸ºå¯èƒ½ï¼ŒåŒæ—¶ç»™æ„å»ºé«˜æ•ˆä½è€—çš„é€Ÿç‡æ§åˆ¶å™¨æä¾›äº†åŸºç¡€ã€‚

### ç‰¹å®šåº”ç”¨çš„é”™è¯¯ä»£ç 

æˆ‘ä»¬çš„å­˜æ ¹ç”Ÿæˆå™¨å…è®¸å¼€å‘è€…é€šè¿‡è‡ªå®šä¹‰é€‰é¡¹å®šä¹‰ç‰¹å®šåº”ç”¨çš„é”™è¯¯ä»£ç 

```
enum ErrorCode {
  option (rpc_core.rpc_error) = true;

  UNKNOWN = 0;
  NOT_FOUND = 1 [(rpc_core.grpc_code)="NOT_FOUND"];
  ALREADY_EXISTS = 2 [(rpc_core.grpc_code)="ALREADY_EXISTS"];
  ...
  STALE_READ = 7 [(rpc_core.grpc_code)="UNAVAILABLE"];
  SHUTTING_DOWN = 8 [(rpc_core.grpc_code)="CANCELLED"];
}
```

åœ¨åŒä¸€ä¸ªæœåŠ¡ä¸­ï¼Œä¼šä¼ æ’­ gRPC å’Œåº”ç”¨é”™è¯¯ï¼Œä½†æ˜¯æ‰€æœ‰çš„é”™è¯¯åœ¨ API è¾¹ç•Œéƒ½ä¼šè¢«æ›¿æ¢æˆ UNKOWNã€‚è¿™é¿å…äº†ä¸åŒæœåŠ¡ä¹‹é—´çš„æ„å¤–é”™è¯¯ä»£ç†çš„é—®é¢˜ï¼Œä¿®æ”¹äº†è¯­ä¹‰ä¸Šçš„æ„æ€ã€‚

### Python ç‰¹å®šçš„ä¿®æ”¹

æˆ‘ä»¬åœ¨ Python å­˜æ ¹ç»™æ‰€æœ‰çš„ Courier å¤„ç†å™¨ä¸­åŠ å…¥äº†æ˜¾å¼çš„ä¸Šä¸‹æ–‡å‚æ•°ï¼Œä¾‹å¦‚ï¼š

```
from dropbox.context import Context
from dropbox.proto.test.service_pb2 import (
        TestRequest,
        TestResponse,
)
from typing_extensions import Protocol

class TestCourierClient(Protocol):
    def UnaryUnary(
            self,
            ctx,      # ç±»å‹ï¼šContext
            request,  # ç±»å‹ï¼šTestRequest
            ):
        # ç±»å‹ï¼š (...) -> TestResponse
        ...
```

ä¸€å¼€å§‹ï¼Œè¿™çœ‹èµ·æ¥æœ‰äº›å¥‡æ€ªï¼Œä½†æ—¶å€™åæ¥å¼€å‘è€…ä»¬æ¸æ¸ä¹ æƒ¯äº†æ˜¾å¼çš„ `ctx`ï¼Œå°±åƒä»–ä»¬ä¹ æƒ¯ `self` ä¸€æ ·ã€‚

è¯·æ³¨æ„ï¼Œæˆ‘ä»¬çš„å­˜æ ¹ä¹Ÿéƒ½æ˜¯ mypy ç±»å‹çš„ï¼Œè¿™åœ¨å¤§è§„æ¨¡é‡æ„æœŸé—´ä¼šå¾—åˆ°å……åˆ†çš„å›æŠ¥ã€‚

ç»§ç»­é™æ€ç±»å‹çš„è¶‹åŠ¿ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥å°† mypy çš„æ³¨è§£åŠ å…¥åˆ° proto ä¸­ã€‚

```
class TestMessage(Message):
    field: int

    def __init__(self,
        field : Optional[int] = ...,
        ) -> None: ...
    @staticmethod
    def FromString(s: bytes) -> TestMessage: ...
```

è¿™äº›æ³¨è§£é¿å…äº†è®¸å¤šå¸¸è§çš„æ¼æ´ï¼Œæ¯”å¦‚å°† `None` èµ‹å€¼ç»™ Python ä¸­çš„ `string` å­—æ®µã€‚

è¿™äº›ä»£ç åœ¨ [dropbox/mypy-protobuf](https://github.com/dropbox/mypy-protobuf) ä¸­å¼€æºäº†ã€‚

## è¿ç§»è¿‡ç¨‹

ç¼–å†™ä¸€ä¸ªæ–°çš„ RPC æ ˆç»éæ˜“äº‹ï¼Œä½†å°±æ“ä½œçš„å¤æ‚æ€§è€Œè¨€è¿˜æ˜¯ä¸èƒ½å’Œè·¨èŒƒå›´çš„è¿ç§»ç›¸æå¹¶è®ºã€‚ä¸ºäº†ä¿è¯é¡¹ç›®çš„æˆåŠŸï¼Œæˆ‘ä»¬å°è¯•ç®€åŒ–å¼€å‘è€…ä»ä¼ ç»Ÿ RPC è¿ç§»åˆ° Courier çš„è¿‡ç¨‹ã€‚ç”±äºè¿ç§»æœ¬èº«å°±æ˜¯ä¸ªå¾ˆå®¹æ˜“å‡ºé”™çš„è¿‡ç¨‹ï¼Œæˆ‘ä»¬å†³å®šåˆ†æˆå¤šä¸ªæ­¥éª¤æ¥è¿›è¡Œã€‚

### ç¬¬ 0 æ­¥ï¼š å†»ç»“ä¼ ç»Ÿçš„ RPC

åœ¨å¼€å§‹ä¹‹å‰ï¼Œæˆ‘ä»¬ä¼šå†»ç»“ä¼ ç»Ÿ RPC çš„ç‰¹å¾é›†ï¼Œè¿™æ ·ä»–å°±ä¸ä¼šå˜åŒ–äº†ã€‚è¿™æ ·ï¼Œç”±äºè¿½è¸ªå’Œæµä¹‹ç±»çš„æ–°ç‰¹æ€§åªèƒ½åœ¨ Courier çš„æœåŠ¡ä¸­ä½¿ç”¨ï¼Œå¤§å®¶ä¹Ÿä¼šæ›´æ„¿æ„è¿ç§»åˆ° Courierã€‚

### ç¬¬ 1 æ­¥ï¼šä¼ ç»Ÿ RPC å’Œ Courier çš„é€šç”¨æ¥å£

æˆ‘ä»¬ä»ç»™ä¼ ç»Ÿ RPC å’Œ Courier å®šä¹‰é€šç”¨æ¥å£å¼€å§‹ã€‚æˆ‘ä»¬çš„ä»£ç ç”Ÿæˆä¼šç”Ÿæˆé€‚ç”¨äºè¿™ä¸¤ç§ç‰ˆæœ¬æ¥å£çš„å­˜æ ¹ï¼š

```
type TestServer interface {
   UnaryUnary(
      ctx context.Context,
      req *test.TestRequest) (
      *test.TestResponse,
      error)
   ...
}
```

### ç¬¬ 2 æ­¥ï¼šè¿ç§»åˆ°æ–°æ¥å£

ç„¶åæˆ‘ä»¬å°†æ¯ä¸ªæœåŠ¡éƒ½åˆ‡æ¢åˆ°æ–°çš„æ¥å£ï¼Œä½†è¿˜æ˜¯ä½¿ç”¨ä¼ ç»Ÿ RPCã€‚è¿™å¯¹äºæ‰€æœ‰æœåŠ¡å’Œå®¢æˆ·ç«¯ä¸­çš„æ–¹æ³•æ¥è¯´é€šå¸¸éƒ½æœ‰å¾ˆå¤§çš„å·®å¼‚ã€‚è¿™ä¸ªè¿‡ç¨‹å¾ˆå®¹æ˜“å‡ºé”™ï¼Œä¸ºäº†å°½å¯èƒ½é™ä½é£é™©ï¼Œæˆ‘ä»¬æ¯æ¬¡åªæ”¹ä¸€ä¸ªå‚æ•°ã€‚

> å¤„ç†åªæœ‰å°‘æ•°æ–¹æ³•å’Œ[å¤‡ç”¨é”™è¯¯é¢„ç®—](https://landing.google.com/sre/sre-book/chapters/embracing-risk/)çš„ä½é˜¶æœåŠ¡æ—¶å¯ä»¥ä¸€æ­¥å®Œæˆè¿ç§»ï¼Œä¸ç”¨ç®¡è¿™ä¸ªè­¦å‘Šã€‚

### ç¬¬ 3 æ­¥ï¼šå°†å®¢æˆ·ç«¯åˆ‡æ¢åˆ° Courier RPC

ä½œä¸ºè¿ç§»åˆ° Courier çš„ä¸€éƒ¨åˆ†ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ä¸åŒçš„ç«¯å£ä¸ŠåŒæ—¶è¿è¡Œä¼ ç»Ÿå’Œ Courier æœåŠ¡å™¨çš„äºŒè¿›åˆ¶æ–‡ä»¶ã€‚ç„¶åå°†å®¢æˆ·ç«¯ä¸­ RPC å®ç°çš„ä¸€è¡Œè¿›è¡Œä¿®æ”¹ã€‚

```
class MyClient(object):
  def __init__(self):
-   self.client = LegacyRPCClient('myservice')
+   self.client = CourierRPCClient('myservice')
```

è¯·æ³¨æ„ï¼Œä½¿ç”¨ä¸Šé¢çš„æ¨¡å‹ä¸€æ¬¡å¯ä»¥è¿ç§»ä¸€ä¸ªå®¢æˆ·ç«¯ï¼Œæˆ‘ä»¬å¯ä»¥ä»æ‰¹å¤„ç†è¿›ç¨‹å’Œå…¶ä»–ä¸€äº›å¼‚æ­¥ä»»åŠ¡ç­‰æ‹¥æœ‰è¾ƒä½ SLA çš„å¼€å§‹ã€‚

### ç¬¬ 4 æ­¥ï¼šæ¸…ç†

åœ¨æ‰€æœ‰çš„æœåŠ¡å®¢æˆ·ç«¯éƒ½è¿ç§»å®Œæˆä¹‹åï¼Œæˆ‘ä»¬éœ€è¦è¯æ˜ä¼ ç»Ÿçš„ RPC å·²ç»ä¸å†è¢«ä½¿ç”¨äº†ï¼ˆå¯ä»¥é€šè¿‡ä»£ç æ£€æŸ¥é™æ€åœ°å®Œæˆï¼Œæˆ–è€…é€šè¿‡æ£€æŸ¥ä¼ ç»ŸæœåŠ¡å™¨ç»Ÿè®¡æ¥åŠ¨æ€åœ°å®Œæˆã€‚ï¼‰è¿™ä¸€æ­¥å®Œæˆä¹‹åï¼Œå¼€å‘è€…å°±å¯ä»¥ç»§ç»­è¿›è¡Œæ¸…ç†å¹¶åˆ æ‰æ—§çš„ä»£ç äº†ã€‚

## ç»éªŒæ•™è®­

åˆ°äº†æœ€åï¼ŒCourier å¸¦ç»™æˆ‘ä»¬çš„æ˜¯ä¸€ä¸ªå¯ä»¥åŠ é€ŸæœåŠ¡å¼€å‘çš„ç»Ÿä¸€ RPC æ¡†æ¶ï¼Œå®ƒç®€åŒ–äº†æ“ä½œå¹¶åŠ å¼ºäº† Dropbox çš„å¯é æ€§ã€‚

è¿™é‡Œæˆ‘ä»¬æ€»ç»“äº†å¼€å‘å’Œéƒ¨ç½² Courier è¿‡ç¨‹ä¸­ä¸»è¦çš„ç»éªŒæ•™è®­ï¼š

1.  å¯è§‚å¯Ÿæ€§æ˜¯ä¸€ä¸ªç‰¹æ€§ã€‚ åœ¨æ’é™¤æ•…éšœæ—¶ï¼Œæ‰€æœ‰ç°æˆçš„åº¦é‡å’Œæ•…éšœæ˜¯éå¸¸å®è´µçš„ã€‚
2.  æ ‡å‡†åŒ–å’Œä¸€è‡´æ€§å¾ˆé‡è¦ã€‚ å®ƒä»¬å¯ä»¥é™ä½è®¤çŸ¥å‹åŠ›å¹¶ç®€åŒ–æ“ä½œå’Œä»£ç ç»´æŠ¤ã€‚
3.  è¯•ç€æœ€å°åŒ–ä»£ç å¼€å‘è€…éœ€è¦ç¼–å†™çš„æ ·æ¿æ–‡ä»¶ã€‚ä»£ç ç”Ÿæˆå™¨æ˜¯ä½ çš„ä¼™ä¼´ã€‚
4.  å°½é‡è®©è¿ç§»ç®€å•äº›ã€‚è¿ç§»é€šå¸¸éœ€è¦æ¯”å¼€å‘æ›´å¤šçš„æ—¶é—´ã€‚åŒæ—¶ï¼Œè¿ç§»åªæœ‰åœ¨æ¸…ç†è¿‡ç¨‹å®Œæˆä¹‹åæ‰ç®—ç»“æŸã€‚
5. å¯ä»¥åœ¨ RPC æ¡†æ¶ä¸­å¯¹åŸºç¡€è®¾æ–½èŒƒå›´å†…çš„å¯é æ€§è¿›è¡Œæ”¹è¿›ï¼Œä¾‹å¦‚ï¼Œå¼ºåˆ¶æˆªæ­¢æœŸé™ã€è¶…è½½ä¿æŠ¤ç­‰ç­‰ã€‚å¸¸è§çš„å¯é æ€§é—®é¢˜å¯ä»¥é€šè¿‡æ¯ä¸ªå­£åº¦çš„äº‹ä»¶æŠ¥å‘Šæ¥ç¡®å®šã€‚

## å·¥ä½œå±•æœ›

Courier å’Œ gRPC æœ¬èº«éƒ½åœ¨ä¸æ–­å˜åŒ–ï¼Œæ‰€ä»¥æˆ‘ä»¬æœ€åæ¥æ€»ç»“ä¸€ä¸‹è¿è¡Œæ—¶å›¢é˜Ÿå’Œå¯é æ€§å›¢é˜Ÿçš„å·¥ä½œè·¯çº¿ã€‚

åœ¨ä¸è¿œçš„å°†æ¥ï¼Œæˆ‘ä»¬ä¼šç»™ Python çš„ gRPC ä»£ç åŠ ä¸€ä¸ªåˆé€‚çš„è§£æå™¨ APIï¼Œåˆ‡æ¢åˆ° Python/Rust ä¸­çš„ C++ ç»‘å®šï¼Œå¹¶åŠ ä¸Šå®Œæ•´çš„æ–­è·¯æ§åˆ¶å’Œæ•…éšœæ³¨å…¥çš„æ”¯æŒã€‚æ˜å¹´æˆ‘ä»¬å‡†å¤‡è°ƒç ”ä¸€ä¸‹ [ALTS å¹¶ä¸”å°† TLS æ¡æ‰‹ç§»åˆ°å•ç‹¬çš„è¿›ç¨‹](https://cloud.google.com/security/encryption-in-transit/application-layer-transport-security/resources/alts-whitepaper.pdf) (å¯èƒ½ç”šè‡³ä¸æœåŠ¡å®¹å™¨åˆ†ç¦»å¼€ã€‚)

## æˆ‘ä»¬åœ¨æ‹›è˜ï¼

ä½ æƒ³åšè¿è¡Œæ—¶ç›¸å…³çš„å·¥ä½œå—ï¼ŸDropbox åœ¨å±±æ™¯åŸå’Œæ—§é‡‘å±±çš„å°å›¢é˜Ÿè´Ÿè´£å…¨çƒåˆ†å¸ƒçš„è¾¹ç¼˜ç½‘ç»œã€å…†æ¯”ç‰¹æµé‡ã€æ¯ç§’æ•°ç™¾ä¸‡æ¬¡çš„è¯·æ±‚ã€‚

![](https://dropboxtechblog.files.wordpress.com/2019/01/09-screenshot2018-10-0318.04.58.png?w=650&h=364)

[é€šä¿¡é‡/è¿è¡Œæ—¶/å¯é æ€§å›¢é˜Ÿéƒ½åœ¨æ‹› SWE å’Œ SRE](https://www.dropbox.com/jobs/listing/1233364?gh_src=f80311fa1)ï¼Œè´Ÿè´£å¼€å‘ TCP/IP åŒ…å¤„ç†å™¨å’Œè´Ÿè½½å‡è¡¡å™¨ã€HTTP/gRPC ä»£ç†å’Œæˆ‘ä»¬å†…éƒ¨çš„è¿è¡Œæ—¶ service meshï¼šCourier/gRPCã€æœåŠ¡å‘ç°å’Œ AFSã€‚æ„Ÿè§‰ä¸åˆé€‚ï¼Ÿæˆ‘ä»¬[æ—§é‡‘å±±ã€çº½çº¦ã€è¥¿é›…å›¾ã€ç‰¹æ‹‰ç»´ç­‰åœ°çš„åŠå…¬å®¤è¿˜æœ‰å„ä¸ªæ–¹å‘çš„èŒä½](https://www.dropbox.com/jobs/teams/engineering?gh_src=f80311fa1#open-positions).

## é¸£è°¢

**é¡¹ç›®è´¡çŒ®è€…:** Ashwin Amit, Can Berk Guder, Dave Zbarsky, Giang Nguyen, Mehrdad Afshari, Patrick Lee, Ross Delinger, Ruslan Nigmatullin, Russ Allbery, Santosh Ananthakrishnan.

åŒæ—¶ä¹Ÿéå¸¸æ„Ÿè°¢ gRPC å›¢é˜Ÿçš„æ”¯æŒã€‚

> å¦‚æœå‘ç°è¯‘æ–‡å­˜åœ¨é”™è¯¯æˆ–å…¶ä»–éœ€è¦æ”¹è¿›çš„åœ°æ–¹ï¼Œæ¬¢è¿åˆ° [æ˜é‡‘ç¿»è¯‘è®¡åˆ’](https://github.com/xitu/gold-miner) å¯¹è¯‘æ–‡è¿›è¡Œä¿®æ”¹å¹¶ PRï¼Œä¹Ÿå¯è·å¾—ç›¸åº”å¥–åŠ±ç§¯åˆ†ã€‚æ–‡ç« å¼€å¤´çš„ **æœ¬æ–‡æ°¸ä¹…é“¾æ¥** å³ä¸ºæœ¬æ–‡åœ¨ GitHub ä¸Šçš„ MarkDown é“¾æ¥ã€‚


---

> [æ˜é‡‘ç¿»è¯‘è®¡åˆ’](https://github.com/xitu/gold-miner) æ˜¯ä¸€ä¸ªç¿»è¯‘ä¼˜è´¨äº’è”ç½‘æŠ€æœ¯æ–‡ç« çš„ç¤¾åŒºï¼Œæ–‡ç« æ¥æºä¸º [æ˜é‡‘](https://juejin.im) ä¸Šçš„è‹±æ–‡åˆ†äº«æ–‡ç« ã€‚å†…å®¹è¦†ç›– [Android](https://github.com/xitu/gold-miner#android)ã€[iOS](https://github.com/xitu/gold-miner#ios)ã€[å‰ç«¯](https://github.com/xitu/gold-miner#å‰ç«¯)ã€[åç«¯](https://github.com/xitu/gold-miner#åç«¯)ã€[åŒºå—é“¾](https://github.com/xitu/gold-miner#åŒºå—é“¾)ã€[äº§å“](https://github.com/xitu/gold-miner#äº§å“)ã€[è®¾è®¡](https://github.com/xitu/gold-miner#è®¾è®¡)ã€[äººå·¥æ™ºèƒ½](https://github.com/xitu/gold-miner#äººå·¥æ™ºèƒ½)ç­‰é¢†åŸŸï¼Œæƒ³è¦æŸ¥çœ‹æ›´å¤šä¼˜è´¨è¯‘æ–‡è¯·æŒç»­å…³æ³¨ [æ˜é‡‘ç¿»è¯‘è®¡åˆ’](https://github.com/xitu/gold-miner)ã€[å®˜æ–¹å¾®åš](http://weibo.com/juejinfanyi)ã€[çŸ¥ä¹ä¸“æ ](https://zhuanlan.zhihu.com/juejinfanyi)ã€‚
