> * åŸæ–‡åœ°å€ï¼š[This one line of Javascript made FT.com 10 times slower](https://medium.com/ft-product-technology/this-one-line-of-javascript-made-ft-com-10-times-slower-5afb02bfd93f)
> * åŸæ–‡ä½œè€…ï¼š[Arjun](https://medium.com/@adgad?source=post_header_lockup)
> * è¯‘æ–‡å‡ºè‡ªï¼š[æ˜é‡‘ç¿»è¯‘è®¡åˆ’](https://github.com/xitu/gold-miner)
> * æœ¬æ–‡æ°¸ä¹…é“¾æ¥ï¼š[https://github.com/xitu/gold-miner/blob/master/TODO1/ft-product-technology/this-one-line-of-javascript-made-ft-com-10-times-slower.md](https://github.com/xitu/gold-miner/blob/master/TODO1/ft-product-technology/this-one-line-of-javascript-made-ft-com-10-times-slower.md)
> * è¯‘è€…ï¼š[IridescentMia](https://github.com/IridescentMia)
> * æ ¡å¯¹è€…ï¼š

# ä¸€è¡Œ JavaScript ä»£ç ç«Ÿç„¶è®© FT.com ç½‘ç«™æ…¢äº†åå€

## æ€§èƒ½é€€åŒ–çš„æ¢ç´¢ä¹‹æ—…

### å‘ç°é—®é¢˜

è¿™ä¸€åˆ‡å¼€å§‹äºä¸€ä¸ªè­¦æŠ¥ï¼Œé¦–é¡µåº”ç”¨çš„é”™è¯¯ç‡é«˜äº 4ï¼… çš„é˜ˆå€¼ã€‚

æ˜¾ç¤ºæ•°åƒä¸ªé”™è¯¯é¡µé¢å¯¹æˆ‘ä»¬çš„ç”¨æˆ·äº§ç”Ÿäº†åˆ‡å®çš„å½±å“ï¼ˆè¿˜å¥½ CDN ç¼“å­˜æŠµæ¶ˆä¸€éƒ¨åˆ†å½±å“ï¼‰ã€‚

![](https://cdn-images-1.medium.com/max/800/0*NulY2pOWG5_EEmKq)

è¢«ç”¨æˆ·çœ‹åˆ°çš„é”™è¯¯é¡µé¢

åº”ç”¨ç¨‹åºçš„é”™è¯¯æ—¥å¿—æ˜¾ç¤ºï¼Œè¯¥åº”ç”¨ç¨‹åºæ²¡æœ‰ä»»ä½•æœ‰å…³ top stories çš„æ•°æ®ã€‚

![](https://cdn-images-1.medium.com/max/800/0*sctKUx9eZMjK3ecQ)

### è¯Šæ–­é—®é¢˜

é¦–é¡µçš„å·¥ä½œåŸç†æ˜¯åœ¨ä¸€ä¸ªæ—¶é—´é—´éš”å†…è½®è¯¢ GraphQL api ä»¥è·å–æ•°æ®ï¼Œå°†è¯¥æ•°æ®å­˜å‚¨åœ¨å†…å­˜ä¸­å¹¶æ ¹æ®è¯·æ±‚æ¸²æŸ“å®ƒã€‚ä»ç†è®ºä¸Šè®²ï¼Œå¦‚æœè¯·æ±‚å¤±è´¥ï¼Œåº”è¯¥ä¿ç•™ä¹‹å‰ç¨³å®šçš„æ•°æ®ã€‚è¿›ä¸€æ­¥æ·±å…¥æ—¥å¿—ï¼Œæˆ‘ä»¬çœ‹åˆ°å¯¹ GraphQL api çš„è¯·æ±‚å¤±è´¥äº†ï¼Œä½†æ˜¯æ˜¯æœ‰é”™è¯¯è€Œä¸æ˜¯è¶…æ—¶ - æˆ–è€…è‡³å°‘æ˜¯ä¸åŒç±»å‹çš„è¶…æ—¶ã€‚

```
FetchError: response timeout at https://â€¦.&source=next-front-page over limit: 5000
```

![](https://cdn-images-1.medium.com/max/800/0*QGxZjzHsATzwm8WF)

å¥‡æ€ªçš„æ˜¯ï¼ŒAPI çš„å“åº”æ—¶é—´ä¼¼ä¹è¿œä½äºé¦–é¡µè®¾ç½®çš„ 5 ç§’è¶…æ—¶ã€‚è¿™è®©æˆ‘ä»¬ç›¸ä¿¡é—®é¢˜å‡ºç°åœ¨é¦–é¡µå’Œåº”ç”¨ç¨‹åºä¹‹é—´ã€‚æˆ‘ä»¬åšäº†äº›å°è¯• - åœ¨ä¸¤è€…ä¹‹é—´ä½¿ç”¨ keepAlive è¿æ¥ï¼Œåˆ†æ•£è¯·æ±‚ï¼Œè¿™æ ·å®ƒä»¬å°±ä¸ä¼šåŒæ—¶å‘èµ·ã€‚è¿™äº›ä¼¼ä¹éƒ½æ²¡æœ‰äº§ç”Ÿä»»ä½•å½±å“ã€‚

![](https://cdn-images-1.medium.com/max/800/0*dFdztWjeKbMtWdLx)

æ›´ç¥ç§˜çš„æ˜¯ Heroku ä¸Šæ˜¾ç¤ºçš„å“åº”æ—¶é—´ã€‚95th percentile çº¦ä¸º 2 - 3 ç§’ï¼Œè€Œ max æœ‰æ—¶è¾¾åˆ° 10 - 15 ç§’ã€‚ç”±äºé¦–é¡µè¢« Fastly é«˜åº¦ç¼“å­˜ï¼ŒåŒ…æ‹¬ [stale-while-revalidate](https://docs.fastly.com/guides/performance-tuning/serving-stale-content.html) å¤´ï¼Œè®¸å¤šç”¨æˆ·å¯èƒ½ä¸ä¼šæ³¨æ„åˆ°ã€‚ä½†è¿™å¾ˆå¥‡æ€ªï¼Œå› ä¸ºé¦–é¡µ_çœŸçš„_ä¸åº”è¯¥åšå¾ˆå¤šå·¥ä½œæ¥æ¸²æŸ“é¡µé¢ã€‚æ‰€æœ‰æ•°æ®éƒ½ä¿å­˜åœ¨å†…å­˜ä¸­ã€‚

![](https://cdn-images-1.medium.com/max/800/0*0KSUFEF86Vmgjq8S)

é¦–é¡µçš„ Heroku å“åº”æ—¶é—´

å› æ­¤æˆ‘ä»¬å†³å®šå¯¹æœ¬åœ°è¿è¡Œçš„åº”ç”¨ç¨‹åºå‰¯æœ¬è¿›è¡Œä¸€äº›åˆ†æã€‚æˆ‘ä»¬å°†é€šè¿‡ä½¿ç”¨ Apache Bench æ¯ç§’å‘å‡º10ä¸ªè¯·æ±‚ï¼Œå…±å‘å‡º 1000 ä¸ªè¯·æ±‚æ¥å¤åˆ¶ä¸€äº›è´Ÿè½½ã€‚

```
ab -n 1000 -c 10 http://local.ft.com:3002/
```

ä½¿ç”¨ [node-clinic](https://www.nearform.com/blog/introducing-node-clinic-a-performance-toolkit-for-node-js-developers/) å’Œ [nsolid](https://nodesource.com/products/nsolid)ï¼Œæˆ‘ä»¬å¯ä»¥å¯¹å†…å­˜ã€CPU å’Œåº”ç”¨ç¨‹åºä»£ç æœ‰æ›´æ·±çš„ç†è§£ã€‚è¿è¡Œå®ƒä»¬ï¼Œç¡®è®¤æˆ‘ä»¬å¯ä»¥åœ¨æœ¬åœ°å¤ç°è¯¥é—®é¢˜ã€‚é¦–é¡µéœ€è¦ 200 - 300s æ‰èƒ½å®Œæˆæµ‹è¯•ï¼Œè¶…è¿‡ 800 ä¸ªè¯·æ±‚ä¸æˆåŠŸã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼Œåœ¨æ–‡ç« é¡µé¢ä¸Šè¿è¡Œç›¸åŒçš„æµ‹è¯•éœ€è¦å¤§çº¦ 50 ç§’ã€‚

```
æµ‹è¯•ç”¨æ—¶: 305.629 ç§’
å®Œæˆçš„è¯·æ±‚: 1000
å¤±è´¥çš„è¯·æ±‚: 876
```

è€Œä¸”ä½ çœ‹ï¼Œn-solid çš„å›¾è¡¨æ˜¾ç¤ºäº‹ä»¶å¾ªç¯çš„æ»åè¶…è¿‡ 100 æ¯«ç§’ã€‚

![](https://cdn-images-1.medium.com/max/800/0*VJC8ZG_P-WR28cvR)

åœ¨åšåŠ è½½æµ‹è¯•æ—¶äº‹ä»¶å¾ªç¯æ»å

ä½¿ç”¨ n-solid çš„ CPU åˆ†æå™¨ï¼Œæˆ‘ä»¬å¯ä»¥ç²¾ç¡®å®šä½é˜»å¡äº‹ä»¶å¾ªç¯çš„ç¡®åˆ‡ä»£ç è¡Œã€‚

![](https://cdn-images-1.medium.com/max/800/0*nhC_5jlhKw7uqOL6)

ç«ç„°å›¾æ˜¾ç¤ºå¯¼è‡´æ»åçš„å‡½æ•°

### ä¿®å¤é—®é¢˜

ç½ªé­ç¥¸é¦–æ˜¯.......

```
return JSON.parse(JSON.stringify(this._data));
```

å¯¹äºæ¯ä¸ªè¯·æ±‚ï¼Œæˆ‘ä»¬ä½¿ç”¨ JSON.parse/stringify æ¥åˆ›å»ºæ•°æ®çš„æ·±å…‹éš†ã€‚è¿™ç§æ–¹æ³•æœ¬èº«ä¸å - å¯èƒ½æ˜¯æ·±å…‹éš†æ¯”è¾ƒå¿«æ–¹æ³•ä¹‹ä¸€ã€‚ä½†å®ƒä»¬æ˜¯åŒæ­¥æ–¹æ³•ï¼Œå› æ­¤åœ¨æ‰§è¡Œæ—¶ä¼šé˜»å¡äº‹ä»¶å¾ªç¯ã€‚

åœ¨æˆ‘ä»¬çš„æ¡ˆä¾‹ä¸­ï¼Œè¿™ä¸ªæ–¹æ³•åœ¨æ¯ä¸ªé¡µé¢æ¸²æŸ“ï¼ˆå¯¹äºæ¯ä¸ªè¢«æ¸²æŸ“çš„éƒ¨åˆ†ï¼‰ä¸­å¤šæ¬¡è°ƒç”¨ï¼Œå…·æœ‰å¤§é‡æ•°æ®ï¼ˆæ¯æ¬¡æ‰§è¡Œæ—¶æ•´ä¸ªé¡µé¢æ‰€éœ€çš„æ•°æ®ï¼‰ï¼Œå¹¶ä¸”æˆ‘ä»¬æœ‰å‡ ä¸ªå¹¶å‘è¯·æ±‚ã€‚ç”±äº Javascript æ˜¯å•çº¿ç¨‹çš„ï¼Œå› æ­¤è¿™å°†å¯¹åº”ç”¨ç¨‹åºå°è¯•æ‰§è¡Œçš„æ‰€æœ‰å…¶ä»–æ“ä½œäº§ç”Ÿè¿é”ååº”ã€‚

æ·±å…‹éš†æ•°æ®çš„åŸå› æ˜¯ï¼Œæˆ‘ä»¬ä¼šæ ¹æ®è¯·æ±‚ä¸­çš„ä¸€äº›ä¿¡æ¯ï¼ˆä¾‹å¦‚ï¼Œæ˜¯å¦å¯ç”¨äº†ç‰¹å®šçš„å±æ€§ï¼‰ï¼Œæ¥æ”¹å˜å¯¹è±¡ã€‚

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ - å¹¶å‡è½»å…‹éš†æ‰€æœ‰å†…å®¹çš„éœ€è¦ - æˆ‘ä»¬åœ¨æ£€ç´¢æ—¶å¯¹å¯¹è±¡åº”ç”¨äº†æ·±åº¦å†»ç»“ï¼Œç„¶ååœ¨æ•°æ®è¢«æ”¹åŠ¨çš„åœ°æ–¹å…‹éš†ç‰¹å®šä½ã€‚è¿™ä»ç„¶æ‰§è¡ŒåŒæ­¥å…‹éš† - ä½†ä»…é™äºæ›´å°çš„æ•°æ®å­é›†ã€‚

### ç»“è®º

ä¿®å¤å¥½åï¼Œæˆ‘ä»¬é‡æ–°è¿è¡Œäº†è´Ÿè½½æµ‹è¯•ï¼Œå¹¶åœ¨å¾ˆçŸ­çš„æ—¶é—´å†…å®Œæˆï¼Œ0 æ¬¡é”™è¯¯ã€‚

```
æµ‹è¯•ç”¨æ—¶: 37.476 ç§’
å®Œæˆçš„è¯·æ±‚: 1000
å¤±è´¥çš„è¯·æ±‚: 0
```

æˆ‘ä»¬å‘å¸ƒäº†ç”Ÿäº§ä¿®å¤ç¨‹åºï¼Œçœ‹åˆ°å“åº”æ—¶é—´å’Œé”™è¯¯ï¼ˆğŸ¤ğŸ¼ï¼‰ç«‹å³å‡å°‘ï¼Œå¹¶å¸Œæœ›ä¸€äº›ç”¨æˆ·å¼€å¿ƒï¼

![](https://cdn-images-1.medium.com/max/800/1*zsJVZsXvp39EDlv8vAOk2w.png)

ä¿®å¤åé¦–é¡µçš„å“åº”æ—¶é—´

![](https://cdn-images-1.medium.com/max/800/1*ASzi7PZfAIVLLQr5ybNZzw.png)

### å…³äºæœªæ¥

* å¯¹å…¶ä»–ä¸€äº›åº”ç”¨ç¨‹åºè¿è¡Œæ­¤åˆ†æï¼Œå¹¶äº†è§£æˆ‘ä»¬å¯ä»¥è¿›ä¸€æ­¥ä¼˜åŒ–å’Œ/æˆ–å‡å°‘ dyno å¤§å°çš„ä½ç½®ã€‚
* æˆ‘ä»¬å¯ä»¥è®©äº‹ä»¶å¾ªç¯æ›´å¯è§å—ï¼Ÿ
* æˆ‘ä»¬çš„é¦–é¡µåº”è¯¥æ˜¯ stale-on-error - æ‰€ä»¥ä¸ºä»€ä¹ˆä»ç„¶ä¼šçœ‹åˆ°æ•°ä»¥åƒè®¡çš„é”™è¯¯é¡µé¢ï¼Ÿè¿™ä¸ªæ•°å­—å¥½è¿˜æ˜¯åï¼Ÿ

Thanks to [Samuel Parkinson](https://medium.com/@samparkinson_?source=post_page).

> å¦‚æœå‘ç°è¯‘æ–‡å­˜åœ¨é”™è¯¯æˆ–å…¶ä»–éœ€è¦æ”¹è¿›çš„åœ°æ–¹ï¼Œæ¬¢è¿åˆ° [æ˜é‡‘ç¿»è¯‘è®¡åˆ’](https://github.com/xitu/gold-miner) å¯¹è¯‘æ–‡è¿›è¡Œä¿®æ”¹å¹¶ PRï¼Œä¹Ÿå¯è·å¾—ç›¸åº”å¥–åŠ±ç§¯åˆ†ã€‚æ–‡ç« å¼€å¤´çš„ **æœ¬æ–‡æ°¸ä¹…é“¾æ¥** å³ä¸ºæœ¬æ–‡åœ¨ GitHub ä¸Šçš„ MarkDown é“¾æ¥ã€‚


---

> [æ˜é‡‘ç¿»è¯‘è®¡åˆ’](https://github.com/xitu/gold-miner) æ˜¯ä¸€ä¸ªç¿»è¯‘ä¼˜è´¨äº’è”ç½‘æŠ€æœ¯æ–‡ç« çš„ç¤¾åŒºï¼Œæ–‡ç« æ¥æºä¸º [æ˜é‡‘](https://juejin.im) ä¸Šçš„è‹±æ–‡åˆ†äº«æ–‡ç« ã€‚å†…å®¹è¦†ç›– [Android](https://github.com/xitu/gold-miner#android)ã€[iOS](https://github.com/xitu/gold-miner#ios)ã€[å‰ç«¯](https://github.com/xitu/gold-miner#å‰ç«¯)ã€[åç«¯](https://github.com/xitu/gold-miner#åç«¯)ã€[åŒºå—é“¾](https://github.com/xitu/gold-miner#åŒºå—é“¾)ã€[äº§å“](https://github.com/xitu/gold-miner#äº§å“)ã€[è®¾è®¡](https://github.com/xitu/gold-miner#è®¾è®¡)ã€[äººå·¥æ™ºèƒ½](https://github.com/xitu/gold-miner#äººå·¥æ™ºèƒ½)ç­‰é¢†åŸŸï¼Œæƒ³è¦æŸ¥çœ‹æ›´å¤šä¼˜è´¨è¯‘æ–‡è¯·æŒç»­å…³æ³¨ [æ˜é‡‘ç¿»è¯‘è®¡åˆ’](https://github.com/xitu/gold-miner)ã€[å®˜æ–¹å¾®åš](http://weibo.com/juejinfanyi)ã€[çŸ¥ä¹ä¸“æ ](https://zhuanlan.zhihu.com/juejinfanyi)ã€‚
