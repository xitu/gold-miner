> - åŸæ–‡åœ°å€ï¼š[HOW TO DEAL WITH DIRTY SIDE EFFECTS IN YOUR PURE FUNCTIONAL JAVASCRIPT](https://jrsinclair.com/articles/2018/how-to-deal-with-dirty-side-effects-in-your-pure-functional-javascript/)
> - åŸæ–‡ä½œè€…ï¼š[James Sinclair](https://jrsinclair.com/articles/2018/how-to-deal-with-dirty-side-effects-in-your-pure-functional-javascript/)
> - è¯‘æ–‡å‡ºè‡ªï¼š[æ˜é‡‘ç¿»è¯‘è®¡åˆ’](https://github.com/xitu/gold-miner)
> - æœ¬æ–‡æ°¸ä¹…é“¾æ¥ï¼š[https://github.com/xitu/gold-miner/blob/master/TODO1/how-to-deal-with-dirty-side-effects-in-your-pure-functional-javascript.md](https://github.com/xitu/gold-miner/blob/master/TODO1/how-to-deal-with-dirty-side-effects-in-your-pure-functional-javascript.md)
> - è¯‘è€…ï¼š
> - æ ¡å¯¹è€…ï¼š

# å¦‚ä½•ä½¿ç”¨çº¯å‡½æ•°å¼ JavaScript å¤„ç†è„å‰¯ä½œç”¨

é¦–å…ˆï¼Œå‡å®šä½ å¯¹å‡½æ•°å¼ç¼–ç¨‹æœ‰æ‰€æ¶‰çŒã€‚ä¸ä¹…ä½ å°±ä¼šé‡åˆ° _çº¯å‡½æ•°_ çš„æ¦‚å¿µã€‚éšç€æ—¶é—´çš„æ¨ç§»ï¼Œä½ ä¼šå‘ç°å‡½æ•°å¼ç¨‹åºå‘˜ä¼¼ä¹å¯¹çº¯å‡½æ•°å¾ˆç€è¿·ã€‚ä»–ä»¬è¯´ï¼šâ€œçº¯å‡½æ•°è®©ä½ å¯¹ä»£ç è¿›è¡Œæ¨ç†â€ï¼Œâ€œçº¯å‡½æ•°ä¸å¤ªå¯èƒ½å¼•å‘ä¸€åœºçƒ­æ ¸æˆ˜äº‰â€ï¼Œâ€œçº¯å‡½æ•°æä¾›äº†å¼•ç”¨é€æ˜æ€§â€ã€‚ä»–ä»¬è¯´çš„å¹¶æ²¡æœ‰é”™ï¼Œçº¯å‡½æ•°æ˜¯ä¸ªå¥½ä¸œè¥¿ã€‚ä½†æ˜¯å­˜åœ¨ä¸€ä¸ªé—®é¢˜â€¦â€¦

çº¯å‡½æ•°æ˜¯æ²¡æœ‰å‰¯ä½œç”¨çš„å‡½æ•°ã€‚[1](#fn:1 "see footnote") ä½†å¦‚æœä½ äº†è§£ç¼–ç¨‹ï¼Œä½ å°±ä¼šçŸ¥é“å‰¯ä½œç”¨æ˜¯ _é‡ç‚¹_ã€‚å¦‚æœæ— æ³•è¯»å– ğœ‹ æˆ‘ä»¬ä¸ºä»€ä¹ˆè¦åœ¨ 100 ä¸ªåœ°æ–¹è®¡ç®—å®ƒï¼Ÿä¸ºäº†æŠŠå®ƒæ‰“å°å‡ºæ¥ï¼Œæˆ‘ä»¬éœ€è¦å†™ä¸€ä¸ªæ§åˆ¶å°ï¼Œæˆ–å‘é€æ•°æ®åˆ°æŒ‡é’ˆï¼Œæˆ–æœ‰ä¸€ä¸ªå¯ä»¥è¢«è¯»å–çš„*ä¸œè¥¿*ã€‚å¦‚æœæ•°æ®åº“ä¸èƒ½è¾“å…¥ä»»ä½•æ•°æ®ï¼Œé‚£ä¹ˆå®ƒåˆæœ‰ä»€ä¹ˆç”¨å‘¢ï¼Ÿæˆ‘ä»¬éœ€è¦ä»è¾“å…¥è®¾å¤‡è¯»å–æ•°æ®ï¼Œå¹¶ä»ç½‘ç»œè¯·æ±‚ä¿¡æ¯ã€‚æˆ‘ä»¬åšä»»ä½•äº‹æƒ…éƒ½ä¸å¯èƒ½æ²¡æœ‰å‰¯ä½œç”¨ã€‚ç„¶è€Œï¼Œå‡½æ•°å¼ç¼–ç¨‹æ˜¯å»ºç«‹åœ¨çº¯å‡½æ•°ä¹‹ä¸Šçš„ã€‚é‚£ä¹ˆå‡½æ•°å¼ç¨‹åºå‘˜æ˜¯å¦‚ä½•å®Œæˆä»»åŠ¡çš„å‘¢ï¼Ÿ

ç®€å•æ¥è¯´å°±æ˜¯ï¼Œåšæ•°å­¦å®¶åšçš„äº‹æƒ…ï¼šæ¬ºéª—

ä»–ä»¬æ¬ºéª—æ—¶ä¸¥æ ¼éµå®ˆè§„åˆ™ã€‚ä½†æ˜¯ä»–ä»¬å‘ç°äº†è¿™äº›è§„åˆ™ä¸­çš„æ¼æ´ï¼Œå¹¶å°†å…¶æ‰©å¤§åˆ°è¶³ä»¥è®©ä¸€ç¾¤å¤§è±¡é€šè¿‡ã€‚æœ‰ä¸¤ç§ä¸»è¦çš„æ–¹æ³•ï¼š

1.  _ä¾èµ–æ³¨å…¥_ï¼Œæˆ–è€…æˆ‘ä»¬ä¹Ÿå¯ä»¥å«å®ƒ _æç½®é—®é¢˜_ï¼›ä»¥åŠ
2.  _ä½¿ç”¨ Effect å‡½å­_ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå®ƒæƒ³è±¡ä¸º _é‡åº¦æ‹–å»¶_ã€‚[2](#fn:2 "see footnote")

## ä¾èµ–æ³¨å…¥

ä¾èµ–æ³¨å…¥æ˜¯æˆ‘ä»¬å¤„ç†å‰¯ä½œç”¨çš„ç¬¬ä¸€ç§æ–¹æ³•ã€‚åœ¨è¿™ç§æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬å°†ä»£ç ä¸­çš„ä¸çº¯çš„éƒ¨åˆ†æ”¾å…¥å‡½æ•°å‚æ•°ä¸­ï¼Œç„¶åæˆ‘ä»¬å°±å¯ä»¥æŠŠå®ƒä»¬çœ‹ä½œæ˜¯å…¶ä»–å‡½æ•°çš„è´£ä»»ã€‚ä¸ºäº†è§£é‡Šæˆ‘çš„æ„æ€ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ä¸€äº›ä»£ç ï¼š

```js
// logSomething :: String -> ()
function logSomething(something) {
  const dt = new Date().toIsoString();
  console.log(`${dt}: ${something}`);
  return something;
}
```

`logSomething()` å‡½æ•°æœ‰ä¸¤ä¸ªä¸çº¯çš„åœ°æ–¹ï¼šå®ƒåˆ›å»ºäº†ä¸€ä¸ª `Date()` å¯¹è±¡å¹¶ä¸”æŠŠå®ƒè¾“å‡ºåˆ°æ§åˆ¶å°ã€‚å› æ­¤ï¼Œå®ƒä¸ä»…æ‰§è¡Œäº† IO æ“ä½œ, è€Œä¸”æ¯æ¬¡è¿è¡Œçš„æ—¶å€™éƒ½ä¼šç»™å‡ºä¸åŒçš„ç»“æœã€‚é‚£ä¹ˆï¼Œå¦‚ä½•ä½¿è¿™ä¸ªå‡½æ•°å˜çº¯ï¼Ÿä½¿ç”¨ä¾èµ–æ³¨å…¥ï¼Œæˆ‘ä»¬ä»¥å‡½æ•°å‚æ•°çš„å½¢å¼æ¥å—ä¸çº¯çš„éƒ¨åˆ†ï¼Œå› æ­¤æˆ‘ä»¬çš„å‡½æ•°å¹¶éæ¥æ”¶ä¸€ä¸ªå‚æ•°è€Œæ˜¯ä¸‰ä¸ªå‚æ•°ï¼š

```js
// logSomething: Date -> Console -> String -> ()
function logSomething(d, cnsl, something) {
  const dt = d.toIsoString();
  cnsl.log(`${dt}: ${something}`);
  return something;
}
```

ç„¶åè°ƒç”¨å®ƒï¼Œæˆ‘ä»¬å¿…é¡»è‡ªè¡Œæ˜ç¡®åœ°ä¼ å…¥ä¸çº¯çš„éƒ¨åˆ†ï¼š

```js
const something = "Curiouser and curiouser!";
const d = new Date();
logSomething(d, console, something);
// â¦˜ Curiouser and curiouser!
```

ç°åœ¨ï¼Œä½ å¯èƒ½ä¼šæƒ³ï¼šâ€œè¿™æ ·åšæœ‰ç‚¹å‚»é€¼ã€‚æˆ‘ä»¬æ‰€åšå°±ä¸€åˆ‡æŠŠé—®é¢˜å˜å¾—æ›´ä¸¥é‡äº†ï¼Œä»£ç è¿˜æ˜¯å’Œä¹‹å‰ä¸€æ ·ä¸çº¯â€ã€‚ä½ æ˜¯å¯¹çš„ã€‚è¿™å®Œå…¨å°±æ˜¯ä¸€ä¸ªæ¼æ´ã€‚

YouTube è§†é¢‘é“¾æ¥ï¼šhttps://youtu.be/9ZSoJDUD_bU

è¿™å°±åƒæ˜¯åœ¨è£…å‚»ï¼šâ€œå™¢ï¼ä¸ï¼è­¦å®˜ï¼Œæˆ‘ä¸çŸ¥é“åœ¨ `cnsl` ä¸Šè°ƒç”¨ `log()` ä¼šæ‰§è¡Œ IO æ“ä½œã€‚è¿™æ˜¯åˆ«äººä¼ ç»™æˆ‘çš„ã€‚æˆ‘ä¸çŸ¥é“å®ƒä»å“ªæ¥çš„â€ï¼Œè¿™çœ‹èµ·æ¥æœ‰ç‚¹è¹©è„šã€‚

è¿™å¹¶ä¸åƒè¡¨é¢ä¸Šé‚£ä¹ˆæ„šè ¢ï¼Œæ³¨æ„æˆ‘ä»¬çš„ `logSomething()` å‡½æ•°ã€‚å¦‚æœä½ è¦å¤„ç†ä¸€äº›ä¸çº¯çš„äº‹æƒ…, ä½ å°±ä¸å¾—ä¸æŠŠå®ƒå˜å¾—ä¸çº¯ã€‚æˆ‘ä»¬å¯ä»¥ç®€å•åœ°ä¼ å…¥ä¸åŒçš„å‚æ•°ï¼š

```js
const d = { toISOString: () => "1865-11-26T16:00:00.000Z" };
const cnsl = {
  log: () => {
    // do nothing
  }
};
logSomething(d, cnsl, "Off with their heads!");
//  ï¿© "Off with their heads!"
```

ç°åœ¨ï¼Œæˆ‘ä»¬çš„å‡½æ•°ä»€ä¹ˆäº‹æƒ…ä¹Ÿæ²¡å¹²ï¼Œé™¤äº†è¿”å› `something` å‚æ•°ã€‚ä½†æ˜¯å®ƒæ˜¯çº¯çš„ã€‚å¦‚æœä½ ç”¨ç›¸åŒçš„å‚æ•°è°ƒç”¨å®ƒï¼Œå®ƒæ¯æ¬¡éƒ½ä¼šè¿”å›ç›¸åŒçš„ç»“æœã€‚è¿™æ‰æ˜¯é‡ç‚¹ã€‚ä¸ºäº†ä½¿å®ƒå˜å¾—ä¸çº¯ï¼Œæˆ‘ä»¬å¿…é¡»é‡‡å–æ·±æ€ç†Ÿè™‘çš„è¡ŒåŠ¨ã€‚æˆ–è€…æ¢å¥è¯è¯´ï¼Œå‡½æ•°ä¾èµ–äºå³è¾¹çš„ç­¾åã€‚å‡½æ•°æ— æ³•è®¿é—®åˆ°åƒ `console` æˆ–è€… `Date` ä¹‹ç±»çš„å…¨å±€å˜é‡ã€‚è¿™æ ·æ‰€æœ‰äº‹æƒ…å°±å¾ˆæ˜ç¡®äº†ã€‚

åŒæ ·éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å°†å‡½æ•°ä¼ é€’ç»™åŸæ¥ä¸çº¯çš„å‡½æ•°ã€‚è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹å¦ä¸€ä¸ªä¾‹å­ã€‚å‡è®¾è¡¨å•ä¸­æœ‰ä¸€ä¸ª `username` å­—æ®µã€‚æˆ‘ä»¬æƒ³è¦ä»è¡¨å•ä¸­å–åˆ°å®ƒçš„å€¼ï¼š

```js
// getUserNameFromDOM :: () -> String
function getUserNameFromDOM() {
  return document.querySelector("#username").value;
}

const username = getUserNameFromDOM();
username;
// ï¿© "mhatter"
```

åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å°è¯•å»ä» DOM ä¸­æŸ¥è¯¢ä¿¡æ¯ã€‚è¿™æ˜¯ä¸çº¯çš„ï¼Œå› ä¸º `document` æ˜¯ä¸€ä¸ªéšæ—¶å¯èƒ½æ”¹å˜çš„å…¨å±€å˜é‡ã€‚æŠŠæˆ‘ä»¬çš„å‡½æ•°è½¬åŒ–ä¸ºçº¯å‡½æ•°çš„æ–¹æ³•ä¹‹ä¸€å°±æ˜¯æŠŠ å…¨å±€ `document` å¯¹è±¡å½“ä½œä¸€ä¸ªå‚æ•°ä¼ å…¥ã€‚ä½†æ˜¯æˆ‘ä»¬ä¹Ÿå¯ä»¥åƒè¿™æ ·ä¼ å…¥ä¸€ä¸ª `querySelector()` å‡½æ•°ï¼š

```js
// getUserNameFromDOM :: (String -> Element) -> String
function getUserNameFromDOM($) {
  return $("#username").value;
}

// qs :: String -> Element
const qs = document.querySelector.bind(document);

const username = getUserNameFromDOM(qs);
username;
// ï¿© "mhatter"
```

ç°åœ¨ï¼Œä½ å¯èƒ½è¿˜æ˜¯ä¼šè®¤ä¸ºï¼šâ€œè¿™æ ·è¿˜æ˜¯ä¸€æ ·å‚»å•Šï¼â€ æˆ‘ä»¬æ‰€åšåªæ˜¯æŠŠä¸çº¯çš„ä»£ç ä» `getUsernameFromDOM()` ç§»å‡ºæ¥è€Œå·²ã€‚å®ƒå¹¶æ²¡æœ‰æ¶ˆå¤±ï¼Œæˆ‘ä»¬åªæ˜¯æŠŠå®ƒæ”¾åœ¨äº†å¦ä¸€ä¸ªå‡½æ•° `qs()` ä¸­ã€‚é™¤äº†ä½¿ä»£ç æ›´é•¿ä¹‹å¤–ï¼Œå®ƒä¼¼ä¹æ²¡ä»€ä¹ˆä½œç”¨ã€‚æˆ‘ä»¬ä¸¤ä¸ªå‡½æ•°å–ä»£äº†ä¹‹å‰ä¸€ä¸ªä¸çº¯çš„å‡½æ•°ï¼Œä½†æ˜¯å…¶ä¸­ä¸€ä¸ªä»ç„¶ä¸çº¯ã€‚

å†å¿å—ä¸€ä¸‹æˆ‘ï¼Œå‡è®¾æˆ‘ä»¬æƒ³ç»™ `getUserNameFromDOM()` å†™æµ‹è¯•ã€‚ç°åœ¨ï¼Œæ¯”è¾ƒä¸€ä¸‹ä¸çº¯å’Œçº¯çš„ç‰ˆæœ¬ï¼Œå“ªä¸ªæ›´å®¹æ˜“ç¼–å†™æµ‹è¯•ï¼Ÿä¸ºäº†å¯¹ä¸çº¯ç‰ˆæœ¬çš„å‡½æ•°è¿›è¡Œæµ‹è¯•ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªå…¨å±€ `document` å¯¹è±¡ï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œè¿˜éœ€è¦ä¸€ä¸ª ID ä¸º `username` çš„å…ƒç´ ã€‚å¦‚æœæˆ‘æƒ³åœ¨æµè§ˆå™¨ä¹‹å¤–æµ‹è¯•å®ƒï¼Œé‚£ä¹ˆæˆ‘å¿…é¡»å¯¼å…¥è¯¸å¦‚ JSDOM æˆ–æ— å¤´æµè§ˆå™¨ä¹‹ç±»çš„ä¸œè¥¿ã€‚è¿™ä¸€åˆ‡éƒ½æ˜¯ä¸ºäº†æµ‹è¯•ä¸€ä¸ªå¾ˆå°çš„å‡½æ•°ã€‚ä½†æ˜¯ä½¿ç”¨ç¬¬äºŒä¸ªç‰ˆæœ¬çš„å‡½æ•°ï¼Œæˆ‘å¯ä»¥è¿™æ ·åšï¼š

```js
const qsStub = () => ({ value: "mhatter" });
const username = getUserNameFromDOM(qsStub);
assert.strictEqual("mhatter", username, `Expected username to be ${username}`);
```

ç°åœ¨ï¼Œè¿™å¹¶ä¸æ„å‘³ç€ä½ ä¸åº”è¯¥åˆ›å»ºåœ¨çœŸæ­£çš„æµè§ˆå™¨ä¸­è¿è¡Œçš„é›†æˆæµ‹è¯•ã€‚(æˆ–è€…ï¼Œè‡³å°‘æ˜¯åƒ JSDOM è¿™æ ·çš„æ¨¡æ‹Ÿç‰ˆæœ¬)ã€‚ä½†æ˜¯è¿™ä¸ªä¾‹å­æ‰€å±•ç¤ºçš„æ˜¯`getUserNameFromDOM()` ç°åœ¨æ˜¯å®Œå…¨å¯é¢„æµ‹çš„ã€‚å¦‚æœæˆ‘ä»¬ä¼ é€’ç»™å®ƒ qsStub å®ƒæ€»æ˜¯ä¼šè¿”å› â€œmhatterâ€ã€‚æˆ‘ä»¬æŠŠä¸å¯é¢„æµ‹è½¬æ€§ç§»åˆ°äº†æ›´å°çš„å‡½æ•° qs ä¸­ã€‚

å¦‚æœæˆ‘ä»¬è¿™æ ·åšï¼Œå°±å¯ä»¥æŠŠè¿™ç§ä¸å¯é¢„æµ‹æ€§æ¨å¾—è¶Šæ¥è¶Šè¿œã€‚æœ€ç»ˆï¼Œæˆ‘ä»¬å°†å®ƒä»¬æ¨åˆ°ä»£ç çš„è¾¹ç•Œã€‚å› æ­¤ï¼Œæˆ‘ä»¬æœ€ç»ˆå¾—åˆ°äº†ä¸€ä¸ªç”±ä¸çº¯ä»£ç ç»„æˆçš„è–„å£³ï¼Œå®ƒåŒ…å›´ç€ä¸€ä¸ªæµ‹è¯•å‹å¥½çš„ã€å¯é¢„æµ‹çš„æ ¸å¿ƒã€‚å½“æ‚¨å¼€å§‹æ„å»ºæ›´å¤§çš„åº”ç”¨ç¨‹åºæ—¶ï¼Œè¿™ç§å¯é¢„æµ‹æ€§å°±ä¼šèµ·åˆ°å¾ˆå¤§çš„ä½œç”¨ã€‚

### ä¾èµ–æ³¨å…¥çš„ç¼ºç‚¹

å¯ä»¥ä»¥è¿™ç§æ–¹å¼åˆ›å»ºå¤§å‹ã€å¤æ‚çš„åº”ç”¨ç¨‹åºã€‚æˆ‘çŸ¥é“æ˜¯ [å› ä¸ºæˆ‘åšè¿‡](https://www.squiz.net/technology/squiz-workplace)ã€‚
ä¾èµ–æ³¨å…¥ä½¿æµ‹è¯•å˜å¾—æ›´å®¹æ˜“ï¼Œä¹Ÿä¼šä½¿æ¯ä¸ªå‡½æ•°çš„ä¾èµ–å…³ç³»å˜å¾—æ˜ç¡®ã€‚ä½†å®ƒä¹Ÿæœ‰ä¸€äº›ç¼ºç‚¹ã€‚æœ€ä¸»è¦çš„ä¸€ç‚¹æ˜¯ï¼Œä½ æœ€ç»ˆä¼šå¾—åˆ°ç±»ä¼¼è¿™æ ·å†—é•¿çš„å‡½æ•°ç­¾åï¼š

```js
function app(doc, con, ftch, store, config, ga, d, random) {
  // è¿™é‡Œæ˜¯åº”ç”¨ç¨‹åºä»£ç 
}

app(document, console, fetch, store, config, ga, new Date(), Math.random);
```

è¿™è¿˜ä¸ç®—å¤ªç³Ÿï¼Œé™¤æ­¤ä¹‹å¤–ä½ å¯èƒ½é‡åˆ°å‚æ•°é’»äº•çš„é—®é¢˜ã€‚åœ¨ä¸€ä¸ªåº•å±‚çš„å‡½æ•°ä¸­ï¼Œä½ å¯èƒ½éœ€è¦è¿™äº›å‚æ•°ä¸­çš„ä¸€ä¸ªã€‚å› æ­¤ï¼Œæ‚¨å¿…é¡»é€šè¿‡è®¸å¤šå±‚çš„å‡½æ•°è°ƒç”¨æ¥è¿æ¥å‚æ•°ã€‚è¿™è®©äººæ¼ç«ã€‚ä¾‹å¦‚ï¼Œæ‚¨å¯èƒ½éœ€è¦é€šè¿‡ 5 å±‚ä¸­é—´å‡½æ•°ä¼ é€’æ—¥æœŸã€‚æ‰€æœ‰è¿™äº›ä¸­é—´å‡½æ•°éƒ½ä¸ä½¿ç”¨ date å¯¹è±¡ã€‚è¿™ä¸æ˜¯ä¸–ç•Œæœ«æ—¥ï¼Œè‡³å°‘èƒ½å¤Ÿçœ‹åˆ°è¿™äº›æ˜¾å¼çš„ä¾èµ–å…³ç³»è¿˜æ˜¯ä¸é”™çš„ã€‚ä½†å®ƒä»ç„¶è®©äººæ¼ç«ã€‚è¿™è¿˜æœ‰å¦ä¸€ç§æ–¹æ³•â€¦â€¦

## æ‡’å‡½æ•°

è®©æˆ‘ä»¬çœ‹çœ‹å‡½æ•°å¼ç¨‹åºå‘˜åˆ©ç”¨çš„ç¬¬äºŒä¸ªæ¼æ´ã€‚å®ƒæ˜¯è¿™çš„ï¼šâ€œå‘ç”Ÿçš„å‰¯ä½œç”¨æ‰æ˜¯å‰¯ä½œç”¨â€ã€‚æˆ‘çŸ¥é“è¿™å¬èµ·æ¥ç¥ç§˜çš„ã€‚è®©æˆ‘ä»¬è¯•ç€è®©å®ƒæ›´æ˜ç¡®ä¸€ç‚¹ã€‚æ€è€ƒä¸€ä¸‹è¿™æ®µä»£ç ï¼š

```js
// fZero :: () -> Number
function fZero() {
  console.log("Launching nuclear missiles");
  // è¿™é‡Œæ˜¯å‘å°„æ ¸å¼¹çš„ä»£ç 
  return 0;
}
```

æˆ‘çŸ¥é“è¿™æ˜¯ä¸ªæ„šè ¢çš„ä¾‹å­ã€‚å¦‚æœæˆ‘ä»¬æƒ³åœ¨ä»£ç ä¸­æœ‰ä¸€ä¸ª 0ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥å†™å‡ºæ¥ã€‚æˆ‘çŸ¥é“ä½ ï¼Œæ–‡é›…çš„è¯»è€…ï¼Œæ°¸è¿œä¸ä¼šç”¨ JavaScript å†™æ§åˆ¶æ ¸æ­¦å™¨çš„ä»£ç ã€‚ä½†å®ƒæœ‰åŠ©äºè¯´æ˜è¿™ä¸€ç‚¹ã€‚è¿™æ˜¾ç„¶æ˜¯ä¸çº¯çš„ä»£ç ã€‚å› ä¸ºå®ƒè¾“å‡ºæ—¥å¿—åˆ°æ§åˆ¶å°ï¼Œä¹Ÿå¯èƒ½å¼€å§‹çƒ­æ ¸æˆ˜äº‰ã€‚å‡è®¾æˆ‘ä»¬æƒ³è¦ 0ã€‚å‡è®¾æˆ‘ä»¬æƒ³è¦è®¡ç®—å¯¼å¼¹å‘å°„åçš„æƒ…å†µï¼Œæˆ‘ä»¬å¯èƒ½éœ€è¦å¯åŠ¨å€’è®¡æ—¶ä¹‹ç±»çš„ä¸œè¥¿ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæå‰è®¡åˆ’å¦‚ä½•è¿›è¡Œè®¡ç®—æ˜¯å®Œå…¨åˆç†çš„ã€‚æˆ‘ä»¬ä¼šéå¸¸å°å¿ƒè¿™äº›å¯¼å¼¹ä»€ä¹ˆæ—¶å€™èµ·é£ï¼Œæˆ‘ä»¬ä¸æƒ³ææ··æˆ‘ä»¬çš„è®¡ç®—ç»“æœï¼Œä»¥å…ä»–ä»¬æ„å¤–å‘å°„å¯¼å¼¹ã€‚é‚£ä¹ˆï¼Œå¦‚æœæˆ‘ä»¬å°† `fZero()` åŒ…è£…åœ¨å¦ä¸€ä¸ªåªè¿”å›å®ƒçš„å‡½æ•°ä¸­å‘¢ï¼Ÿæœ‰ç‚¹åƒå®‰å…¨åŒ…è£…ã€‚

```js
// fZero :: () -> Number
function fZero() {
  console.log("Launching nuclear missiles");
  // è¿™é‡Œæ˜¯å‘å°„æ ¸å¼¹çš„ä»£ç 
  return 0;
}

// returnZeroFunc :: () -> (() -> Number)
function returnZeroFunc() {
  return fZero;
}
```

æˆ‘å¯ä»¥è¿è¡Œ `returnZeroFunc()` ä»»æ„æ¬¡ï¼Œåªè¦ä¸è°ƒç”¨è¿”å›å€¼ï¼Œæˆ‘ç†è®ºä¸Šå°±æ˜¯å®‰å…¨çš„ã€‚æˆ‘çš„ä»£ç ä¸ä¼šå‘å°„ä»»ä½•æ ¸å¼¹ã€‚

```js
const zeroFunc1 = returnZeroFunc();
const zeroFunc2 = returnZeroFunc();
const zeroFunc3 = returnZeroFunc();
// æ²¡æœ‰å‘å°„æ ¸å¼¹ã€‚
```

ç°åœ¨ï¼Œè®©æˆ‘ä»¬æ›´æ­£å¼åœ°å®šä¹‰çº¯å‡½æ•°ã€‚ç„¶åï¼Œæˆ‘ä»¬å¯ä»¥æ›´è¯¦ç»†åœ°æ£€æŸ¥æˆ‘ä»¬çš„ `returnZeroFunc()` å‡½æ•°ã€‚å¦‚æœä¸€ä¸ªå‡½æ•°æ»¡è¶³ä»¥ä¸‹æ¡ä»¶å°±å¯ä»¥ç§°ä¹‹ä¸ºçº¯å‡½æ•°ï¼š

1.  æ²¡æœ‰æ˜æ˜¾çš„å‰¯ä½œç”¨
2.  å¼•ç”¨é€æ˜ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œç»™å®šç›¸åŒçš„è¾“å…¥ï¼Œå®ƒæ€»æ˜¯è¿”å›ç›¸åŒçš„è¾“å‡ºã€‚

è®©æˆ‘ä»¬çœ‹çœ‹ `returnZeroFunc()`ã€‚æœ‰å‰¯ä½œç”¨å—ï¼Ÿå—¯ï¼Œä¹‹å‰æˆ‘ä»¬ç¡®å®šè¿‡ï¼Œè°ƒç”¨ `returnZeroFunc()` ä¸ä¼šå‘å°„ä»»ä½•æ ¸å¯¼å¼¹ã€‚é™¤éæ‰§è¡Œè°ƒç”¨è¿”å›å‡½æ•°çš„é¢å¤–æ­¥éª¤ï¼Œå¦åˆ™ä»€ä¹ˆä¹Ÿä¸ä¼šå‘ç”Ÿã€‚æ‰€ä»¥ï¼Œè¿™ä¸ªå‡½æ•°æ²¡æœ‰å‰¯ä½œç”¨ã€‚

`returnZeroFunc()` å¼•ç”¨é€æ˜å—? ä¹Ÿå°±æ˜¯è¯´ï¼Œç»™å®šç›¸åŒçš„è¾“å…¥ï¼Œå®ƒæ€»æ˜¯è¿”å›ç›¸åŒçš„è¾“å‡º? å¥½å§ï¼ŒæŒ‰ç…§å®ƒç›®å‰çš„ç¼–å†™æ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥æµ‹è¯•å®ƒ:

```js
zeroFunc1 === zeroFunc2; // true
zeroFunc2 === zeroFunc3; // true
```

ä½†å®ƒè¿˜ä¸èƒ½ç®—çº¯ã€‚`returnZeroFunc()` å‡½æ•°å¼•ç”¨å‡½æ•°ä½œç”¨åŸŸå¤–çš„ä¸€ä¸ªå˜é‡ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥ä»¥è¿™ç§æ–¹å¼è¿›è¡Œé‡å†™ï¼š

```js
// returnZeroFunc :: () -> (() -> Number)
function returnZeroFunc() {
  function fZero() {
    console.log("Launching nuclear missiles");
    // è¿™é‡Œæ˜¯å‘å°„æ ¸å¼¹çš„ä»£ç 
    return 0;
  }
  return fZero;
}
```

ç°åœ¨æˆ‘ä»¬çš„å‡½æ•°æ˜¯çº¯å‡½æ•°äº†ã€‚ä½†æ˜¯ï¼ŒJavaScript é˜»ç¢äº†æˆ‘ä»¬ä¸€ä¼šã€‚æˆ‘ä»¬æ— æ³•å†ä½¿ç”¨ `===` æ¥éªŒè¯å¼•ç”¨é€æ˜æ€§ã€‚è¿™æ˜¯å› ä¸º `returnZeroFunc()` æ€»æ˜¯è¿”å›ä¸€ä¸ªæ–°çš„å‡½æ•°å¼•ç”¨ã€‚ä½†æ˜¯ä½ å¯ä»¥é€šè¿‡å®¡æŸ¥ä»£ç æ¥æ£€æŸ¥å¼•ç”¨é€æ˜ã€‚`returnZeroFunc()` å‡½æ•°æ¯æ¬¡é™¤äº†è¿”å›ç›¸åŒçš„å‡½æ•°å…¶ä»–ä»€ä¹ˆä¹Ÿä¸åšã€‚

è¿™æ˜¯ä¸€ä¸ªå·§å¦™çš„å°æ¼æ´ã€‚ä½†æˆ‘ä»¬çœŸçš„èƒ½æŠŠå®ƒç”¨åœ¨çœŸæ­£çš„ä»£ç ä¸Šå—ï¼Ÿç­”æ¡ˆæ˜¯è‚¯å®šçš„ã€‚ä½†åœ¨æˆ‘ä»¬è®¨è®ºå¦‚ä½•åœ¨å®è·µä¸­å®ç°å®ƒä¹‹å‰ï¼Œè®©æˆ‘ä»¬å…ˆæç½®è¿™ä¸ªæƒ³æ³•ã€‚å…ˆå›åˆ°å±é™©çš„ `fZero()` å‡½æ•°ï¼š

```js
// fZero :: () -> Number
function fZero() {
  console.log("Launching nuclear missiles");
  // è¿™é‡Œæ˜¯å‘å°„æ ¸å¼¹çš„ä»£ç 
  return 0;
}
```

è®©æˆ‘ä»¬å°è¯•ä½¿ç”¨ `fZero()` è¿”å›çš„é›¶ï¼Œä½†è¿™ä¸ä¼šå¼€å§‹çƒ­æ ¸æˆ˜äº‰ã€‚æˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªå‡½æ•°ï¼Œå®ƒæ¥å— `fZero()` æœ€ç»ˆè¿”å›çš„ 0ï¼Œå¹¶åœ¨æ­¤åŸºç¡€ä¸ŠåŠ ä¸€ï¼š

```js
// fIncrement :: (() -> Number) -> Number
function fIncrement(f) {
  return f() + 1;
}

fIncrement(fZero);
// â¦˜ å‘å°„å¯¼å¼¹
// ï¿© 1
```

å“å‘¦ï¼æˆ‘ä»¬æ„å¤–åœ°å‘åŠ¨äº†çƒ­æ ¸æˆ˜äº‰ã€‚è®©æˆ‘ä»¬å†è¯•ä¸€æ¬¡ã€‚è¿™ä¸€æ¬¡ï¼Œæˆ‘ä»¬ä¸ä¼šè¿”å›ä¸€ä¸ªæ•°å­—ã€‚ç›¸åï¼Œæˆ‘ä»¬å°†è¿”å›ä¸€ä¸ªæœ€ç»ˆè¿”å›ä¸€ä¸ªæ•°å­—çš„å‡½æ•°ï¼š

```js
// fIncrement :: (() -> Number) -> (() -> Number)
function fIncrement(f) {
  return () => f() + 1;
}

fIncrement(zero);
// ï¿© [Function]
```

å”·ï¼ä¸ºäº†é¿å…å±æœºï¼Œè®©æˆ‘ä»¬ç»§ç»­ã€‚æœ‰äº†è¿™ä¸¤ä¸ªå‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ç³»åˆ—çš„ â€˜æœ€ç»ˆæ•°å­—â€™ï¼ˆè¯‘è€…æ³¨ï¼šæœ€ç»ˆæ•°å­—å³è¿”å›æ•°å­—çš„å‡½æ•°ï¼Œåé¢å¤šæ¬¡å‡ºç°ï¼‰ï¼š

```js
const fOne = fIncrement(zero);
const fTwo = fIncrement(one);
const fThree = fIncrement(two);
// ç­‰ç­‰â€¦
```

æˆ‘ä»¬ä¹Ÿå¯ä»¥åˆ›å»ºä¸€ç»„ `f*()` å‡½æ•°æ¥å¤„ç†æœ€ç»ˆå€¼ï¼š

```js
// fMultiply :: (() -> Number) -> (() -> Number) -> (() -> Number)
function fMultiply(a, b) {
  return () => a() * b();
}

// fPow :: (() -> Number) -> (() -> Number) -> (() -> Number)
function fPow(a, b) {
  return () => Math.pow(a(), b());
}

// fSqrt :: (() -> Number) -> (() -> Number)
function fSqrt(x) {
  return () => Math.sqrt(x());
}

const fFour = fPow(fTwo, fTwo);
const fEight = fMultiply(fFour, fTwo);
const fTwentySeven = fPow(fThree, fThree);
const fNine = fSqrt(fTwentySeven);
// æ²¡æœ‰æ§åˆ¶å°æ—¥å¿—æˆ–çƒ­æ ¸æˆ˜äº‰ã€‚å¹²å¾—ä¸é”™ï¼
```

çœ‹åˆ°æˆ‘ä»¬åšäº†ä»€ä¹ˆäº†å—ï¼Ÿå¦‚æœèƒ½ç”¨æ™®é€šæ•°å­—æ¥åšçš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¹Ÿå¯ä»¥ç”¨æœ€ç»ˆæ•°å­—ã€‚æ•°å­¦ç§°ä¹‹ä¸º [åŒæ„](https://en.wikipedia.org/wiki/Isomorphism)ã€‚æˆ‘ä»¬æ€»æ˜¯å¯ä»¥æŠŠä¸€ä¸ªæ™®é€šçš„æ•°æ”¾åœ¨ä¸€ä¸ªå‡½æ•°ä¸­ï¼Œå°†å…¶å˜æˆä¸€ä¸ªæœ€ç»ˆæ•°å­—ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡è°ƒç”¨è¿™ä¸ªå‡½æ•°å¾—åˆ°æœ€ç»ˆçš„æ•°å­—ã€‚æ¢å¥è¯è¯´ï¼Œæˆ‘ä»¬å»ºç«‹ä¸€ä¸ªæ•°å­—å’Œæœ€ç»ˆæ•°å­—ä¹‹é—´æ˜ å°„ã€‚è¿™æ¯”å¬èµ·æ¥æ›´ä»¤äººå…´å¥‹ã€‚æˆ‘ä¿è¯ï¼Œæˆ‘ä»¬å¾ˆå¿«å°±ä¼šå›åˆ°è¿™ä¸ªé—®é¢˜ä¸Šã€‚

è¿™æ ·è¿›è¡Œå‡½æ•°åŒ…è£…æ˜¯åˆæ³•çš„ç­–ç•¥ã€‚æˆ‘ä»¬å¯ä»¥ä¸€ç›´èº²åœ¨å‡½æ•°åé¢ï¼Œæƒ³èº²å¤šä¹…å°±èº²å¤šä¹…ã€‚åªè¦æˆ‘ä»¬ä¸è°ƒç”¨è¿™äº›å‡½æ•°ï¼Œå®ƒä»¬ç†è®ºä¸Šéƒ½æ˜¯çº¯çš„ã€‚æ²¡æœ‰äººå‘åŠ¨æˆ˜äº‰ã€‚åœ¨å¸¸è§„ï¼ˆéæ ¸ï¼‰ä»£ç ä¸­ï¼Œæˆ‘ä»¬å®é™…ä¸Šæœ€ç»ˆå¸Œæœ›å¾—åˆ°é‚£äº›å‰¯ä½œç”¨èƒ½å¤Ÿè¿è¡Œã€‚å°†æ‰€æœ‰ä¸œè¥¿åŒ…è£…åœ¨ä¸€ä¸ªå‡½æ•°ä¸­å¯ä»¥è®©æˆ‘ä»¬ç²¾ç¡®åœ°æ§åˆ¶è¿™äº›æ•ˆæœã€‚æˆ‘ä»¬å†³å®šè¿™äº›å‰¯ä½œç”¨å‘ç”Ÿçš„ç¡®åˆ‡æ—¶é—´ã€‚ä½†æ˜¯ï¼Œè¾“å…¥é‚£äº›æ‹¬å·å¾ˆç—›è‹¦ã€‚åˆ›å»ºæ¯ä¸ªå‡½æ•°çš„æ–°ç‰ˆæœ¬å¾ˆçƒ¦äººã€‚æˆ‘ä»¬åœ¨è¯­è¨€ä¸­å†…ç½®äº†ä¸€äº›éå¸¸å¥½çš„å‡½æ•°ï¼Œæ¯”å¦‚ `Math.sqrt()`ã€‚å¦‚æœæœ‰ä¸€ç§æ–¹æ³•å¯ä»¥ç”¨å»¶è¿Ÿå€¼æ¥ä½¿ç”¨è¿™äº›æ™®é€šå‡½æ•°å°±å¥½äº†ã€‚è¿›å…¥ä¸‹ä¸€èŠ‚ Effect å‡½å­ã€‚

## Effect å‡½å­

å°±æˆ‘ä»¬çš„ç›®çš„è€Œè¨€ï¼ŒEffect å‡½å­åªä¸è¿‡æ˜¯ä¸€ä¸ªè¢«ç½®å…¥å»¶è¿Ÿå‡½æ•°çš„å¯¹è±¡ã€‚æˆ‘ä»¬å°†æŠŠ `fZero` å‡½æ•°ç½®å…¥åˆ°ä¸€ä¸ª Effect å¯¹è±¡ä¸­ã€‚ä½†æ˜¯ï¼Œåœ¨æˆ‘ä»¬è¿™æ ·åšä¹‹å‰ï¼Œè®©æˆ‘ä»¬æŠŠéš¾åº¦é™ä½ä¸€ä¸ªç­‰çº§

```js
// zero :: () -> Number
function fZero() {
  console.log("Starting with nothing");
  // ç»å¯¹ä¸ä¼šåœ¨è¿™é‡Œå‘åŠ¨æ ¸æ‰“å‡»ã€‚
  // ä½†æ˜¯è¿™ä¸ªå‡½æ•°ä»ç„¶ä¸çº¯
  return 0;
}
```

ç°åœ¨æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªè¿”å› Effect å¯¹è±¡çš„æ„é€ å‡½æ•°

```js
// Effect :: Function -> Effect
function Effect(f) {
  return {};
}
```

åˆ°ç›®å‰ä¸ºæ­¢ï¼Œè¿˜æ²¡æœ‰ä»€ä¹ˆå¯çœ‹çš„ã€‚è®©æˆ‘ä»¬åšä¸€äº›æœ‰ç”¨çš„äº‹æƒ…ã€‚æˆ‘ä»¬å¸Œæœ›é…åˆ Effetct ä½¿ç”¨å¸¸è§„çš„ `fZero()` å‡½æ•°ã€‚æˆ‘ä»¬å°†ç¼–å†™ä¸€ä¸ªæ¥æ”¶å¸¸è§„å‡½æ•°å¹¶å»¶åè¿”å›å€¼çš„æ–¹æ³•ï¼Œå®ƒè¿è¡Œæ—¶ä¸è§¦å‘ä»»ä½•æ•ˆæœã€‚æˆ‘ä»¬ç§°ä¹‹ä¸º `map`ã€‚è¿™æ˜¯å› ä¸ºå®ƒåœ¨å¸¸è§„å‡½æ•°å’Œ Effect å‡½æ•°ä¹‹é—´åˆ›å»ºäº†ä¸€ä¸ª _æ˜ å°„_ã€‚å®ƒå¯èƒ½çœ‹èµ·æ¥åƒè¿™æ ·ï¼š

```js
// Effect :: Function -> Effect
function Effect(f) {
  return {
    map(g) {
      return Effect(x => g(f(x)));
    }
  };
}
```

ç°åœ¨ï¼Œå¦‚æœä½ è§‚å¯Ÿä»”ç»†çš„è¯ï¼Œä½ å¯èƒ½æƒ³çŸ¥é“ `map()` çš„ä½œç”¨ã€‚å®ƒçœ‹èµ·æ¥åƒæ˜¯ç»„åˆã€‚æˆ‘ä»¬ç¨åä¼šè®²åˆ°ã€‚ç°åœ¨ï¼Œè®©æˆ‘ä»¬å°è¯•ä¸€ä¸‹ï¼š

```js
const zero = Effect(fZero);
const increment = x => x + 1; // ä¸€ä¸ªæ™®é€šçš„å‡½æ•°ã€‚
const one = zero.map(increment);
```

å—¯ã€‚æˆ‘ä»¬å¹¶æ²¡æœ‰çœ‹åˆ°å‘ç”Ÿäº†ä»€ä¹ˆã€‚è®©æˆ‘ä»¬ä¿®æ”¹ä¸€ä¸‹ Effectï¼Œè¿™æ ·æˆ‘ä»¬å°±æœ‰äº†åŠæ³•æ¥â€œæ‰£åŠ¨æ‰³æœºâ€ã€‚å¯ä»¥è¿™å†™:

```js
// Effect :: Function -> Effect
function Effect(f) {
  return {
    map(g) {
      return Effect(x => g(f(x)));
    },
    runEffects(x) {
      return f(x);
    }
  };
}

const zero = Effect(fZero);
const increment = x => x + 1; // åªæ˜¯ä¸€ä¸ªæ™®é€šçš„å‡½æ•°
const one = zero.map(increment);

one.runEffects();
// â¦˜ ä»€ä¹ˆä¹Ÿæ²¡å¯åŠ¨
// ï¿© 1
```

å¹¶ä¸”åªè¦æˆ‘ä»¬æ„¿æ„, æˆ‘ä»¬å¯ä»¥ä¸€ç›´è°ƒç”¨ `map` å‡½æ•°:

```js
const double = x => x * 2;
const cube = x => Math.pow(x, 3);
const eight = Effect(fZero)
  .map(increment)
  .map(double)
  .map(cube);

eight.runEffects();
// â¦˜ ä»€ä¹ˆä¹Ÿæ²¡å¯åŠ¨
// ï¿© 8
```

ä»è¿™é‡Œå¼€å§‹å˜å¾—æœ‰æ„æ€äº†ã€‚æˆ‘ä»¬ç§°è¿™ä¸ºå‡½å­ï¼Œè¿™æ„å‘³ç€ Effect æœ‰ä¸€ä¸ª `map` å‡½æ•°ï¼Œå®ƒ [éµå¾ªä¸€äº›è§„åˆ™](https://github.com/fantasyland/fantasy-land#functor)ã€‚è¿™äº›è§„åˆ™å¹¶ä¸æ„å‘³ç€ä½ ä¸èƒ½è¿™æ ·åšã€‚å®ƒä»¬æ˜¯ä½ å¯ä»¥åšçš„è§„åˆ™ã€‚å®ƒä»¬æ›´åƒæ˜¯ä¼˜å…ˆçº§ã€‚å› ä¸º Effect æ˜¯å‡½å­å¤§å®¶åº­çš„ä¸€ä»½å­ï¼Œæ‰€ä»¥å®ƒå¯ä»¥åšä¸€äº›äº‹æƒ…ï¼Œå…¶ä¸­ä¸€ä¸ªå«åšâ€œåˆæˆè§„åˆ™â€ã€‚å®ƒé•¿è¿™æ ·ï¼š

å¦‚æœæˆ‘ä»¬æœ‰ä¸€ä¸ª Effect `e`, ä¸¤ä¸ªå‡½æ•° `f` å’Œ `g`  
é‚£ä¹ˆ `e.map(g).map(f)` ç­‰åŒäº `e.map(x => f(g(x)))`ã€‚

æ¢å¥è¯è¯´ï¼Œä¸€è¡Œå†™ä¸¤ä¸ª `map` å‡½æ•°ç­‰åŒäºç»„åˆè¿™ä¸¤ä¸ªå‡½æ•°ã€‚ä¹Ÿå°±æ˜¯è¯´ Effect å¯ä»¥è¿™æ ·å†™ï¼ˆå›é¡¾ä¸€ä¸‹ä¸Šé¢çš„ä¾‹å­ï¼‰ï¼š

```js
const incDoubleCube = x => cube(double(increment(x)));
// å¦‚æœä½ ä½¿ç”¨åƒ Ramda æˆ–è€… lodash/fp ä¹‹ç±»çš„åº“ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥è¿™æ ·å†™ï¼š
// const incDoubleCube = compose(cube, double, increment);
const eight = Effect(fZero).map(incDoubleCube);
```

å½“æˆ‘ä»¬è¿™æ ·åšçš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥ç¡®è®¤ä¼šå¾—åˆ°ä¸ä¸‰é‡ `map` ç‰ˆæœ¬ç›¸åŒçš„ç»“æœã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å®ƒé‡æ„ä»£ç ï¼Œå¹¶ç¡®ä¿¡ä»£ç ä¸ä¼šå´©æºƒã€‚åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ç”šè‡³å¯ä»¥é€šè¿‡åœ¨ä¸åŒæ–¹æ³•ä¹‹é—´è¿›è¡Œäº¤æ¢æ¥æ”¹è¿›æ€§èƒ½ã€‚

ä½†è¿™äº›ä¾‹å­å·²ç»è¶³å¤Ÿäº†ï¼Œè®©æˆ‘ä»¬å¼€å§‹å®æˆ˜å§ã€‚

### Effect ç®€å†™

æˆ‘ä»¬çš„ Effect æ„é€ å‡½æ•°æ¥å—ä¸€ä¸ªå‡½æ•°ä½œä¸ºå®ƒçš„å‚æ•°ã€‚è¿™å¾ˆæ–¹ä¾¿ï¼Œå› ä¸ºå¤§å¤šæ•°æˆ‘ä»¬æƒ³è¦å»¶è¿Ÿçš„å‰¯ä½œç”¨ä¹Ÿæ˜¯å‡½æ•°ã€‚ä¾‹å¦‚ï¼Œ`Math.random()` å’Œ `console.log()` éƒ½æ˜¯è¿™ç§ç±»å‹çš„ä¸œè¥¿ã€‚ä½†æœ‰æ—¶æˆ‘ä»¬æƒ³æŠŠä¸€ä¸ªæ™®é€šçš„æ—§å€¼å‹ç¼©æˆä¸€ä¸ª Effectã€‚ä¾‹å¦‚ï¼Œå‡è®¾æˆ‘ä»¬åœ¨æµè§ˆå™¨çš„ `window` å…¨å±€å¯¹è±¡ä¸­é™„åŠ äº†æŸç§é…ç½®å¯¹è±¡ã€‚æˆ‘ä»¬æƒ³è¦å¾—åˆ°ä¸€ä¸ª a çš„å€¼ï¼Œä½†è¿™ä¸æ˜¯ä¸€ä¸ªçº¯ç²¹çš„è¿ç®—ã€‚æˆ‘ä»¬å¯ä»¥å†™ä¸€ä¸ªå°çš„ç®€å†™ï¼Œä½¿è¿™ä¸ªä»»åŠ¡æ›´å®¹æ˜“ï¼š[3](#fn:3 "see footnote")

```js
// of :: a -> Effect a
Effect.of = function of(val) {
  return Effect(() => val);
};
```

ä¸ºäº†è¯´æ˜è¿™å¯èƒ½ä¼šå¾ˆæ–¹ä¾¿ï¼Œå‡è®¾æˆ‘ä»¬æ­£åœ¨å¤„ç†ä¸€ä¸ª web åº”ç”¨ã€‚è¿™ä¸ªåº”ç”¨æœ‰ä¸€äº›æ ‡å‡†ç‰¹æ€§ï¼Œæ¯”å¦‚æ–‡ç« åˆ—è¡¨å’Œç”¨æˆ·ç®€ä»‹ã€‚ä½†æ˜¯åœ¨ HTML ä¸­ï¼Œè¿™äº›ç»„ä»¶é’ˆå¯¹ä¸åŒçš„å®¢æˆ·è¿›è¡Œå±•ç¤ºã€‚å› ä¸ºæˆ‘ä»¬æ˜¯èªæ˜çš„å·¥ç¨‹å¸ˆï¼Œæ‰€ä»¥æˆ‘ä»¬å†³å®šå°†ä»–ä»¬çš„ä½ç½®å­˜å‚¨åœ¨ä¸€ä¸ªå…¨å±€é…ç½®å¯¹è±¡ä¸­ï¼Œè¿™æ ·æˆ‘ä»¬æ€»èƒ½æ‰¾åˆ°å®ƒä»¬ã€‚ä¾‹å¦‚ï¼š

```js
window.myAppConf = {
  selectors: {
    "user-bio": ".userbio",
    "article-list": "#articles",
    "user-name": ".userfullname"
  },
  templates: {
    greet: "Pleased to meet you, {name}",
    notify: "You have {n} alerts"
  }
};
```

ç°åœ¨ä½¿ç”¨ `Effect.of()`ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆå¿«åœ°æŠŠæˆ‘ä»¬æƒ³è¦çš„å€¼åŒ…è£…è¿›ä¸€ä¸ª Effect å®¹å™¨, å°±åƒè¿™æ ·

```js
const win = Effect.of(window);
userBioLocator = win.map(x => x.myAppConf.selectors["user-bio"]);
// ï¿© Effect('.userbio')
```

### å†…åµŒ ä¸ éå†…åµŒ Effect

æ˜ å°„ Effect å¯èƒ½èŠ±äº†æˆ‘ä»¬æ¯”è¾ƒå¤šçš„ç²¾åŠ›ã€‚ä½†æ˜¯æœ‰æ—¶å€™æˆ‘ä»¬ä¼šé‡åˆ°æ˜ å°„çš„å‡½æ•°ä¹Ÿè¿”å›ä¸€ä¸ª Effect çš„æƒ…å†µã€‚æˆ‘ä»¬å·²ç»å®šä¹‰äº†ä¸€ä¸ª `getElementLocator()`, å®ƒè¿”å›ä¸€ä¸ªåŒ…å«å­—ç¬¦ä¸²çš„ Effectã€‚å¦‚æœæˆ‘ä»¬çœŸçš„æƒ³è¦æ‹¿åˆ° DOM å…ƒç´ ï¼Œæˆ‘ä»¬éœ€è¦è°ƒç”¨å¦å¤–ä¸€ä¸ªéçº¯å‡½æ•° `document.querySelector()`ã€‚æ‰€ä»¥æˆ‘ä»¬å¯èƒ½ä¼šé€šè¿‡è¿”å›ä¸€ä¸ª Effect æ¥çº¯åŒ–å®ƒï¼š

```js
// $ :: String -> Effect DOMElement
function $(selector) {
  return Effect.of(document.querySelector(s));
}
```

ç°åœ¨å¦‚æœæƒ³æŠŠå®ƒä¸¤æ”¾ä¸€èµ·ï¼Œæˆ‘ä»¬å¯ä»¥å°è¯•ä½¿ç”¨ `map()`ï¼š

```js
const userBio = userBioLocator.map($);
// ï¿© Effect(Effect(<div>))
```

æƒ³è¦çœŸæ­£è¿ä½œèµ·æ¥è¿˜æœ‰ç‚¹å°´å°¬ã€‚å¦‚æœæˆ‘ä»¬æƒ³è¦è®¿é—®é‚£ä¸ª divï¼Œæˆ‘ä»¬å¿…é¡»ç”¨ä¸€ä¸ªå‡½æ•°æ¥æ˜ å°„æˆ‘ä»¬æƒ³è¦åšçš„äº‹æƒ…ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæˆ‘ä»¬æƒ³è¦å¾—åˆ° `innerHTML`ï¼Œå®ƒçœ‹èµ·æ¥æ˜¯è¿™æ ·çš„ï¼š

```js
const innerHTML = userBio.map(eff => eff.map(domEl => domEl.innerHTML));
// ï¿© Effect(Effect('<h2>User Biography</h2>'))
```

è®©æˆ‘ä»¬è¯•ç€åˆ†è§£ã€‚æˆ‘ä»¬ä¼šå›åˆ° `userBio`ï¼Œç„¶åç»§ç»­ã€‚è¿™æœ‰ç‚¹ä¹å‘³ï¼Œä½†æˆ‘ä»¬æƒ³å¼„æ¸…æ¥šè¿™é‡Œå‘ç”Ÿäº†ä»€ä¹ˆã€‚æˆ‘ä»¬ä½¿ç”¨çš„æ ‡è®° `Effect('user-bio')` æœ‰ç‚¹è¯¯å¯¼äººã€‚å¦‚æœæˆ‘ä»¬æŠŠå®ƒå†™æˆä»£ç ï¼Œå®ƒçœ‹èµ·æ¥æ›´åƒè¿™æ ·ï¼š

```js
Effect(() => ".userbio");
```

ä½†è¿™ä¹Ÿä¸å‡†ç¡®ã€‚æˆ‘ä»¬çœŸæ­£åšçš„æ˜¯ï¼š

```js
Effect(() => window.myAppConf.selectors["user-bio"]);
```

ç°åœ¨ï¼Œå½“æˆ‘ä»¬è¿›è¡Œæ˜ å°„æ—¶ï¼Œå®ƒå°±ç›¸å½“äºå°†å†…éƒ¨å‡½æ•°ä¸å¦ä¸€ä¸ªå‡½æ•°ç»„åˆï¼ˆæ­£å¦‚æˆ‘ä»¬åœ¨ä¸Šé¢çœ‹åˆ°çš„ï¼‰ã€‚æ‰€ä»¥å½“æˆ‘ä»¬ç”¨ `$` æ˜ å°„æ—¶ï¼Œå®ƒçœ‹èµ·æ¥åƒè¿™æ ·ï¼š

```js
Effect(() => window.myAppConf.selectors["user-bio"]);
```

æŠŠå®ƒå±•å¼€å¾—åˆ°:

```js
Effect(
  () => Effect.of(document.querySelector(window.myAppConf.selectors['user-bio'])))
);
```

å±•å¼€ `Effect.of` ç»™æˆ‘ä»¬ä¸€ä¸ªæ›´æ¸…æ™°çš„æ¦‚è§ˆï¼š

```js
Effect(() =>
  Effect(() => document.querySelector(window.myAppConf.selectors["user-bio"]))
);
```

æ³¨æ„: æ‰€æœ‰å®é™…æ‰§è¡Œæ“ä½œçš„ä»£ç éƒ½åœ¨æœ€é‡Œé¢çš„å‡½æ•°ä¸­ï¼Œè¿™äº›éƒ½æ²¡æœ‰æ³„éœ²åˆ°å¤–éƒ¨çš„ Effectã€‚

#### Join

ä¸ºä»€ä¹ˆè¦è¿™æ ·æ‹¼å†™å‘¢? å¥½å§, æˆ‘ä»¬æƒ³è¦è¿™äº›å†…åµŒçš„ Effect å˜æˆéå†…åµŒçš„å½¢å¼ã€‚å¯¹äº Effect è€Œè¨€, ä¸å†…åµŒçš„æ–¹å¼å°±æ˜¯åœ¨å¤–éƒ¨å‡½æ•°è°ƒç”¨ `.runEffects()`ã€‚ ä½†è¿™å¯èƒ½ä¼šè®©äººå›°æƒ‘ã€‚æˆ‘ä»¬å·²ç»å®Œæˆäº†æ•´ä¸ªç»ƒä¹ ï¼Œä»¥æ£€æŸ¥æˆ‘ä»¬ä¸ä¼šè¿è¡Œä»»ä½• Effectã€‚æˆ‘ä»¬ä¼šåˆ›å»ºå¦ä¸€ä¸ªå‡½æ•°åšåŒæ ·çš„äº‹æƒ…ï¼Œå¹¶å°†å…¶å‘½åä¸º `join`ã€‚æˆ‘ä»¬ä½¿ç”¨ `join` æ¥è§£å†³ Effect å†…åµŒçš„é—®é¢˜ï¼Œä½¿ç”¨ `runEffects()` çœŸæ­£è¿è¡Œæ‰€æœ‰ Effectã€‚è¿™ä½¿æˆ‘ä»¬çš„æ„å›¾æ›´åŠ æ¸…æ™°ï¼Œå³ä½¿æˆ‘ä»¬è¿è¡Œçš„ä»£ç æ˜¯ç›¸åŒçš„ã€‚

```js
// Effect :: Function -> Effect
function Effect(f) {
  return {
    map(g) {
        return Effect(x => g(f(x)));
    },
    runEffects(x) {
        return f(x);
    }
    join(x) {
        return f(x);
    }
  }
}
```

ç„¶åï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å®ƒæ¥è§£å†…åµŒæˆ‘ä»¬ç”¨æˆ·ç®€ä»‹å…ƒç´ :

```js
const userBioHTML = Effect.of(window)
  .map(x => x.myAppConf.selectors["user-bio"])
  .map($)
  .join()
  .map(x => x.innerHTML);
// ï¿© Effect('<h2>User Biography</h2>')
```

#### Chain

`.map()` ä¹‹åç´§è·Ÿ `.join()` è¿™ç§æ¨¡å¼ç»å¸¸å‡ºç°ã€‚äº‹å®ä¸Šï¼Œæœ‰ä¸€ä¸ªç®€å†™å‡½æ•°æ˜¯å¾ˆæ–¹ä¾¿çš„ã€‚è¿™æ ·ï¼Œæ— è®ºä½•æ—¶æˆ‘ä»¬æœ‰ä¸€ä¸ªè¿”å› Effect çš„å‡½æ•°ï¼Œæˆ‘ä»¬éƒ½å¯ä»¥ä½¿ç”¨è¿™ä¸ªç®€å†™å‡½æ•°ã€‚å®ƒå¯ä»¥æŠŠæˆ‘ä»¬ä»ä¸€éåˆä¸€éåœ°å†™ `map` ç„¶åç´§è·Ÿ `join` ä¸­è§£æ•‘å‡ºæ¥ã€‚æˆ‘ä»¬è¿™æ ·å†™ï¼š

```js
// Effect :: Function -> Effect
function Effect(f) {
    return {
        map(g) {
            return Effect(x => g(f(x)));
        },
        runEffects(x) {
            return f(x);
        }
        join(x) {
            return f(x);
        }
        chain(g) {
            return Effect(f).map(g).join();
        }
    }
}
```

æˆ‘ä»¬è°ƒç”¨æ–°çš„å‡½æ•° `chain()` å› ä¸ºå®ƒå…è®¸æˆ‘ä»¬æŠŠ Effect é“¾æ¥åˆ°ä¸€èµ·ã€‚ï¼ˆå…¶å®ä¹Ÿæ˜¯å› ä¸ºæ ‡å‡†å‘Šè¯‰æˆ‘ä»¬å¯ä»¥è¿™æ ·è°ƒç”¨å®ƒï¼‰ã€‚[4](#fn:4 "see footnote")å–åˆ°ç”¨æˆ·ç®€ä»‹å…ƒç´ çš„ `innerHTML` å¯èƒ½é•¿è¿™æ ·ï¼š

```js
const userBioHTML = Effect.of(window)
  .map(x => x.myAppConf.selectors["user-bio"])
  .chain($)
  .map(x => x.innerHTML);
// ï¿© Effect('<h2>User Biography</h2>')
```

ä¸å¹¸çš„æ˜¯, å¯¹äºè¿™ä¸ªå®ç°å…¶ä»–å‡½æ•°å¼è¯­è¨€æœ‰ç€ä¸€äº›ä¸åŒçš„åå­—ã€‚å¦‚æœä½ è¯»åˆ°å®ƒï¼Œä½ å¯èƒ½ä¼šæœ‰ç‚¹ç–‘æƒ‘ã€‚æœ‰æ—¶å€™å®ƒè¢«ç§°ä¹‹ä¸º `flatMap`ï¼Œè¿™ä¸ªåå­—å¾ˆæœ‰æ„ä¹‰ï¼Œå› ä¸ºæˆ‘ä»¬å…ˆè¿›è¡Œä¸€ä¸ªæ™®é€šçš„æ˜ å°„ï¼Œç„¶åä½¿ç”¨ `.join()` æ‰å¹³åŒ–ç»“æœã€‚ ä¸è¿‡åœ¨ Haskell ä¸­ï¼Œ`chain` è¢«èµ‹äºˆäº†ä¸€ä¸ªä»¤äººç–‘æƒ‘çš„åå­— `bind`ã€‚æ‰€ä»¥å¦‚æœä½ åœ¨å…¶ä»–åœ°æ–¹è¯»åˆ°çš„è¯ï¼Œè®°ä½ `chain`ï¼Œ`flatMap` å’Œ `bind`å…¶å®æ˜¯åŒä¸€æ¦‚å¿µçš„å¼•ç”¨ã€‚

### ç»“åˆ Effect

è¿™æ˜¯æœ€åä¸€ä¸ªä½¿ç”¨ Effect æœ‰ç‚¹å°´å°¬çš„åœºæ™¯ï¼Œæˆ‘ä»¬æƒ³è¦åœ¨ä¸€ä¸ªå‡½æ•°ä¸­ç»„åˆä¸¤ä¸ªæˆ–è€…å¤šä¸ªå‡½å­ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæˆ‘ä»¬è¦ä» DOM ä¸­æ‹¿åˆ°ç”¨æˆ·çš„åå­—è¦æ€ä¹ˆåšï¼Ÿç„¶åæ ¹æ®æˆ‘çš„åº”ç”¨è®¾ç½®æ’å…¥ä¸€ä¸ªæ¨¡æ¿å‘¢ï¼Ÿå› æ­¤ï¼Œæˆ‘ä»¬å¯èƒ½æœ‰ä¸€ä¸ªæ¨¡æ¿å‡½æ•°ï¼ˆæ³¨æ„æˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªç§‘é‡ŒåŒ–ç‰ˆæœ¬çš„å‡½æ•°ï¼‰

```js
// tpl :: String -> Object -> String
const tpl = curry(function tpl(pattern, data) {
    return Object.keys(data).reduce(
        (str, key) => str.replace(new RegExp(`{${key}}`, data[key]),
        pattern
    );
});
```

ä¸€åˆ‡éƒ½å¾ˆæ­£å¸¸ï¼Œä½†æ˜¯ç°åœ¨æ¥è·å–æˆ‘ä»¬éœ€è¦çš„æ•°æ®ï¼š

```js
const win = Effect.of(window);
const name = win.map(w => w.myAppConfig.selectors['user-name'])
    .chain($)
    .map(el => el.innerHTML)
    .map(str => ({name: str});
// ï¿© Effect({name: 'Mr. Hatter'});

const pattern = win.map(w => w.myAppConfig.templates('greeting'));
// ï¿© Effect('Pleased to meet you, {name}');
```

æˆ‘ä»¬å·²ç»æœ‰ä¸€ä¸ªæ¨¡æ¿å‡½æ•°äº†ã€‚å®ƒæ¥æ”¶ä¸€ä¸ªå­—ç¬¦ä¸²å’Œä¸€ä¸ªå¯¹è±¡å¹¶ä¸”è¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²ã€‚ä½†æ˜¯æˆ‘ä»¬çš„å­—ç¬¦ä¸²å’Œå¯¹è±¡ï¼ˆ`name` å’Œ `pattern`ï¼‰å·²ç»åŒ…è£…åˆ° Effect é‡Œäº†ã€‚æˆ‘ä»¬æ‰€è¦åšçš„å°±æ˜¯æå‡æˆ‘ä»¬ `tpl()` å‡½æ•°åˆ°æ›´é«˜çš„åœ°æ–¹ä½¿å¾—å®ƒèƒ½å¾ˆå¥½åœ°ä¸ Effect å·¥ä½œã€‚

è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹å¦‚æœæˆ‘ä»¬åœ¨ pattern Effect ä¸Šç”¨ `map()` è°ƒç”¨ `tpl()` ä¼šå‘ç”Ÿä»€ä¹ˆï¼š

```js
pattern.map(tpl);
// ï¿© Effect([Function])
```

å¯¹ç…§ä¸€ä¸‹ç±»å‹å¯èƒ½ä¼šä½¿å¾—äº‹æƒ…æ›´åŠ æ¸…æ™°ä¸€ç‚¹ã€‚map çš„ç±»å‹ç­¾åå¯èƒ½é•¿è¿™æ ·ï¼š

    _map :: Effect a ~> (a -> b) -> Effect b_

æ¨¡æ¿å‡½æ•°æ˜¯è¿™æ ·çš„ç­¾åï¼š

    _tpl :: String -> Object -> String_

å› æ­¤ï¼Œå½“æˆ‘ä»¬åœ¨ `pattern` ä¸Šè°ƒç”¨ `map`, æˆ‘ä»¬åœ¨ Effect å†…éƒ¨å¾—åˆ°äº†ä¸€ä¸ª _ååº”ç”¨_ å‡½æ•°ï¼ˆè®°ä½æˆ‘ä»¬ç§‘é‡ŒåŒ–è¿‡ `tpl`ï¼‰ã€‚

    _Effect (Object -> String)_

ç°åœ¨æˆ‘ä»¬æƒ³ä» pattern Effect å†…éƒ¨ä¼ é€’å€¼ï¼Œä½†æˆ‘ä»¬è¿˜æ²¡æœ‰åŠæ³•åšåˆ°ã€‚æˆ‘ä»¬å°†ç¼–å†™å¦ä¸€ä¸ª Effect æ–¹æ³•ï¼ˆç§°ä¸º `ap()`ï¼‰æ¥å¤„ç†è¿™ä¸ªé—®é¢˜ï¼š

```js
// Effect :: Function -> Effect
function Effect(f) {
    return {
        map(g) {
            return Effect(x => g(f(x)));
        },
        runEffects(x) {
            return f(x);
        }
        join(x) {
            return f(x);
        }
        chain(g) {
            return Effect(f).map(g).join();
        }
        ap(eff) {
            // å¦‚æœæœ‰äººè°ƒç”¨äº† apï¼Œæˆ‘ä»¬å‡å®š eff æœ‰ä¸€ä¸ªå‡½æ•°è€Œä¸æ˜¯ä¸€ä¸ªå€¼åœ¨é‡Œé¢ã€‚
            // æˆ‘ä»¬å°†ç”¨ map æ¥è¿›å…¥ eff å†…éƒ¨, å¹¶ä¸”è®¿é—®é‚£ä¸ªå‡½æ•°
            // ä¸€æ—¦æˆ‘ä»¬å¾—åˆ°äº† gï¼Œæˆ‘ä»¬å°±å¯¹å®ƒåº”ç”¨ f() é‡Œé¢çš„å€¼
            return eff.map(g => g(f()));
        }
    }
}
```

æœ‰äº†å®ƒï¼Œæˆ‘ä»¬å¯ä»¥è¿è¡Œ `.ap()` æ¥åº”ç”¨æˆ‘ä»¬çš„æ¨¡æ¿å‡½æ•°ï¼š

```js
const win = Effect.of(window);
const name = win
  .map(w => w.myAppConfig.selectors["user-name"])
  .chain($)
  .map(el => el.innerHTML)
  .map(str => ({ name: str }));

const pattern = win.map(w => w.myAppConfig.templates("greeting"));

const greeting = name.ap(pattern.map(tpl));
// ï¿© Effect('Pleased to meet you, Mr Hatter')
```

æˆ‘ä»¬å·²ç»å®ç°æˆ‘ä»¬çš„ç›®æ ‡ã€‚ä½†æœ‰ä¸€ç‚¹æˆ‘è¦æ‰¿è®¤ï¼Œæˆ‘å‘ç° `ap()` æœ‰æ—¶ä¼šè®©äººæ„Ÿåˆ°å›°æƒ‘ã€‚å¾ˆéš¾è®°ä½æˆ‘å¿…é¡»å…ˆæ˜ å°„å‡½æ•°ï¼Œç„¶åå†è¿è¡Œ `ap()`ã€‚ç„¶åæˆ‘å¯èƒ½ä¼šå¿˜äº†å‚æ•°çš„é¡ºåºã€‚ä½†æ˜¯æœ‰ä¸€ç§æ–¹æ³•å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚å¤§å¤šæ•°æ—¶å€™ï¼Œæˆ‘æƒ³åšçš„æ˜¯æŠŠä¸€ä¸ªæ™®é€šå‡½æ•°æå‡åˆ°åº”ç”¨ç¨‹åºçš„ä¸–ç•Œã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘å·²ç»æœ‰äº†ç®€å•çš„å‡½æ•°ï¼Œæˆ‘æƒ³è®©å®ƒä»¬ä¸å…·æœ‰ `.ap()` æ–¹æ³•çš„ Effect ä¸€èµ·å·¥ä½œã€‚æˆ‘ä»¬å¯ä»¥å†™ä¸€ä¸ªå‡½æ•°æ¥åšè¿™ä¸ªï¼š

```js
// liftA2 :: (a -> b -> c) -> (Applicative a -> Applicative b -> Applicative c)
const liftA2 = curry(function liftA2(f, x, y) {
  return y.ap(x.map(f));
  // æˆ‘ä»¬ä¹Ÿå¯ä»¥è¿™æ ·å†™ï¼š
  //  return x.map(f).chain(g => y.map(g));
});
```

æˆ‘ä»¬ç§°å®ƒä¸º `liftA2()` å› ä¸ºå®ƒä¼šæå‡ä¸€ä¸ªæ¥å—ä¸¤ä¸ªå‚æ•°çš„å‡½æ•°. æˆ‘ä»¬å¯ä»¥å†™ä¸€ä¸ªä¸ä¹‹ç›¸ä¼¼çš„ `liftA3()`, åƒè¿™æ ·:

```js
// liftA3 :: (a -> b -> c -> d) -> (Applicative a -> Applicative b -> Applicative c -> Applicative d)
const liftA3 = curry(function liftA3(f, a, b, c) {
  return c.ap(b.ap(a.map(f)));
});
```

æ³¨æ„ï¼Œ`liftA2` å’Œ `liftA3` ä»æ¥æ²¡æœ‰æåˆ° Effectã€‚ç†è®ºä¸Šï¼Œå®ƒä»¬å¯ä»¥ä¸ä»»ä½•å…·æœ‰å…¼å®¹ `ap()` æ–¹æ³•çš„å¯¹è±¡ä¸€èµ·å·¥ä½œã€‚
ä½¿ç”¨ `liftA2()` æˆ‘ä»¬å¯ä»¥åƒä¸‹é¢è¿™æ ·é‡å†™ä¹‹å‰çš„ä¾‹å­ï¼š

```js
const win = Effect.of(window);
const user = win.map(w => w.myAppConfig.selectors['user-name'])
    .chain($)
    .map(el => el.innerHTML)
    .map(str => ({name: str});

const pattern = win.map(w => w.myAppConfig.templates['greeting']);

const greeting = liftA2(tpl)(pattern, user);
// ï¿© Effect('Pleased to meet you, Mr Hatter')
```

## é‚£åˆæ€æ ·?

è¿™æ—¶å€™ä½ å¯èƒ½ä¼šæƒ³ï¼šâ€œè¿™ä¼¼ä¹ä¸ºäº†é¿å…éšå¤„å¯è§çš„å¥‡æ€ªçš„å‰¯ä½œç”¨è€Œä»˜å‡ºäº†å¾ˆå¤šåŠªåŠ›â€ã€‚è¿™æœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿä¼ å…¥å‚æ•°åˆ° Effect å†…éƒ¨ï¼Œå°è£… `ap()` ä¼¼ä¹æ˜¯ä¸€é¡¹è‰°å·¨çš„å·¥ä½œã€‚å½“ä¸çº¯ä»£ç æ­£å¸¸å·¥ä½œæ—¶ï¼Œä¸ºä»€ä¹ˆè¿˜è¦çƒ¦æ¼å‘¢ï¼Ÿåœ¨å®é™…åœºæ™¯ä¸­ï¼Œä½ ä»€ä¹ˆæ—¶å€™ä¼šéœ€è¦è¿™ä¸ª?

> å‡½æ•°å¼ç¨‹åºå‘˜å¬èµ·æ¥æœ‰ç‚¹åƒä¸€ä¸ªè‹¦è¡Œåƒ§ï¼Œå¦è®¤è‡ªå·±çš„å¿«ä¹ç”Ÿæ´»ï¼Œå¸Œæœ›æ…ˆæ‚²ä¸ºæ€€ã€‚
>
> â€”John Hughes[5](#fn:5 "see footnote")

è®©æˆ‘ä»¬æŠŠè¿™äº›åå¯¹æ„è§åˆ†æˆä¸¤ä¸ªé—®é¢˜ï¼š

1.  å‡½æ•°çº¯åº¦çœŸçš„é‡è¦å—ï¼Ÿä»¥åŠ
2.  åœ¨çœŸå®åœºæ™¯ä¸­ä»€ä¹ˆæ—¶å€™æœ‰ç”¨ï¼Ÿ

### å‡½æ•°çº¯åº¦é‡è¦æ€§

å‡½æ•°çº¯åº¦çš„ç¡®é‡è¦ã€‚å½“ä½ å•ç‹¬è§‚å¯Ÿä¸€ä¸ªå°å‡½æ•°æ—¶ï¼Œä¸€ç‚¹ç‚¹çš„ä¸çº¯å¹¶ä¸é‡è¦ã€‚å†™`const pattern = window.myAppConfig.templates['greeting'];` æ¯”å†™ä¸‹é¢è¿™æ ·çš„ä»£ç æ›´åŠ å¿«é€Ÿç®€å•

```js
const pattern = Effect.of(window).map(w => w.myAppConfig.templates("greeting"));
```

å¦‚æœä½ æ‰€åšçš„ä¸€åˆ‡éƒ½æ˜¯æ˜¯å¯¹çš„, é‚£ä¹ˆå‰¯ä½œç”¨ä¸è¦ç´§ã€‚ä½†è¿™åªæ˜¯åº”ç”¨ç¨‹åºä¸­çš„ä¸€è¡Œä»£ç ï¼Œå…¶ä¸­å¯èƒ½åŒ…å«æ•°åƒç”šè‡³æ•°ç™¾ä¸‡è¡Œä»£ç ã€‚å½“ä½ è¯•å›¾å¼„æ¸…æ¥šä¸ºä»€ä¹ˆä½ çš„åº”ç”¨ç¨‹åºè«åå…¶å¦™åœ°â€œæ¯«æ— ç†ç”±â€åœ°åœæ­¢å·¥ä½œæ—¶ï¼Œå‡½æ•°çº¯åº¦å°±å˜å¾—æ›´åŠ é‡è¦äº†ã€‚å¦‚æœå‘ç”Ÿäº†ä¸€äº›æ„æƒ³ä¸åˆ°çš„äº‹ï¼Œä½ è¯•å›¾æŠŠé—®é¢˜åˆ†è§£å¼€æ¥ï¼Œæ‰¾å‡ºåŸå› ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¯ä»¥æ’é™¤çš„ä»£ç è¶Šå¤šè¶Šå¥½ã€‚å¦‚æœæ‚¨çš„å‡½æ•°æ˜¯çº¯çš„ï¼Œé‚£ä¹ˆæ‚¨å¯ä»¥ç¡®ä¿¡ï¼Œå½±å“å®ƒä»¬è¡Œä¸ºçš„å”¯ä¸€å› ç´ æ˜¯ä¼ é€’ç»™å®ƒçš„è¾“å…¥ã€‚è¿™å°±å¤§å¤§å‡å°‘äº†ä½ éœ€è¦è€ƒè™‘çš„äº‹æƒ…çš„æ•°é‡ã€‚æ¢å¥è¯è¯´ï¼Œå®ƒèƒ½è®©ä½ å°‘æ€è€ƒã€‚åœ¨å¤§å‹ã€å¤æ‚çš„åº”ç”¨ç¨‹åºä¸­å°¤ä¸ºé‡è¦ã€‚

### å®é™…åœºæ™¯ä¸­çš„ Effect æ¨¡å¼

å¥½å§ã€‚å¦‚æœä½ æ­£åœ¨æ„å»ºä¸€ä¸ªå¤§å‹çš„ã€å¤æ‚çš„åº”ç”¨ç¨‹åºï¼Œç±»ä¼¼ Facebook æˆ– Gmailã€‚é‚£ä¹ˆå‡½æ•°çº¯åº¦å¯èƒ½å¾ˆé‡è¦ã€‚ä½†å¦‚æœä½ ä¸è¿™ä¹ˆåšå‘¢ï¼Ÿè®©æˆ‘ä»¬è€ƒè™‘ä¸€ä¸ªè¶Šå‘æ™®éçš„åœºæ™¯ã€‚ä½ æœ‰ä¸€äº›æ•°æ®ã€‚ä¸åªæ˜¯ä¸€ç‚¹ç‚¹æ•°æ®ï¼Œè€Œæ˜¯å¤§é‡çš„æ•°æ® â€”â€” æ•°ç™¾ä¸‡è¡Œï¼Œåœ¨ CSV æ–‡æœ¬æ–‡ä»¶æˆ–å¤§å‹æ•°æ®åº“è¡¨ä¸­ã€‚ä½ çš„ä»»åŠ¡æ˜¯å¤„ç†è¿™äº›æ•°æ®ã€‚ä¹Ÿè®¸ä½ åœ¨è®­ç»ƒä¸€ä¸ªäººå·¥ç¥ç»ç½‘ç»œæ¥å»ºç«‹ä¸€ä¸ªæ¨ç†æ¨¡å‹ã€‚ä¹Ÿè®¸ä½ æ­£è¯•å›¾æ‰¾å‡ºåŠ å¯†è´§å¸çš„ä¸‹ä¸€ä¸ªå¤§åŠ¨å‘ã€‚æ— è®ºå¦‚ä½•, é—®é¢˜æ˜¯è¦å®Œæˆè¿™é¡¹å·¥ä½œéœ€è¦å¤§é‡çš„å¤„ç†å·¥ä½œã€‚

Joel Spolsky ä»¤äººä¿¡æœåœ°è®ºè¯è¿‡ [å‡½æ•°å¼ç¼–ç¨‹å¯ä»¥å¸®åŠ©æˆ‘ä»¬è§£å†³è¿™ä¸ªé—®é¢˜](https://www.joelonsoftware.com/2006/08/01/can-your-programming-language-do-this/)ã€‚æˆ‘ä»¬å¯ä»¥ç¼–å†™å¹¶è¡Œè¿è¡Œçš„ `map` å’Œ `reduce` çš„æ›¿ä»£ç‰ˆæœ¬ï¼Œè€Œå‡½æ•°çº¯åº¦ä½¿è¿™æˆä¸ºå¯èƒ½ã€‚ä½†è¿™å¹¶ä¸æ˜¯æ•…äº‹çš„ç»“å°¾ã€‚å½“ç„¶ï¼Œæ‚¨å¯ä»¥ç¼–å†™ä¸€äº›å¥‡ç‰¹çš„å¹¶è¡Œå¤„ç†ä»£ç ã€‚ä½†å³ä¾¿å¦‚æ­¤ï¼Œæ‚¨çš„å¼€å‘æœºå™¨ä»ç„¶åªæœ‰ 4 ä¸ªå†…æ ¸ï¼ˆå¦‚æœå¹¸è¿çš„è¯ï¼Œå¯èƒ½æ˜¯ 8 ä¸ªæˆ– 16 ä¸ªï¼‰ã€‚é‚£é¡¹å·¥ä½œä»ç„¶éœ€è¦å¾ˆé•¿æ—¶é—´ã€‚é™¤éï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä½ å¯ä»¥åœ¨ä¸€å †å¤„ç†å™¨ä¸Šè¿è¡Œå®ƒï¼Œæ¯”å¦‚ GPUï¼Œæˆ–è€…æ•´ä¸ªå¤„ç†æœåŠ¡å™¨é›†ç¾¤ã€‚

è¦ä½¿å…¶å·¥ä½œï¼Œæ‚¨éœ€è¦æè¿°æ‚¨æƒ³è¦è¿è¡Œçš„è®¡ç®—ã€‚ä½†æ˜¯ï¼Œæ‚¨éœ€è¦åœ¨ä¸å®é™…è¿è¡Œå®ƒä»¬çš„æƒ…å†µä¸‹æè¿°å®ƒä»¬ã€‚å¬èµ·æ¥æ˜¯ä¸æ˜¯å¾ˆç†Ÿæ‚‰ï¼Ÿç†æƒ³æƒ…å†µä¸‹ï¼Œæ‚¨åº”è¯¥å°†æè¿°ä¼ é€’ç»™æŸç§æ¡†æ¶ã€‚è¯¥æ¡†æ¶å°†å°å¿ƒåœ°è´Ÿè´£è¯»å–æ‰€æœ‰æ•°æ®ï¼Œå¹¶å°†å…¶åœ¨å¤„ç†èŠ‚ç‚¹ä¹‹é—´åˆ†å‰²ã€‚ç„¶åç›¸åŒçš„æ¡†æ¶ä¼šæŠŠç»“æœæ‹‰å›ä¸€èµ·ï¼Œå‘Šè¯‰ä½ å®ƒæ˜¯å¦‚ä½•è¿›è¡Œçš„ã€‚è¿™å°±æ˜¯ TensorFlow çš„å·¥ä½œæµç¨‹ã€‚

> TensorFlowâ„¢ æ˜¯ä¸€ä¸ªé‡‡ç”¨æ•°æ®æµå›¾ï¼ˆdata flow graphsï¼‰ï¼Œç”¨äºæ•°å€¼è®¡ç®—çš„å¼€æºè½¯ä»¶åº“ã€‚èŠ‚ç‚¹ï¼ˆNodesï¼‰åœ¨å›¾ä¸­è¡¨ç¤ºæ•°å­¦æ“ä½œï¼Œå›¾ä¸­çš„çº¿ï¼ˆedgesï¼‰åˆ™è¡¨ç¤ºåœ¨èŠ‚ç‚¹é—´ç›¸äº’è”ç³»çš„å¤šç»´æ•°æ®æ•°ç»„ï¼Œå³å¼ é‡ï¼ˆtensorï¼‰ã€‚å®ƒçµæ´»çš„æ¶æ„è®©ä½ å¯ä»¥åœ¨å¤šç§å¹³å°ä¸Šå±•å¼€è®¡ç®—ï¼Œä¾‹å¦‚å°å¼è®¡ç®—æœºä¸­çš„ä¸€ä¸ªæˆ–å¤šä¸ª CPUï¼ˆæˆ– GPUï¼‰ï¼ŒæœåŠ¡å™¨ï¼Œç§»åŠ¨è®¾å¤‡ç­‰ç­‰ã€‚TensorFlow æœ€åˆç”± Google å¤§è„‘å°ç»„ï¼ˆéš¶å±äº Google æœºå™¨æ™ºèƒ½ç ”ç©¶æœºæ„ï¼‰çš„ç ”ç©¶å‘˜å’Œå·¥ç¨‹å¸ˆä»¬å¼€å‘å‡ºæ¥ï¼Œç”¨äºæœºå™¨å­¦ä¹ å’Œæ·±åº¦ç¥ç»ç½‘ç»œæ–¹é¢çš„ç ”ç©¶ï¼Œä½†è¿™ä¸ªç³»ç»Ÿçš„é€šç”¨æ€§ä½¿å…¶ä¹Ÿå¯å¹¿æ³›ç”¨äºå…¶ä»–è®¡ç®—é¢†åŸŸã€‚
>
> â€”TensorFlow é¦–é¡µ[6](#fn:6 "see footnote")

å½“æ‚¨ä½¿ç”¨ TensorFlow æ—¶ï¼Œä½ ä¸ä¼šä½¿ç”¨ä½ æ‰€ä½¿ç”¨çš„ç¼–ç¨‹è¯­è¨€ä¸­çš„å¸¸è§„æ•°æ®ç±»å‹ã€‚è€Œæ˜¯ï¼Œä½ éœ€è¦åˆ›å»ºå¼ é‡ã€‚å¦‚æœæˆ‘ä»¬æƒ³åŠ ä¸¤ä¸ªæ•°å­—ï¼Œå®ƒçœ‹èµ·æ¥æ˜¯è¿™æ ·çš„ï¼š

```python
node1 = tf.constant(3.0, tf.float32)
node2 = tf.constant(4.0, tf.float32)
node3 = tf.add(node1, node2)
```

ä¸Šé¢çš„ä»£ç æ˜¯ç”¨ Python ç¼–å†™çš„ï¼Œä½†æ˜¯å®ƒçœ‹èµ·æ¥å’Œ JavaScript æ²¡æœ‰å¤ªå¤§çš„åŒºåˆ«ï¼Œä¸æ˜¯å—ï¼Ÿå’Œæˆ‘ä»¬çš„ Effect ç±»ä¼¼ï¼Œ`add` ç›´åˆ°æˆ‘ä»¬è°ƒç”¨å®ƒæ‰ä¼šè¿è¡Œ (åœ¨è¿™ä¸ªä¾‹å­ä¸­ä½¿ç”¨äº† `sess.run()`)ï¼š

```python
print("node3: ", node3)
print("sess.run(node3): ", sess.run(node3))
#â¦˜ node3:  Tensor("Add_2:0", shape=(), dtype=float32)
#â¦˜ sess.run(node3):  7.0
```

åœ¨è°ƒç”¨ `se .run()` ä¹‹å‰ï¼Œæˆ‘ä»¬ä¸ä¼šå¾—åˆ° 7.0ã€‚æ­£å¦‚ä½ çœ‹åˆ°çš„ï¼Œå®ƒå’Œæˆ‘ä»¬çš„å»¶æ—¶å‡½æ•°å¾ˆåƒã€‚æˆ‘ä»¬æå‰è®¡åˆ’å¥½äº†è®¡ç®—ã€‚ç„¶åï¼Œä¸€æ—¦æˆ‘ä»¬å‡†å¤‡å¥½äº†ï¼Œæˆ‘ä»¬å°±ä¼šæ‰£åŠ¨æ‰³æœºæŠŠä¸€åˆ‡éƒ½è¸¢å¼€ã€‚

## æ€»ç»“

æˆ‘ä»¬è¦†ç›–äº†å¤§èŒƒå›´çš„çŸ¥è¯†ã€‚ä½†æ˜¯æˆ‘ä»¬å·²ç»æ¢ç´¢äº†ä¸¤ç§æ–¹æ³•æ¥å¤„ç†ä»£ç ä¸­çš„å‡½æ•°çº¯åº¦ï¼š

1.  ä¾èµ–æ³¨å…¥ï¼›ä»¥åŠ
2.  Effect å‡½å­

ä¾èµ–æ³¨å…¥çš„å·¥ä½œåŸç†æ˜¯å°†ä»£ç çš„ä¸çº¯éƒ¨åˆ†ç§»å‡ºå‡½æ•°ã€‚æ‰€ä»¥ä½ å¿…é¡»æŠŠå®ƒä»¬ä½œä¸ºå‚æ•°ä¼ é€’è¿›æ¥ã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼ŒEffect å‡½å­çš„å·¥ä½œåŸç†åˆ™æ˜¯å°†æ‰€æœ‰å†…å®¹åŒ…è£…åœ¨ä¸€ä¸ªå‡½æ•°åé¢ã€‚è¦è¿è¡Œè¿™äº› Effectï¼Œæˆ‘ä»¬å¿…é¡»ç‰¹æ„è¿è¡ŒåŒ…è£…å™¨å‡½æ•°ã€‚

è¿™ä¸¤ç§æ–¹æ³•éƒ½æ˜¯æ¬ºéª—ã€‚ä»–ä»¬ä¸ä¼šå®Œå…¨å»é™¤ä¸çº¯ï¼Œä»–ä»¬åªæ˜¯æŠŠå®ƒä»¬æ¨åˆ°ä»£ç çš„è¾¹ç¼˜ã€‚ä½†è¿™æ˜¯ä»¶å¥½äº‹ã€‚å®ƒæ˜ç¡®è¯´æ˜äº†ä»£ç çš„å“ªäº›éƒ¨åˆ†æ˜¯ä¸çº¯çš„ã€‚åœ¨è°ƒè¯•å¤æ‚ä»£ç åº“ä¸­çš„é—®é¢˜æ—¶ï¼Œå¾ˆæœ‰ä¼˜åŠ¿ã€‚

1.  è¿™ä¸æ˜¯ä¸€ä¸ªå®Œæ•´çš„å®šä¹‰ï¼Œä½†æš‚æ—¶å¯ä»¥ä½¿ç”¨ã€‚æˆ‘ä»¬ç¨åä¼šå›åˆ°æ­£å¼çš„å®šä¹‰ã€‚ [Â â†©](#fnref:1 "return to body")

2.  åœ¨å…¶ä»–è¯­è¨€(å¦‚ Haskell)ä¸­ï¼Œè¿™ç§°ä¸º IO å‡½å­æˆ– IO å•å­ã€‚ [PureScript](http://www.purescript.org/) ä½¿ç”¨ _Effect_ ä½œä¸ºæœ¯è¯­ã€‚æˆ‘å‘ç°å®ƒæ›´å…·æœ‰æè¿°æ€§ã€‚[Â â†©](#fnref:2 "return to body")

3.  æ³¨æ„ï¼Œä¸åŒçš„è¯­è¨€å¯¹è¿™ä¸ªç®€å†™æœ‰ä¸åŒçš„åç§°ã€‚ä¾‹å¦‚ï¼Œåœ¨ Haskell ä¸­ï¼Œå®ƒè¢«ç§°ä¸º â€œpureâ€ã€‚æˆ‘ä¸çŸ¥é“ä¸ºä»€ä¹ˆã€‚ [Â â†©](#fnref:3 "return to body")

4.  åœ¨è¿™ä¸ªä¾‹å­ä¸­, é‡‡ç”¨äº† [Fantasy Land specification for Chain](https://github.com/fantasyland/fantasy-land#chain) è§„èŒƒã€‚ [Â â†©](#fnref:4 "return to body")

5.  John Hughes, 1990, â€˜Why Functional Programming Mattersâ€™, _Research Topics in Functional Programming_ ed. D. Turner, Addisonâ€“Wesley, pp 17â€“42, [https://www.cs.kent.ac.uk/people/staff/dat/miranda/whyfp90.pdf](https://www.cs.kent.ac.uk/people/staff/dat/miranda/whyfp90.pdf) [Â â†©](#fnref:5 "return to body")

6.  _TensorFlowâ„¢: é¢å‘æ‰€æœ‰äººçš„å¼€æºæœºå™¨å­¦ä¹ æ¡†æ¶,_ [https://www.tensorflow.org/](https://www.tensorflow.org/), 12 May 2018. [Â â†©](#fnref:6 "return to body")

- [é€šè¿‡ Twitter è®©æˆ‘çŸ¥é“ä½ çš„æƒ³æ³•](https://twitter.com/share?url=http://jrsinclair.com/articles/2018/how-to-deal-with-dirty-side-effects-in-your-pure-functional-javascript&text=%E2%80%9CHow to deal with dirty side effects in your pure functional JavaScript%E2%80%9D+by+%40jrsinclair)
- [é€šè¿‡ç”µå­é‚®ä»¶ç³»ç»Ÿè®¢é˜…æœ€æ–°èµ„è®¯](/subscribe.html)

> å¦‚æœå‘ç°è¯‘æ–‡å­˜åœ¨é”™è¯¯æˆ–å…¶ä»–éœ€è¦æ”¹è¿›çš„åœ°æ–¹ï¼Œæ¬¢è¿åˆ° [æ˜é‡‘ç¿»è¯‘è®¡åˆ’](https://github.com/xitu/gold-miner) å¯¹è¯‘æ–‡è¿›è¡Œä¿®æ”¹å¹¶ PRï¼Œä¹Ÿå¯è·å¾—ç›¸åº”å¥–åŠ±ç§¯åˆ†ã€‚æ–‡ç« å¼€å¤´çš„ **æœ¬æ–‡æ°¸ä¹…é“¾æ¥** å³ä¸ºæœ¬æ–‡åœ¨ GitHub ä¸Šçš„ MarkDown é“¾æ¥ã€‚

---

> [æ˜é‡‘ç¿»è¯‘è®¡åˆ’](https://github.com/xitu/gold-miner) æ˜¯ä¸€ä¸ªç¿»è¯‘ä¼˜è´¨äº’è”ç½‘æŠ€æœ¯æ–‡ç« çš„ç¤¾åŒºï¼Œæ–‡ç« æ¥æºä¸º [æ˜é‡‘](https://juejin.im) ä¸Šçš„è‹±æ–‡åˆ†äº«æ–‡ç« ã€‚å†…å®¹è¦†ç›– [Android](https://github.com/xitu/gold-miner#android)ã€[iOS](https://github.com/xitu/gold-miner#ios)ã€[å‰ç«¯](https://github.com/xitu/gold-miner#å‰ç«¯)ã€[åç«¯](https://github.com/xitu/gold-miner#åç«¯)ã€[åŒºå—é“¾](https://github.com/xitu/gold-miner#åŒºå—é“¾)ã€[äº§å“](https://github.com/xitu/gold-miner#äº§å“)ã€[è®¾è®¡](https://github.com/xitu/gold-miner#è®¾è®¡)ã€[äººå·¥æ™ºèƒ½](https://github.com/xitu/gold-miner#äººå·¥æ™ºèƒ½)ç­‰é¢†åŸŸï¼Œæƒ³è¦æŸ¥çœ‹æ›´å¤šä¼˜è´¨è¯‘æ–‡è¯·æŒç»­å…³æ³¨ [æ˜é‡‘ç¿»è¯‘è®¡åˆ’](https://github.com/xitu/gold-miner)ã€[å®˜æ–¹å¾®åš](http://weibo.com/juejinfanyi)ã€[çŸ¥ä¹ä¸“æ ](https://zhuanlan.zhihu.com/juejinfanyi)ã€‚
