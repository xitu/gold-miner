> * åŸæ–‡åœ°å€ï¼š[New Node.js 12 features will see it disrupt AI, IoT and more surprising areas](https://tsh.io/blog/new-node-js-features/)
> * åŸæ–‡ä½œè€…ï¼š[Adam Polak](https://pl.linkedin.com/in/adam-polak-3267a99b)
> * è¯‘æ–‡å‡ºè‡ªï¼š[æ˜é‡‘ç¿»è¯‘è®¡åˆ’](https://github.com/xitu/gold-miner)
> * æœ¬æ–‡æ°¸ä¹…é“¾æ¥ï¼š[https://github.com/xitu/gold-miner/blob/master/TODO1/new-node-js-features.md](https://github.com/xitu/gold-miner/blob/master/TODO1/new-node-js-features.md)
> * è¯‘è€…ï¼š[Badd](https://juejin.im/user/5b0f6d4b6fb9a009e405dda1)
> * æ ¡å¯¹è€…ï¼š[Alfxjx](https://github.com/Alfxjx), [cyz980908](https://github.com/cyz980908)

# Node.js æ–°ç‰¹æ€§å°†é¢ è¦† AIã€ç‰©è”ç½‘ç­‰æ›´å¤šæƒŠäººé¢†åŸŸ

**æ–°ç‰ˆ Node.js çš„ç‰¹æ€§å¹¶éè¿™ä¸ªå¹³å°æ­¤å‰çš„é‚£äº›ç­‰é—²å–ç‚¹ã€‚Node.js ä¸»è¦ä»¥å…¶[è¿…é€Ÿå’Œç®€æ´](https://tsh.io/blog/node-js-tutorial-for-beginners/)è€Œé—»åã€‚è¿™ä¹Ÿæ˜¯ä¸ºä½•é‚£ä¹ˆå¤šå…¬å¸éƒ½æ„¿æ„å°è¯• Node.jsã€‚ç„¶è€Œï¼Œéšç€æœ€æ–°çš„ LTSï¼ˆlong-term supportï¼Œé•¿æœŸæ”¯æŒï¼‰ç‰ˆæœ¬çš„å‘å¸ƒï¼ŒNode.js å°†ä¼šå¸¦æ¥å¾ˆå¤šè®©æ¯ä½ Node.js å¼€å‘è€…æ¬£å–œè‹¥ç‹‚çš„æ–°ç‰¹æ€§ã€‚ä¸ºä»€ä¹ˆï¼Ÿå› ä¸º Node.js 12 æ–°é²œå‡ºç‚‰çš„ç‰¹æ€§åŠå…¶å¸¦æ¥çš„å¯èƒ½æ€§ç®€ç›´è®©äººæƒŠè‰³ï¼**

## å¤šçº¿ç¨‹è¶‹å‘ç¨³å®šï¼

åœ¨ä¸Šä¸€ä¸ª LTS ç‰ˆæœ¬ä¸­ï¼Œæˆ‘ä»¬å·²ç»å¯ä»¥ä½¿ç”¨å¤šçº¿ç¨‹äº†ã€‚è¯šç„¶ï¼Œè¿™æ˜¯ä¸€ä¸ªè¯•éªŒæ€§ç‰¹æ€§ï¼Œéœ€è¦ä¸€ä¸ªåä¸º **--experimental-worker** çš„æ ‡å¿—ï¼ˆflagï¼‰æ‰èƒ½ç”Ÿæ•ˆã€‚

åœ¨å³å°†é—®ä¸–çš„è¿™ä¸ª LTS ç‰ˆæœ¬ï¼ˆNode 12ï¼‰ä¸­ï¼Œå¤šçº¿ç¨‹ä»æ˜¯è¯•éªŒæ€§çš„ï¼Œä½†ä¸å†éœ€è¦ä¾èµ– **--experimental-worker** è¿™ç§æ ‡å¿—äº†ã€‚ç¨³å®šç‰ˆæœ¬æ­£åœ¨å‘æˆ‘ä»¬ç¿©è·¹èµ°æ¥ï¼

## æ”¯æŒ ES æ¨¡å—

æˆ‘ä»¬éœ€è¦è®¤æ¸…è¿™æ ·çš„äº‹å®ï¼šES æ¨¡å—æ˜¯ç›®å‰ JavaScript å¼€å‘çš„å¿…ç»ä¹‹è·¯ã€‚æˆ‘ä»¬åœ¨å‰ç«¯åº”ç”¨ä¸­ä½¿ç”¨å®ƒã€‚æˆ‘ä»¬åœ¨æ¡Œé¢ç«¯ä¹ƒè‡³ç§»åŠ¨ç«¯åº”ç”¨ä¸­ä½¿ç”¨å®ƒã€‚å¯æ˜¯ï¼Œåœ¨ Node.js é¢†åŸŸï¼Œæˆ‘ä»¬è¿˜å¡åœ¨ Common.js æ¨¡å—åœæ»ä¸å‰ã€‚

å½“ç„¶äº†ï¼Œæˆ‘ä»¬è¿˜æœ‰ Babel å’Œ TypeScript å¯ä»¥ç”¨ï¼Œä½†æ—¢ç„¶ Node.js æ˜¯ä¸€é—¨åç«¯æŠ€æœ¯ï¼Œæˆ‘ä»¬åº”å½“å…³å¿ƒçš„åº”è¯¥åªæ˜¯æœåŠ¡å™¨ä¸Šå®‰è£…çš„ Node çš„ç‰ˆæœ¬æ˜¯å¦æ›´æ–°ã€‚æˆ‘ä»¬ä¸å¿…å»åœ¨æ„äº”èŠ±å…«é—¨çš„æµè§ˆå™¨å’Œ Node.js å¯¹å®ƒä»¬çš„æ”¯æŒæƒ…å†µï¼Œé‚£ä¹ˆå®‰è£…ä¸“é—¨é’ˆå¯¹æ­¤ç›®çš„è€Œè®¾è®¡çš„å·¥å…·ï¼ˆBabelã€Webpack ç­‰ï¼‰æœ‰ä»€ä¹ˆæ„ä¹‰å‘¢ï¼Ÿ

åœ¨ Node 10 ç‰ˆæœ¬ä¸­ï¼Œæˆ‘ä»¬æ€»ç®—æ˜¯å¯ä»¥ç”¨ ES æ¨¡å—å°è¯•ç‰›åˆ€äº†ï¼ˆç›®å‰çš„ LTS ç‰ˆæœ¬å¯¹æ¨¡å—è¿›è¡Œäº†è¯•éªŒæ€§çš„å®ç°ï¼‰ï¼Œä½†è¿˜éœ€è¦ä½¿ç”¨ä¸€ä¸ªç‰¹å®šçš„æ–‡ä»¶æ‰©å±• â€”â€” **.mjs**ï¼ˆæ¨¡å— JavaScript ä»£ç æ–‡ä»¶ï¼‰ã€‚

è€Œåœ¨ Node 12 ç‰ˆæœ¬ä¸­ï¼Œä½¿ç”¨ ES æ¨¡å—è¦ç¨å¾®å®¹æ˜“ä¸€äº›äº†ã€‚æ­£å¦‚åœ¨ Web App ä¸­ä¸€æ ·ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ä¸€ä¸ªä¸“æœ‰çš„å±æ€§ç±»å‹æ¥å®šä¹‰æŸæ®µä»£ç æ˜¯åº”è¯¥å¤„ç†ä¸º Common.js è¿˜æ˜¯ ES æ¨¡å—ã€‚

è¦æƒ³æŠŠæ–‡ä»¶éƒ½ä½œä¸ºæ¨¡å—ä½¿ç”¨ï¼Œä½ åªéœ€åœ¨ package.json ä¸­æ·»åŠ  **type** å±æ€§å¹¶èµ‹å€¼ä¸º **module**ã€‚

```json
{
  "type": "module"
}
```

ä»ç°åœ¨èµ·ï¼Œå¦‚æœç¦» .js æ–‡ä»¶**æœ€è¿‘**çš„ package.json æ–‡ä»¶å¸¦æœ‰ type å±æ€§ï¼Œé‚£ä¹ˆè¿™äº› .js æ–‡ä»¶å°†ä½œä¸ºæ¨¡å—å­˜åœ¨ã€‚å†è§äº†æ‚¨å‘ï¼Œ**mjs**ï¼ˆå¦‚æœæƒ³ç”¨ï¼Œè¿˜æ˜¯å¯ä»¥ç»§ç»­ç”¨çš„ï¼‰ï¼

é‚£ä¹ˆï¼Œè¦æ˜¯æˆ‘ä»¬æƒ³è¦ç”¨ Common.js é£æ ¼çš„æ¨¡å—ï¼Œè¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ

åªè¦ç¦»å®ƒæœ€è¿‘çš„ package.json ä¸åŒ…å«æ¨¡å—å±æ€§ typeï¼Œé‚£å®ƒå°±å°†è¢«è§†ä¸ºæ˜¯éµå¾ª Common.js è§„èŒƒçš„ä»£ç ã€‚

å¦å¤–ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸€ç§æ–°å‹çš„æ‰©å±•æ–‡ä»¶ï¼Œå«åš **cjs** â€”â€” ä»£è¡¨ä¸€ä¸ª Common.js æ–‡ä»¶ã€‚

æ¯ä¸ª **mjs** æ–‡ä»¶éƒ½æ˜¯ä¸€ä¸ª ES æ¨¡å—ï¼Œè€Œæ¯ä¸ª **cjs** éƒ½æ˜¯ä¸€ä¸ª Common.js æ–‡ä»¶ã€‚

å¦‚æœä½ è¿˜æ²¡å°è¿‡è¿™ä¸€å‹ºé²œï¼Œé‚£ç°åœ¨èµ¶ç´§è¯•è¯•å§ï¼

## JavaScript å’Œç§æœ‰å˜é‡

è¯´èµ· JavaScriptï¼Œæˆ‘ä»¬æ€»éœ€è¦ç»å°½è„‘æ±é˜²æ­¢ç±»æˆ–å‡½æ•°ä¸­çš„æ•°æ®å¤–æ³„ã€‚

JavaScript å› å…¶çŒ´å­è¡¥ä¸ï¼ˆ[Monkey patching](https://segmentfault.com/n/1330000004293098)ï¼‰è€Œé—»åï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬æ€»æ˜¯èƒ½é€šè¿‡æŸç§é—¨è·¯æ‹¿åˆ°æ‰€æœ‰æ•°æ®ã€‚

æˆ‘ä»¬å°è¯•è¿‡ç”¨é—­åŒ…ã€Symbol ç­‰ç­‰æ¨¡æ‹Ÿç§æœ‰å˜é‡ã€‚Node 12 ç‰ˆæœ¬è£…è½½äº†æ–°ç‰ˆ V8 å¼•æ“ï¼Œå› æ­¤æˆ‘ä»¬æœ‰æœºä¼šä½¿ç”¨ä¸€ä¸ªç‚«é…·ç‰¹æ€§ â€”â€” ç±»ä¸­çš„ç§æœ‰å±æ€§ã€‚

æˆ‘æƒ³ä½ ä»¬éƒ½è¿˜è®°å¾—åœ¨ Node ä¸­å®ç°ç§æœ‰æ€§çš„è€æ–¹æ³•ï¼š

```js
class MyClass {
  constructor() {
    this._x = 10
  }
  
  get x() {
    return this._x
  }
}
```

æˆ‘ä»¬éƒ½æ¸…æ¥šï¼Œè¿™å¹¶éçœŸæ­£çš„ç§æœ‰ â€”â€” æˆ‘ä»¬æ€»æœ‰åŠæ³•æ‹¿åˆ°å®ƒï¼Œä½†å¤§å¤šæ•° IDE éƒ½æŠŠå®ƒçœ‹ä½œç§æœ‰å­—æ®µï¼Œå¤šæ•° Node å¼€å‘è€…éƒ½çŸ¥é“è¿™ä¸ªæƒ¯ä¾‹ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬ç»ˆäºå¯ä»¥å°†è¿™ç§æ–¹æ³•æŠ›ä¹‹è„‘åäº†ã€‚

```js
class MyClass {
  #x = 10
  
  get x() {
    return this.#x
  }
}
```

èƒ½çœ‹åˆ°äºŒè€…çš„å·®å¼‚å—ï¼Ÿæ²¡é”™ï¼Œæˆ‘ä»¬ç”¨ **#** å‘Šè¯‰ Nodeï¼Œè¿™ä¸ªå˜é‡æ˜¯ç§æœ‰å˜é‡ï¼Œåªèƒ½åœ¨ç±»å†…éƒ¨è®¿é—®åˆ°ã€‚

å¦‚æœè¯•å›¾ç›´æ¥è®¿é—®å®ƒï¼Œä½ ä¼šçœ‹åˆ°æŠ¥é”™ä¿¡æ¯ï¼Œè¯´è¿™ä¸ªå˜é‡ä¸å­˜åœ¨ã€‚

ä»¤äººéƒé—·çš„æ˜¯ï¼Œæœ‰äº› IDE ç›®å‰è¿˜ä¸èƒ½è¯†åˆ«è¿™ç§ç§æœ‰å˜é‡ã€‚

## Flat å’Œ flatMap

åœ¨ Node 12 ç‰ˆæœ¬ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å°½æƒ…ä½¿ç”¨ JavaScript çš„æ–°ç‰¹æ€§ã€‚

é¦–å…ˆï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ•°ç»„çš„æ–°æ–¹æ³• â€”â€” **flat** å’Œ **flatMap**ã€‚å‰è€…å¾ˆåƒ **Lodash** ä¸­çš„ **flattenDepth** æ–¹æ³•ã€‚

å¦‚æœå‘æ–¹æ³•ä¸­ä¼ å…¥ä¸€ä¸ªåµŒå¥—çš„æ•°ç»„ï¼Œå¯ä»¥å¾—åˆ°ä¸€ä¸ªå±•å¼€çš„æ•°ç»„ã€‚

```js
[10, [20, 30], [40, 50, [60, 70]]].flat() // => [10, 20, 30, 40, 50, [60, 70]]
[10, [20, 30], [40, 50, [60, 70]]].flat(2) // => [10, 20, 30, 40, 50, 60, 70]
```

å¦‚ä½ æ‰€è§ï¼Œè¯¥æ–¹æ³•è¿˜æœ‰ä¸ªç‰¹åˆ«çš„å‚æ•° â€”â€” **depth**ï¼ˆæ·±åº¦ï¼‰ã€‚è¿™ä¸ªå‚æ•°å†³å®šäº†åµŒå¥—æ•°ç»„å°†ä»¥ä½•ç§æ·±åº¦è¢«é™ç»´ã€‚

ç¬¬äºŒä¸ªæ–°ç‰¹æ€§ â€”â€” **flatMap**ï¼Œå…¶ä½œç”¨ç±»ä¼¼äºé¦–å…ˆæ‰§è¡Œ **map** æ–¹æ³•ï¼Œå†æ‰§è¡Œ **flat**ã€‚ğŸ™‚

## å¯é€‰çš„ Catch ç»‘å®š

å¦ä¸€ä¸ªæ–°ç‰¹æ€§å°±æ˜¯ **å¯é€‰çš„ Catch ç»‘å®š**ï¼ˆOptional catch bindingï¼‰ã€‚æ­¤å‰ï¼Œæˆ‘ä»¬æ€»æ˜¯éœ€è¦ä¸º **try - catch** å®šä¹‰ä¸€ä¸ª error å˜é‡ã€‚

```js
try {
  someMethod()
} catch(err) {
  // err å˜é‡æ˜¯å¿…é¡»çš„
}
```

è€Œåœ¨ Node 12 ç‰ˆæœ¬ä¸­ï¼Œæˆ‘ä»¬è™½ä¸èƒ½å®Œå…¨æ‘†è„± **try - catch** è¯­å¥ï¼Œä½† error å˜é‡æ˜¯å¯ä»¥çœäº†ã€‚

```js
try {
  someMethod()
} catch {
  // err å˜é‡æ˜¯å¯é€‰çš„
}
```

## Object.fromEntries

è¿˜æœ‰ä¸€ä¸ªæ–°ç‰¹æ€§å°±æ˜¯ **Object.fromEntries** æ–¹æ³•ã€‚å…¶ä¸»è¦ç”¨é€”æ˜¯é€šè¿‡ **Map** æˆ–è€…**é”®å€¼å¯¹**æ•°ç»„åˆ›å»ºä¸€ä¸ªå¯¹è±¡ã€‚

```js
Object.fromEntries(new Map([['key', 'value'], ['otherKey', 'otherValue']]));
// { key: 'value', otherKey: 'otherValue' }


Object.fromEntries([['key', 'value'], ['otherKey', 'otherValue']]);
// { key: 'value', otherKey: 'otherValue' }
```

## V8 å¼•æ“çš„å˜åŒ–

æˆ‘æåˆ°è¿‡ï¼Œæ–°ç‰ˆçš„ Node è£…è½½äº† V8 å¼•æ“ã€‚è¿™ä½¿å¾— Node ä¸ä»…æ”¯æŒç§æœ‰å˜é‡ï¼Œè¿˜å¸¦æœ‰ä¸€äº›æ€§èƒ½ä¼˜åŒ–åŠŸèƒ½ã€‚

Await å°†ä¼šåƒ Javascript è§£æé‚£æ ·è¿è¡Œé£å¿«ã€‚

è€Œç”±äºæ”¯æŒå †æ ˆè¿½è¸ªï¼Œæˆ‘ä»¬çš„åº”ç”¨å°†ä¼šåŠ è½½å¾—æ›´å¿«ï¼ŒAsync ä»£ç å°†æ›´åŠ æ˜“äºè°ƒè¯•ã€‚

å¦å¤–ï¼Œå †ï¼ˆHeapï¼‰çš„å¤§å°ä¹Ÿæ­£åœ¨æ”¹å˜ã€‚æ­¤å‰ï¼Œå…¶ä½“é‡ä¸º 700MBï¼ˆåœ¨ 32 ä½ç³»ç»Ÿä¸­ï¼‰æˆ– 1400MBï¼ˆåœ¨ 64 ä½ç³»ç»Ÿä¸­ï¼‰ã€‚éšç€æ–°ç‰ˆæœ¬å¸¦æ¥çš„å˜åŒ–ï¼Œå †å¤§å°å°†ä¾å¯ç”¨å†…å­˜å¤§å°è€Œå®šï¼

## Node 12 ç‰ˆæœ¬æ¥å•¦ï¼

æˆ‘ä¸çŸ¥é“ä½ æœŸä¸æœŸå¾…ï¼Œåæ­£æˆ‘æ˜¯å¯¹ Node 12 æ‹­ç›®ä»¥å¾…ã€‚è·ç¦»å®˜æ–¹å°† 12 ç‰ˆæœ¬æ›´æ–°ä¸º LTS ç‰ˆæœ¬è¿˜è¦å‡ ä¸ªæœˆï¼ˆå‘å¸ƒæ—¥æœŸå®šäº 2019 å¹´ 10 æœˆï¼‰ï¼Œä½†æˆ‘ä»¬å°†è¦å¾—åˆ°çš„æ–°ç‰¹æ€§æ— ç–‘æ˜¯å‰é€”æ— é‡çš„ã€‚

åªæœ‰å‡ ä¸ªæœˆå•¦ï¼

## æ–°ç‰ˆ Node.js æœ€å¤§çš„çœ‹ç‚¹å°±æ˜¯å¤šçº¿ç¨‹ï¼

**æ¯ç§ç¼–ç¨‹è¯­è¨€éƒ½å„æœ‰å…¶åˆ©å¼Š**ï¼Œè¿™æ˜¯æˆ‘ä»¬å¤§å®¶éƒ½æ¯‹åº¸ç½®ç–‘çš„ã€‚å¤§å¤šæ•°æµè¡Œçš„æŠ€æœ¯éƒ½åœ¨æŠ€æœ¯ä¸–ç•Œæœ‰å„è‡ªçš„ä¸€å¸­ä¹‹åœ°ã€‚Node.js ä¹Ÿä¸ä¾‹å¤–ã€‚
  
å‡ å¹´æ¥ï¼Œæˆ‘ä»¬ä¸€ç›´éƒ½è¯´ [Node.js é€‚ç”¨äº API gateway](https://tsh.io/blog/serverless-in-node-js-beginners-guide/) å’Œå®æ—¶ä»ªè¡¨æ¿ï¼ˆ[å¦‚åŸºäº Websocket](https://tsh.io/blog/php-websocket/)ï¼‰ã€‚äº‹å®ä¸Šï¼ŒNode çš„è®¾è®¡è®©æˆ‘ä»¬ä¸å¾—ä¸ä¾èµ–å¾®æœåŠ¡æ¶æ„æ¥å¼¥è¡¥å…¶æœ¬èº«çš„å¸¸è§ç¼ºé™·ã€‚

ç»è¿‡æ—¶é—´çš„æ£€éªŒï¼Œæˆ‘ä»¬å·²çŸ¥æ‚‰ï¼Œç”±äºå…¶å•çº¿ç¨‹è®¾è®¡ç†å¿µï¼ŒNode.js ä¸é€‚åˆå¤„ç†è€—æ—¶é•¿ã€ä¸¥é‡å ç”¨ CPU ç®—åŠ›æˆ–é˜»å¡æ“ä½œçš„ä»»åŠ¡ã€‚è¿™æ˜¯äº‹ä»¶å¾ªç¯æœºåˆ¶æœ¬èº«çš„é—®é¢˜ã€‚
  
å¦‚æœæœ‰ä¸€ä¸ªå¤æ‚çš„åŒæ­¥æ“ä½œé˜»å¡äº†äº‹ä»¶å¾ªç¯ï¼Œé‚£ä¹ˆåœ¨è¯¥æ“ä½œå®Œæˆå‰ï¼Œåˆ«çš„ä»€ä¹ˆä¹Ÿåšä¸äº†ã€‚è¿™å°±æ˜¯æˆ‘ä»¬é¢‘ç¹ä½¿ç”¨ Async æˆ–å°†è€—æ—¶é—´çš„é€»è¾‘ç§»åˆ°å•ç‹¬çš„å¾®æœåŠ¡ä¸­çš„åŸå› ã€‚
  
éšç€ Node.js 10 ç‰ˆæœ¬ä¸­çš„æ–°ç‰¹æ€§çš„é¢ä¸–ï¼Œè¿™ç§æƒå®œä¹‹è®¡å°†å˜å¾—ä¸å†å¿…è¦ã€‚**è¿™ä¸ªåŒ–è…æœ½ä¸ºç¥å¥‡çš„å·¥å…·å°±æ˜¯ Worker thread**ã€‚æ­£å› å¦‚æ­¤ï¼ŒNode.js å°†èƒ½å¤Ÿåœ¨é€šå¸¸æˆ‘ä»¬ä¼šä½¿ç”¨å…¶ä»–è¯­è¨€çš„é¢†åŸŸä¸­å¤§æ”¾å¼‚å½©ã€‚

äººå·¥æ™ºèƒ½ã€æœºå™¨å­¦ä¹ æˆ–å¤§æ•°æ®éƒ½æ˜¯å¾ˆå¥½çš„ä½è¯ï¼Œå°±ç›®å‰æ¥è¯´ï¼Œè¿™äº›é¢†åŸŸçš„ç ”ç©¶éœ€è¦å¤§é‡çš„ CPU ç®—åŠ›ï¼Œè¿™è®©æˆ‘ä»¬åˆ«æ— ä»–é€‰ï¼Œåªèƒ½æ­å»ºæ›´å¤šçš„æœåŠ¡æˆ–è€…æ¢ä¸€ä¸ªæ›´é€‚åˆçš„è¯­è¨€ã€‚ä½†ä»æ–°ç‰ˆ Node.js å¼€å§‹ï¼Œä¸€åˆ‡éƒ½ä¸ä¸€æ ·äº†ã€‚

## æ”¯æŒå¤šçº¿ç¨‹ï¼Ÿæ€ä¹ˆåšåˆ°çš„ï¼Ÿ

è¿™ä¸ªæ–°ç‰¹æ€§ä»å¤„åœ¨è¯•éªŒé˜¶æ®µ â€”â€” è¿˜ä¸èƒ½åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨ã€‚ä½†æˆ‘ä»¬è¿˜æ˜¯å¯ä»¥éšæ„ç©ç©çš„ã€‚é‚£ä»å“ªå¼€å§‹å‘¢ï¼Ÿ

ä» Node 12 å¼€å§‹åŠè‡³æ›´é«˜ç‰ˆæœ¬ä¸­ï¼Œæˆ‘ä»¬ä¸å†éœ€è¦ä½¿ç”¨ç‰¹å®šçš„ç‰¹æ€§æ ‡å¿— **--experimental-worker**ã€‚ Worker å°†æ˜¯é»˜è®¤æ¿€æ´»çš„ï¼

**node index.js**

ç°åœ¨æˆ‘ä»¬å¯ä»¥å……åˆ†åˆ©ç”¨ **worker_threads** æ¨¡å—ã€‚è®©æˆ‘ä»¬å…ˆå†™ä¸€ä¸ªç®€å•çš„å¸¦æœ‰ä¸¤ä¸ªæ–¹æ³•çš„ HTTP æœåŠ¡å™¨ï¼š

* GET /helloï¼ˆè¿”å›å¸¦æœ‰â€œHello Worldâ€ä¿¡æ¯çš„ JSON å¯¹è±¡ï¼‰ï¼Œ
* GET /computeï¼ˆä½¿ç”¨ä¸€ä¸ªåŒæ­¥æ–¹æ³•é‡å¤åŠ è½½ä¸€ä¸ªå¤§ JSON æ–‡ä»¶ï¼‰ã€‚

```js
const express = require('express');
const fs = require('fs');

const app = express();

app.get('/hello', (req, res) => {
  res.json({
    message: 'Hello world!'
  })
});

app.get('/compute', (req, res) => {
  let json = {};
  for (let i=0;i<100;i++) {
    json = JSON.parse(fs.readFileSync('./big-file.json', 'utf8'));
  }

  json.data.sort((a, b) => a.index - b.index);

  res.json({
    message: 'done'
  })
});

app.listen(3000);
```

è¿™æ®µä»£ç çš„è¿è¡Œç»“æœå¾ˆå®¹æ˜“é¢„æµ‹ã€‚å½“ **GET /compute** å’Œ **/hello** è¢«åŒæ—¶è°ƒç”¨ï¼Œæˆ‘ä»¬å¿…é¡»ç­‰åˆ° **compute** è°ƒç”¨å®Œæˆæ‰èƒ½ä» **hello** å¾—åˆ°å“åº”ã€‚äº‹ä»¶å¾ªç¯è¢«é˜»å¡ï¼Œç›´åˆ°æ–‡ä»¶åŠ è½½å®Œæˆã€‚

è®©æˆ‘ä»¬ç”¨å¤šçº¿ç¨‹ä¼˜åŒ–ä¸€ä¸‹å§ï¼

```js
const express = require('express');
const fs = require('fs');
const { Worker, isMainThread, parentPort, workerData } = require('worker_threads');

if (isMainThread) {
  console.log("Spawn http server");

  const app = express();

  app.get('/hello', (req, res) => {
    res.json({
      message: 'Hello world!'
    })
  });

  app.get('/compute', (req, res) => {

    const worker = new Worker(__filename, {workerData: null});
    worker.on('message', (msg) => {
      res.json({
        message: 'done'
      });
    })
    worker.on('error', console.error);
	  worker.on('exit', (code) => {
		if(code != 0)
          console.error(new Error(`Worker stopped with exit code ${code}`))
    });
  });

  app.listen(3000);
} else {
  let json = {};
  for (let i=0;i<100;i++) {
    json = JSON.parse(fs.readFileSync('./big-file.json', 'utf8'));
  }

  json.data.sort((a, b) => a.index - b.index);

  parentPort.postMessage({});
}
```

å¾ˆæ˜æ˜¾ï¼Œè¿™ç§è¯­æ³•å’Œæˆ‘ä»¬æ‰€çŸ¥é“çš„ Node.js é›†ç¾¤æ‰©å±•éå¸¸ç›¸ä¼¼ã€‚ä½†ä»è¿™å„¿å°±å¼€å§‹å˜å¾—æœ‰è¶£èµ·æ¥äº†ã€‚

ä½ å¯ä»¥è¯•ç€åŒæ—¶è°ƒç”¨ä¸¤ä¸ªè·¯å¾„ã€‚æ³¨æ„åˆ°ä»€ä¹ˆäº†å—ï¼Ÿã€‚æ²¡é”™ï¼Œäº‹ä»¶å¾ªç¯ä¸å†è¢«é˜»å¡ï¼Œè¿™æ ·æˆ‘ä»¬å°±èƒ½åœ¨æ–‡ä»¶åŠ è½½æœŸé—´è°ƒç”¨ **/hello** äº†ã€‚

ç°åœ¨ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬éƒ½ç¿˜é¦–ä»¥ç›¼çš„ä¸œè¥¿ï¼å‰©ä¸‹çš„å°±æ˜¯ç­‰å¾…ç¨³å®šç‰ˆæœ¬çš„ API å‡ºç‚‰äº†ã€‚

## æ¸´æœ›æ›´å¤šçš„ Node.js æ–°ç‰¹æ€§ï¼Ÿè¿™ä¸ª N-API èƒ½å¤Ÿæ„å»º C/C++ æ¨¡å—ï¼

Node.js çš„åŸç”Ÿè¿è¡Œé€Ÿåº¦æ­£æ˜¯æˆ‘ä»¬é’çè¿™ä¸ªæŠ€æœ¯çš„åŸå› ä¹‹ä¸€ã€‚Worker threads å°†ä¼šæ›´è¿›ä¸€æ­¥åœ°æå‡ Node.js çš„é€Ÿåº¦ã€‚ä½†ä»…ä»…æ˜¯è¿™æ ·å°±å¤Ÿäº†å—ï¼Ÿ

Node.js æ˜¯ä¸€ç§åŸºäº C è¯­è¨€çš„æŠ€æœ¯ã€‚å½“ç„¶äº†ï¼Œæˆ‘ä»¬æŠŠ JavaScript å½“ä½œä¸€ä¸ªä¸»è¦ç¼–ç¨‹è¯­è¨€æ¥ä½¿ç”¨ã€‚ä½†å¦‚æœæˆ‘ä»¬èƒ½ç”¨ C è¯­è¨€åšæ›´åŠ å¤æ‚çš„è®¡ç®—å‘¢ï¼Ÿ

Node.js 10 ç‰ˆæœ¬ç»™æˆ‘ä»¬å¸¦æ¥äº† **N-API**ã€‚è¿™æ˜¯ä¸€ä¸ªæ ‡å‡†åŒ–çš„ APIï¼Œé€‚ç”¨äºåŸç”Ÿæ¨¡å—ï¼Œè®©ç”¨ C/C++ ç”šè‡³æ˜¯ Rust è¯­è¨€æ„å»ºæ¨¡å—æˆä¸ºå¯èƒ½ã€‚å¬èµ·æ¥å¾ˆæ£’ï¼Œå¯¹å§ï¼Ÿ

![C++ logo](https://tsh.io/wp-content/uploads/2018/12/c-logo-267x300.png)

ç”¨ C/C++ æ„å»º Node.js åŸç”Ÿæ¨¡å—å˜å¾—æ›´åŠ å®¹æ˜“ã€‚

ä¸‹é¢æ˜¯ä¸€ä¸ªå¾ˆç®€å•çš„åŸç”Ÿæ¨¡å—ç¤ºä¾‹ï¼š

```cpp
#include <napi.h>
#include <math.h>

namespace helloworld {
    Napi::Value Method(const Napi::CallbackInfo& info) {
        Napi::Env env = info.Env();
        return Napi::String::New(env, "hello world");
    }

    Napi::Object Init(Napi::Env env, Napi::Object exports) {
        exports.Set(Napi::String::New(env, "hello"),
                    Napi::Function::New(env, Method));
        return exports;
    }

    NODE_API_MODULE(NODE_GYP_MODULE_NAME, Init)
}
```

å¦‚æœä½ æœ‰ C++ çš„åŸºç¡€ï¼Œå†™ä¸€ä¸ªè‡ªå®šä¹‰æ¨¡å—è‚¯å®šä¸è´¹å¹ç°ä¹‹åŠ›ã€‚ä½ åªéœ€è®°å¾—åœ¨æ¨¡å—ç»“å°¾å°† C++ çš„ç±»å‹è½¬åŒ–ä¸º Node.js ç±»å‹å³å¯ã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦**ç»‘å®š**ï¼ˆbindingï¼‰ï¼š

```gyp
{
    "targets": [
        {
            "target_name": "helloworld",
            "sources": [ "hello-world.cpp"],
            "include_dirs": ["<!@(node -p \"require('node-addon-api').include\")"],
            "dependencies": ["<!(node -p \"require('node-addon-api').gyp\")"],
            "defines": [ 'NAPI_DISABLE_CPP_EXCEPTIONS' ]
        }
    ]
}
```

è¿™ä¸ªç®€å•çš„é…ç½®è®©æˆ‘ä»¬èƒ½å¤Ÿæ„å»º *.cpp æ–‡ä»¶ï¼Œä»¥ä¾¿äºåç»­åœ¨ Node.js åº”ç”¨ä¸­ä½¿ç”¨ã€‚

åœ¨ç”¨äº JavaScript ä»£ç ä¹‹å‰ï¼Œæˆ‘ä»¬å¿…é¡»è¿›è¡Œæ„å»ºå¹¶é…ç½® package.json æ–‡ä»¶æ¥æŸ¥æ‰¾ gyp æ–‡ä»¶ï¼ˆç»‘å®šæ–‡ä»¶ï¼‰ã€‚

```json
{
  "name": "n-api-example",
  "version": "1.0.0",
  "description": "",
  "main": "index.js",
  "scripts": {
    "install": "node-gyp rebuild"
  },
  "gypfile": true,
  "keywords": [],
  "author": "",
  "license": "ISC",
  "dependencies": {
    "node-addon-api": "^1.5.0",
    "node-gyp": "^3.8.0"
  }
}
```

å½“æ¨¡å—å‡†å¤‡å°±ç»ªï¼Œæˆ‘ä»¬å°±å¯ä»¥ç”¨ **node-gyp rebuild** å‘½ä»¤è¿›è¡Œæ„å»ºå¹¶å¯¼å…¥åˆ° JavaScript ä»£ç ä¸­ã€‚ç”¨æ³•å’Œå…¶ä»–æµè¡Œçš„æ¨¡å—çš„ç”¨æ³•ä¸€æ ·ï¼

```js
const addon = require('./build/Release/helloworld.node');

console.log(addon.hello());
```

N-API ä»¥åŠ Worker threads èµ‹äºˆæˆ‘ä»¬åŠŸèƒ½å¼ºå¤§çš„å·¥å…·ï¼Œå¸®æˆ‘ä»¬æ„å»ºé«˜æ€§èƒ½çš„åº”ç”¨ã€‚ä¸ç”¨è¯´ API æˆ–ä»ªè¡¨æ¿ â€”â€” å³ä½¿æ˜¯å¤æ‚çš„æ•°æ®å¤„ç†æˆ–è€…æœºå™¨å­¦ä¹ ç³»ç»Ÿéƒ½å°†å‚æ‰‹å¯å¾—ã€‚å¤šä¹ˆæ£’å•Šï¼

**å¦è¯·å‚é˜…ï¼š**[Swoole â€“ Is it Node in PHP? ](https://tsh.io/blog/swoole-is-it-node-in-php-or-am-i-wrong/)

## Node.js ä¼šå…¨é¢æ”¯æŒ HTTP/2 å—ï¼Ÿå½“ç„¶äº†ï¼ä½•ä¹ä¸ä¸ºï¼Ÿ

æˆ‘ä»¬èƒ½å¤Ÿ**è®¡ç®—å¾—æ›´å¿«**ã€‚æˆ‘ä»¬èƒ½è¿›è¡Œ**åˆ†å¸ƒå¼è®¡ç®—**ã€‚é‚£ä¹ˆ**èµ„æºå’Œé¡µé¢æœåŠ¡**æ–¹é¢è¡¨ç°å¦‚ä½•ï¼Ÿ

å¤šå¹´æ¥ï¼Œæˆ‘ä»¬ä¸€ç›´éƒ½å¡åœ¨ä¼˜ç§€å´é™ˆæ—§çš„ **http** æ¨¡å—å’Œ HTTP/1.1 ä¸Šæ²¡æœ‰è¿›æ­¥ã€‚éšç€æœåŠ¡å™¨è¦æä¾›çš„èµ„æºè¶Šæ¥è¶Šå¤šï¼Œæˆ‘ä»¬è¶Šæ¥è¶Šå—åˆ¶äºåŠ è½½æ‰€èŠ±è´¹çš„æ—¶é—´ã€‚é’ˆå¯¹æ¯ä¸ªæœåŠ¡å™¨æˆ–ä»£ç†æœåŠ¡å™¨ï¼Œå„ä¸ªæµè§ˆå™¨éƒ½æœ‰ä¸ªå¹¶å‘æŒä¹…è¿æ¥æ•°ä¸Šé™ï¼Œç‰¹åˆ«æ˜¯ HTTP/1.1 åè®®ä¸‹ã€‚æœ‰äº†å¯¹ HTTP/2 çš„æ”¯æŒï¼Œæˆ‘ä»¬å°±å¯ä»¥å’Œè¿™ä¸ªé—®é¢˜å»åˆ«äº†ã€‚

é‚£æˆ‘ä»¬è¯¥ä»å“ªé‡Œä¸‹æ‰‹å‘¢ï¼Ÿä½ æ˜¯å¦è¿˜è®°å¾—ç½‘ä¸Šæ¯ä¸ªæ•™ç¨‹ä¸­éƒ½ä¼šå‡ºç°çš„è¿™ä¸ª Node.js åŸºç¡€ç¤ºä¾‹ï¼Ÿå¯¹ï¼Œå°±æ˜¯è¿™ä¸ªï¼š

```js
const http = require('http');

http.createServer(function (req, res) {
  res.write('Hello World!');
  res.end();
}).listen(3000);
```

åœ¨ Node.js 10 ç‰ˆæœ¬ä¸­ï¼Œæœ‰ä¸€ä¸ªå´­æ–°çš„ **http2** æ¨¡å—å¯ä»¥è®©æˆ‘ä»¬ä½¿ç”¨ HTTP/2.0ï¼å¯ç®—æ˜¯è¿æ¥äº† HTTP/2.0ï¼

```js
const http = require('http2');
const fs = require('fs');

const options = {
  key: fs.readFileSync('example.key'),
  cert: fs.readFileSync('example.crt')
 };

http.createSecureServer(options, function (req, res) {
  res.write('Hello World!');
  res.end();
}).listen(3000);
```

![Http/2 åè®® logo](https://tsh.io/wp-content/uploads/2018/12/https2-logo-300x300.png)

æˆ‘ä»¬å¿ƒå¿ƒå¿µå¿µçš„å°±æ˜¯ Node.js 10 ç‰ˆæœ¬ä¸­å…¨é¢æ”¯æŒçš„ HTTP/2ã€‚

## è¿™äº›æ–°ç‰¹æ€§ä¼šè®© Node.js çš„æœªæ¥ä¸€ç‰‡å…‰æ˜

Node.js çš„æ–°ç‰¹æ€§ä¸ºæˆ‘ä»¬çš„æŠ€æœ¯ç”Ÿæ€æ³¨å…¥äº†æ–°é²œè¡€æ¶²ã€‚å®ƒä»¬ç»™ Node.js æ’ä¸Šç¿…è†€ï¼Œè®©å®ƒé£å‘æ–°çš„å¤©åœ°ã€‚ä½ æƒ³åˆ°è¿‡è¿™ä¸ªæŠ€æœ¯æœ‰ä¸€å¤©ä¼šç”¨äºå›¾åƒè¯†åˆ«æˆ–è€…æ•°æ®ç§‘å­¦å—ï¼Ÿæˆ‘ä¹Ÿä»æ¥æ²¡æœ‰æƒ³åˆ°è¿‡ã€‚

è¿™ä¸ªç‰ˆæœ¬çš„ Node.js è¿˜å¸¦æ¥äº†æ›´å¤šçš„äººä»¬æœŸç›¼å·²ä¹…çš„ç‰¹æ€§ï¼Œä¾‹å¦‚å¯¹ **ES æ¨¡å—**çš„æ”¯æŒï¼ˆè™½ç„¶ä»å‡ºäºè¯•éªŒé˜¶æ®µï¼‰ï¼›åˆå¦‚ **fs** æ–¹æ³•çš„æ›´æ–°ï¼Œç»ˆäºè®©æˆ‘ä»¬èƒ½å¤Ÿè„±ç¦»å›è°ƒåœ°ç‹±ã€æ‹¥æŠ± Promise å¤©å ‚äº†ã€‚

æƒ³çŸ¥é“**æ›´å¤šçš„ Node.js æ–°ç‰¹æ€§**å—ï¼Ÿè¯·è§‚çœ‹[è¿™ä¸ªçŸ­è§†é¢‘](https://youtu.be/FuWZeUfaI4s)ã€‚

åœ¨ä¸‹é¢çš„æŠ˜çº¿å›¾ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œç»è¿‡å†å¹´çš„å¢é•¿ï¼ŒNode.js çš„äººæ°”åœ¨ 2017 å¹´æ—©æœŸè¾¾åˆ°äº†å·…å³°ã€‚è¿™å¹¶ä¸æ˜¯å¢é•¿å¼€å§‹ç¼“æ…¢çš„è¿¹è±¡ï¼Œè€Œæ˜¯æ ‡å¿—ç€è¿™ä¸ªæŠ€æœ¯çš„æˆç†Ÿã€‚

![Node.js å†å¹´äººæ°”æŠ˜çº¿å›¾ï¼Œ2017 å¹´è¾¾åˆ°å³°å€¼](https://tsh.io/wp-content/uploads/2018/12/node-popularity-over-the-years-chart-1024x425.png)

ä¸è®ºå¦‚ä½•ï¼Œæˆ‘èƒ½å¤Ÿæ¸…æ™°åœ°çœ‹å‡ºï¼Œæ‰€æœ‰è¿™äº›æ–°çš„æ”¹è¿›å’Œ Node.js åŒºå—é“¾åº”ç”¨ï¼ˆåŸºäº truffle.js æ¡†æ¶ï¼‰çš„èµ°çº¢ï¼Œæˆ–å¯è¿›ä¸€æ­¥æ¨åŠ¨ Node.js çš„å‘å±•ï¼Œè®© Node.js åœ¨æ–°å‹çš„é¡¹ç›®ã€è§’è‰²å’Œç¯å¢ƒä¸­æ¢…å¼€äºŒåº¦ã€‚

TSHï¼ˆThe Software Houseï¼‰Node.js å›¢é˜Ÿéå¸¸æœŸå¾… 2020 å¹´çš„åˆ°æ¥!

> å¦‚æœå‘ç°è¯‘æ–‡å­˜åœ¨é”™è¯¯æˆ–å…¶ä»–éœ€è¦æ”¹è¿›çš„åœ°æ–¹ï¼Œæ¬¢è¿åˆ° [æ˜é‡‘ç¿»è¯‘è®¡åˆ’](https://github.com/xitu/gold-miner) å¯¹è¯‘æ–‡è¿›è¡Œä¿®æ”¹å¹¶ PRï¼Œä¹Ÿå¯è·å¾—ç›¸åº”å¥–åŠ±ç§¯åˆ†ã€‚æ–‡ç« å¼€å¤´çš„ **æœ¬æ–‡æ°¸ä¹…é“¾æ¥** å³ä¸ºæœ¬æ–‡åœ¨ GitHub ä¸Šçš„ MarkDown é“¾æ¥ã€‚

---

> [æ˜é‡‘ç¿»è¯‘è®¡åˆ’](https://github.com/xitu/gold-miner) æ˜¯ä¸€ä¸ªç¿»è¯‘ä¼˜è´¨äº’è”ç½‘æŠ€æœ¯æ–‡ç« çš„ç¤¾åŒºï¼Œæ–‡ç« æ¥æºä¸º [æ˜é‡‘](https://juejin.im) ä¸Šçš„è‹±æ–‡åˆ†äº«æ–‡ç« ã€‚å†…å®¹è¦†ç›– [Android](https://github.com/xitu/gold-miner#android)ã€[iOS](https://github.com/xitu/gold-miner#ios)ã€[å‰ç«¯](https://github.com/xitu/gold-miner#å‰ç«¯)ã€[åç«¯](https://github.com/xitu/gold-miner#åç«¯)ã€[åŒºå—é“¾](https://github.com/xitu/gold-miner#åŒºå—é“¾)ã€[äº§å“](https://github.com/xitu/gold-miner#äº§å“)ã€[è®¾è®¡](https://github.com/xitu/gold-miner#è®¾è®¡)ã€[äººå·¥æ™ºèƒ½](https://github.com/xitu/gold-miner#äººå·¥æ™ºèƒ½)ç­‰é¢†åŸŸï¼Œæƒ³è¦æŸ¥çœ‹æ›´å¤šä¼˜è´¨è¯‘æ–‡è¯·æŒç»­å…³æ³¨ [æ˜é‡‘ç¿»è¯‘è®¡åˆ’](https://github.com/xitu/gold-miner)ã€[å®˜æ–¹å¾®åš](http://weibo.com/juejinfanyi)ã€[çŸ¥ä¹ä¸“æ ](https://zhuanlan.zhihu.com/juejinfanyi)ã€‚
