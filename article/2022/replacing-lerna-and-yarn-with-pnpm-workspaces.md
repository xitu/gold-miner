> * åŸæ–‡åœ°å€ï¼š[Replacing Lerna + Yarn with PNPM Workspaces](https://www.raulmelo.dev/blog/replacing-lerna-and-yarn-with-pnpm-workspaces)
> * åŸæ–‡ä½œè€…ï¼š[Raul Melo](https://www.raulmelo.dev/)
> * è¯‘æ–‡å‡ºè‡ªï¼š[æ˜é‡‘ç¿»è¯‘è®¡åˆ’](https://github.com/xitu/gold-miner)
> * æœ¬æ–‡æ°¸ä¹…é“¾æ¥ï¼š[https://github.com/xitu/gold-miner/blob/master/article/2022/replacing-lerna-and-yarn-with-pnpm-workspaces.md](https://github.com/xitu/gold-miner/blob/master/article/2022/replacing-lerna-and-yarn-with-pnpm-workspaces.md)
> * è¯‘è€…ï¼š[CarlosChenN](https://github.com/CarlosChenN)
> * æ ¡å¯¹è€…ï¼š

# ç”¨ PNPM Workspaces æ›¿æ¢ Lerna + Yarn

è¿‘å¹´æ¥ï¼ŒMonorepo æ¶æ„ä»¥è¶Šæ¥è¶Šæµè¡Œï¼Œé‰´äºå®ƒè§£å†³çš„é—®é¢˜ï¼Œè¿™æ˜¯å¯ä»¥ç†è§£çš„ã€‚ç„¶è€Œï¼Œæœ€å¤§çš„æŒ‘æˆ˜æ˜¯æ‰¾åˆ°ä¸€ä¸ªç®€å•æ˜“ç”¨çš„å·¥å…·å»å¤„ç†ç±»ä¼¼çš„æ¶æ„ã€‚

å¦‚æœä½  Google â€œmonorepo tool javascriptâ€ï¼Œä½ ä¼šæ‰¾åˆ°è®¸å¤šæ–‡ç« æè¿°æˆ‘ä»¬ç°æœ‰æœ€æµè¡Œçš„é€‰é¡¹ï¼Œæ¯ä¸ªéƒ½å°è¯•ä½¿ç”¨ä¸åŒçš„æ–¹å¼å»è§£å†³è¿™ä¸ªé—®é¢˜ã€‚

ä»æˆ‘ä»¬ç°æœ‰çš„é€‰é¡¹ï¼Œä¸€äº›å·²ç»å­˜åœ¨ä¸€æ®µæ—¶é—´ï¼ˆåƒ Lernaï¼‰ï¼Œä½†å·²ç»ä¸å†æŒç»­ç»´æŠ¤äº†ï¼›ä¸€äº›è¿˜æ²¡æ¸¡è¿‡æ–¹æ¡ˆï¼ˆåƒ Boltï¼‰ï¼Œä¸€äº›åœ¨è¿è¡Œï¼Œä½†åªé€‚ç”¨äºæŸç§ç‰¹å®šçš„é¡¹ç›®ã€‚

ä¸å¹¸çš„æ˜¯ï¼Œæˆ‘ä»¬æ²¡æœ‰ä¸€ä¸ªå¥½çš„å·¥å…·åŒ¹é…æ‰€æœ‰ JavaScript/Typescript ç±»å‹çš„é¡¹ç›®å’Œæ‰€æœ‰å›¢é˜Ÿè§„æ¨¡ï¼Œè¿™æ˜¯å¯ä»¥ç†è§£çš„ã€‚

ç„¶è€Œï¼Œç°åœ¨æœ‰ä¸€ä¸ªæ–°é€‰é¡¹ï¼Œå¯èƒ½åœ¨å¤§å¤šæ•°ä¾‹å­ä¸­ï¼Œå¯¹æˆ‘ä»¬æœ‰æ‰€å¸®åŠ©ï¼š**pnpm workspaces**ã€‚

ä½†åœ¨è°ˆåˆ° pnpm ä¹‹å‰ï¼Œè®©æˆ‘å‘Šè¯‰ä½ ï¼Œæˆ‘çš„ monorepo/workspaces ç”¨æ³•ï¼Œä»¥åŠæˆ‘æ˜¯å¦‚ä½•ä¸€å¼€å§‹å°±è§£å†³è¿™ä¸ªé—®é¢˜çš„ã€‚

## æˆ‘çš„åšå®¢

åœ¨æˆ‘ç¬¬ä¸€æ¬¡åˆ›å»ºæˆ‘çš„åšå®¢ï¼Œæˆ‘è‡ªå·±åšäº†ä¸€ä¸ª Next.js åº”ç”¨ï¼ŒæŠŠä»–æ”¾åˆ°ä¸€ä¸ª git ä»“åº“ï¼Œè¿˜æ¨ä¸€äº›è„šæ‰‹æ¶ä»£ç åœ¨é‚£é‡Œã€‚

åœ¨æ­¤ä¹‹åï¼Œæˆ‘éœ€è¦å»ºç«‹ä¸€ä¸ª CMSï¼ˆå†…å®¹ç®¡ç†ç³»ç»Ÿï¼‰å»å­˜æ”¾æˆ‘çš„å†…å®¹ã€‚ç„¶åï¼Œæˆ‘åˆ›å»ºä¸€ä¸ª Strapi åº”ç”¨ï¼ŒæŠŠå®ƒæ”¾åˆ°å¦ä¸€ä¸ª git ä»“åº“ï¼Œç„¶åå°†å®ƒæ¨é€åˆ°å¦ä¸€ä¸ª Github ä»“åº“ã€‚

ç„¶åï¼Œæˆ‘å†³å®š fork ä¸€ä¸ªå« `mdx-prism` çš„ä»“åº“å»ä¿®å¤ä¸€äº›å°é—®é¢˜å’Œè‡ªåŠ¨åŒ–éƒ¨ç½²ã€‚å†ä¸€æ¬¡ï¼Œå»ºç«‹å¦ä¸€ä¸ªæ–°çš„åŒ…å«å®ƒçš„ä»£ç çš„ git ä»“åº“ã€‚

æˆ‘æœ‰ 3 ä¸ª git ä»“åº“ï¼Œæ„å‘³ç€ï¼Œæˆ‘æœ‰äº†ä¸‰ä¸ª eslintï¼Œprettierï¼Œjestï¼Œbabelï¼Œå’Œ typescript é…ç½®ï¼Œæˆ‘å¤„ç†äº†ä¸€é˜µå­ã€‚

å¾ˆå¿«çš„ï¼Œæˆ‘è¢«æ¯ä¸ªä¾èµ–æ›´æ–°ï¼ˆåƒ TypeScriptï¼‰æ„Ÿåˆ°çƒ¦æ¼ï¼›æˆ‘ä¸å¾—ä¸æ›´æ–°æ‰€æœ‰ä»“åº“ï¼ˆä¸‰æ¬¡ pull è¯·æ±‚ï¼‰ã€‚æˆ‘å­¦åˆ°æ¯ä¸ªæ–°äº‹ç‰©åƒæ–°çš„ eslint è§„åˆ™ï¼Œæˆ‘åŒæ„ï¼Œæˆ‘ä¸å¾—ä¸åˆ°é‡Œé¢æ”¹ä¸‰æ¬¡ç­‰ç­‰ã€‚

æˆ‘çš„ç¬¬ä¸€ååº”æ˜¯ï¼š

> å¦‚æœæˆ‘æŠŠæ‰€æœ‰é¡¹ç›®æ”¾åˆ°ä¸€ä¸ªå•ç‹¬çš„æ–‡ä»¶å¤¹å’Œä»“åº“é‡Œï¼Œåˆ›å»ºæˆ‘çš„åŸºç¡€é…ç½®ï¼Œç„¶åç”¨å®ƒå»æ‰©å±•åˆ°æ¯ä¸ªé¡¹ç›®é…ç½®é‡Œå‘¢ï¼Ÿ

ä¸å¹¸çš„æ˜¯ï¼Œæˆ‘æ— æ³•ç®€å•æ”¾ä¸€äº›æ–‡ä»¶åœ¨é‚£ï¼Œæ‰©å±•ï¼Œå¸Œæœ›å®ƒè¿è¡Œï¼Œå› ä¸ºå®é™…æ¯”é‚£å¤æ‚å¾—å¤šã€‚å·¥å…·éœ€è¦ module/file è§£å†³æ–¹æ¡ˆï¼Œæˆ‘ä¸æƒ³åœ¨æˆ‘æƒ³è¦éƒ¨ç½²çš„æ—¶å€™ï¼Œä¼ é€åˆ°æ‰€æœ‰çš„é¡¹ç›®é‡Œã€‚

åœ¨é‚£ç¬é—´ï¼Œæˆ‘æ„è¯†åˆ°æˆ‘éœ€è¦ä¸€ä¸ª monorepo å·¥å…·å»é“¾æ¥ï¼Œè®©æˆ‘çš„ä½“éªŒæ›´å¥½ã€‚

æˆ‘å°è¯•ä¸€äº›è§£å†³æ–¹æ¡ˆï¼Œæœ€ç®€å•æ„å»ºå’Œè¿è¡Œçš„æ–¹å¼ Lerna + Yarn Workspacesã€‚

å½“ç„¶ï¼Œåœ¨æ„å»ºæµç¨‹ä¸­ï¼Œæˆ‘æœ‰ä¸€äº›æ„Ÿæ‚Ÿï¼Œæ¯”å¦‚ç†è§£ä¸ºä»€ä¹ˆæœ‰äº›æ„å»ºå¤±è´¥ï¼ˆä¸æ˜¯æ‰€æœ‰çš„åº”ç”¨å–œæ¬¢æå‡ä¾èµ–å…³ç³»ï¼‰ï¼Œå¿…é¡»é€‚é…æˆ‘çš„ç®¡é“ï¼Œä»¥åŠå¦‚ä½•æˆ‘å¦‚ä½•éƒ¨ç½²æ¯ä¸ªé¡¹ç›®ã€‚å°½ç®¡å¦‚æ­¤ï¼Œæˆ‘è¿˜æ˜¯ç®¡ç†æ‰€æœ‰ä¸œè¥¿ï¼Œå¹¶æœ‰ä¸ªåˆé€‚çš„é…ç½®ã€‚

æœ‰äº†ä¹‹å‰æœ€ç®€å•çš„è®¾ç½®ï¼Œæˆ‘å¼€å§‹åˆ›å»ºæ›´å°çš„ç‹¬ç«‹æ¨¡å—/åº”ç”¨å»å¤ç”¨ï¼Œæ‰©å±•ï¼Œå°è¯•æç‚¼ä¸ä¼šå¯¹æˆ‘ç°æœ‰ä»£ç äº§ç”Ÿå½±å“çš„æ–°å·¥å…·ã€‚è¿™æ˜¯æˆ‘äº²çœ¼è§è¯å®ƒåœ¨ä¸€ä¸ª monorepo è¿è¡Œå¾—è®©äººæƒŠè®¶çš„æ—¶åˆ»ã€‚

## å…³äº Lerna + Yarn Workspaces

Lerna æ˜¯ä¸€ä¸ªé«˜çº§ monorepo å·¥å…·ï¼Œå®ƒæä¾›åŒæ—¶ç®¡ç†ä¸€ä¸ªæˆ–å¤šä¸ªåº”ç”¨/åŒ…çš„æŠ½è±¡ã€‚ 

ä½ å¯ä»¥è¿è¡Œå‘½ä»¤ï¼ˆe.g., build, test, lintï¼‰ï¼Œç”¨ä¸€æ¡å‘½ä»¤æŒ‡ç¤ºæ‰€æœ‰ä½ æ§åˆ¶çš„é¡¹ç›®ï¼Œå¦‚æœä½ æƒ³ï¼Œä½ ç”šè‡³å¯ä»¥ç”¨æ ‡è®° `--scope`è¿‡æ»¤ä¸€ä¸ªæŒ‡å®šçš„é¡¹ç›®ã€‚

Yarn Workspaces æ˜¯ä¸€ä¸ªä½çº§å·¥å…·ï¼Œå®ƒæ“çºµåŒ…çš„å®‰è£…ï¼Œåœ¨é¡¹ç›®ä¹‹é—´åˆ›å»ºç¬¦å·é“¾æ¥ï¼Œå’Œåœ¨æ ¹ä¸­åˆ†é…æ¨¡å—ï¼Œæ§åˆ¶é¡¹ç›®æ–‡ä»¶å¤¹ã€‚

ä½ èƒ½ç”¨æ•´ä¸ª Lerna æˆ–è€… Yarn Workspaces å»ç®¡ç†ä½ çš„ä»“åº“ï¼Œä½†ä½ å¯èƒ½æ³¨æ„åˆ°ä»–ä»¬çš„äº’è¡¥å¤§äºä»–ä»¬çš„äº’æ–¥ã€‚æ¢å¥è¯è¯´ï¼Œå®ƒä»¬ä¸€èµ·è¿è¡Œçš„å¾ˆå¥½ã€‚

ç”šè‡³ç°åœ¨ï¼Œè¿™ä¸ªç»“åˆä»ç„¶æ˜¯å¥½é€‰æ‹©ï¼Œä½†ä¸€äº›é—®é¢˜å¯èƒ½è¿˜æ˜¯çªå‡ºï¼š

* Yarn Workspacesï¼ˆè‡³å°‘å¯¹ v1ï¼‰ä¸å†æ¥æ”¶æ–°ç‰¹æ€§å’Œæ”¹è¿›ï¼ˆä¸Šæ¬¡æ›´æ–°æ˜¯åœ¨ 2018ï¼‰ï¼›
* Lerna æ–‡æ¡£æ˜¯å¯ä»¥çš„ï¼Œä½†ä½ éœ€è¦è‡ªå·±å¼„æ˜ç™½å¾ˆå¤šé—®é¢˜ï¼›
* Lerna å‘å¸ƒç³»ç»Ÿå¹¶ä¸æ˜¯å®ƒçœ‹åˆ°çš„é‚£ä¹ˆç®€å•ï¼Œç‰¹åˆ«æ˜¯ç”¨ commit lint å¼•å‘è‡ªåŠ¨å‘å¸ƒã€‚
* ä½ å¿…é¡»è¿è¡Œçš„å‘½ä»¤æˆ–è€…ä½ è°ƒç”¨åˆ«çš„å‘½ä»¤å¼€å§‹è¿è¡Œæ—¶ï¼Œä¼šå¾ˆå®¹æ˜“åœ¨ç†è§£ä¸­è¿·å¤±ï¼›
* Lerna CLI æœ‰ä¸€äº›åƒ[ä½ æ— æ³•åœ¨åŒä¸€æ—¶é—´å®‰è£…å¤šä¸ªä¾èµ–](https://github.com/lerna/lerna/issues/2004) ç­‰é—®é¢˜ã€‚
* Lerna CLI `--scope`å¹¶ä¸å¯é å¹¶ä¸”éš¾ä»¥ç†è§£å’Œä½¿ç”¨ï¼›
* æœ‰ä¸€ä¸ª [wizard](https://github.com/webuniverseio/lerna-wizard) åœ¨å¸¸è§ä»»åŠ¡ä¸­å¸®åŠ©æˆ‘ä»¬ï¼Œä½†å®ƒæ›´åƒæ˜¯åœ¨ä¸»ä»“åº“ä¹‹å¤–ç»´æŠ¤çš„ã€‚
* [Lerna ç›®å‰æ˜¯æ²¡æœ‰ç»´æŠ¤çš„](https://github.com/lerna/lerna/issues/2703#issuecomment-744601134);

åœ¨å®ƒåˆ›å»ºçš„æ—¶å€™ï¼ˆåœ¨ 2015 å¹´ï¼‰ï¼ŒLernaå¸®åŠ©è§£å†³äº†ç¼ºå°‘å·¥å…·ç®¡ç† JS monorepos çš„é—®é¢˜ï¼Œå¹¶ä¸”åšå¾—å¾ˆå¥½ã€‚

è™½ç„¶å› ä¸ºå®ƒä»¬å¯èƒ½æ²¡æœ‰ä¸€ä¸ªä¸“æ³¨å›¢é˜Ÿï¼ˆæˆ–è€…å‡ ä¸ªäººï¼‰å»ç»´æŠ¤å®ƒï¼Œè§„åˆ’å·¥å…·çš„æœªæ¥ï¼ŒLerna æ­£åœ¨æ…¢æ…¢æ­»äº¡ã€‚

æˆ‘åœ¨è¿™é‡Œä¸æ˜¯æŠ±æ€¨åˆ›å»ºè€…å’Œç»´æŠ¤è€…ï¼Œå¼€æºçš„ä¸–ç•Œæœ‰è®¸å¤šçš„é—®é¢˜ï¼Œä½†è¿™æ˜¯å¦ä¸€ç¯‡æ–‡ç« çš„ä¸»é¢˜ã€‚

ä½ ä¹Ÿè®¸ä¸ä¼šæƒ³ï¼š

> å¦‚æœ Lerna åœ¨è¿™ä¸ªæ—¶ä»£ï¼Œæˆ‘ä»¬ç°åœ¨æœ‰ä»€ä¹ˆé€‰é¡¹ï¼Ÿ

## pnpm ç®€ä»‹

ä»¥é˜²ä½ ä¸çŸ¥é“ï¼Œåƒ **npm** å’Œ **Yarn**ï¼Œ**pnpm** ä¹Ÿæ˜¯ä¸€ä¸ª JavaScript é¡¹ç›®çš„åŒ…ç®¡ç†å·¥å…·ã€‚å®ƒç”¨é«˜æ•ˆçš„æ–¹å¼åšåŒæ ·çš„å·¥ä½œã€‚

**pnpm** æœ€å¤§çš„é—®é¢˜æ˜¯ï¼Œå®ƒè§£å†³ä¸€ä¸ª npm å¼•å…¥å’Œ Yarn å¤åˆ¶çš„é—®é¢˜ï¼Œè¿™ä¸ªé—®é¢˜æ˜¯å®‰è£…ä¾èµ–çš„æ–¹å¼ã€‚

**pnpm** æœ‰ä¸¤ä¸ªå¤§é—®é¢˜éœ€è¦è§£å†³ï¼š

### ç£ç›˜ç©ºé—´

æ¯”å¦‚è¯´ä½ æœ‰ 5 ä¸ªåŒ…å« `react@17.0.2` ä½œä¸ºä¾èµ–çš„é¡¹ç›®ã€‚

å½“ä½ åœ¨æ‰€æœ‰é¡¹ç›®é‡Œ  **npm** or **Yarn** install æ—¶ï¼Œæ¯ä¸ªé¡¹ç›®å°†ä¼šåœ¨  `node_modules` ä¸­æœ‰å®ƒè‡ªå·±çš„ React å‰¯æœ¬ã€‚è€ƒè™‘åˆ° React å¤§æ¦‚æœ‰ **6.9kB**ï¼Œåœ¨ 5 ä¸ªä»“åº“ä¸­ï¼Œæˆ‘ä»¬å°†åœ¨ä½ çš„ç£ç›˜ä¸­æœ‰ **34.5kB** çš„ç›¸åŒä¾èµ–ã€‚

è¿™ä¸ªä¾‹å­çœ‹èµ·æ¥å¾ˆå°ï¼Œä½†æ¯ä¸ªä½¿ç”¨ JS çš„ äººçŸ¥é“ï¼Œæœ‰æ—¶å€™ `node_modules` èƒ½ç®€å•å¾—è¾¾åˆ° GB çº§åˆ«ã€‚

ä½¿ç”¨ **pnpm** å®‰è£…ä¾èµ–ï¼Œå®ƒå…ˆæ˜¯åœ¨å®ƒæœ¬èº«çš„å­˜å‚¨ï¼ˆ`~/.pnpm-store`ï¼‰ä¸­ä¸‹è½½ã€‚åœ¨é‚£ä¸‹è½½ä¹‹åï¼Œå®ƒåœ¨ä½ çš„é¡¹ç›®ä¸­åˆ›å»ºä¸€ä¸ªä¸€ä¸ªä» module åˆ° node_module çš„ç¡¬é“¾æ¥.

åœ¨ä¹‹å‰ç›¸åŒçš„ä¾‹å­ä¸­ï¼Œ**pnpm** å°†åœ¨å®ƒè‡ªèº«çš„å­˜å‚¨ä¸­å®‰è£… `react@17.0.2`ï¼Œå½“æˆ‘ä»¬å®‰è£…é¡¹ç›®çš„ä¾èµ–æ—¶ï¼Œå®ƒä¼šå…ˆæ£€æŸ¥ 17.0.2 ç‰ˆæœ¬çš„ React æ˜¯å¦å·²ç»ä¿å­˜ã€‚å¦‚æœæ˜¯çš„è¯ï¼Œå®ƒä¼šåœ¨é¡¹ç›®çš„ `node_modules` åˆ›å»ºä¸€ä¸ªç¡¬é“¾æ¥ï¼ˆæŒ‡å‡ºç£ç›˜ä¸­çš„æ–‡ä»¶ï¼‰ã€‚

ç°åœ¨ï¼Œç›¸æ¯” 5 ä»½ `react@17.0.2` å‰¯æœ¬ ï¼ˆ**34.5kB**ï¼‰ åœ¨æˆ‘ä»¬çš„ç£ç›˜ä¸­ï¼Œæˆ‘ä»¬å°†æœ‰ 1 ä¸ªç‰ˆæœ¬ï¼ˆ**6.9kB**ï¼‰åœ¨ pnpm ä»“åº“æ–‡ä»¶å¤¹å’Œä¸€ä¸ªç¡¬é“¾æ¥ï¼ˆå®ƒä¸å‰¯æœ¬æ–‡ä»¶åšåŒæ ·çš„å·¥ä½œï¼‰åœ¨æ¯ä¸ªç”¨è¿™ä¸ªç‰ˆæœ¬ React é¡¹ç›®çš„é¡¹ç›®ä¸­ã€‚

å› æ­¤ï¼Œæˆ‘ä»¬èŠ‚çœäº†å¾ˆå¤šç£ç›˜ç©ºé—´å’Œä¸ºæˆ‘ä»¬å·²ç»å®‰è£…å¥½çš„ä¾èµ–çš„æ–°é¡¹ç›®ï¼Œæä¾›æ›´å¿«çš„å®‰è£…é€Ÿåº¦

## Phantom ä¾èµ–

å½“æˆ‘ä»¬ç”¨ **npm** å®‰è£…ä¾èµ–æ—¶ï¼Œå®ƒä¸‹è½½æ‰€æœ‰ä¾èµ–ï¼Œä¾èµ–æŠŠæ‰€æœ‰ä¸œè¥¿æ¨åˆ°  `node_modules` é‡Œã€‚è¿™å°±æ˜¯å®ƒä»¬æ‰€ç§°çš„ "flat way"ã€‚

è®©æˆ‘ä»¬åœ¨ç»ƒä¹ ä¸­æ¥çœ‹è¿™ä¸ªã€‚ä¸‹é¢æ˜¯ `package.json`ï¼š 

```json
{
  "dependencies": {
    "unified": "10.1.0"
  }
}
```

åœ¨è¿è¡Œ `npm install` ä¹‹åï¼Œ`node_modules` ä¼šå˜æˆä¸‹é¢è¿™æ ·ï¼š 

```text
node_modules
â”œâ”€â”€ @types
â”œâ”€â”€ bail
â”œâ”€â”€ extend
â”œâ”€â”€ is-buffer
â”œâ”€â”€ is-plain-obj
â”œâ”€â”€ trough
â”œâ”€â”€ unified
â”œâ”€â”€ unist-util-stringify-position
â”œâ”€â”€ vfile
â””â”€â”€ vfile-message
```

è™½ç„¶è¿™ç§æ–¹å¼å·²ç»å·¥ä½œäº†è®¸å¤šå¹´ï¼Œå®ƒèƒ½å¯¼è‡´ä¸€äº›å«åš â€œphantom dependencyâ€ çš„é—®é¢˜ã€‚

åœ¨æˆ‘ä»¬é¡¹ç›®ä¸­å£°æ˜çš„å”¯ä¸€ä¾èµ–æ˜¯`ç»Ÿä¸€çš„`ï¼Œä½†åœ¨æˆ‘ä»¬çš„é¡¹ç›®ä¸­ï¼Œä»ç„¶èƒ½åœ¨æˆ‘ä»¬çš„ä»£ç ä¸­å¯¼å…¥`is-plain-obj` (ç»Ÿä¸€çš„ä¾èµ–)ï¼š

```js
import ob from "is-plain-obj";

console.log(ob); // [Function: isPlainObject]
```

å› ä¸ºè¿™æ˜¯å¯èƒ½å‘ç”Ÿçš„ï¼Œæˆ‘ä»¬çš„ä¾èµ–å’Œæˆ‘ä»¬çš„ä¾èµ–çš„ä¾èµ–ä¹Ÿèƒ½å‡ºè¿™ä¸ªé”™è¯¯ï¼Œä» `node_modules`å¯¼å…¥ä¸€äº›ä¸œè¥¿ï¼Œè€Œä¸å°†å…¶å£°æ˜ä¸º dependency/peerDependencyã€‚

ç°åœ¨ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹ **pnpm** æ˜¯å¦‚ä½•åšåˆ°çš„ã€‚

ç”¨ç›¸åŒçš„ `package.json`ï¼Œç„¶åè¿è¡Œ `pnpm install`ï¼Œæˆ‘ä»¬å°†ä¼šæœ‰ä¸‹é¢çš„ `node_modules`ï¼š

```text
node_modules
â”œâ”€â”€ .pnpm
â”œâ”€â”€ @types
â”œâ”€â”€ unified -> .pnpm/unified@10.1.0/node_modules/unified
â””â”€â”€ .modules.yaml
```

æ­£å¦‚ä½ æ‰€çœ‹åˆ°çš„ï¼Œå¯¹äºå”¯ä¸€çš„ä¾èµ–ï¼Œæˆ‘ä»¬ç”¨çš„æ˜¯ç»Ÿä¸€çš„ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬ä»…æœ‰çš„ï¼Œä½†æ˜¯â€¦â€¦æœ‰ä¸€ä¸ªç®­å¤´æŒ‡æ˜è¿™ä¸ªæ¨¡å—çš„æ˜¯ä¸€ä¸ªç¬¦å·é“¾æ¥ã€‚

ç„¶åï¼Œè§‚å¯Ÿ `.pnpm` é‡Œé¢æœ‰ä»€ä¹ˆï¼š

```text
node_modules
â”œâ”€â”€ .pnpm
â”‚ â”œâ”€â”€ @types+unist@2.0.6
â”‚ â”œâ”€â”€ bail@2.0.1
â”‚ â”œâ”€â”€ extend@3.0.2
â”‚ â”œâ”€â”€ is-buffer@2.0.5
â”‚ â”œâ”€â”€ is-plain-obj@4.0.0
â”‚ â”œâ”€â”€ node_modules
â”‚ â”œâ”€â”€ trough@2.0.2
â”‚ â”œâ”€â”€ unified@10.1.0
â”‚ â”œâ”€â”€ unist-util-stringify-position@3.0.0
â”‚ â”œâ”€â”€ vfile-message@3.0.2
â”‚ â”œâ”€â”€ vfile@5.2.0
â”‚ â””â”€â”€ lock.yaml
â”œâ”€â”€ @types
â”‚ â””â”€â”€ unist -> ../.pnpm/@types+unist@2.0.6/node_modules/@types/unist
â”œâ”€â”€ unified -> .pnpm/unified@10.1.0/node_modules/unified
â””â”€â”€ .modules.yaml
```

**pnpm** å°†æ¯ä¸ªä¾èµ–é¡¹ä½œä¸ºåç¼€å®‰è£…åœ¨ `.pnpm` æ–‡ä»¶å¤¹ä¸­ï¼Œç„¶åï¼Œå°†å®ƒä»¬ç§»åŠ¨åˆ°åœ¨ä½ çš„ package.json ä¸­å‡†ç¡®å®šä¹‰çš„ `node_modules` æ ¹ç›®å½•ã€‚

ç°åœ¨ï¼Œå¦‚æœæˆ‘ä»¬å°è¯•åƒä»¥å‰ä¸€æ ·å†™ç›¸åŒçš„ä»£ç ï¼Œæˆ‘ä»¬å°†ä¼šå¾—åˆ°ä¸€ä¸ªé”™è¯¯ï¼Œå› ä¸º `is-plain-obj` æ²¡æœ‰å®‰è£…åœ¨ `node_modules` ä¸­ï¼š

```
internal/process/esm_loader.js:74
 internalBinding('errors').triggerUncaughtException(
 ^

Error [ERR_MODULE_NOT_FOUND]: Cannot find package 'is-plain-obj' imported from /Users/raulmelo/development/sandbox/test-pnpm-npm/pnpm/index.js
```

è™½ç„¶ç”¨è¿™ç§æ–¹å¼ å®‰è£… `node_modules` æ›´åŠ å¯é ï¼Œè¿™å¯èƒ½ç ´ç¯ä¸€äº›å·²ç»ç”¨ä¸Šé¢çš„ flat `node_modules` æ„å»ºçš„åº”ç”¨å…¼å®¹æ€§ã€‚

> ä¸€ä¸ªä¾‹å­å°±æ˜¯ Strapi v3ã€‚ä½ å¯ä»¥åœ¨[è¿™](https://github.com/strapi/strapi/issues/9604)çœ‹åˆ°, ä»–ä»¬ä¹Ÿæ„è¯†åˆ°äº†è¿™ä¸€ç‚¹ï¼Œåœ¨å°†æ¥æŸå¤©ä¹Ÿä¼šè§£å†³çš„ã€‚

å¥½è¿çš„æ˜¯ï¼Œ**pnpm** ç”¨äº†è¿™äº›ä¾‹å­åˆ°è´¦å·é‡Œï¼Œç„¶åæä¾›ä¸€ä¸ªæ ‡è®°å« [`shamefully-hoist`](https://pnpm.io/npmrc#shamefully-hoist) ã€‚

å½“æˆ‘ä»¬ç”¨è¿™ä¸ªæ ‡è®°æ—¶ï¼Œä¾èµ–ä¼šç”¨â€flat wayâ€œå®‰è£…ä¾èµ–ï¼Œåº”ç”¨ä¼šåƒ Strapi è¿è¡Œã€‚

## pnpm Workspaces

**pnpm** åœ¨ v2 ä¸­å¼•å…¥çš„å·¥ä½œåŒºç‰¹æ€§ã€‚

å®ƒçš„ç›®æ ‡æ˜¯å¡«è¡¥æˆ‘ä»¬ç›®å‰æ‹¥æœ‰çš„æ˜“äºä½¿ç”¨å’Œç»´æŠ¤è‰¯å¥½çš„ monorepo å·¥å…·çš„å·®è·ã€‚

ç”±äºå®ƒä»¬å·²ç»æœ‰ä½çº§éƒ¨åˆ†ï¼ˆpackage managerï¼‰äº†ï¼Œå®ƒä»¬åªè¦æ·»åŠ ä¸€ä¸ªæ–°æ¨¡å—å»å¤„ç†ä½ é¡¹ç›®æ ¹ç›®å½•çº§ä¸­æœ‰çš„ `pnpm-workspace.yaml` æ–‡ä»¶å·¥ä½œåŒºã€‚

å®ƒä¸ Lerna + Yarn Workspaces çš„é…ç½®å‡ ä¹ä¸€æ ·ï¼Œæœ‰ä¸‰ä¸ªæ˜¾è‘—çš„ä¼˜åŠ¿ï¼š

1. æˆ‘ä»¬ä» **pnpm** æ§åˆ¶ç£ç›˜ç©ºé—´ä¿®å¤;
2. æˆ‘ä»¬ç”¨å®ƒä»¬å¾ˆæ£’çš„ CLI ï¼ˆè¿™æ˜¯å†…ç½®å¥½çš„ï¼Œå¹¶ä¸”æœ‰ç‰¹åˆ«æ£’çš„ DXï¼‰ï¼›
3. å®ƒè§£å†³äº†è®¸å¤š Lerna CLI åƒè¿‡æ»¤ï¼Œå®‰è£…å¤šç‰ˆæœ¬çš„é—®é¢˜ã€‚

åœ¨ï¼ˆå‡ ä¹ï¼‰æ‰€æœ‰å‘½ä»¤ï¼Œ **pnpm** å…è®¸æˆ‘ä»¬ç”¨ä¸€ä¸ªå« `--filter` çš„æ ‡è¯†è¿è¡Œã€‚æˆ‘è®¤ä¸ºè¿™æ˜¯ä¸è¨€è‡ªæ˜çš„ï¼Œä½†å®ƒä¼šä¸ºè¿‡æ»¤åçš„ä»“åº“è¿è¡Œè¯¥å‘½ä»¤ã€‚

æ‰€ä»¥æƒ³è±¡ä½ æœ‰ä¸¤æ¡ç‹¬ç«‹ pipelines çš„ä¸¤ä¸ªå®Œæ•´åº”ç”¨ã€‚ç”¨ Lerna + **npm** æˆ–è€… **Yarn**ï¼Œåœ¨æˆ‘ä»¬è¿è¡Œå®‰è£…å‘½ä»¤æ—¶ï¼Œæˆ‘ä»¬ç»™æ¯ä¸ªé¡¹ç›®å®‰è£…ä¾èµ–ã€‚

è¿™æ„å‘³ç€ï¼Œåœ¨ä¸€äº›ä¾‹å­ä¸­ï¼Œä¸‹è½½ 1GB çš„ä¾èµ–å¯ä»¥é™åˆ° 300MBã€‚

æœ‰äº† **pnpm**ï¼Œæˆ‘å¯ä»¥ç®€å•çš„è¿è¡Œï¼š

```bash
pnpm install --filter website
```

ç°åœ¨ï¼Œåªæœ‰æ ¹ç›®å½•ä¾èµ–å’Œæˆ‘çš„ç½‘ç«™çš„ä¾èµ–ä¼šè¢«å®‰è£…ã€‚

è¿‡æ»¤çš„å‘½ä»¤å·²ç»è¶³å¤Ÿå¥½äº†ï¼Œä½†æ˜¯å®ƒè¶…è¶Šå¹¶ä¸”æä¾›æ›´å¤šçš„çµæ´»æ€§ã€‚

æˆ‘å»ºè®®ä½ é˜…è¯»ä¸€ä¸‹ [pnpm's "Filtering" æ–‡æ¡£](https://pnpm.io/filtering) ç„¶åçœ‹ä¸€ä¸‹å®ƒæ˜¯æœ‰å¤šä¹ˆä»¤äººæƒŠè®¶ã€‚

> å¦ä¸€ä¸ªå»ºè®®ï¼š["pnpm vs Lernaï¼šå¤šåŒ…ä»“åº“ä¸­ç­›é€‰"](https://medium.com/pnpm/pnpm-vs-lerna-filtering-in-a-multi-package-repository-1f68bc644d6a)

è¿™çœ‹èµ·æ¥æ˜¯ä¸€ä»¶ç‰¹åˆ«å°çš„äº‹æƒ…ï¼Œä½†æ˜¯è¿™äº›å°ç»†èŠ‚åœ¨ä¸åŒç¯å¢ƒä¸­ï¼Œåœ¨æ•´ä¸ªå·¥ä½œä¸­é€ æˆäº†å¾ˆå¤§çš„ä¸åŒã€‚

## è¿ç§»

å¦‚æœä½ æƒ³çœ‹æˆ‘å·²ç»åˆå¹¶åŒ…å«æ•´ä¸ªè¿ç§» PRï¼Œä½ å¯ä»¥çœ‹[è¿™é‡Œ](https://github.com/raulfdm/raulmelo-studio/pull/803) ã€‚æˆ‘å°†åªé«˜äº®æ‰€æœ‰æˆ‘éœ€è¦å±•ç¤ºçš„æ”¹å˜ã€‚

### æ›¿ä»£å‘½ä»¤

æˆ‘æœ‰ä¸€å †è„šæœ¬ï¼Œæ‰§è¡Œ `yarn` CLIã€‚å¯¹äºè¿™äº›ï¼Œæˆ‘åªéœ€è¦ç”¨ `pnpm <command>` æˆ–è€… `pnpm run <command>` æ›¿æ¢ï¼›

### ç§»é™¤ Yarn Workspace é…ç½®

åœ¨æˆ‘çš„ package.jsonï¼Œæˆ‘å·²ç»ä¸º Yarn å£°æ˜å·¥ä½œåŒºåŒºåŸŸå¹¶ä¸”å®šä¹‰ä¸€äº›æ²¡æœ‰æå‡åˆ°æ ¹ node_modules çš„åŒ…ï¼›

```json
{
"workspaces": {
   "packages": [
     "packages/*",
     "apps/*"
   ],
   "nohoist": [
     "**/netlify-lambda",
     "**/netlify-lambda/**"
   ]
 }
}
```

è¿™ä¸€åˆ‡éƒ½è¿‡å»äº†ã€‚

### ç”¨ `pnpm-workspace.yml` ä»£æ›¿ `lerna.json` 

æˆ‘å·²ç»ç§»é™¤äº†ä¸‹é¢çš„é…ç½®ï¼š

```json
{
  "version": "independent",
  "packages": ["packages/*", "apps/*"],
  "npmClient": "yarn",
  "useWorkspaces": true,
  "command": {
    "version": {
      "allowBranch": "main"
    },
    "publish": {
      "conventionalCommits": true,
      "message": "chore(release): publish",
      "ignoreChanges": ["*.md", "!packages/**/*"]
    }
  }
}
```

æ¢æˆ:

```yml
prefer-workspace-packages: true
packages:
  - 'packages/*'
  - 'apps/*'
```

### é€‚é… pipelinesï¼ŒDockerfileï¼Œå’Œä¸»å¹³å°

ä¸€ä»¶äº‹æˆ‘å¿…é¡»æ”¹å˜çš„æ˜¯ç¡®ä¿æˆ‘ä¸€ç›´åœ¨å®‰è£… `pnpm` ä¹‹å‰ï¼Œå®‰è£…æˆ‘ Github Actions é‡Œçš„ä¾èµ–ï¼ŒDocker é•œåƒï¼Œå’Œ Vercel's å®‰è£…è„šæœ¬ï¼š

```bash
npm install -g pnpm && pnpm install --filter <project-name>
```

è¿™æ˜¯å¿…ä¸å¯å°‘çš„æ­¥éª¤å› ä¸ºå¤§å¤šæ•°ç¯å¢ƒåŒ…å«å¼€ç®±å³ç”¨çš„ yarnï¼Œè€Œä¸æ˜¯ pnpmï¼ˆæˆ‘å¸Œæœ›è¿™ä¼šå¾ˆå¿«æ”¹å˜ï¼‰ã€‚

### ç§»é™¤ `yarn.lock` æ–‡ä»¶

è¿™ä¸ªæ–‡ä»¶å·²ç»ä¸å†éœ€è¦äº†ã€‚Pnpm åˆ›å»ºäº†å®ƒè‡ªèº«çš„ `pnpm-lock.yaml` é”æ–‡ä»¶å»æ§åˆ¶ä¾èµ–ç‰ˆæœ¬ã€‚

### é€‚é…æ„å»ºå‘½ä»¤

åœ¨æˆ‘ä¸ºæˆ‘çš„ç½‘ç«™è¿è¡Œ `lerna run build` æ—¶ï¼Œå®ƒè‡ªåŠ¨ç†è§£ï¼Œå®ƒå¿…é¡»æ„å»ºæˆ‘çš„ç½‘ç«™ä½¿ç”¨çš„åŒ…ã€‚

å¯¹äº **pnpm**ï¼Œæˆ‘å¿…é¡»æ˜ç¡®è¯´æ˜ï¼š

```bash
pnpm run build --filter website # Only build the website

pnpm run build --filter website... # Builds first all dependencies from the website and only then, the website
```

è¿™æ˜¯é‡è¦çš„ï¼Œå› ä¸ºæˆ‘ä¸æ˜¯æŠŠæ‰€æœ‰åŒ…å‘å¸ƒåœ¨ NPMã€‚

### æ·»åŠ  `.npmrc`

pnpm é€šè¿‡ CLI æ¥æ”¶ä¸€å †æ ‡è¯†å’Œé€‰é¡¹ã€‚å¦‚æœæˆ‘ä¸æƒ³ä¸€ç›´é€šè¿‡å®ƒä»¬ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä¸€ä¸ª `.npmrc` æ–‡ä»¶ä¸­å®šä¹‰å®ƒä»¬ã€‚

æˆ‘æ·»åŠ åœ¨é‚£é‡Œçš„å”¯ä¸€é€‰é¡¹æ˜¯ï¼š

```bash
shamefully-hoist=true
```

å°±åƒæˆ‘å‰é¢è§£é‡Šçš„ï¼ŒStrapi å¹¶ä¸èƒ½ä½¿ç”¨ pnpm çš„å®‰è£… node_modules æ–¹å¼ï¼Œè¿™æ˜¯æƒ­æ„§çš„ã€‚

é€šè¿‡æäº¤è¿™äº›æ–‡ä»¶ï¼Œæˆ‘ç¡®ä¿äº†ï¼Œæ— è®ºåœ¨å“ªï¼Œæˆ‘è¿è¡Œ `pnpm install` æ—¶ï¼Œä¾èµ–ä¼šè¢«æ­£ç¡®çš„å®‰è£…ã€‚

### ç”¨ Changesets æ›¿æ¢ semantic-release

æˆ‘å¿…é¡»å¦ç™½ï¼Œæˆ‘ç°åœ¨è¿˜æ²¡æœ‰å®Œå…¨æµ‹è¯•è¿™ä¸ªã€‚

æ€»ç»“ï¼Œåœ¨æˆ‘ä¹‹å‰çš„æ­¥éª¤ï¼Œæˆ‘è¢«è¿«ä»¥ä¸€ç§ç‰¹å®šçš„æ–¹å¼ç¼–å†™æäº¤ï¼Œä»¥ä¾¿è¯­ä¹‰å‘å¸ƒèƒ½å¤Ÿæ£€æŸ¥æˆ‘çš„æ›´æ”¹ï¼Œé€šè¿‡è¯»å–æ¶ˆæ¯è‡ªåŠ¨çŸ¥é“æ›´æ”¹äº†ä»€ä¹ˆï¼Œæ›´æ”¹ç‰ˆæœ¬å¹¶å‘å¸ƒæˆ‘çš„åŒ…ã€‚

æˆ‘ä¹‹å‰è¿è¡Œå¾—å¾ˆå¥½ï¼Œä½†ä¸€äº›é™·é˜±ï¼Œç‰¹åˆ«æ˜¯è€ƒè™‘ Github Actions ç¯å¢ƒæ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚

Though, Pnpm recommends we use [changesets from Atlassian](https://pnpm.io/using-changesets).

è™½ç„¶ï¼ŒPnpm å»ºè®®æˆ‘ä»¬ç”¨ [Atlassian çš„ changesets](https://pnpm.io/using-changesets) ã€‚

è¿™ä¸ªæ–¹å¼æœ‰ç‚¹ä¸åŒã€‚ç°åœ¨å¦‚æœæˆ‘åšä¸€ä¸ªæ”¹å˜ï¼Œæˆ‘å¿…é¡»åˆ›å»ºä¸€ä¸ªå¸¦æœ‰ä¸€äº› meta ä¿¡æ¯å’Œæè¿°å“ªäº›æ”¹å˜çš„ .md æ–‡ä»¶ï¼ŒåŸºäºè¿™ä¸ªæ–‡ä»¶ï¼Œæ˜ç™½å¦‚ä½•ç”Ÿæˆæ”¹å˜ longï¼Œä»¥åŠåº”è¯¥æ›´æ”¹å“ªä¸ªç‰ˆæœ¬ã€‚

æˆ‘ä»ç„¶éœ€è¦å®Œæˆè¿™ä¸ªå‡†å¤‡å·¥ä½œå’Œå¯èƒ½å†™ä¸€ç¯‡å…³äºé‚£ä¸ªçš„æ–‡ç« ã€‚ ğŸ˜…

## ç»“è®º

è¿™å°±æ˜¯æˆ‘éœ€è¦ç”¨ **pnpm** workspaces ä»£æ›¿ Lerna + Yarn Workspaces çš„å…¨éƒ¨åŸºæœ¬çŸ¥è¯†ã€‚

è¯šå®è®²ï¼Œå®ƒæ¯”æˆ‘æœ€åˆè®¾æƒ³çš„æ›´ç®€å•ã€‚

æˆ‘ç”¨ **pnpm** æ›´å¤šï¼Œæˆ‘æ›´äº«å—å®ƒã€‚é¡¹ç›®æ˜¯å¯é çš„ï¼Œç”¨æˆ·ä½“éªŒæ˜¯ä»¤äººæ„‰å¿«çš„ã€‚

## å‚è€ƒ

* [https://pnpm.io](https://pnpm.io)
* [https://github.com/lerna/lerna](https://github.com/lerna/lerna)
* [https://classic.yarnpkg.com/lang/en/docs/workspaces/](https://classic.yarnpkg.com/lang/en/docs/workspaces/)
* [https://medium.com/pnpm/pnpm-vs-lerna-filtering-in-a-multi-package-repository-1f68bc644d6a](https://medium.com/pnpm/pnpm-vs-lerna-filtering-in-a-multi-package-repository-1f68bc644d6a)
* [https://github.com/raulfdm/raulmelo-studio/pull/803/files](https://github.com/raulfdm/raulmelo-studio/pull/803/files)
* [https://medium.com/@307/hard-links-and-symbolic-links-a-comparison-7f2b56864cdd](https://medium.com/@307/hard-links-and-symbolic-links-a-comparison-7f2b56864cdd)

> å¦‚æœå‘ç°è¯‘æ–‡å­˜åœ¨é”™è¯¯æˆ–å…¶ä»–éœ€è¦æ”¹è¿›çš„åœ°æ–¹ï¼Œæ¬¢è¿åˆ° [æ˜é‡‘ç¿»è¯‘è®¡åˆ’](https://github.com/xitu/gold-miner) å¯¹è¯‘æ–‡è¿›è¡Œä¿®æ”¹å¹¶ PRï¼Œä¹Ÿå¯è·å¾—ç›¸åº”å¥–åŠ±ç§¯åˆ†ã€‚æ–‡ç« å¼€å¤´çš„ **æœ¬æ–‡æ°¸ä¹…é“¾æ¥** å³ä¸ºæœ¬æ–‡åœ¨ GitHub ä¸Šçš„ MarkDown é“¾æ¥ã€‚

---

> [æ˜é‡‘ç¿»è¯‘è®¡åˆ’](https://github.com/xitu/gold-miner) æ˜¯ä¸€ä¸ªç¿»è¯‘ä¼˜è´¨äº’è”ç½‘æŠ€æœ¯æ–‡ç« çš„ç¤¾åŒºï¼Œæ–‡ç« æ¥æºä¸º [æ˜é‡‘](https://juejin.im) ä¸Šçš„è‹±æ–‡åˆ†äº«æ–‡ç« ã€‚å†…å®¹è¦†ç›– [Android](https://github.com/xitu/gold-miner#android)ã€[iOS](https://github.com/xitu/gold-miner#ios)ã€[å‰ç«¯](https://github.com/xitu/gold-miner#å‰ç«¯)ã€[åç«¯](https://github.com/xitu/gold-miner#åç«¯)ã€[åŒºå—é“¾](https://github.com/xitu/gold-miner#åŒºå—é“¾)ã€[äº§å“](https://github.com/xitu/gold-miner#äº§å“)ã€[è®¾è®¡](https://github.com/xitu/gold-miner#è®¾è®¡)ã€[äººå·¥æ™ºèƒ½](https://github.com/xitu/gold-miner#äººå·¥æ™ºèƒ½)ç­‰é¢†åŸŸï¼Œæƒ³è¦æŸ¥çœ‹æ›´å¤šä¼˜è´¨è¯‘æ–‡è¯·æŒç»­å…³æ³¨ [æ˜é‡‘ç¿»è¯‘è®¡åˆ’](https://github.com/xitu/gold-miner)ã€[å®˜æ–¹å¾®åš](http://weibo.com/juejinfanyi)ã€[çŸ¥ä¹ä¸“æ ](https://zhuanlan.zhihu.com/juejinfanyi)ã€‚
