> * åŸæ–‡åœ°å€ï¼š[Machine Learning with Android 11: Whatâ€™s new](https://proandroiddev.com/machine-learning-with-android-11-whats-new-1a8d084c7398)
> * åŸæ–‡ä½œè€…ï¼š[Rishit Dagli](https://medium.com/@rishit.dagli)
> * è¯‘æ–‡å‡ºè‡ªï¼š[æ˜é‡‘ç¿»è¯‘è®¡åˆ’](https://github.com/xitu/gold-miner)
> * æœ¬æ–‡æ°¸ä¹…é“¾æ¥ï¼š[https://github.com/xitu/gold-miner/blob/master/article/2021/machine-learning-with-android-11-whats-new.md](https://github.com/xitu/gold-miner/blob/master/article/2021/machine-learning-with-android-11-whats-new.md)
> * è¯‘è€…ï¼š[éœœç¾½ Hoarfroster](https://github.com/PassionPenguin)
> * æ ¡å¯¹è€…ï¼š

# ä½¿ç”¨ Android 11 è¿›è¡Œæœºå™¨å­¦ä¹ ï¼šæ–°åŠŸèƒ½

![ä½¿ç”¨ Android 11 è¿›è¡Œæœºå™¨å­¦ä¹ ï¼šæ–°åŠŸèƒ½](https://cdn-images-1.medium.com/max/3840/1*_6zTCa-SeOV2q549ey3b5Q.jpeg)

æœ¬æ–‡å°†ä¼šå‘å¤§å®¶å±•ç¤ºå¦‚ä½•ä½¿ç”¨ä¸“é—¨åœ¨ [Android 11](https://developer.android.com/11) ä¸Šå¯åŠ¨çš„å·¥å…·æˆ–æ’ä»¶æ¥å¼€å§‹ä½¿ç”¨è®¾å¤‡ä¸Šçš„æœºå™¨å­¦ä¹ åŠŸèƒ½ã€‚å¦‚æœä½ ä»¥å‰åœ¨ Android ä¸­ä½¿ç”¨è¿‡æœºå™¨å­¦ä¹ ï¼Œåˆ™å¯ä»¥è·Ÿéšæœ¬æ–‡ä¸€èµ·æ¢ç´¢å°†æœºå™¨å­¦ä¹ åº”ç”¨ç¨‹åºä¸ Android åº”ç”¨ç¨‹åºé›†æˆçš„æ›´ç®€ä¾¿æ–¹æ³•ã€‚è€Œå¦‚æœä½ ä»¥å‰æ²¡æœ‰åœ¨ Android ä¸­ä½¿ç”¨è¿‡æœºå™¨å­¦ä¹ ï¼Œé‚£ä¹ˆè¿™å¯èƒ½æ˜¯ä½ ä½¿ç”¨ Android è¿›è¡Œæœºå™¨å­¦ä¹ çš„èµ·ç‚¹ï¼Œå¹¶å¼€å§‹ä½ ä½¿ç”¨æœºå™¨å­¦ä¹ ä¸ºä½ çš„ Android åº”ç”¨ç¨‹åºæä¾›è¶…å¼ºåŠŸèƒ½ä¹‹æ—…ã€‚åœ¨æ­¤åšå®¢ä¸­ï¼Œæˆ‘å°†ä¸»è¦æ¼”ç¤º Android 11 çš„ä¸¤ä¸ªæœ€å¼ºå¤§çš„æ›´æ–°ï¼š[æœºå™¨å­¦ä¹ æ¨¡å‹ç»‘å®šæ’ä»¶](https://developer.android.com/studio/preview/features#tensor-flow-lite-models)å’Œ[æ–°çš„æœºå™¨å­¦ä¹ å¥—ä»¶](https://g.co/mlkit)ã€‚æˆ‘ä»¬ä¸‹é¢è®¨è®ºçš„æ‰€æœ‰ç¤ºä¾‹åº”ç”¨ç¨‹åºä»£ç éƒ½åœ¨[æ­¤ GitHub å­˜å‚¨åº“](https://github.com/Rishit-dagli/ML-with-Android-11)ä¸­å¯ä»¥æ‰¾åˆ°ã€‚

ä½ ä¹Ÿå¯ä»¥åœ¨ [GitHub å­˜å‚¨åº“](https://github.com/Rishit-dagli/ML-with-Android-11/blob/master/talks.md)ä¸­æŸ¥çœ‹æœ‰å…³è¯¥ä¸»é¢˜çš„è®¨è®ºã€‚

## ä¸ºä»€ä¹ˆæˆ‘ä»¬è¦å…³å¿ƒ Android è®¾å¤‡ä¸Šæœºå™¨å­¦ä¹ åŠŸèƒ½ï¼Ÿ

å¦‚ä½ æ‰€è§ï¼Œæˆ‘ä»¬åœ¨æœ¬æ–‡ä¸­ä¸»è¦å…³æ³¨è®¾å¤‡ä¸Šçš„æœºå™¨å­¦ä¹ ã€‚Android 11 å¯¹è®¾å¤‡ä¸Šçš„æœºå™¨å­¦ä¹ åšå‡ºäº†è®¸å¤šå¾ˆé…·çš„æ›´æ–°ï¼Œä½†è®©æˆ‘ä»¬ç®€å•åœ°è°ˆä¸€è°ˆä½ ä¸ºä»€ä¹ˆè¦å¯¹æ­¤åŠ ä»¥å…³æ³¨ï¼Œä½ è¿˜å°†äº†è§£ä¸ºä»€ä¹ˆæœ‰è¿™ä¹ˆå¤šäººå®£ä¼ è®¾å¤‡ä¸Šçš„æœºå™¨å­¦ä¹ æˆ–è¾¹ç¼˜æœºå™¨å­¦ä¹ ã€‚

**è®¾å¤‡ä¸Šçš„æœºå™¨å­¦ä¹ è¿™ä¸ªæ€è·¯çš„èƒŒåï¼š**

è¿™é‡Œä½¿ç”¨æœºå™¨å­¦ä¹ çš„æƒ³æ³•ä¸æˆ‘ä»¬çš„æ—§æœ‰æ–¹æ³•æ°å¥½ç›¸åï¼Œæˆ‘ä»¬ä¸å†å°†è®¾å¤‡ä¸Šçš„æ•°æ®å‘é€åˆ°æœåŠ¡å™¨æˆ–æŸä¸ªåŸºäºäº‘çš„ç³»ç»Ÿï¼Œåœ¨ä¸Šé¢æ‰§è¡Œæœºå™¨å­¦ä¹ ï¼Œç„¶åå†è¾“å‡ºè¿”å›ç»™è®¾å¤‡ã€‚å–è€Œä»£ä¹‹çš„æ˜¯ï¼Œç›´æ¥åˆ©ç”¨è®¾å¤‡æœ¬èº«ä¸Šçš„æœºå™¨å­¦ä¹ æ¨¡å‹è·å–è¾“å‡ºæˆ–æ¨æ–­ï¼Œå³ä¸å†è®©è®¾å¤‡å‘é€æ•°æ®ç»™æœåŠ¡å™¨åˆ¤æ–­æ•°æ®ï¼Œåˆ©ç”¨ç§»åŠ¨è®¾å¤‡æœ¬èº«ï¼Œå®Œæˆæ‰€æœ‰çš„å¤„ç†å’Œæ¨æ–­ã€‚

![è®¾å¤‡ä¸Šçš„æœºå™¨å­¦ä¹ è¿™ä¸ªæ€è·¯çš„èƒŒå](https://cdn-images-1.medium.com/max/3836/1*O1a_Su6P-XggXk9IXTSzMQ.jpeg)

ä½ ä¸ä¼šç›´æ¥å°†æ¨¡å‹ç”¨äºä½ çš„è®¾å¤‡ï¼Œè€Œéœ€è¦å‹ç¼©æˆ–ä¼˜åŒ–æ¨¡å‹ï¼Œä»¥ä¾¿å¯ä»¥åœ¨è®¾å¤‡ä¸Šè¿è¡Œå®ƒï¼Œå› ä¸ºå®ƒçš„è®¡ç®—èƒ½åŠ›ã€ç½‘ç»œå¯ç”¨æ€§å’Œç£ç›˜ç©ºé—´æœ‰é™ã€‚ä½†æ˜¯ï¼Œåœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†ä¸è®¨è®ºä¼˜åŒ–è¿‡ç¨‹ã€‚æˆ‘ä»¬å°†ç›´æ¥éƒ¨ç½² `.tflite` æ¨¡å‹æ–‡ä»¶ã€‚æ‚¨å¯ä»¥é€šè¿‡ä½¿ç”¨ TensorFlow Lite è¿›ä¸€æ­¥äº†è§£ [TensorFlow Lite](https://www.tensorflow.org/lite/)å’Œ[æ¨¡å‹ä¼˜åŒ–è¿‡ç¨‹](https://www.tensorflow.org/lite/performance/model_optimization)ã€‚

**å†…ç½®æœºå™¨å­¦ä¹ çš„ä¼˜åŠ¿**

åœ¨è¿™é‡Œï¼Œæˆ‘åˆ—å‡ºäº†ä½¿ç”¨è®¾å¤‡ä¸Šæœºå™¨å­¦ä¹ çš„ä¸€äº›ä¼˜ç‚¹ï¼š

* èƒ½é‡æ¶ˆè€— æˆ‘æ‰€èƒ½å¤Ÿæƒ³åˆ°çš„ç¬¬ä¸€ä»¶äº‹å°±æ˜¯åŠŸè€—ï¼šä½ æœ¬æ¥æ˜¯éœ€è¦èŠ±è´¹å¤§é‡çš„ç²¾åŠ›å°†è§†é¢‘æ•°æ®è¿ç»­å‘é€æˆ–æµå¼ä¼ è¾“åˆ°æœåŠ¡å™¨ï¼Œä½†æœ‰æ—¶è¿™æ ·åšæ˜¯ä¸å¯è¡Œçš„ã€‚å€¼å¾—ä¸€æçš„æ˜¯ï¼Œå½“ä½ è¿›è¡Œå¤§é‡é¢„å¤„ç†æ—¶ï¼Œæœ‰äº›æ—¶å€™å€’æ˜¯èƒ½å¤Ÿå®ç°èŠ‚çœåŠŸè€—ã€‚

* æ¨æ–­æ—¶é—´ è¦è€ƒè™‘çš„å¦ä¸€é‡è¦äº‹é¡¹æ˜¯æˆ‘è·å¾—è¾“å‡ºæˆ–å®è´¨ä¸Šè¿è¡Œæ¨¡å‹æ‰€èŠ±è´¹çš„æ—¶é—´ã€‚å¯¹äºå®æ—¶åº”ç”¨ç¨‹åºï¼Œè¿™æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„æ–¹é¢ã€‚åœ¨ä¸å‘é€æ•°æ®ä¸”ä¸å¿…æ¥æ”¶æ•°æ®çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä¹ŸåŠ å¿«äº†æ¨ç†é€Ÿåº¦ã€‚

* ç½‘ç»œå¯ç”¨æ€§ å°±ç½‘ç»œå¯ç”¨æ€§è€Œè¨€ï¼Œä½¿ç”¨ä¼ ç»Ÿæ–¹æ³•æ˜¯ä¾èµ–äºç½‘ç»œé€šä¿¡çš„ã€‚è®¾å¤‡å¿…é¡»åœ¨å¸¦å®½æˆ–ç½‘ç»œçš„è¿æ¥ä¸‹æ‰èƒ½å¤Ÿè¿ç»­å‘é€æ•°æ®å¹¶ä»æœåŠ¡å™¨æ¥æ”¶æ¨è®ºã€‚

* å®‰å…¨ æœ€åï¼Œå®‰å…¨æ€§ä¹Ÿå°†æå‡ï¼šè®¾å¤‡ä¸å†éœ€è¦å°†æ•°æ®å‘é€åˆ°æœåŠ¡å™¨æˆ–åŸºäºäº‘çš„ç³»ç»Ÿï¼Œå³ä¸å†å°†æ•°æ®å‘é€å‡ºè®¾å¤‡ï¼Œä»è€Œå¢å¼ºäº†å®‰å…¨æ€§ã€‚

## MLæ¨¡å‹ç»‘å®šæ’ä»¶

> æ³¨æ„ï¼šæ‚¨éœ€è¦ Android Studio 4.1 æˆ–æ›´é«˜ç‰ˆæœ¬æ‰èƒ½ä½¿ç”¨æ¨¡å‹ç»‘å®šæ’ä»¶

**æ¨¡å‹ç»‘å®šæ’ä»¶å…³æ³¨ä»€ä¹ˆï¼Ÿ**

æ‚¨å¯ä»¥ä»â€œæ¨¡å‹æ„å»ºâ€è¿™ä¸ªåç§°ä¸­åšå‡ºè¶³å¤Ÿåˆç†çš„çŒœæµ‹ï¼Œä»¥äº†è§£[æœºå™¨å­¦ä¹ æ¨¡å‹ç»‘å®šæ’ä»¶]çš„ç”¨é€”(https://developer.android.com/studio/preview/features#tensor-flow-lite-models)ç¡®å®å¯ä»¥ä½¿æˆ‘ä»¬éå¸¸è½»æ¾åœ°ä½¿ç”¨è‡ªå®šä¹‰ TF Lite æ¨¡å‹ã€‚è¿™ä½¿å¼€å‘äººå‘˜å¯ä»¥å¯¼å…¥ä»»ä½• TFLite æ¨¡å‹ï¼Œè¯»å–æ¨¡å‹çš„è¾“å…¥æˆ–è¾“å‡ºçš„ç­¾åï¼Œå¹¶å°†å…¶ä¸ä»…å‡ è¡Œä»£ç ä¸€èµ·ä½¿ç”¨ï¼Œä»¥è°ƒç”¨å¼€æº TensorFlow Lite Android æ”¯æŒåº“ã€‚

æœºå™¨å­¦ä¹ æ¨¡å‹ç»‘å®šæ’ä»¶ä½¿æ‚¨å¯ä»¥åœ¨åº”ç”¨ç¨‹åºä¸­è½»æ¾ä½¿ç”¨ TF æ¨¡å‹ã€‚ä»æœ¬è´¨ä¸Šè®²ï¼Œä½ éœ€è¦ç¼–å†™çš„ä»£ç å°‘å¾—å¤šï¼Œå¯ä»¥è°ƒç”¨ TensorFlow Lite Android æ”¯æŒåº“ã€‚å¦‚æœæ‚¨ä½¿ç”¨è¿‡ TensorFlow Lite æ¨¡å‹ï¼Œåˆ™å¯èƒ½çŸ¥é“æ‚¨é¦–å…ˆéœ€è¦å°†æ‰€æœ‰å†…å®¹éƒ½è½¬æ¢ä¸º `ByteArray`ï¼Œè€Œä¸å†éœ€è¦ä½¿ç”¨æœºå™¨å­¦ä¹ æ¨¡å‹ç»‘å®šæ’ä»¶å°†æ‰€æœ‰å†…å®¹éƒ½è½¬æ¢ä¸º `ByteArray`ã€‚

æˆ‘ä¹Ÿå–œæ¬¢è¿™ä¸ªæ–°æ’ä»¶ï¼Œå› ä¸ºæ‚¨å¯ä»¥è½»æ¾åœ°è½»æ¾ä½¿ç”¨ GPU å’Œ NN APIã€‚ä½¿ç”¨æ¨¡å‹ç»‘å®šæ’ä»¶ï¼Œä½¿ç”¨å®ƒä»¬ä»æœªå¦‚æ­¤ç®€å•ã€‚ç°åœ¨ï¼Œä½¿ç”¨å®ƒä»¬åªæ˜¯ä¸€ä¸ªä¾èµ–é¡¹è°ƒç”¨ï¼Œè€Œåªéœ€è¦ä¸€è¡Œä»£ç å°±ä¸èƒ½åƒä½¿ç”¨ Model Binding æ’ä»¶é‚£æ ·é…·ã€‚å€ŸåŠ© Android 11 The Neural Network APIï¼Œæ‚¨è¿˜å…·æœ‰æ— ç¬¦å·æ•´æ•°æƒé‡æ”¯æŒå’Œæ–°çš„æœåŠ¡è´¨é‡ï¼ˆQOSï¼‰APIï¼Œä¹Ÿæ”¯æŒæ›´å¤šè¾¹ç¼˜åœºæ™¯ã€‚å½“ç„¶ï¼Œè¿™å°†ä½¿æ‚¨ä½¿ç”¨æˆ‘ä»¬åˆšåˆšè°ˆåˆ°çš„åŠŸèƒ½å¯ä»¥æ›´å¿«åœ°è¿›è¡Œå¼€å‘ã€‚

**ä½¿ç”¨æ¨¡å‹ç»‘å®šæ’ä»¶**

ç°åœ¨è®©æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•å®ç°æ‰€è®¨è®ºçš„æ‰€æœ‰å†…å®¹ã€‚

å› æ­¤ï¼Œç¬¬ä¸€æ­¥æ˜¯å¯¼å…¥å¸¦æœ‰å…ƒæ•°æ®çš„ TensorFlow Lite æ¨¡å‹ã€‚ Android Studio ç°åœ¨æœ‰ä¸€ä¸ªç”¨äºå¯¼å…¥ TensorFlow æ¨¡å‹çš„æ–°é€‰é¡¹ï¼Œåªéœ€å³é”®å•å‡»è¦å¯¼å…¥å®ƒçš„æ¨¡å—ï¼Œæ‚¨å°±ä¼šåœ¨â€œå…¶ä»–â€ä¸‹çœ‹åˆ°ä¸€ä¸ªåä¸º `TF Lite Model` çš„é€‰é¡¹ã€‚

![Android Studioä¸­çš„å¯¼å…¥æ¨¡å‹é€‰é¡¹](https://cdn-images-1.medium.com/max/2500/1*fnNNyLYKqafERAjUfwPsxQ.jpeg)

ç°åœ¨ï¼Œæ‚¨åªéœ€ä¼ é€’ `tflite` æ¨¡å‹çš„è·¯å¾„å³å¯ï¼Œå®ƒå°†åœ¨æ‚¨ä¹‹å‰é€‰æ‹©çš„æ¨¡å— `ml` ä¸­çš„ç›®å½•ä¸­ä¸ºæ‚¨å¯¼å…¥æ¨¡å‹ï¼Œæ‚¨å¯ä»¥åœ¨å…¶ä¸­ä½¿ç”¨è¯¥æ¨¡å‹ã€‚åªéœ€å•å‡»å³å¯æ·»åŠ ä¾èµ–æ€§å’Œ GPU åŠ é€Ÿã€‚

![å¯¼å…¥ `tflite` æ¨¡å‹](https://cdn-images-1.medium.com/max/2502/1*wJmnVf7wtCOV50HnXXmmPQ.jpeg)

å› æ­¤ï¼Œç°åœ¨ä»æˆ‘çš„æ¨¡å‹å…ƒæ•°æ®ä¸­ï¼Œæˆ‘è¿˜å¯ä»¥çŸ¥é“è¾“å…¥ï¼Œè¾“å‡ºå½¢çŠ¶ä»¥åŠéœ€è¦ä½¿ç”¨çš„æ›´å¤šä¿¡æ¯ï¼Œæ‚¨å¯ä»¥é€šè¿‡åœ¨ Android Studio ä¸­æ‰“å¼€ `tflite` æ¨¡å‹æ–‡ä»¶æ¥æŸ¥çœ‹æ­¤ä¿¡æ¯ã€‚å› æ­¤ï¼Œåœ¨æ­¤å±å¹•æˆªå›¾ä¸­ï¼Œæˆ‘ä½¿ç”¨çš„æ˜¯æˆ‘åˆ¶ä½œçš„å¼€æºæ¨¡å‹æ¥å¯¹çŸ³å¤´ï¼Œçº¸å¼ å’Œå‰ªåˆ€è¿›è¡Œåˆ†ç±»ã€‚å› æ­¤ï¼Œæ‚¨åªéœ€å°†æ‰‹æ”¾åœ¨ç›¸æœºå‰å³å¯è¯†åˆ«å‡ºæ˜¯çŸ³å¤´çº¸è¿˜æ˜¯å‰ªåˆ€ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘åœ¨æ­¤å¤„æ¼”ç¤ºçš„å†…å®¹ã€‚

![æŸ¥çœ‹æ¨¡å‹å…ƒæ•°æ®](https://cdn-images-1.medium.com/max/2502/1*ZHuSORcTLhxtSWr60TzxWA.jpeg)

æœ€åï¼Œè®©æˆ‘ä»¬å¼€å§‹ä½¿ç”¨è¯¥æ¨¡å‹ï¼Œä»¥ä¾¿è¿›è¡Œæµæ¨æ–­ï¼Œè¿™å¾ˆå¯èƒ½æ˜¯æ‚¨æƒ³è¦æ‰§è¡Œçš„æ“ä½œï¼›å®æ—¶å›¾åƒåˆ†ç±»ã€‚æœ€ç®€å•çš„æ–¹æ³•æ˜¯ä½¿ç”¨ Camera Xï¼Œå¹¶å°†æ¯ä¸ªå¸§ä¼ é€’ç»™å¯ä»¥æ‰§è¡Œæ¨ç†çš„åŠŸèƒ½ã€‚å› æ­¤ï¼Œåˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘æ„Ÿå…´è¶£çš„æ˜¯è¿›è¡Œæ¨æ–­çš„å‡½æ•°ã€‚æ‚¨å°†çœ‹åˆ°æ‰§è¡Œæ­¤æ“ä½œéå¸¸å®¹æ˜“ï¼Œåœ¨å¯¼å…¥å¯ä»¥ä½¿ç”¨çš„ TF Lite æ¨¡å‹æ—¶ï¼Œä¼¼ä¹ä¹Ÿä¼šæœ‰ä¸€ä¸ªç¤ºä¾‹ä»£ç ã€‚

```kotlin
private val rpsModel = RPSModel.newInstance(ctx)
```

å› æ­¤ï¼Œæˆ‘ä»¬å°†é¦–å…ˆå®ä¾‹åŒ–ä¸€ä¸ª `rps` æ¨¡å‹ï¼Œè¯¥æ¨¡å‹æ˜¯å‰ªåˆ€çŸ³å¤´å¸ƒæ¨¡å‹çš„ç¼©å†™ï¼Œå¹¶å°†å…¶ä¼ é€’ç»™ä¸Šä¸‹æ–‡ã€‚ä½¿ç”¨è¯¥æ’ä»¶ï¼Œæˆ‘çš„æ¨¡å‹åç§°ä¸º `RPS Model.tflite`ï¼Œå› æ­¤å°†ä¸ºæ‚¨åˆ›å»ºä¸€ä¸ªå®Œå…¨ç›¸åŒåç§°çš„ç±»ï¼Œå› æ­¤æˆ‘æœ‰ä¸€ä¸ªåä¸º `RPS Model` çš„ç±»ã€‚

```kotlin
val tfImage = TensorImage.fromBitmap(toBitmap(imageProxy))
```

å®Œæˆæ­¤æ“ä½œåï¼Œæ‚¨éœ€è¦å°†æ•°æ®è½¬æ¢ä¸ºå¯ä½¿ç”¨çš„æ ¼å¼ï¼Œä»¥ä¾¿å°†å…¶ä» `Bitmap` è½¬æ¢ä¸º `Tensor Image`ï¼Œå¦‚æœæ‚¨ä½¿ç”¨ TF è§£é‡Šå™¨ï¼Œåˆ™çŸ¥é“éœ€è¦å°†å›¾åƒè½¬æ¢ä¸ºä¸€ä¸ª`ByteArray`ï¼Œæ‚¨æ— éœ€å†è¿™æ ·åšäº†ï¼Œæ‚¨å°†è¾“å…¥ä¸€ä¸ªå›¾åƒä»£ç†

```kotlin
val outputs = rpsModel.process(tfImage)
    .probabilityAsCategoryList.apply {
        sortByDescending { it.score } // Sort with highest confidence first
    }.take(MAX_RESULT_DISPLAY) // take the top results
```

æ‰€ä»¥ç°åœ¨æˆ‘ä»¬å°†æ•°æ®ä¼ é€’ç»™æ¨¡å‹ï¼Œæ‰€ä»¥é¦–å…ˆæˆ‘ä»¬å°†å¤„ç†æ¨¡å‹ä¸­çš„å›¾åƒå¹¶è·å¾—è¾“å‡ºï¼Œæˆ‘ä»¬å°†åŸºæœ¬ä¸Šå¾—åˆ°ä¸€ä¸ªæ¦‚ç‡æ•°ç»„å¹¶å¯¹å…¶è¿›è¡Œé™åºæ’åºï¼Œå› ä¸ºæˆ‘ä»¬æƒ³æ˜¾ç¤ºæ ‡ç­¾ä¸­å…·æœ‰æœ€å¤§æ•°é‡çš„æ ‡ç­¾ã€‚æ¦‚ç‡ï¼Œç„¶åé€‰æ‹©ç¬¬ä¸€ä¸ª `n` ä¸ªç»“æœè¿›è¡Œæ˜¾ç¤ºã€‚

```kotlin
for (output in outputs) {
    items.add(
        Recognition(
            output.label,
            output.score
        )
    )
}
```

æœ€åï¼Œæˆ‘æƒ³å‘ç”¨æˆ·æ˜¾ç¤ºæ ‡ç­¾ï¼Œä»¥ä¾¿åœ¨è¾“å‡ºä¸­æ·»åŠ ä¸æ¯ä¸ªæ¡ç›®ç›¸å¯¹åº”çš„æ ‡ç­¾ã€‚è¿™å°±æ˜¯æ‚¨æ‰€éœ€è¦çš„ ğŸš€ï½

**åˆ©ç”¨GPUåŠ é€Ÿ**

å¦‚æœæ‚¨æƒ³å†æ¬¡ä½¿ç”¨ GPU åŠ é€Ÿï¼Œè¿™å¯¹æ‚¨æ¥è¯´éå¸¸å®¹æ˜“ï¼Œé‚£ä¹ˆæ‚¨å°†åœ¨æˆ‘æŒ‡å®šè¦ä½¿ç”¨ GPU å¹¶è¿›è¡Œæ„å»ºçš„åœ°æ–¹åˆ›å»ºä¸€ä¸ª `options` å¯¹è±¡ã€‚åœ¨å®ä¾‹åŒ–éƒ¨åˆ†ï¼Œæˆ‘åªæ˜¯å°†å…¶ä½œä¸ºå‚æ•°ä¼ é€’ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ GPUã€‚è¿™ä¹Ÿä½¿å¾—ä½¿ç”¨ NN API åŠ é€Ÿå¹¶åœ¨ Android 11 ä¸Šæ‰§è¡Œæ›´å¤šæ“ä½œå˜å¾—éå¸¸å®¹æ˜“ã€‚

```kotlin
private val options = Model.Options.Builder().setDevice(Model.Device.GPU).build()
private val rpsModel = rpsModel.newInstance(ctx, options)
```

## ä¸€ä¸ªæ–°çš„æœºå™¨å­¦ä¹ å¥—ä»¶

> ä½ ç°åœ¨ä¸å†éœ€è¦ Firebase é¡¹ç›®æ¥ä¸ ML Kit ä¸€èµ·ä½¿ç”¨ï¼Œå³ä½¿åœ¨ Firebase ä¸­ä¹Ÿå¯ä»¥ä½¿ç”¨å®ƒã€‚

å¦ä¸€ä¸ªå€¼å¾—æ³¨æ„çš„æ›´æ–°å¦ä¸€ä¸ªå®ç° TensorFlow Lite æ¨¡å‹çš„æ–¹æ³•æ˜¯é€šè¿‡ [ML Kit](https://g.co/mlkit)ã€‚è€Œä¸”ï¼Œå³ä½¿æˆ‘æ— éœ€ä½¿ç”¨ Firebase é¡¹ç›®ï¼Œç°åœ¨ä¹Ÿå¯ä»¥ä½¿ç”¨ ML Kitï¼Œè€Œç°åœ¨å³ä½¿æ²¡æœ‰ Firebase é¡¹ç›®ä¹Ÿå¯ä»¥ä½¿ç”¨ ML Kitã€‚

æ­£å¦‚æˆ‘ä¹‹å‰æåˆ°çš„ï¼Œç”±äºæˆ‘ä¹‹å‰æåˆ°çš„å¥½å¤„ï¼ŒAndroid 11 ä¸­çš„è®¸å¤šæ›´æ–°éƒ½é›†ä¸­åœ¨è®¾å¤‡ä¸Šçš„æœºå™¨å­¦ä¹ ä¸Šã€‚ç°åœ¨ï¼Œæ–°çš„ ML Kit åœ¨è®¾å¤‡ä¸Šå…·æœ‰æ›´å¥½çš„å¯ç”¨æ€§ã€‚ML Kit [å›¾åƒåˆ†ç±»](https://developers.google.com/ml-kit/vision/image-labeling/custom-models/android)å’Œ[å¯¹è±¡æ£€æµ‹å’Œè·Ÿè¸ªï¼ˆODTï¼‰](https://developers.google.com/ml-kit/vision/object-detection/custom-models/android)ç°åœ¨ä¹Ÿæ”¯æŒè‡ªå®šä¹‰æ¨¡å‹ï¼Œè¿™æ„å‘³ç€æ‚¨ç°åœ¨è¿˜å¯ä»¥æ‹¥æœ‰ä¸€ä¸ª `tflite` æ¨¡å‹æ–‡ä»¶ã€‚è¿™ä¹Ÿæ„å‘³ç€å¦‚æœæ‚¨æ­£åœ¨å¤„ç†æŸäº›é€šç”¨ç”¨ä¾‹ï¼Œä¾‹å¦‚ç‰¹å®šç±»å‹çš„å¯¹è±¡æ£€æµ‹ï¼Œé‚£ä¹ˆ ML Kit æ˜¯æœ€å¥½çš„é€‰æ‹©ã€‚

**ä½¿ç”¨ ML Kit**

è®©æˆ‘ä»¬åœ¨ä»£ç ä¸­çœ‹åˆ°è¿™ä¸€ç‚¹ï¼Œå¹¶çœ‹åˆ°ä¸€ä¸ªç¤ºä¾‹ã€‚å› æ­¤ï¼Œåœ¨æ­¤æˆ‘ä»¥ä¸€ä¸ªç¤ºä¾‹ä¸ºä¾‹ï¼Œå»ºç«‹ä¸€ä¸ªå¯ä»¥å¯¹ä¸åŒé£Ÿå“åˆ†ç±»çš„æ¨¡å‹ï¼Œ

```kotlin
private localModel = LocalModel.Builder()
    .setAssetFilePath("lite-model_aiy_vision_classifier_food_V1_1.tflite").
    .build()
```

å› æ­¤ï¼Œæˆ‘å°†é¦–å…ˆé€šè¿‡è®¾ç½®æ¨¡å‹å¹¶ä¸ºå…¶æŒ‡å®š `tflite` æ¨¡å‹æ–‡ä»¶è·¯å¾„å¼€å§‹ã€‚

```kotlin
private val customObjectDetectorOptions = CustomObjectDetectorOptions
    .Builder(localModel)
    .setDetectorMode(CustomObjectDetectorOptions.STREAM_MODE) 
    .setClassificationConfidenceThreshold(0.8f) 
    .build()
```

ç„¶åï¼Œæ­¤ `tflite` æ¨¡å‹å°†åœ¨å¸¦æœ‰ ML Kit çš„å¯¹è±¡æ£€æµ‹æ¨¡å‹çš„é¡¶éƒ¨è¿è¡Œï¼Œå› æ­¤æ‚¨å¯ä»¥ç¨å¾®è‡ªå®šä¹‰è¿™äº›é€‰é¡¹ã€‚åœ¨è¿™é‡Œï¼Œç”±äºè¦ä½¿ç”¨æµè¾“å…¥å¹¶æŒ‡å®šç½®ä¿¡åº¦é˜ˆå€¼ï¼Œå› æ­¤æˆ‘ä¸“é—¨ä½¿ç”¨äº† `STREAM_MODE`ã€‚

```kotlin
private val objectDetector = ObjectDetection.getClient(customObjectDetectorOptions) objectDetector.process(image) 
    .addOnFailureListener(Log.d(...))

    .addOnSuccessListener{ 
        graphicsOverlay.clear() 
        for (detectedObject in it){ 
            graphicsOverlay.add(ObjectGraphic(graphicsOverlay, detectedObject))
        } 
        graphicsOverlay.postInvalidate()} 

    .addOnCompleteListenerl imageProxy.close() }
```

å› æ­¤ï¼Œè®©æˆ‘ä»¬è¿›å…¥è¿è¡Œæ¨¡å‹çš„é‚£ä¸€éƒ¨åˆ†ï¼Œè¿™æ ·æ‚¨å¯èƒ½ä¼šçœ‹åˆ°ä¸€äº›ç±»ä¼¼äºæ­¤å¤„å‰é¢ç¤ºä¾‹çš„è¯­æ³•ã€‚æˆ‘å°†å¤„ç†æˆ‘çš„å›¾åƒï¼Œè¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ‰€æœ‰å¤„äºå¤±è´¥æˆ–æˆåŠŸçŠ¶æ€çš„ä¾¦å¬å™¨éƒ½æ˜¯å¿…ä¸å¯å°‘çš„ä»»åŠ¡ï¼Œå› æ­¤æ¯æ¬¡è¿è¡Œéƒ½éœ€è¦é™„åŠ è¿™äº›ä¾¦å¬å™¨ã€‚è¿™å°±æ˜¯æ‚¨éœ€è¦åšçš„ï¼Œæˆ‘ä»¬å·²ç»å®Œæˆ ğŸš€ï½

## æŸ¥æ‰¾æ¨¡å‹

æˆ‘ä»¬è®¨è®ºäº†å¾ˆå¤šæœ‰å…³æ¨¡å‹åˆ¶ä½œåçš„å†…å®¹ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•ä¸ºæ‚¨çš„ç”¨ä¾‹æ‰¾åˆ°æ¨¡å‹ã€‚

* TF Lite Model Maker

TensorFlow å›¢é˜Ÿä¹Ÿäº 2020 å¹´åˆå¼€å¯äº† TF Lite Model Makerã€‚è¿™ä½¿å¾—åˆ¶ä½œå¥½çš„æ¨¡å‹è¶…çº§å®¹æ˜“ä½¿ç”¨ï¼Œå…·æœ‰å¾ˆé«˜çš„æ€§èƒ½ï¼Œè¿˜å¯ä»¥è¿›è¡Œå¤§é‡çš„è‡ªå®šä¹‰ã€‚æ‚¨å¯ä»¥ç®€å•åœ°ä¼ é€’æ•°æ®å¹¶ä½¿ç”¨å¾ˆå°‘çš„ä»£ç æ¥æ„å»º `tflite` æ¨¡å‹ã€‚æ‚¨å¯ä»¥æŸ¥çœ‹å›è´­ä¸­å­˜åœ¨çš„ [TensorFlow Lite Model Maker ç¤ºä¾‹](https://github.com/Rishit-dagli/ML-with-Android-11/blob/dev/TensorFlow_Lite_Model_Maker_example.ipynb)ã€‚

* TensorFlow Hub

TensorFlow Hub æ˜¯ä¸€ä¸ªå¼€æ”¾æºä»£ç å­˜å‚¨åº“ï¼Œå…¶ä¸­åŒ…å«æœ€æ–°æŠ€æœ¯å’Œæœ‰æ®å¯æŸ¥çš„æ¨¡å‹ã€‚æˆ‘ä»¬ä½¿ç”¨ ML Kit æ„å»ºçš„é£Ÿå“åˆ†ç±»åº”ç”¨ç¨‹åºä¹Ÿå‡ºç°åœ¨ TF Hub ä¸Šã€‚æ‚¨è¿˜å¯ä»¥ä½¿ç”¨ç¤¾åŒºä¸­çš„æ¨¡å‹ã€‚æ‚¨å¯ä»¥åœ¨ [tfhub.dev](https://tfhub.dev/) ä¸Šæ‰¾åˆ°å®ƒä»¬ã€‚

![tfhub.dev ä¸Šçš„ä¸€äº›å‘å¸ƒè€…](https://cdn-images-1.medium.com/max/2022/0*cv-fzgw2WPuf4PQI.png)

![TF Hub ä¸­çš„è¿‡æ»¤å™¨](https://cdn-images-1.medium.com/max/2000/1*Cu-XiVrzOi2MdKatQ1dpzw.png)

å¦‚æœæ‚¨åªæƒ³æŸ¥æ‰¾åŸºäºå›¾åƒæˆ–æ–‡æœ¬çš„æ¨¡å‹ï¼Œåˆ™å¯ä»¥åœ¨ TF Hub ä¸­æœç´¢å¸¦æœ‰å¤šä¸ªè¿‡æ»¤å™¨çš„æ¨¡å‹ï¼Œä¾‹å¦‚â€œé—®é¢˜åŸŸâ€ï¼›å¦‚æœè¦åœ¨ç½‘ç»œï¼Œè¾¹ç¼˜è®¾å¤‡æˆ– Corals ä¸Šè¿è¡Œï¼Œè¯·ä½¿ç”¨â€œæ¨¡å‹â€æ ¼å¼ï¼Œè¿‡æ»¤æ¶æ„ï¼Œä½¿ç”¨çš„æ•°æ®é›†ç­‰ç­‰ã€‚

æ‚¨å¯ä»¥è¿›ä¸€æ­¥ç›´æ¥ä» TF Hub ä¸‹è½½è¿™äº›æ¨¡å‹ï¼Œä¹Ÿå¯ä»¥éå¸¸è½»æ¾åœ°ä½¿ç”¨æ‚¨è‡ªå·±çš„æ•°æ®å¯¹å…¶è¿›è¡Œè½¬ç§»å­¦ä¹ ã€‚ä½†æ˜¯ï¼Œåœ¨æœ¬åšå®¢çš„èŒƒå›´å†…ï¼Œæˆ‘ä»¬å°†ä¸ä»‹ç» TF Hub çš„è½¬ç§»å­¦ä¹ ï¼Œæ‚¨å¯ä»¥åœ¨[æˆ‘çš„åšå®¢](https://towardsdatascience.com/building-better-ai-apps-and-tf-hub-88716b302265)çœ‹åˆ°æ›´å¤šä¿¡æ¯ã€‚

è¿˜æœ‰å¾ˆå¤šï¼æœ‰å¾ˆå¤šæœåŠ¡ï¼Œä¾‹å¦‚ [Teachable Machine](https://teachablemachine.withgoogle.com/)ï¼Œ[AutoML](https://cloud.google.com/automl)ï¼Œè¿˜æœ‰è®¸å¤šå…¶ä»–æœåŠ¡ï¼Œä½†è¿™æ˜¯ä¸»è¦çš„æœåŠ¡ã€‚

---

[GitHub ä»“åº“](https://github.com/Rishit-dagli/ML-with-Android-11) ä¸­æä¾›äº†æ­¤å¤„å±•ç¤ºçš„æœ‰å…³ TF Lite Model Maker çš„ç¤ºä¾‹çš„æ‰€æœ‰ä»£ç ã€‚åœ¨å›è´­ä¸­ï¼Œæˆ‘è¿˜ä¸ºæ‚¨æä¾›äº†ä¸€äº›ç»è¿‡è®­ç»ƒçš„æ¨¡å‹ï¼Œä¾›æ‚¨å…¥é—¨å’Œå°è¯•ä½¿ç”¨ã€‚

> å¦‚æœå‘ç°è¯‘æ–‡å­˜åœ¨é”™è¯¯æˆ–å…¶ä»–éœ€è¦æ”¹è¿›çš„åœ°æ–¹ï¼Œæ¬¢è¿åˆ° [æ˜é‡‘ç¿»è¯‘è®¡åˆ’](https://github.com/xitu/gold-miner) å¯¹è¯‘æ–‡è¿›è¡Œä¿®æ”¹å¹¶ PRï¼Œä¹Ÿå¯è·å¾—ç›¸åº”å¥–åŠ±ç§¯åˆ†ã€‚æ–‡ç« å¼€å¤´çš„ **æœ¬æ–‡æ°¸ä¹…é“¾æ¥** å³ä¸ºæœ¬æ–‡åœ¨ GitHub ä¸Šçš„ MarkDown é“¾æ¥ã€‚

---

> [æ˜é‡‘ç¿»è¯‘è®¡åˆ’](https://github.com/xitu/gold-miner) æ˜¯ä¸€ä¸ªç¿»è¯‘ä¼˜è´¨äº’è”ç½‘æŠ€æœ¯æ–‡ç« çš„ç¤¾åŒºï¼Œæ–‡ç« æ¥æºä¸º [æ˜é‡‘](https://juejin.im) ä¸Šçš„è‹±æ–‡åˆ†äº«æ–‡ç« ã€‚å†…å®¹è¦†ç›– [Android](https://github.com/xitu/gold-miner#android)ã€[iOS](https://github.com/xitu/gold-miner#ios)ã€[å‰ç«¯](https://github.com/xitu/gold-miner#å‰ç«¯)ã€[åç«¯](https://github.com/xitu/gold-miner#åç«¯)ã€[åŒºå—é“¾](https://github.com/xitu/gold-miner#åŒºå—é“¾)ã€[äº§å“](https://github.com/xitu/gold-miner#äº§å“)ã€[è®¾è®¡](https://github.com/xitu/gold-miner#è®¾è®¡)ã€[äººå·¥æ™ºèƒ½](https://github.com/xitu/gold-miner#äººå·¥æ™ºèƒ½)ç­‰é¢†åŸŸï¼Œæƒ³è¦æŸ¥çœ‹æ›´å¤šä¼˜è´¨è¯‘æ–‡è¯·æŒç»­å…³æ³¨ [æ˜é‡‘ç¿»è¯‘è®¡åˆ’](https://github.com/xitu/gold-miner)ã€[å®˜æ–¹å¾®åš](http://weibo.com/juejinfanyi)ã€[çŸ¥ä¹ä¸“æ ](https://zhuanlan.zhihu.com/juejinfanyi)ã€‚
