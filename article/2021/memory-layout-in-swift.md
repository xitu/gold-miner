> * åŸæ–‡åœ°å€ï¼š[Memory layout in Swift](https://theswiftdev.com/memory-layout-in-swift/)
> * åŸæ–‡ä½œè€…ï¼š[Tibor BÃ¶decs](https://theswiftdev.com)
> * è¯‘æ–‡å‡ºè‡ªï¼š[æ˜é‡‘ç¿»è¯‘è®¡åˆ’](https://github.com/xitu/gold-miner)
> * æœ¬æ–‡æ°¸ä¹…é“¾æ¥ï¼š[https://github.com/xitu/gold-miner/blob/master/article/2021/memory-layout-in-swift.md](https://github.com/xitu/gold-miner/blob/master/article/2021/memory-layout-in-swift.md)
> * è¯‘è€…ï¼š[LoneyIsError](https://github.com/LoneyIsError)
> * æ ¡å¯¹è€…ï¼š[liyaxuanliyaxuan](https://github.com/liyaxuanliyaxuan),[PassionPenguin](https://github.com/PassionPenguin)

# Swift ä¸­çš„å†…å­˜å¸ƒå±€

## Swift ä¸­å€¼ç±»å‹çš„å†…å­˜å¸ƒå±€

å†…å­˜å°±æ˜¯ä¸€ä¸² \`1\` å’Œ \`0\`ï¼Œç®€ç§°ä¸º [bits](https://en.wikipedia.org/wiki/Bit)ï¼ˆäºŒè¿›åˆ¶ä½ï¼‰ã€‚å¦‚æœå°†æ¯”ç‰¹æµåˆ†æˆæ¯ 8 ä½ä¸€ç»„ï¼Œæˆ‘ä»¬å¯ä»¥ç§°è¿™ä¸ªæ–°çš„å•ä½ä¸º[å­—èŠ‚](https://en.wikipedia.org/wiki/Byte)ï¼ˆ8 ä½æ˜¯ä¸€ä¸ªå­—èŠ‚ï¼Œä¾‹å¦‚äºŒè¿›åˆ¶ 10010110 æ˜¯åå…­è¿›åˆ¶ 96ï¼‰ã€‚æˆ‘ä»¬è¿˜å¯ä»¥ä»¥[åå…­è¿›åˆ¶å½¢å¼](https://en.wikipedia.org/wiki/Hexadecimal)å¯è§†åŒ–è¿™äº›å­—èŠ‚ï¼ˆä¾‹å¦‚ 96 A6 6D 74 B2 4C 4A 15 ç­‰ï¼‰ã€‚ç°åœ¨å¦‚æœæˆ‘ä»¬æŠŠè¿™äº›å¯è§†åŒ–å­—èŠ‚åˆ†æˆ 8 ç»„ï¼Œæˆ‘ä»¬ä¼šå¾—åˆ°ä¸€ä¸ªæ–°çš„å•ä½ï¼Œæˆä¸º[å•è¯](https://en.wikipedia.org/wiki/Word_(computer_architecture))ã€‚

è¿™ç§ 64 ä½å†…å­˜ï¼ˆå³ä¸€ä¸ªå­—ä»£è¡¨ 64 ä½ï¼‰å¸ƒå±€æ˜¯æˆ‘ä»¬ç°ä»£ [x64](https://en.wikipedia.org/wiki/64-bit_computing) CPU æ¶æ„çš„åŸºæœ¬åŸºç¡€ã€‚æ¯ä¸ªå­—éƒ½ä¸ä¸€ä¸ªè™šæ‹Ÿå†…å­˜åœ°å€ç›¸å…³è”ï¼Œè¯¥åœ°å€ä¹Ÿç”±ä¸€ä¸ªï¼ˆ[é€šå¸¸ä¸º 64 ä½](https://superuser.com/questions/1188364/what-is-the-size-of-an-address-of-a-variable-in-memory-on-a-64-bit-processor-in)ï¼‰åå…­è¿›åˆ¶æ•°è¡¨ç¤ºã€‚åœ¨ [x86-64](https://en.wikipedia.org/wiki/X86-64) æ—¶ä»£ä¹‹å‰ï¼Œ[x32 ABI](https://en.wikipedia.org/wiki/X32_ABI) ä½¿ç”¨ 32 ä½é•¿[åœ°å€](https://en.wikipedia.org/wiki/Byte_addressing)ï¼Œå…¶æœ€å¤§å†…å­˜é™åˆ¶ä¸º 4GiBã€‚å¹¸è¿çš„æ˜¯ï¼Œæˆ‘ä»¬æ­£åœ¨ä½¿ç”¨ x64ã€‚ğŸ’ª

é‚£ä¹ˆï¼Œæˆ‘ä»¬å¦‚ä½•åœ¨[è™šæ‹Ÿå†…å­˜](https://en.wikipedia.org/wiki/Virtual_memory)åœ°å€ç©ºé—´ä¸­å­˜å‚¨æ•°æ®ç±»å‹å‘¢ï¼Ÿå¥½å§ï¼Œé•¿è¯çŸ­è¯´ï¼Œæˆ‘ä»¬ä¸ºæ¯ç§æ•°æ®ç±»å‹åˆ†é…äº†é€‚é‡çš„ç©ºé—´ï¼Œå¹¶å°†å€¼çš„åå…­è¿›åˆ¶è¡¨ç¤ºå½¢å¼å†™å…¥å†…å­˜ã€‚è¿™æ˜¯æ“ä½œç³»ç»Ÿæä¾›çš„é­”æ³•ï¼Œå®ƒå°±æ˜¯è¿™æ ·å·¥ä½œçš„ã€‚

æˆ‘ä»¬ä¹Ÿå¯ä»¥å¼€å§‹è®¨è®º[å†…å­˜åˆ†æ®µ](https://en.wikipedia.org/wiki/Memory_segmentation)ã€åˆ†é¡µå’Œå…¶ä»–åº•å±‚çš„ä¸œè¥¿ï¼Œä½†è€å®è¯´ï¼Œæˆ‘çœŸçš„ä¸çŸ¥é“è¿™äº›ä¸œè¥¿æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚å½“æˆ‘è¶Šæ¥è¶Šæ·±å…¥åœ°ç ”ç©¶[è¿™ç±»åº•å±‚å†…å®¹](https://en.wikipedia.org/wiki/Low-level_programming_language)æ—¶ï¼Œæˆ‘å­¦åˆ°äº†å¾ˆå¤šå…³äºè®¡ç®—æœºå¦‚ä½•åœ¨å¹•åå·¥ä½œçš„çŸ¥è¯†ã€‚

æˆ‘æƒ³å’Œå¤§å®¶åˆ†äº«ä¸€ä¸ªæˆ‘å·²çŸ¥çš„å¾ˆé‡è¦çš„ç‚¹ã€‚è¿™å°±æ˜¯å…³äºå„ç§æ¶æ„ä¸Šçš„[å†…å­˜è®¿é—®](https://cs.stackexchange.com/questions/45083/cpu-reading-cycles)ã€‚ä¾‹å¦‚ï¼Œå¦‚æœ CPU çš„æ€»çº¿å®½åº¦ä¸º 32 ä½ï¼Œåˆ™æ„å‘³ç€ CPU åªèƒ½åœ¨ 1 ä¸ªè¯»å–å‘¨æœŸå†…ä»å†…å­˜ä¸­è¯»å– 32 ä½ã€‚ç°åœ¨ï¼Œå¦‚æœæˆ‘ä»¬ç®€å•åœ°å°†æ¯ä¸ªå¯¹è±¡å†™å…¥å†…å­˜ï¼Œè€Œä¸è¿›è¡Œé€‚å½“çš„æ•°æ®åˆ†ç¦»ï¼Œå¯èƒ½ä¼šé€ æˆä¸€äº›éº»çƒ¦ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           ...            â”‚  4b  â”‚            ...            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”¬â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚            32 bytes          â”‚            32 bytes          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

å¦‚ä½ æ‰€è§ï¼Œå¦‚æœå†…å­˜æ•°æ®æœªå¯¹é½ï¼Œç¬¬ä¸€ä¸ªè¯»å–å‘¨æœŸåªèƒ½è¯»å– 4 ä½æ•°æ®å¯¹è±¡çš„ç¬¬ä¸€éƒ¨åˆ†ã€‚éœ€è¦ 2 ä¸ªè¯»å–å‘¨æœŸæ‰èƒ½ä»ç»™å®šçš„å†…å­˜ç©ºé—´å–å›æˆ‘ä»¬çš„æ•°æ®ã€‚è¿™æ˜¯éå¸¸ä½æ•ˆä¸”å±é™©çš„ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆå¤§å¤šæ•°æ“ä½œç³»ç»Ÿä¸å…è®¸è¿›è¡Œéå¯¹é½è®¿é—®ï¼ŒåŒæ—¶ä¹Ÿæ˜¯ç¨‹åºç«‹å³å´©æºƒçš„åŸå› ã€‚é‚£ä¹ˆï¼Œåœ¨ Swift ä¸­çš„[å†…å­˜å¸ƒå±€](https://stevenpcurtis.medium.com/memorylayout-in-swift-c4e70bb32e3f)æ˜¯ä»€ä¹ˆæ ·å­å‘¢ï¼Ÿè®©æˆ‘ä»¬ä½¿ç”¨å†…ç½®çš„ [MemoryLayout](https://swiftdoc.org/v3.1/type/memorylayout/) æšä¸¾ç±»å‹å¿«é€Ÿæµè§ˆä¸€ä¸‹æˆ‘ä»¬çš„æ•°æ®ç±»å‹ã€‚

```swift
print(MemoryLayout<Bool>.size)      // 1
print(MemoryLayout<Bool>.stride)    // 1
print(MemoryLayout<Bool>.alignment) // 1


print(MemoryLayout<Int>.size)       // 8
print(MemoryLayout<Int>.stride)     // 8
print(MemoryLayout<Int>.alignment)  // 8
```

å¦‚æ‚¨æ‰€è§ï¼ŒSwift ä½¿ç”¨ 1 ä¸ªå­—èŠ‚å­˜å‚¨ Bool å€¼ï¼Œè€Œç”¨ï¼ˆåœ¨ 64 ä½ç³»ç»Ÿä¸Šï¼‰ä½¿ç”¨ 8 ä¸ªå­—èŠ‚å­˜å‚¨ Int  ç±»å‹ã€‚é‚£ä¹ˆï¼Œ[**size**ã€**stride**å’Œ**alignment**](https://swiftunboxed.com/internals/size-stride-alignment/)ä¹‹é—´åˆ°åº•æœ‰ä»€ä¹ˆä¸åŒå‘¢ï¼Ÿ 

 **alignment** å°†å‘Šè¯‰ä½ éœ€è¦å¤šå°‘å†…å­˜ï¼ˆå…¶å€¼çš„å€æ•°ï¼‰æ‰èƒ½å°†å®Œå…¨å¯¹é½çš„å†…å®¹ä¿å­˜åœ¨å†…å­˜ç¼“å†²åŒºä¸­ã€‚**size** æ˜¯å®é™…å­˜å‚¨è¯¥ç±»å‹æ‰€éœ€çš„å­—èŠ‚æ•°ã€‚ **stride** ä¼šå‘Šè¯‰ä½ åœ¨ç¼“å†²åŒºä¸Šä¸¤ä¸ªå…ƒç´ ä¹‹é—´çš„è·ç¦»ã€‚å¦‚æœä½ å¯¹è¿™äº›éæ­£å¼çš„å®šä¹‰ä¸€æ— æ‰€çŸ¥ï¼Œä¹Ÿä¸ç”¨æ‹…å¿ƒï¼Œä¸€ä¼šå„¿å°±ä¼šæ˜ç™½çš„ã€‚

```swift
struct Example {
    let foo: Int  // 8
    let bar: Bool // 1
}

print(MemoryLayout<Example>.size)      // 9
print(MemoryLayout<Example>.stride)    // 16
print(MemoryLayout<Example>.alignment) // 8
```

å½“æ„é€ æ–°çš„æ•°æ®ç±»å‹æ—¶ï¼Œåœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­æ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼ˆç±»çš„å·¥ä½œæ–¹å¼æœ‰æ‰€ä¸åŒï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®ç»“æ„ä½“ä¸­çš„å±æ€§çš„å†…å­˜å¸ƒå±€åœ¨è®¡ç®—æ•´ä¸ªç»“æ„ä½“çš„å†…å­˜å¸ƒå±€ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         16 bytes stride (8x2)       â”‚         16 bytes stride (8x2)       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚       8 bytes    â”‚  1b  â”‚  7 bytes  â”‚      8 bytes     â”‚  1b  â”‚  7 bytes  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   9 bytes size (8+1)    â”‚  padding  â”‚   9 bytes size (8+1)    â”‚  padding  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

åœ¨ Swift ä¸­ï¼Œç®€å•ç±»å‹çš„ **alignment** çš„å¤§å°ä¸å…¶ **size**  ç›¸åŒã€‚å¦‚æœå°†æ ‡å‡†çš„ Swift æ•°æ®ç±»å‹å­˜å‚¨åœ¨ä¸€ä¸ªè¿ç»­çš„å†…å­˜ç¼“å†²åŒºä¸­ï¼Œåˆ™ä¸éœ€è¦å¡«å……ï¼Œå› æ­¤æ¯ä¸€ä¸ª **stride** éƒ½å°†ä¸è¿™äº›ç±»å‹çš„ **alignment** ç›¸ç­‰ã€‚

ä½¿ç”¨å¤åˆç±»å‹æ—¶ï¼Œä¾‹å¦‚ç¤ºä¾‹ `Example` çš„ç»“æ„ä½“ï¼Œå°†ä½¿ç”¨å±æ€§ **alignment** çš„æœ€å¤§å€¼ï¼ˆ8ï¼‰ä¸ºè¯¥ç±»å‹çš„[å†…å­˜å¯¹é½å€¼](https://stackoverflow.com/questions/47610995/alignment-vs-stride-in-swift)ã€‚ **size** æ˜¯å±æ€§çš„æ€»å’Œ (8 + 1)ï¼Œ**stride** åˆ™å¯ä»¥é€šè¿‡å°†å¤§å°å››èˆäº”å…¥åˆ°å¯¹é½çš„ä¸‹ä¸€ä¸ªå€æ•°æ¥è®¡ç®—ã€‚åœ¨ä»»ä½•æƒ…å†µä¸‹éƒ½æ˜¯è¿™æ ·å—ï¼Ÿå—¯ï¼Œä¸å®Œå…¨æ˜¯...

```swift
struct Example {
    let bar: Bool // 1
    let foo: Int  // 8
}

print(MemoryLayout<Example>.size)      // 16
print(MemoryLayout<Example>.stride)    // 16
print(MemoryLayout<Example>.alignment) // 8
```

è¿™é‡Œåˆ°åº•å‘ç”Ÿäº†ä»€ä¹ˆäº‹ï¼Ÿä¸ºä»€ä¹ˆ **size** ä¼šå¢åŠ å‘¢ï¼Ÿ **size** çš„å¢å¤§å˜å¾—æœ‰äº›æ£˜æ‰‹ï¼Œå› ä¸ºå¦‚æœå¡«å……ä½äºå­˜å‚¨çš„å˜é‡ä¹‹é—´ï¼Œé‚£ä¹ˆå®ƒä¼šå¢åŠ æˆ‘ä»¬ç±»å‹çš„æ•´ä½“å¤§å°ã€‚ä½ ä¸èƒ½ä» 1 ä¸ªå­—èŠ‚å¼€å§‹ï¼Œç„¶ååœ¨å®ƒåé¢å†åŠ ä¸Š 8 ä¸ªå­—èŠ‚ï¼Œå› ä¸ºè¿™æ ·ä¼šä½¿æ•´æ•°ç±»å‹ä¸å¯¹é½ï¼Œæ‰€ä»¥ä½ éœ€è¦ 1 ä¸ªå­—èŠ‚ï¼Œç„¶åæ˜¯ 7 ä¸ªå­—èŠ‚çš„å¡«å……ï¼Œæœ€åæ˜¯ 8 ä¸ªå­—èŠ‚æ¥å­˜å‚¨æ•´æ•°å€¼ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        16 bytes stride (8x2)        â”‚        16 bytes stride (8x2)        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¤
â”‚     8 bytes      â”‚  7 bytes  â”‚  1b  â”‚     8 bytes      â”‚  7 bytes  â”‚  1b  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”˜
                   â”‚  padding  â”‚                         â”‚  padding  â”‚       
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
â”‚       16 bytes size (1+7+8)         â”‚       16 bytes size (1+7+8)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

è¿™æ˜¯ç¬¬äºŒä¸ªç¤ºä¾‹ç»“æ„çš„å¤§å°å€¼ç•¥æœ‰å¢åŠ çš„ä¸»è¦åŸå› ã€‚éšæ„åˆ›å»ºå…¶ä»–ç±»å‹ï¼Œå¹¶é€šè¿‡ä¸ºå…¶ç»˜åˆ¶å†…å­˜å¸ƒå±€æ¥è¿›è¡Œç»ƒä¹ ï¼Œä½ å¯ä»¥éšæ—¶ä½¿ç”¨ Swift åœ¨è¿è¡Œæ—¶æ‰“å°å†…å­˜å¸ƒå±€æ¥æ£€æŸ¥ä½ çš„ç»˜åˆ¶æ˜¯å¦æ­£ç¡®ã€‚ğŸ’¡

> æ•´ä¸ªé—®é¢˜åœ¨ [[swift unboxed]](https://swiftunboxed.com/internals/size-stride-alignment/) åšå®¢ä¸Šå¾—åˆ°äº†å¾ˆå¥½çš„è§£é‡Šã€‚æˆ‘è¿˜æƒ³æ¨è [Steven Curtis çš„è¿™ç¯‡æ–‡ç« ](https://stevenpcurtis.medium.com/memorylayout-in-swift-c4e70bb32e3f)ï¼Œä»¥åŠè¿™ç¯‡å…³äº [Unsafe Swift: A road to memory](https://medium.com/swlh/unsafe-swift-a-road-to-memory-15e7d7e701f9) çš„å¥½æ–‡ç« ã€‚è¿™äº›æ–‡ç« å¯¹æˆ‘ç†è§£ Swift ä¸­çš„å†…å­˜å¸ƒå±€èµ·äº†å¾ˆå¤§å¸®åŠ©ã€‚ğŸ™

## Swift ä¸­å¼•ç”¨ç±»å‹çš„å†…å­˜å¸ƒå±€

æˆ‘åœ¨å‰é¢æåˆ°è¿‡ï¼Œ**ç±»**çš„è¡¨ç°éå¸¸ä¸åŒï¼Œè¿™æ˜¯å› ä¸ºå®ƒä»¬æ˜¯å¼•ç”¨ç±»å‹ã€‚è®©æˆ‘å°†ç¤ºä¾‹ç±»å‹æ›´æ”¹æˆä¸€ä¸ªç±»ï¼Œçœ‹çœ‹å†…å­˜å¸ƒå±€ä¼šå‘ç”Ÿä»€ä¹ˆã€‚

```swift
class Example {
    let bar: Bool = true // 1
    let foo: Int = 0 // 8
}

print(MemoryLayout<Example>.size)      // 8
print(MemoryLayout<Example>.stride)    // 8
print(MemoryLayout<Example>.alignment) // 8
```

ä»€ä¹ˆï¼Œä¸ºä»€ä¹ˆï¼Ÿç›´åˆ°ç°åœ¨ï¼Œæˆ‘ä»¬éƒ½åœ¨è°ˆè®º[æ ˆ](https://stackoverflow.com/questions/27441456/swift-stack-and-heap-understanding)ä¸­ä¿ç•™çš„å†…å­˜ã€‚**æ ˆ**å†…å­˜æ˜¯ä¸ºé™æ€å†…å­˜åˆ†é…è€Œä¿ç•™çš„ï¼Œè¿˜æœ‰ä¸€ä¸ªå«åš**å †**çš„ä¸œè¥¿ç”¨äºåŠ¨æ€å†…å­˜åˆ†é…ã€‚æˆ‘ä»¬å¯ä»¥ç®€å•åœ°è¯´ï¼Œå€¼ç±»å‹ï¼ˆstructã€Intã€Boolã€Float ç­‰ï¼‰å­˜åœ¨äºæ ˆä¸­ï¼Œè€Œå¼•ç”¨ç±»å‹ï¼ˆç±»ï¼‰åˆ™åœ¨å †ä¸­åˆ†é…ï¼Œè¿™å¹¶é 100% æ­£ç¡®ã€‚Swift è¶³å¤Ÿèªæ˜ï¼Œå¯ä»¥æ‰§è¡Œé¢å¤–çš„å†…å­˜ä¼˜åŒ–ï¼Œä½†ä¸ºäº†â€œç®€å•â€ï¼Œæˆ‘ä»¬å°±åˆ°æ­¤ä¸ºæ­¢ã€‚

ä½ å¯èƒ½ä¼šé—®è¿™æ ·çš„é—®é¢˜ï¼š [ä¸ºä»€ä¹ˆæœ‰ä¸€ä¸ªæ ˆå’Œä¸€ä¸ªå †](https://stackoverflow.com/questions/7123936/why-is-there-a-stack-and-a-heap)ï¼Ÿè¿™æ˜¯å› ä¸ºå®ƒä»¬å®Œå…¨ä¸åŒã€‚æ ˆå¯ä»¥æ›´å¿«ï¼Œå› ä¸ºæ˜¯ä½¿ç”¨ push/pop æ“ä½œè¿›è¡Œå†…å­˜åˆ†é…çš„ï¼Œä½†ä½ åªèƒ½å‘å…¶ä¸­æ·»åŠ æˆ–ä»ä¸­åˆ é™¤é¡¹ç›®ã€‚æ ˆå¤§å°ä¹Ÿæ˜¯æœ‰é™çš„ï¼Œä½ é‡åˆ°è¿‡æ ˆæº¢å‡ºé”™è¯¯å—ï¼Ÿå †å…è®¸éšæœºçš„å†…å­˜åˆ†é…ï¼Œä½†æ˜¯ä½ å¿…é¡»ç¡®ä¿ä¼šé‡Šæ”¾ä½ ç”³è¯·çš„å†…å­˜ã€‚å¦ä¸€ä¸ªç¼ºç‚¹æ˜¯åˆ†é…è¿‡ç¨‹ä¼šæœ‰ä¸€äº›å¼€é”€ï¼Œä½†é™¤äº† RAM çš„ç‰©ç†å®¹é‡å¤–ï¼Œæ²¡æœ‰å¤§å°é™åˆ¶ã€‚[æ ˆå’Œå †](https://www.guru99.com/stack-vs-heap.html)å®Œå…¨ä¸åŒï¼Œä½†å®ƒä»¬éƒ½æ˜¯éå¸¸æœ‰ç”¨ã€‚ğŸ‘

å›åˆ°æ•´ä½“ï¼Œè¿™é‡Œçš„æ¯ä¸ªå€¼ï¼ˆå¤§å°ã€æ­¥å¹…ã€å¯¹é½ï¼‰éƒ½æ˜¯ 8 æ˜¯å¦‚ä½•å¾—åˆ°ï¼Ÿæˆ‘ä»¬å¯ä»¥ä½¿ç”¨  `class_getInstanceSize` æ–¹æ³•è®¡ç®—[å †ä¸Šå¯¹è±¡çš„å®é™…å¤§å°ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰](https://stackoverflow.com/questions/40312123/get-the-size-in-bytes-of-an-object-on-the-heap)ã€‚ä¸€ä¸ªç±»è‡³å°‘å«æœ‰ 16 å­—èŠ‚çš„å…ƒæ•°æ®ï¼ˆå³ä»…ä½¿ç”¨ `class_getInstanceSize` æ–¹æ³•æ‰“å°å‡ºç©ºç±»çš„å¤§å°ï¼‰åŠ ä¸Šå…¶å®ä¾‹å˜é‡çš„è®¡ç®—å€¼ã€‚

```swift
class Empty {}
print(class_getInstanceSize(Empty.self)) // 16

class Example {
    let bar: Bool = true // 1 + 7 padding
    let foo: Int = 0     // 8
}
print(class_getInstanceSize(Example.self)) // 32 (16 + 16)
```

ç±»çš„å†…å­˜å¸ƒå±€å§‹ç»ˆä¸º 8 å­—èŠ‚ï¼Œä½†å®ƒä»å †ä¸­è·å–çš„å®é™…å¤§å°åˆ™å–å†³äºå®ä¾‹å˜é‡ç±»å‹ã€‚å¦å¤–çš„ 16 å­—èŠ‚æ¥åˆ™è‡ª[â€œis aâ€æŒ‡é’ˆ](https://stackoverflow.com/questions/10998984/isa-pointer-in-objective-c)å’Œå¼•ç”¨è®¡æ•°ã€‚å¦‚æœä½ å¯¹ Objective-C è¿è¡Œæ—¶æœ‰æ‰€äº†è§£ï¼Œè¿™å¬èµ·æ¥å¯èƒ½å¾ˆç†Ÿæ‚‰ï¼Œä½†æ˜¯å¦‚æœä¸äº†è§£ï¼Œè¿™é‡Œä¹Ÿä¸è¦å¤ªæ‹…å¿ƒ ISA æŒ‡é’ˆã€‚æˆ‘ä»¬ä¸‹æ¬¡å†è°ˆè¿™ä»¶äº‹ã€‚ğŸ˜…

Swift ä½¿ç”¨[è‡ªåŠ¨å¼•ç”¨è®¡æ•° (ARC)](https://docs.swift.org/swift-book/LanguageGuide/AutomaticReferenceCounting.html) æ¥è·Ÿè¸ªå’Œç®¡ç†æ‚¨çš„åº”ç”¨ç¨‹åºçš„å†…å­˜ä½¿ç”¨æƒ…å†µã€‚å¤šäºäº†æœ‰ ARCï¼Œåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œä½ ä¸å¿…æ“å¿ƒäºæ‰‹åŠ¨å†…å­˜ç®¡ç†ã€‚ä½ åªéœ€ç¡®ä¿ä¸ä¼šåœ¨ç±»å®ä¾‹ä¹‹é—´åˆ›å»ºå¼ºçš„å¼•ç”¨å¾ªç¯ã€‚è€Œå¹¸è¿çš„æ˜¯ï¼Œè¿™äº›æƒ…å†µå¯ä»¥é€šè¿‡[å¼±å¼•ç”¨æˆ–æ— ä¸»å¼•ç”¨](https://docs.swift.org/swift-book/LanguageGuide/AutomaticReferenceCounting.html#ID52)è½»æ¾è§£å†³ã€‚ ğŸ”„

```swift
class Author {
    let name: String

    /// weak reference is required to break the cycle.
    weak var post: Post?

    init(name: String) { self.name = name }
    deinit { print("Author deinit") }
}

class Post {
    let title: String
    
    /// this can be a strong reference
    var author: Author?

    init(title: String) { self.title = title }
    deinit { print("Post deinit") }
}


var author: Author? = Author(name: "John Doe")
var post: Post? = Post(title: "Lorem ipsum dolor sit amet")

post?.author = author
author?.post = post

post = nil
author = nil

/// Post deinit
/// Author deinit
```

æ­£å¦‚ä¸Šé¢çš„ç¤ºä¾‹ä¸­æ‰€è¡¨ç°çš„ï¼Œå¦‚æœæˆ‘ä»¬ä¸ä½¿ç”¨å¼±å¼•ç”¨ï¼Œé‚£ä¹ˆå¯¹è±¡ä¹‹é—´å°†å½¼æ­¤å¼ºå¼•ç”¨ï¼Œå½¢æˆå¾ªç¯å¼•ç”¨ï¼Œé‚£ä¹ˆå³ä½¿ä½ å°†å•ä¸ªæŒ‡é’ˆè®¾ç½®ä¸º nilï¼Œå®ƒä»¬ä¹Ÿä¸ä¼šè¢«é‡Šæ”¾ï¼ˆdeinit æ ¹æœ¬ä¸ä¼šè¢«è°ƒç”¨ï¼‰ã€‚è¿™æ˜¯ä¸€ä¸ªéå¸¸åŸºæœ¬çš„ä¾‹å­ï¼Œä½†çœŸæ­£çš„é—®é¢˜æ˜¯æˆ‘ä»€ä¹ˆæ—¶å€™éœ€è¦ä½¿ç”¨ weakã€unowned æˆ– strongï¼Ÿ ğŸ¤”

æˆ‘ä¸å–œæ¬¢è¯´â€œè§†æƒ…å†µè€Œå®šâ€ï¼Œæ‰€ä»¥æˆ‘æƒ³ä¸ºä½ æŒ‡æ˜æ­£ç¡®çš„æ–¹å‘ã€‚å¦‚æœä½ ä»”ç»†æŸ¥çœ‹æœ‰å…³[é—­åŒ…](https://docs.swift.org/swift-book/LanguageGuide/Closures.html)çš„å®˜æ–¹æ–‡æ¡£ï¼Œä½ ä¼šçœ‹åˆ°æœ‰å“ªäº›ä¼šæ•è·å€¼ï¼š

* å…¨å±€å‡½æ•°æ˜¯å…·æœ‰åç§°ä¸”ä¸æ•è·ä»»ä½•å€¼çš„é—­åŒ…ã€‚
* åµŒå¥—å‡½æ•°æ˜¯å…·æœ‰åç§°çš„é—­åŒ…ï¼Œå¯ä»¥ä»å…¶å°é—­å‡½æ•°ä¸­æ•è·å€¼ã€‚
* é—­åŒ…è¡¨è¾¾å¼æ˜¯ç”¨è½»é‡çº§è¯­æ³•ç¼–å†™çš„æœªå‘½åé—­åŒ…ï¼Œå¯ä»¥ä»å…¶ä¸Šä¸‹æ–‡ä¸­æ•è·å€¼ã€‚

å¦‚ä½ æ‰€è§ï¼Œ[å…¨å±€ï¼ˆé™æ€å‡½æ•°ï¼‰ä¸ä¼šå¢åŠ å¼•ç”¨è®¡æ•°å™¨](https://stackoverflow.com/questions/28951324/why-is-the-weak-self-reference-in-the-uiview-animation-closure-causing-a-compila/48420485)ã€‚å¦ä¸€æ–¹é¢ï¼ŒåµŒå¥—å‡½æ•°å°†æ•è·å€¼ï¼Œè¿™åŒæ ·é€‚ç”¨äºé—­åŒ…è¡¨è¾¾å¼å’Œæœªå‘½åçš„é—­åŒ…ï¼Œä½†å®ƒç¨å¾®å¤æ‚ä¸€äº›ã€‚ä¸ºäº†æ›´å¤šåœ°äº†è§£é—­åŒ…å’Œå€¼æ•è·ï¼Œæˆ‘æ¨èä»¥ä¸‹ä¸¤ç¯‡æ–‡ç« ï¼š

* [ä½ ä¸ï¼ˆæ€»æ˜¯ï¼‰éœ€è¦ \[weak self\]](https://medium.com/flawless-app-stories/you-dont-always-need-weak-self-a778bec505ef)
* [Weakã€strongã€unownedï¼Œæˆ‘çš„å¤©å‘ï¼](https://krakendev.io/blog/weak-and-unowned-references-in-swift)

é•¿è¯çŸ­è¯´ï¼Œå¾ªç¯å¼•ç”¨å¾ˆç³Ÿç³•ï¼Œä½†åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œé€šè¿‡ä½¿ç”¨æ­£ç¡®çš„å…³é”®å­—å°±å¯ä»¥é¿å…å®ƒä»¬ã€‚åœ¨å¹•åï¼ŒARC åšå¾—å¾ˆå¥½ï¼Œé™¤äº†ä¸€äº›å¿…é¡»ç ´åå¼•ç”¨å¾ªç¯çš„æƒ…å†µã€‚Swift è¢«è®¾è®¡æˆ[å†…å­˜å®‰å…¨](https://docs.swift.org/swift-book/LanguageGuide/MemorySafety.html)çš„ç¼–ç¨‹è¯­è¨€ã€‚è¯¥è¯­è¨€ç¡®ä¿æ¯ä¸ªå¯¹è±¡åœ¨å¯ä»¥ä½¿ç”¨å®ƒä»¬ä¹‹å‰éƒ½å°†è¢«åˆå§‹åŒ–ï¼Œå¹¶ä¸”å°†è‡ªåŠ¨é‡Šæ”¾ä¸å†è¢«å¼•ç”¨çš„å†…å­˜ä¸­çš„å¯¹è±¡ã€‚ è¿˜ä¼šæ£€æŸ¥æ•°ç»„ç´¢å¼•æ˜¯å¦æœ‰è¶Šç•Œé”™è¯¯ã€‚è¿™ä¸ºæˆ‘ä»¬æä¾›äº†é¢å¤–çš„å®‰å…¨å±‚ï¼Œé™¤éæ˜¯ç¼–å†™ä¸å®‰å…¨çš„ Swift ä»£ç â€¦ğŸ¤“

æ€»ä¹‹ï¼Œç®€è€Œè¨€ä¹‹ï¼ŒSwift ä¸­çš„å†…å­˜å¸ƒå±€å°±æ˜¯è¿™æ ·çš„ã€‚

> å¦‚æœå‘ç°è¯‘æ–‡å­˜åœ¨é”™è¯¯æˆ–å…¶ä»–éœ€è¦æ”¹è¿›çš„åœ°æ–¹ï¼Œæ¬¢è¿åˆ° [æ˜é‡‘ç¿»è¯‘è®¡åˆ’](https://github.com/xitu/gold-miner) å¯¹è¯‘æ–‡è¿›è¡Œä¿®æ”¹å¹¶ PRï¼Œä¹Ÿå¯è·å¾—ç›¸åº”å¥–åŠ±ç§¯åˆ†ã€‚æ–‡ç« å¼€å¤´çš„ **æœ¬æ–‡æ°¸ä¹…é“¾æ¥** å³ä¸ºæœ¬æ–‡åœ¨ GitHub ä¸Šçš„ MarkDown é“¾æ¥ã€‚

---

> [æ˜é‡‘ç¿»è¯‘è®¡åˆ’](https://github.com/xitu/gold-miner) æ˜¯ä¸€ä¸ªç¿»è¯‘ä¼˜è´¨äº’è”ç½‘æŠ€æœ¯æ–‡ç« çš„ç¤¾åŒºï¼Œæ–‡ç« æ¥æºä¸º [æ˜é‡‘](https://juejin.im) ä¸Šçš„è‹±æ–‡åˆ†äº«æ–‡ç« ã€‚å†…å®¹è¦†ç›– [Android](https://github.com/xitu/gold-miner#android)ã€[iOS](https://github.com/xitu/gold-miner#ios)ã€[å‰ç«¯](https://github.com/xitu/gold-miner#å‰ç«¯)ã€[åç«¯](https://github.com/xitu/gold-miner#åç«¯)ã€[åŒºå—é“¾](https://github.com/xitu/gold-miner#åŒºå—é“¾)ã€[äº§å“](https://github.com/xitu/gold-miner#äº§å“)ã€[è®¾è®¡](https://github.com/xitu/gold-miner#è®¾è®¡)ã€[äººå·¥æ™ºèƒ½](https://github.com/xitu/gold-miner#äººå·¥æ™ºèƒ½)ç­‰é¢†åŸŸï¼Œæƒ³è¦æŸ¥çœ‹æ›´å¤šä¼˜è´¨è¯‘æ–‡è¯·æŒç»­å…³æ³¨ [æ˜é‡‘ç¿»è¯‘è®¡åˆ’](https://github.com/xitu/gold-miner)ã€[å®˜æ–¹å¾®åš](http://weibo.com/juejinfanyi)ã€[çŸ¥ä¹ä¸“æ ](https://zhuanlan.zhihu.com/juejinfanyi)ã€‚
