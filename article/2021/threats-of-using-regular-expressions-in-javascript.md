> * åŸæ–‡åœ°å€ï¼š[Threats of Using Regular Expressions in JavaScript](https://blog.bitsrc.io/threats-of-using-regular-expressions-in-javascript-28ddccf5224c)
> * åŸæ–‡ä½œè€…ï¼š[Dulanka Karunasena](https://medium.com/@dulanka)
> * è¯‘æ–‡å‡ºè‡ªï¼š[æ˜é‡‘ç¿»è¯‘è®¡åˆ’](https://github.com/xitu/gold-miner)
> * æœ¬æ–‡æ°¸ä¹…é“¾æ¥ï¼š[https://github.com/xitu/gold-miner/blob/master/article/2021/threats-of-using-regular-expressions-in-javascript.md](https://github.com/xitu/gold-miner/blob/master/article/2021/threats-of-using-regular-expressions-in-javascript.md)
> * è¯‘è€…ï¼š[jaredliw](https://github.com/jaredliw)
> * æ ¡å¯¹è€…ï¼š[KimYangOfCat](https://github.com/KimYangOfCat)ã€[greycodee](https://github.com/greycodee)

# åœ¨ JavaScript ä¸­ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼çš„éšæ‚£

![](https://cdn-images-1.medium.com/max/5760/1*5MYzlcICu2hhNjrtRCjb3A.jpeg)

æ­£åˆ™è¡¨è¾¾å¼ï¼ˆRegExï¼‰è¢«å¹¿æ³›åœ°è¿ç”¨äº Web å¼€å‘ä¸­ï¼Œç”¨ä½œæ¨¡å¼åŒ¹é…åŠéªŒè¯ç­‰ç”¨é€”ã€‚ç„¶è€Œï¼Œåœ¨å®é™…ä½¿ç”¨ä¸­å®ƒä»¬ä¼šå¸¦æ¥ä¸€äº›å®‰å…¨å’Œæ€§èƒ½ä¸Šçš„é£é™©ï¼Œå¹¶å‘æ”»å‡»è€…æ•å¼€å¤§é—¨ã€‚

å› æ­¤ï¼Œåœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å°†è®¨è®ºä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼å‰æ‰€éœ€æ³¨æ„çš„ä¸¤ä¸ªåŸºæœ¬é—®é¢˜ã€‚

## ç¾éš¾æ€§å›æº¯

æ­£åˆ™è¡¨è¾¾å¼çš„ç®—æ³•æœ‰ä¸¤ç§ï¼š

* **ç¡®å®šæ€§æœ‰é™çŠ¶æ€è‡ªåŠ¨æœºï¼ˆDFAï¼‰** â€”â€” å¯¹äºç»™å®šå­—ç¬¦ä¸²ï¼Œæ¯ä¸ªå­—ç¬¦åªæ£€æŸ¥ä¸€æ¬¡ã€‚
* **éç¡®å®šæ€§æœ‰é™çŠ¶æ€è‡ªåŠ¨æœºï¼ˆNFAï¼‰** â€”â€” å¤šæ¬¡æ£€æŸ¥åŒä¸€ä¸ªå­—ç¬¦ï¼Œç›´åˆ°æ‰¾åˆ°æœ€ä½³åŒ¹é…ã€‚

JavaScript çš„ RegEx å¼•æ“ä½¿ç”¨çš„æ˜¯ NFA ç®—æ³•ï¼Œè¿™ä¼šå¯¼è‡´ç¾éš¾æ€§å›æº¯ã€‚

ä¸ºäº†æ›´å¥½åœ°ç†è§£è¿™ä¸ªé—®é¢˜ï¼Œè®©æˆ‘ä»¬è€ƒè™‘ä»¥ä¸‹çš„ RegExï¼š

```js
/(g|i+)+t/
```

è¿™ä¸ª RegEx çœ‹èµ·æ¥å¾ˆç®€å•ã€‚ä½†æ˜¯ï¼Œè¯·åˆ«ä½ä¼°å®ƒè®©ä½ ä»˜å‡ºçš„ä»£ä»·ğŸ˜¯ã€‚é¦–å…ˆï¼Œè®©æˆ‘ä»¬äº†è§£è¿™ä¸ª RegEx èƒŒåçš„å«ä¹‰ï¼š

* **`(g|i+)`** â€”â€” è¿™ä¸ªç»„æ£€æŸ¥ç»™å®šå­—ç¬¦ä¸²æ˜¯å¦ç”± `g` æˆ–è‡³å°‘ä¸€ä¸ª `i` å¼€å¤´ã€‚
* æ¥ä¸‹æ¥çš„ `+` å°†åŒ¹é…å‰é¢çš„ç»„ä¸€æ¬¡æˆ–å¤šæ¬¡ã€‚
* å­—ç¬¦ä¸²åº”ç”±å­—æ¯ `t` ç»“å°¾ã€‚

æ ¹æ®ä¸Šæ–¹çš„ RegExï¼Œä»¥ä¸‹çš„æ–‡æœ¬è¢«åˆ¤å®šä¸ºåŒ¹é…ï¼š

```
git
giit
gggt
gigiggt
igggt
```

ç°åœ¨ï¼Œè®©æˆ‘ä»¬ä»¥ä¸€ä¸ªåŒ¹é…çš„å­—ç¬¦ä¸²ä½œä¸ºè¾“å…¥ï¼Œæµ‹è¯•ä¸Šæ–¹çš„ RegExã€‚æˆ‘å°†ä½¿ç”¨ `console.time()` æ–¹æ³•ï¼š

![åŒ¹é…çš„æ–‡æœ¬](https://cdn-images-1.medium.com/max/2000/1*f6jb5c3Y3nsF6W1SsZucRw.png)

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ‰§è¡Œé€Ÿåº¦éå¸¸å¿«ï¼Œå³ä½¿å­—ç¬¦ä¸²æœ‰ç‚¹é•¿ã€‚

> ä½†æ˜¯ï¼Œå½“ä½ çœ‹åˆ°éªŒè¯ä¸åŒ¹é…çš„æ–‡æœ¬æ‰€èŠ±è´¹çš„æ—¶é—´æ—¶ï¼Œä½ ä¼šæ„Ÿåˆ°æƒŠè®¶ã€‚

åœ¨ä¸‹æ–¹çš„ç¤ºä¾‹ä¸­ï¼Œå­—ç¬¦ä¸²ä»¥ `v` ç»“å°¾ï¼Œå› æ­¤ä¸ RegEx ä¸åŒ¹é…ã€‚ç„¶è€Œï¼Œå®ƒèŠ±äº†å¤§çº¦ 429 æ¯«ç§’ï¼Œå·®ä¸å¤šæ˜¯éªŒè¯åŒ¹é…å­—ç¬¦ä¸²çš„è¿è¡Œæ—¶é—´çš„ 400 å€ã€‚

![ä¸åŒ¹é…çš„æ–‡æœ¬](https://cdn-images-1.medium.com/max/2000/1*zKduT1538LwOWj0x5g9Y7g.png)

> è¿™ä¸ªæ€§èƒ½ä¸Šçš„å·®å¼‚æ¥æºäº JavaScript æ‰€ä½¿ç”¨çš„ NFA ç®—æ³•ã€‚

åœ¨ç¬¬ä¸€æ¬¡éªŒè¯æˆåŠŸåï¼ŒJavaScript çš„ RegEx å¼•æ“ä»ä¼šå°è¯•ç»§ç»­ã€‚å½“å®ƒåœ¨ç‰¹å®šä½ç½®å¤±è´¥æ—¶ï¼Œå®ƒå°†å›æº¯åˆ°ä¸Šä¸€ä¸ªä½ç½®å¹¶å¯»æ‰¾æ›¿ä»£è·¯å¾„ã€‚

å½“å›æº¯å˜å¾—å¤ªå¤æ‚æ—¶ï¼Œç®—æ³•å°±ä¼šæ¶ˆè€—æ›´å¤šè®¡ç®—èƒ½åŠ›ï¼Œé€ æˆ**ç¾éš¾æ€§å›æº¯**ã€‚

> **å¤‡æ³¨**ï¼šæ¬²äº†è§£å›æº¯çš„å¤æ‚åº¦ï¼Œä½ å¯ä»¥è®¿é—® [regex101.com](https://regex101.com/) å¹¶æµ‹è¯•ä½ çš„ RegExã€‚[regex101.com](https://regex101.com/) æ˜¾ç¤ºä½¿ç”¨ä¸Šè¿° RegEx éªŒè¯ `giiiit` åªéœ€è¦ 10 ä¸ªæ­¥éª¤ï¼Œè€ŒéªŒè¯ `giiiiv` åˆ™éœ€è¦ 189 ä¸ªæ­¥éª¤ã€‚

---

## Node.js ç¯å¢ƒä¸Šçš„ ReDoS æ”»å‡»

> æ”»å‡»è€…èƒ½åˆ©ç”¨ç¾éš¾æ€§å›æº¯æ¥æ”»å‡» Node.js æœåŠ¡å™¨ã€‚

ç”±äº JavaScript æ˜¯å•çº¿ç¨‹çš„ï¼ŒReDoS æ”»å‡»èƒ½è€—å°½äº‹ä»¶å¾ªç¯ï¼Œé€ æˆæœåŠ¡å™¨æ— å“åº”ï¼Œç›´åˆ°è¯·æ±‚å®Œæˆä¸ºæ­¢ã€‚

æˆ‘å°†ä½¿ç”¨ Moment.js åº“æ¥æ¼”ç¤ºè¿™ä¸€ç‚¹ï¼Œå› ä¸ºåœ¨ä½äº 2.15.2 çš„ Moment.js çš„ç‰ˆæœ¬ä¸­å­˜åœ¨ä¸€ä¸ªè‘—åçš„ ReDoS æ¼æ´ã€‚

```js
var moment = require('moment');
moment.locale("be");
moment().format("D                               MMN MMMM");
```

åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œæ—¥æœŸæ ¼å¼æœ‰ 40 ä¸ªå­—ç¬¦ï¼Œå…¶ä¸­åŒ…æ‹¬ 31 ä¸ªé™„åŠ ç©ºæ ¼ã€‚ç”±äºç¾éš¾æ€§å›æº¯ï¼Œè¿™äº›ç©ºæ ¼å°†ä½¿è¿è¡Œæ—¶é—´å¢åŠ ä¸€å€ã€‚åœ¨æˆ‘çš„æœ¬åœ°ç¯å¢ƒä¸­ï¼Œå®ƒè€—æ—¶è¶…è¿‡ 4 åˆ†é’Ÿã€‚

![è¿è¡Œç»“æœ](https://cdn-images-1.medium.com/max/2000/1*YUOV_B0E8SHaL_6ys3cDhQ.png)

`/D[oD]?(\[[^\[\]]*\]|\s+)+MMMM?/` ä¸­ `+` è¿ç®—ç¬¦çš„è¿‡åº¦ä½¿ç”¨é€ æˆäº†è¿™ä¸ªæ¼æ´ã€‚å¹¸è¿çš„æ˜¯ï¼Œè¯¥é—®é¢˜ç”± [Snyk](https://snyk.io/)ï¼ˆä¸€ä¸ªæ¼æ´è¿½è¸ªå·¥å…·ï¼‰æå‡ºåä¾¿åœ¨æ›´é«˜çš„ç‰ˆæœ¬ä¸­å¾—åˆ°äº†ä¿®å¤ã€‚

## å¦‚ä½•è§„é¿ RegEx çš„æ¼æ´

### 1. ç¼–å†™ç®€å•çš„ RegEx

å½“ RegEx ä¸­åŒ…å«è‡³å°‘ 3 ä¸ªå­—ç¬¦ï¼Œä¸”åŒ…å«è‡³å°‘ä¸¤ä¸ªå½¼æ­¤æ¥è¿‘çš„ `*`ã€`+` å’Œ `}` æ—¶ï¼Œç¾éš¾æ€§å›æº¯å°±ä¼šå‘ç”Ÿã€‚

æ‰€ä»¥ï¼Œå¦‚æœä½ èƒ½ç®€åŒ–ä½ çš„ RegEx å¹¶é¿å…ä½¿ç”¨ä»¥ä¸Šçš„æ ·å¼ï¼Œé‚£ä¹ˆä½ ä¾¿èƒ½é¿å…ç¾éš¾æ€§å›æº¯ã€‚

### 2. ä½¿ç”¨éªŒè¯åº“

å¯¹äºå¸¸ç”¨çš„éªŒè¯ä»»åŠ¡ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ç¬¬ä¸‰æ–¹åº“ï¼Œä¾‹å¦‚ [validator.js](https://www.npmjs.com/package/validator) æˆ– [express-validator](https://www.npmjs.com/package/express-validator)ã€‚

æˆ‘ä»¬å¯ä»¥ä¾èµ–è¿™äº›åº“ï¼Œå› ä¸ºå®ƒä»¬çš„èƒŒåæœ‰ä¸€ä¸ªå¤§å‹ç¤¾åŒºçš„æ”¯æŒã€‚

### 3. ä½¿ç”¨ RegEx åˆ†æå™¨

ä½ èƒ½é€šè¿‡ä½¿ç”¨ [safe-regex](https://www.npmjs.com/package/safe-regex)ã€[rxxr2](https://www.cs.bham.ac.uk/~hxt/research/rxxr2/) ç­‰å·¥å…·æ¥ç¼–å†™æ— æ¼æ´çš„ RegExã€‚å®ƒä»¬å°†æ£€æŸ¥ä½ çš„ RegEx æ˜¯å¦å­˜åœ¨æ¼æ´å¹¶è¿”å›å…¶åˆæ³•æ€§ã€‚

```js
var safe = require('safe-regex');

var regex = /(g|i+)+t/;
console.log(safe(regex)); // false
```

è¿™å°†è¢«åˆ¤å®šä¸º `false`ï¼Œå› ä¸ºè¿™ä¸ªæ­£åˆ™è¡¨è¾¾å¼å®¹æ˜“å—åˆ°ç¾éš¾æ€§å›æº¯çš„å½±å“ã€‚

### 4. é¿å…ä½¿ç”¨ Node.js é»˜è®¤çš„ RegEx å¼•æ“

ç”±äº Node.js é»˜è®¤çš„ RegEx å¼•æ“å®¹æ˜“å—åˆ° ReDoS æ”»å‡»ï¼Œæˆ‘ä»¬å¯ä»¥é¿å…ä½¿ç”¨å®ƒï¼Œå¹¶ä»¥å…¶ä»–å¼•æ“ä½œä¸ºæ›¿ä»£ï¼Œä¾‹å¦‚ï¼šGoogle çš„ [re2](https://www.npmjs.com/package/re2) å¼•æ“ã€‚å®ƒç¡®ä¿ RegEx å¯ä»¥å®‰å…¨åœ°æŠµå¾¡ ReDoS æ”»å‡»ï¼Œç”¨æ³•ä¹Ÿä¸ Node.js é»˜è®¤çš„ RegEx å¼•æ“ç›¸ä¼¼ã€‚

```js
var RE2 = require('re2');

var re = new RE2(/(g|i+)+t/);
var result = 'giiiiiiiiiiiiiiiiiiit'.search(re);
console.log(result); // 0
```

## ä¸»è¦æ”¶è·

ç¾éš¾æ€§å›æº¯æ˜¯æ­£åˆ™è¡¨è¾¾å¼ä¸­æœ€å¸¸è§çš„é—®é¢˜ã€‚å®ƒä¸ä»…å½±å“åº”ç”¨ç¨‹åºçš„æ€§èƒ½ï¼Œä¹Ÿå‘ ReDoS æ”»å‡»è€…æ•å¼€å¤§é—¨ï¼Œå¯¼è‡´ Node.js æœåŠ¡å™¨è¢«æ”»å‡»ã€‚

åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬è®¨è®ºäº†ç¾éš¾æ€§å›æº¯å’Œ ReDoS çš„åŸç†ï¼Œä»¥åŠè§„é¿è¿™äº›é—®é¢˜çš„æ–¹æ³•ã€‚

æˆ‘å¸Œæœ›è¿™ç¯‡æ–‡ç« èƒ½å¸®åŠ©ä½ ä¿æŠ¤ä½ çš„åº”ç”¨ç¨‹åºå…å—æ­¤ç±»æ”»å‡»ã€‚åˆ«å¿˜äº†åœ¨ç•™è¨€åŒºåˆ†äº«ä½ çš„çœ‹æ³•ã€‚

æ„Ÿè°¢æ‚¨çš„é˜…è¯»ï¼

> å¦‚æœå‘ç°è¯‘æ–‡å­˜åœ¨é”™è¯¯æˆ–å…¶ä»–éœ€è¦æ”¹è¿›çš„åœ°æ–¹ï¼Œæ¬¢è¿åˆ° [æ˜é‡‘ç¿»è¯‘è®¡åˆ’](https://github.com/xitu/gold-miner) å¯¹è¯‘æ–‡è¿›è¡Œä¿®æ”¹å¹¶ PRï¼Œä¹Ÿå¯è·å¾—ç›¸åº”å¥–åŠ±ç§¯åˆ†ã€‚æ–‡ç« å¼€å¤´çš„ **æœ¬æ–‡æ°¸ä¹…é“¾æ¥** å³ä¸ºæœ¬æ–‡åœ¨ GitHub ä¸Šçš„ MarkDown é“¾æ¥ã€‚

---

> [æ˜é‡‘ç¿»è¯‘è®¡åˆ’](https://github.com/xitu/gold-miner) æ˜¯ä¸€ä¸ªç¿»è¯‘ä¼˜è´¨äº’è”ç½‘æŠ€æœ¯æ–‡ç« çš„ç¤¾åŒºï¼Œæ–‡ç« æ¥æºä¸º [æ˜é‡‘](https://juejin.im) ä¸Šçš„è‹±æ–‡åˆ†äº«æ–‡ç« ã€‚å†…å®¹è¦†ç›– [Android](https://github.com/xitu/gold-miner#android)ã€[iOS](https://github.com/xitu/gold-miner#ios)ã€[å‰ç«¯](https://github.com/xitu/gold-miner#å‰ç«¯)ã€[åç«¯](https://github.com/xitu/gold-miner#åç«¯)ã€[åŒºå—é“¾](https://github.com/xitu/gold-miner#åŒºå—é“¾)ã€[äº§å“](https://github.com/xitu/gold-miner#äº§å“)ã€[è®¾è®¡](https://github.com/xitu/gold-miner#è®¾è®¡)ã€[äººå·¥æ™ºèƒ½](https://github.com/xitu/gold-miner#äººå·¥æ™ºèƒ½)ç­‰é¢†åŸŸï¼Œæƒ³è¦æŸ¥çœ‹æ›´å¤šä¼˜è´¨è¯‘æ–‡è¯·æŒç»­å…³æ³¨ [æ˜é‡‘ç¿»è¯‘è®¡åˆ’](https://github.com/xitu/gold-miner)ã€[å®˜æ–¹å¾®åš](http://weibo.com/juejinfanyi)ã€[çŸ¥ä¹ä¸“æ ](https://zhuanlan.zhihu.com/juejinfanyi)ã€‚
