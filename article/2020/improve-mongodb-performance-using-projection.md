> * åŸæ–‡åœ°å€ï¼š[Improve MongoDB Performance Using Projection](https://medium.com/better-programming/improve-mongodb-performance-using-projection-c08c38334269)
> * åŸæ–‡ä½œè€…ï¼š[Tek Loon](https://medium.com/@tcguy)
> * è¯‘æ–‡å‡ºè‡ªï¼š[æ˜é‡‘ç¿»è¯‘è®¡åˆ’](https://github.com/xitu/gold-miner)
> * æœ¬æ–‡æ°¸ä¹…é“¾æ¥ï¼š[https://github.com/xitu/gold-miner/blob/master/article/2020/improve-mongodb-performance-using-projection.md](https://github.com/xitu/gold-miner/blob/master/article/2020/improve-mongodb-performance-using-projection.md)
> * è¯‘è€…ï¼š[onlinelei](https://github.com/onlinelei)
> * æ ¡å¯¹è€…ï¼š[ivileey](https://github.com/ivileey)ï¼Œ[loststar](https://github.com/loststar)

# åˆ©ç”¨æ˜ å°„æé«˜ MongoDB æ€§èƒ½

![Photo by [Greg Rosenke](https://unsplash.com/@greg_rosenke?utm_source=medium&utm_medium=referral) on [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral)](https://cdn-images-1.medium.com/max/10744/0*xNUvb3ABjaziY-2J)

æœ¬æ–‡è®°å½•äº†æˆ‘çš„æ‰€æœ‰å‘ç°å¹¶ä¸”åˆ†æäº†åœ¨ MongoDB ä¸­ä½¿ç”¨æ˜ å°„æ—¶å¯¹æŸ¥è¯¢æ€§èƒ½çš„æå‡ã€‚åœ¨æ–‡ç« çš„æœ€åï¼Œæˆ‘ä»¬å°†çŸ¥é“æ˜¯å¦èƒ½é€šè¿‡æ˜ å°„æé«˜ MongoDB çš„æŸ¥è¯¢æ€§èƒ½ã€‚

äº‹ä¸å®œè¿Ÿï¼Œè®©æˆ‘ä»¬å¼€å§‹å§ã€‚

## é—®é¢˜æè¿°

è¿™ç¯‡æ–‡ç« çš„çµæ„Ÿæ¥æºäºæˆ‘æ›¾åœ¨å·¥ä½œä¸­ä½¿ç”¨[æ˜ å°„](https://docs.mongodb.com/manual/reference/glossary/#term-projection)åœ¨ MongoDB æ•°æ®åº“ä¸­æŸ¥è¯¢æ•°æ®ã€‚æ˜ å°„å°±æ˜¯**â€œåœ¨æ–‡æ¡£ä¸­æŸ¥è¯¢æ—¶æŒ‡å®šè¿”å›çš„ç»“æœé›†å­—æ®µâ€**å…·ä½“å¯ä»¥æŸ¥çœ‹ MongoDB çš„å®˜æ–¹[æ–‡æ¡£](https://docs.mongodb.com/manual/reference/glossary/#term-projection)

å°±åƒåœ¨éº¦å½“åŠ³é‡Œä¹°æ±‰å ¡ä¸€æ ·ï¼Œæˆ‘ä»¬å¯ä»¥é€‰æ‹©å•ç‚¹ä¸€äº›èœå“ï¼Œè€Œä¸æ˜¯é€‰æ‹©åŒ…å«é¥®æ–™å’Œè–¯æ¡çš„å¥—é¤ã€‚

å› æ­¤ï¼Œæˆ‘æƒ³è¦äº†è§£ä½¿ç”¨æ˜ å°„èƒ½è®©æŸ¥è¯¢æ€§èƒ½æé«˜å¤šå°‘ã€‚ä»¥ä¸‹æ˜¯ä¸»è¦ç›®æ ‡ï¼š

#### ä¸»è¦ç›®æ ‡ï¼š

* æ£€æµ‹ MongoDB æ—¶ä½¿ç”¨æ˜ å°„æ˜¯å¦èƒ½æé«˜æŸ¥è¯¢æ€§èƒ½ã€‚
* å¯»æ‰¾ MongoDB ä¸­ä½¿ç”¨æ˜ å°„æŸ¥è¯¢çš„æœ€ä½³æ–¹æ¡ˆã€‚

## è§£å†³æ–¹æ¡ˆåˆ†æ

æˆ‘å–œæ¬¢å¾ªåºæ¸è¿›çš„æ–¹å¼ç ”ç©¶é—®é¢˜ã€‚è¿™æ¬¡ä¹Ÿæ˜¯ä¸€æ ·ï¼š

* æˆ‘éœ€è¦ä¸€ä¸ªè¶…è¿‡ 50 ä¸‡æ¡æ•°æ®çš„æ–‡æ¡£ã€‚è¿™æ ·æˆ‘ä»¬èƒ½æ¸…æ¥šçš„åˆ©ç”¨æŸ¥è¯¢æ—¶é—´åˆ†è¾¨ä½¿ç”¨æ˜ å°„å’Œä¸ä½¿ç”¨æ—¶çš„æ€§èƒ½å·®åˆ«ã€‚
* æˆ‘æ€€ç–‘æœ‰å­æ–‡æ¡£é›†åˆä¼šå¢å¤§æŸ¥è¯¢æ—¶é—´ï¼Œæ‰€ä»¥æˆ‘ä»¬å‡†å¤‡äº†å­æ–‡æ¡£ã€‚

æœ‰å…³æ•°æ®çš„å‡†å¤‡ï¼Œè¯·å‚è€ƒä¸‹é¢çš„æˆªå›¾ã€‚å…³äºå¦‚ä½•ç”Ÿæˆç™¾ä¸‡çº§åˆ«çš„è™šæ‹Ÿæ•°æ®è¯·å‚è€ƒè¿™ç¯‡ [æ–‡ç« ](https://medium.com/@tcguy/mongodb-performance-101-how-to-generate-millions-of-data-for-performance-optimization-cf45d3556693)ã€‚

![](https://cdn-images-1.medium.com/max/2128/1*iYK8wFD1zZg_ItA_GFPSUg.png)

ä¸Šé¢è¿™å¼ æˆªå›¾ä¸­å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬å·²ç»ç”Ÿæˆäº† 50 ä¸‡æ¡ç”¨ä¸‹é¢è¿™äº›å­—æ®µç»„æˆçš„æ–‡æ¡£ï¼š

* `booking_no` â€” èˆªç­ç¼–å·
* `origin` â€” å§‹å‘åœ°
* `destination` â€” ç›®çš„åœ°
* `persons` â€” ç”±åŒ…å« `å§“`ã€ `å` å’Œ `å‡ºç”Ÿæ—¥æœŸ` å¯¹è±¡ç»„æˆçš„æ•°ç»„

## æ€§èƒ½è¯•éªŒ

åœ¨å¼€å§‹æ€§èƒ½è¯•éªŒä¹‹å‰ï¼Œè¯·ç¡®ä¿æ‰€æœ‰çš„é…ç½®æ­£ç¡®ã€‚é™¤äº†é»˜è®¤çš„ `_id` å­—æ®µä»¥å¤–ï¼Œæ²¡æœ‰åˆ›å»ºå…¶ä»–çš„ç´¢å¼•ã€‚

ä¸‹é¢æ˜¯æˆ‘æƒ³æ¼”ç¤ºçš„å®éªŒï¼š

* å®éªŒ 1ï¼šæŸ¥è¯¢çš„æ€§èƒ½ä¼šå› ä¸ºæ˜ å°„å­—æ®µçš„å‡å°‘è€Œæé«˜å—ï¼Ÿ
* å®éªŒ 2ï¼šå¦‚æœå‡å°‘å­—æ®µä¸èƒ½æé«˜æŸ¥è¯¢æ€§èƒ½ï¼Œè¿˜æœ‰å“ªäº›æ–¹æ³•èƒ½å¤Ÿæå‡æŸ¥è¯¢æ€§èƒ½ï¼Ÿ

## å®éªŒ 1ï¼šæŸ¥è¯¢çš„æ€§èƒ½ä¼šå› ä¸ºæ˜ å°„å­—æ®µçš„å‡å°‘è€Œæé«˜å—ï¼Ÿ

ä¸å¹¸çš„æ˜¯ï¼Œæ€§èƒ½å¹¶æ²¡æœ‰æé«˜ã€‚ä½†æ˜¯å¦‚æœæŠŠæ‰€æœ‰æŸ¥è¯¢çš„å­—æ®µåŠ ä¸Šç´¢å¼•ï¼Œä¼šæé«˜æŸ¥è¯¢æ€§èƒ½ï¼Œæˆ‘å°†åœ¨ä¸‹ä¸€ç« èŠ‚è®¨è®ºè¿™ä¸€ç‚¹ã€‚

åœ¨è¿™æ¬¡å®éªŒä¸­ï¼Œæˆ‘ä»¬æŸ¥è¯¢æ‰€æœ‰ç›®çš„åœ°ä¸º â€œGerlachmouthâ€ çš„èˆªç­è®¢å•ã€‚åœ¨ 50 ä¸‡ç¬”è®¢å•ä¸­ï¼Œæ»¡è¶³æ¡ä»¶çš„æœ‰ 93 ä¸ªè®¢å•ã€‚æˆ‘ä»¬æ¥çœ‹ä¸‹éœ€è¦å¤šå°‘æ—¶é—´ã€‚

ä¸ºäº†æŸ¥çœ‹æ¶ˆè€—çš„æ—¶é—´ï¼Œæˆ‘ä½¿ç”¨äº† Mongo Shell Explain å‡½æ•°ã€‚

![](https://cdn-images-1.medium.com/max/2000/1*ZILEtJVXHlvsVaKlImVusA.png)

ä¸Šé¢è¿™å¼ æˆªå›¾æ²¡æœ‰ä½¿ç”¨åˆ°æ˜ å°„ã€‚æŸ¥è¯¢æ—¶é—´ç”¨äº† 461 æ¯«ç§’ã€‚ä¸‹é¢è¿™å¼ å›¾ä¸­è™½ç„¶ä½¿ç”¨åˆ°äº†æ˜ å°„ï¼Œä½†æ˜¯æŸ¥è¯¢æ—¶é—´å´ç”¨äº† 505 æ¯«ç§’ã€‚

ä½¿ç”¨æ˜ å°„çš„å¹¶æ²¡æœ‰æé«˜æ€§èƒ½ï¼Œå´èŠ±è´¹äº†æ›´å¤šçš„æ—¶é—´ã€‚

![](https://cdn-images-1.medium.com/max/2000/1*1jXiJv35xCeu0cYVUtsuZQ.png)

åœ¨æŸ¥è¯¢ä¸­ä½¿ç”¨æ˜ å°„ï¼Œå®éªŒ 1 çš„ç»“è®ºæ˜¯ â€”â€” æ€§èƒ½æ²¡æœ‰æé«˜ã€‚ğŸ‘ğŸ‘

## å®éªŒ 2ï¼šå¦‚æœå‡å°‘å­—æ®µä¸èƒ½æé«˜æŸ¥è¯¢æ€§èƒ½ï¼Œè¿˜æœ‰å“ªäº›æ–¹æ³•èƒ½å¤Ÿæå‡æŸ¥è¯¢æ€§èƒ½ï¼Ÿ

å› ä¸ºç¬¬ä¸€ä¸ªå®éªŒçš„å¤±è´¥ï¼Œæˆ‘ç ”ç©¶äº† MongoDB å¤§å­¦æä¾›çš„ [æ€§èƒ½ä¼˜åŒ–è¯¾ç¨‹](https://university.mongodb.com/courses/M201/about)ã€‚è¿™ä¸ªè¯¾ç¨‹æ˜¯å…è´¹çš„ï¼Œå¦‚æœä½ æƒ³å­¦ä¹  MongoDB æ€§èƒ½ä¼˜åŒ–è¯¾ç¨‹ï¼Œç‚¹å‡»å‰é¢çš„é“¾æ¥ã€‚

ç„¶åæˆ‘å°±å‘ç°äº†è¦†ç›–ç´¢å¼•ã€‚æ ¹æ® MongoDB çš„å®˜æ–¹ [æ–‡æ¡£](https://docs.mongodb.com/manual/core/query-optimization/#covered-query) æè¿°ï¼Œè¦†ç›–ç´¢å¼•æ˜¯ä¸€ç§â€œå¯ä»¥å®Œå…¨ä½¿ç”¨ç´¢å¼•çš„æŸ¥è¯¢ï¼Œä¸éœ€è¦å»è®¿é—®æ–‡æ¡£â€ã€‚

è®©æˆ‘ä»¬æ‹¿çƒ¹é¥ªæ¥ä¸¾ä¾‹å­ï¼Œå½“ä½ è¦åšä¸€é¡¿é¥­æ—¶ï¼Œä½ æ‰€éœ€è¦çš„é£Ÿæéƒ½å·²ç»å‡†å¤‡å¥½åœ¨å†°ç®±é‡Œäº†ï¼Œä½ è¦åšçš„å°±åªæ˜¯åŠ å·¥ä¸€ä¸‹è€Œå·²ã€‚

åœ¨æˆ‘ä»¬åˆ›å»ºä»»ä½•ç´¢å¼•ä¹‹å‰ï¼Œæˆ‘ä»¬è¦çŸ¥é“æˆ‘ä»¬æœŸæœ›è¿”å›çš„å­—æ®µæœ‰å“ªäº›ï¼Œä¾‹å¦‚ä¸‹é¢è¿™äº›æƒ…å†µã€‚

* ç®¡ç†å‘˜å¸Œæœ›çŸ¥é“åˆ°è¾¾æŸä¸ªç›®çš„åœ°çš„æ‰€æœ‰èˆªç­è®¢å•ã€‚è®¢å•çš„ä¿¡æ¯åŒ…å« `èˆªç­å·`, `å§‹å‘åœ°` å’Œ `ç›®çš„åœ°`ã€‚

æ ¹æ®ä¸Šé¢çŸ¥é“çš„è¿™äº›ä¿¡æ¯ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸¤ä¸ªç´¢å¼•ã€‚

* ç›®çš„åœ° â€” åœ¨ `ç›®çš„åœ°` å­—æ®µä¸Šåˆ›å»ºç´¢å¼•ã€‚
* ç›®çš„åœ°ã€ å§‹å‘åœ° å’Œ èˆªç­å·ã€‚ â€” æˆ‘ä»¬å¯ä»¥åœ¨å­—æ®µ `ç›®çš„åœ°`ã€ `å§‹å‘åœ°` å’Œ `èˆªç­å·` ä¸Šåˆ›å»ºè”åˆç´¢å¼•ã€‚

å¦‚ä½•åˆ›å»ºç´¢å¼•ï¼Œè¯·å‚è€ƒä¸‹é¢çš„å‘½ä»¤ã€‚

#### ä¸ä½¿ç”¨æ˜ å°„è¿›è¡ŒæŸ¥è¯¢

é¦–å…ˆï¼Œæˆ‘ä»¬æŸ¥è¯¢ç›®çš„åœ°ä¸º â€œGerlachmouthâ€ çš„è®¢å•ã€‚ä¸‹é¢çš„æˆªå›¾æ˜¾ç¤ºäº†æŸ¥è¯¢æ¶ˆè€—çš„æ—¶é—´ã€‚å¾ˆæ˜¾ç„¶ï¼Œæ‰§è¡Œæ—¶é—´å‡å°‘åˆ°äº† **5 æ¯«ç§’**ã€‚æ¯”ä¸ä½¿ç”¨ç´¢å¼•å¿«äº† **100 å€**ã€‚

ä½ å¯èƒ½æ„Ÿè§‰è¿™å·²ç»å¾ˆæ£’äº†ï¼Œä½†æ˜¯è¿™å¹¶ä¸æ˜¯æœ€å¥½çš„æ•ˆæœã€‚åœ¨ä½¿ç”¨**è¦†ç›–ç´¢å¼•**çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥å°†æŸ¥è¯¢é€Ÿåº¦æé«˜ **250 å€**ã€‚

![](https://cdn-images-1.medium.com/max/2000/1*_07K8c-uv2n9X9cahQnEGQ.png)

## ä½¿ç”¨æ˜ å°„æŸ¥è¯¢ï¼ˆè¦†ç›–ç´¢å¼•ï¼‰

ä½¿ç”¨è¦†ç›–ç´¢å¼•æ„å‘³ç€ï¼Œæˆ‘ä»¬æ‰€æœ‰æƒ³è¦çš„å­—æ®µéƒ½è¢«ç´¢å¼•åŒ…å«ã€‚

ä½¿ç”¨è¦†ç›–ç´¢å¼•ï¼Œå¯ä»¥å°†æŸ¥è¯¢æ—¶é—´é€¼è¿‘ **2 æ¯«ç§’**ï¼Œæ¯”ä¸ä½¿ç”¨ç´¢å¼•æ€§èƒ½å¤§æ¦‚æé«˜äº† **60%**ã€‚

é™¤äº†æå‡æŸ¥è¯¢æ¶ˆè€—çš„æ—¶é—´ï¼Œæˆ‘ä»¬è¿˜æ”¹å–„äº†æŸ¥è¯¢ç­–ç•¥ã€‚ä»å›¾ä¸­å¯ä»¥çœ‹å‡ºï¼Œç´¢å¼•æœ¬èº«å·²ç»åŒ…å«äº†æŸ¥è¯¢æ‰€éœ€çš„å­—æ®µã€‚å› æ­¤æˆ‘ä»¬ä¸éœ€è¦æŸ¥è¯¢ä»»ä½•æ–‡æ¡£ï¼Œè¿™ä»æ•´ä½“ä¸Šæé«˜äº†æŸ¥è¯¢æ€§èƒ½ã€‚

![](https://cdn-images-1.medium.com/max/2000/1*R24vSTP-N7x_kfh2ucWr-g.png)

## æ€»ç»“

æœ¬æ–‡é‡ç‚¹ï¼š

* æŸ¥è¯¢æ›´å°‘çš„å­—æ®µå¹¶ä¸èƒ½æå‡æ€§èƒ½ï¼Œé™¤ééœ€è¦è¿”å›çš„å­—æ®µéƒ½åœ¨ç´¢å¼•ä¸­ã€‚
* ç´¢å¼•å¯ä»¥æé«˜æŸ¥è¯¢æ€§èƒ½ï¼Œå¦‚æœæ˜¯è¦†ç›–ç´¢å¼•çš„è¯æ€§èƒ½å°†å¤§å¹…åº¦æé«˜ã€‚
* è¦†ç›–ç´¢å¼•æ¯”ä¸ä½¿ç”¨ç´¢å¼•æ€§èƒ½æå‡æ¥è¿‘ 60%ã€‚

æ„Ÿè°¢é˜…è¯»ï¼Œä¸‹ç¯‡æ–‡ç« è§ã€‚

## å‚è€ƒ

* Projects Field From Query â€” MongoDB [Documentation](https://docs.mongodb.com/manual/tutorial/project-fields-from-query-results/)
* A Thorough Explanation from [StackOverflow](https://dba.stackexchange.com/questions/198444/how-mongodb-projection-affects-performance)
* Explain Output â€” MongoDB [Documentation](https://docs.mongodb.com/manual/reference/explain-results/#executionstats)

> å¦‚æœå‘ç°è¯‘æ–‡å­˜åœ¨é”™è¯¯æˆ–å…¶ä»–éœ€è¦æ”¹è¿›çš„åœ°æ–¹ï¼Œæ¬¢è¿åˆ° [æ˜é‡‘ç¿»è¯‘è®¡åˆ’](https://github.com/xitu/gold-miner) å¯¹è¯‘æ–‡è¿›è¡Œä¿®æ”¹å¹¶ PRï¼Œä¹Ÿå¯è·å¾—ç›¸åº”å¥–åŠ±ç§¯åˆ†ã€‚æ–‡ç« å¼€å¤´çš„ **æœ¬æ–‡æ°¸ä¹…é“¾æ¥** å³ä¸ºæœ¬æ–‡åœ¨ GitHub ä¸Šçš„ MarkDown é“¾æ¥ã€‚

---

> [æ˜é‡‘ç¿»è¯‘è®¡åˆ’](https://github.com/xitu/gold-miner) æ˜¯ä¸€ä¸ªç¿»è¯‘ä¼˜è´¨äº’è”ç½‘æŠ€æœ¯æ–‡ç« çš„ç¤¾åŒºï¼Œæ–‡ç« æ¥æºä¸º [æ˜é‡‘](https://juejin.im) ä¸Šçš„è‹±æ–‡åˆ†äº«æ–‡ç« ã€‚å†…å®¹è¦†ç›– [Android](https://github.com/xitu/gold-miner#android)ã€[iOS](https://github.com/xitu/gold-miner#ios)ã€[å‰ç«¯](https://github.com/xitu/gold-miner#å‰ç«¯)ã€[åç«¯](https://github.com/xitu/gold-miner#åç«¯)ã€[åŒºå—é“¾](https://github.com/xitu/gold-miner#åŒºå—é“¾)ã€[äº§å“](https://github.com/xitu/gold-miner#äº§å“)ã€[è®¾è®¡](https://github.com/xitu/gold-miner#è®¾è®¡)ã€[äººå·¥æ™ºèƒ½](https://github.com/xitu/gold-miner#äººå·¥æ™ºèƒ½)ç­‰é¢†åŸŸï¼Œæƒ³è¦æŸ¥çœ‹æ›´å¤šä¼˜è´¨è¯‘æ–‡è¯·æŒç»­å…³æ³¨ [æ˜é‡‘ç¿»è¯‘è®¡åˆ’](https://github.com/xitu/gold-miner)ã€[å®˜æ–¹å¾®åš](http://weibo.com/juejinfanyi)ã€[çŸ¥ä¹ä¸“æ ](https://zhuanlan.zhihu.com/juejinfanyi)ã€‚
