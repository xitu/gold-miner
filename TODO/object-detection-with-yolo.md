> * åŸæ–‡åœ°å€ï¼š[Real-time object detection with YOLO](http://machinethink.net/blog/object-detection-with-yolo/)
> * åŸæ–‡ä½œè€…ï¼šæœ¬æ–‡å·²è·åŸä½œè€… [Matthijs Hollemans](http://machinethink.net/blog/) æˆæƒ
> * è¯‘æ–‡å‡ºè‡ªï¼š[æ˜é‡‘ç¿»è¯‘è®¡åˆ’](https://github.com/xitu/gold-miner)
> * è¯‘è€…ï¼š[Danny Lau](https://github.com/Danny1451)
> * æ ¡å¯¹è€…ï¼š[Dalston Xu](https://github.com/xunge0613) ,[DeepMissea](https://github.com/DeepMissea)


# æ·±åº¦å­¦ä¹ åœ¨ iOS ä¸Šçš„å®è·µ â€”â€” é€šè¿‡ YOLO åœ¨ iOS ä¸Šå®ç°å®æ—¶ç‰©ä½“æ£€æµ‹ #


>è¯‘è€…æ³¨ï¼š
>åœ¨é˜…è¯»è¿™ç¯‡æ–‡ç« ä¹‹å‰å¯èƒ½ä¼šé‡åˆ°çš„ä¸€äº›åè¯ï¼Œè¿™é‡Œæ˜¯è§£é‡Š(æˆ‘è‡ªå·±ä¹ŸæŸ¥äº†ç›¸å½“å¤šçš„èµ„æ–™ï¼Œä¸ºäº†ç¿»è¯‘åœ°å°½å¯èƒ½çš„ç®€å•æ˜“æ‡‚ä¸€äº›)
> - Metalï¼šMetal æ˜¯è‹¹æœåœ¨ iOS 8 ä¹‹å æä¾›çš„ä¸€ç§ä½å±‚æ¬¡çš„æ¸²æŸ“åº”ç”¨ç¨‹åºç¼–ç¨‹æ¥å£ï¼Œæä¾›äº†è½¯ä»¶æ‰€éœ€çš„æœ€ä½å±‚ï¼Œä¿è¯è½¯ä»¶å¯ä»¥è¿è¡Œåœ¨ä¸åŒçš„å›¾åƒèŠ¯ç‰‡ä¸Šã€‚ï¼ˆå’Œ OpenGL ES æ˜¯å¹¶åˆ—å…³ç³»ï¼‰
> - åˆ†ç±»å™¨ï¼šè¯¥å‡½æ•°æˆ–æ¨¡å‹èƒ½å¤ŸæŠŠæ•°æ®åº“ä¸­çš„æ•°æ®çºªå½•æ˜ å°„åˆ°ç»™å®šç±»åˆ«ä¸­çš„æŸä¸€ä¸ªï¼Œä»è€Œå¯ä»¥åº”ç”¨äºæ•°æ®é¢„æµ‹ã€‚
> - æ‰¹é‡å½’ä¸€åŒ–ï¼šè§£å†³åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œä¸­é—´å±‚æ•°æ®åˆ†å¸ƒå‘ç”Ÿæ”¹å˜çš„é—®é¢˜ï¼Œä»¥é˜²æ­¢æ¢¯åº¦æ¶ˆå¤±æˆ–çˆ†ç‚¸ã€åŠ å¿«è®­ç»ƒé€Ÿåº¦ã€‚
> - æ–‡ä¸­æœ¯è¯­ä¸»è¦å‚ç…§å­™é€Šç­‰äººå¯¹æ–¯å¦ç¦å¤§å­¦æ·±åº¦å­¦ä¹ æ•™ç¨‹[UFLDL Tutorial](http://ufldl.stanford.edu/wiki/index.php/UFLDL%E6%95%99%E7%A8%8B)çš„ç¿»è¯‘

åœ¨è®¡ç®—æœºè§†è§‰é¢†åŸŸï¼Œç‰©ä½“æ£€æµ‹æ˜¯ç»å…¸é—®é¢˜ä¹‹ä¸€ï¼š
**è¯†åˆ«ä¸€å¼ ç»™å®šçš„å›¾åƒä¸­åŒ…å«çš„ç‰©ä½“*æ˜¯ä»€ä¹ˆ*ï¼Œå’Œå®ƒä»¬åœ¨å›¾åƒä¸­çš„*ä½ç½®*ã€‚**

æ£€æµ‹æ˜¯æ¯”åˆ†ç±»æ›´å¤æ‚çš„ä¸€ä¸ªé—®é¢˜ï¼Œè™½ç„¶åˆ†ç±»ä¹Ÿè¦è¯†åˆ«ç‰©ä½“ï¼Œä½†æ˜¯å®ƒä¸éœ€è¦å‘Šè¯‰ä½ ç‰©ä½“åœ¨å›¾åƒä¸­çš„ä½ç½®ï¼Œå¹¶ä¸”åˆ†ç±»æ— æ³•è¯†åˆ«åŒ…å«å¤šä¸ªç‰©ä½“çš„å›¾åƒã€‚

[![](http://machinethink.net/images/yolo/ClassificationVsDetection.png) ](http://machinethink.net/images/yolo/ClassificationVsDetection@2x.png)

[YOLO](https://pjreddie.com/darknet/yolo/) æ˜¯ä¸€ä¸ªç”¨æ¥å¤„ç†å®æ—¶ç‰©ä½“æ£€æµ‹çš„èªæ˜çš„ç¥ç»ç½‘ç»œã€‚

åœ¨è¿™ç¯‡åšå®¢é‡Œé¢æˆ‘å°†ä»‹ç»å¦‚ä½•é€šè¿‡ Metal Performance Shaders è®©â€œè¿·ä½ â€ç‰ˆçš„ YOLOv2 åœ¨ iOS ä¸Šè¿è¡Œï¼ˆè¯‘ï¼šMetalPerformanceShaders æ˜¯ iOS 9 ä¸­ Metal Kitæ–°å¢çš„æ–¹æ³•ï¼‰ã€‚

åœ¨ä½ ç»§ç»­çœ‹ä¸‹å»ä¹‹å‰ï¼ŒåŠ¡å¿…å…ˆçœ‹ä¸‹è¿™ä¸ª[ä»¤äººéœ‡æƒŠçš„ YOLOv2 é¢„å‘Š](https://www.youtube.com/watch?v=VOC3huqHrss)ã€‚ ğŸ˜

## YOLO æ˜¯æ€ä¹ˆå·¥ä½œçš„ ##

ä½ å¯ä»¥ç”¨ä¸€ä¸ªç±»ä¼¼äº [VGGNet](/blog/convolutional-neural-networks-on-the-iphone-with-vggnet/) æˆ– [Inception](https://github.com/hollance/Forge/tree/master/Examples/Inception) çš„åˆ†ç±»å™¨ï¼Œé€šè¿‡åœ¨å›¾åƒä¸Šç§»åŠ¨ä¸€ä¸ªå°çš„çª—å£å°†åˆ†ç±»å™¨è½¬æ¢æˆç‰©ä½“æ£€æµ‹å™¨ã€‚åœ¨æ¯ä¸€æ¬¡ç§»åŠ¨ä¸­ï¼Œè¿è¡Œåˆ†ç±»å™¨æ¥è·å–å¯¹å½“å‰çª—å£å†…ç‰©ä½“ç±»å‹çš„æ¨æµ‹ã€‚é€šè¿‡æ»‘åŠ¨çª—å£å¯ä»¥è·å¾—æˆç™¾ä¸Šåƒä¸ªå…³äºè¯¥å›¾åƒçš„æ¨æµ‹ï¼Œä½†æ˜¯åªæœ‰é‚£ä¸ªåˆ†ç±»å™¨æœ€ç¡®å®šçš„é‚£ä¸ªé€‰é¡¹ä¼šè¢«ä¿ç•™ã€‚

è¿™ä¸ªæ–¹æ¡ˆè™½ç„¶æ˜¯å¯è¡Œçš„ä½†æ˜¯å¾ˆæ˜æ˜¾å®ƒä¼šéå¸¸çš„æ…¢ï¼Œå› ä¸ºä½ éœ€è¦å¤šæ¬¡è¿è¡Œåˆ†ç±»å™¨ã€‚ä¸€ç§å¯ä»¥ç•¥å¾®æ”¹å–„çš„æ–¹æ³•æ˜¯é¦–å…ˆé¢„æµ‹å“ªäº›éƒ¨åˆ†çš„å›¾ç‰‡å¯èƒ½åŒ…å«æœ‰è¶£çš„ä¿¡æ¯ - æ‰€è°“çš„**åŒºåŸŸå»ºè®®** - ç„¶ååªåœ¨è¿™äº›åŒºåŸŸè¿è¡Œåˆ†ç±»å™¨ã€‚ç›¸æ¯”ç§»åŠ¨çª—å£æ¥è¯´ï¼Œåˆ†ç±»å™¨ç¡®å®å‡å°‘äº†ä¸å°‘å·¥ä½œé‡ï¼Œä½†æ˜¯å®ƒä»ä¼šè¿è¡Œè¾ƒå¤šæ¬¡æ•°ã€‚

YOLO é‡‡ç”¨äº†ä¸€ç§å®Œå…¨ä¸åŒçš„å®ç°æ–¹å¼ã€‚å®ƒä¸æ˜¯ä¼ ç»Ÿçš„åˆ†ç±»å™¨ï¼Œè€Œæ˜¯è¢«æ”¹é€ æˆäº†å¯¹è±¡æ¢æµ‹å™¨ã€‚YOLO å®é™…ä¸Šåªä¼šçœ‹å›¾åƒä¸€æ¬¡ï¼ˆå› æ­¤å¾—åï¼šYou Only Look Onceï¼ˆä½ åªç”¨çœ‹ä¸€æ¬¡ï¼‰ï¼‰ï¼Œä½†æ˜¯æ˜¯é€šè¿‡ä¸€ç§èªæ˜çš„æ–¹å¼ã€‚
YOLO æŠŠå›¾åƒåˆ†å‰²ä¸º 13 ä¹˜ 13 å•å…ƒçš„ç½‘æ ¼ï¼š

[![The 13x13 grid](http://machinethink.net/images/yolo/Grid@2x.png)](/images/yolo/Grid@2x.png)

æ¯ä¸ªå•å…ƒéƒ½è´Ÿè´£é¢„æµ‹ 5 ä¸ªè¾¹ç•Œæ¡†ã€‚è¾¹ç•Œæ¡†ä»£è¡¨ç€è¿™ä¸ªçŸ©å½¢åŒ…å«ç€ä¸€ä¸ªç‰©ä½“ã€‚

YOLO ä¹Ÿä¼šè¾“å‡ºä¸€ä¸ª **ç¡®ä¿¡å€¼** æ¥å‘Šè¯‰æˆ‘ä»¬å®ƒæœ‰å¤šç¡®å®šè¾¹ç•Œæ¡†é‡Œæ˜¯å¦åŒ…å«æŸä¸ªç‰©ä½“ã€‚è¿™ä¸ªåˆ†æ•°ä¸ä¼šåŒ…å«ä»»ä½•å…³äºè¾¹ç•Œæ¡†å†…çš„ç‰©ä½“æ˜¯ä»€ä¹ˆçš„ä¿¡æ¯ï¼Œåªæ˜¯è¿™ä¸ªæ¡†æ˜¯å¦ç¬¦åˆæ ‡å‡†ã€‚

é¢„æµ‹ä¹‹åçš„è¾¹ç•Œæ¡†å¯èƒ½çœ‹ä¸Šå»åƒä¸‹é¢è¿™æ ·ï¼ˆç¡®ä¿¡å€¼è¶Šé«˜ï¼Œç›’å­çš„è¾¹ç•Œç”»çš„è¶Šå®½ï¼‰

[![](http://machinethink.net/images/yolo/Boxes.png)](http://machinethink.net/images/yolo/Boxes@2x.png)

å¯¹æ¯ä¸ªè¾¹ç•Œæ¡†ï¼Œå•å…ƒä¹Ÿä¼šæ¨æµ‹ä¸€ä¸ª**ç±»åˆ«**ã€‚è¿™å°±åƒåˆ†ç±»å™¨ä¸€æ ·ï¼šå®ƒæä¾›äº†æ‰€æœ‰å¯èƒ½ç±»çš„å¯èƒ½æ€§åˆ†å¸ƒæƒ…å†µã€‚è¿™ä¸ªç‰ˆæœ¬çš„ YOLO æˆ‘ä»¬æ˜¯é€šè¿‡ [PASCAL VOC dataset](http://host.robots.ox.ac.uk/pascal/VOC/) æ¥è®­ç»ƒçš„ï¼Œå®ƒå¯ä»¥è¯†åˆ« 20 ç§ä¸åŒçš„ç±»ï¼Œæ¯”å¦‚ï¼š

- è‡ªè¡Œè½¦
- èˆ¹
- æ±½è½¦
- çŒ«
- ç‹—
- äºº
- ç­‰ç­‰â€¦

è¾¹ç•Œæ¡†çš„ç¡®ä¿¡å€¼å’Œç±»çš„é¢„æµ‹ç»„åˆæˆä¸€ä¸ªæœ€ç»ˆåˆ†æ•°ï¼Œå‘Šè¯‰æˆ‘ä»¬è¾¹ç•Œæ¡†ä¸­åŒ…å«ä¸€ä¸ªç‰¹å®šç±»å‹çš„ç‰©ä½“çš„å¯èƒ½æ€§ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œå·¦ä¾§è¿™ä¸ªåˆå¤§åˆç²—çš„é»„è‰²æ–¹æ¡†è®¤ä¸ºæœ‰ 85% çš„å¯èƒ½æ€§å®ƒåŒ…å«äº†â€œç‹—â€è¿™ä¸ªç‰©ä½“ã€‚


[![The bounding boxes with their class scores](http://machinethink.net/images/yolo/Scores.png)](http://machinethink.net/images/yolo/Scores@2x.png)

ä¸€å…±æœ‰ 13Ã—13 = 169 ä¸ªå•å…ƒæ ¼ï¼Œæ¯ä¸ªå•å…ƒæ ¼é¢„æµ‹ 5 ä¸ªè¾¹ç•Œæ¡†ï¼Œæœ€ç»ˆæˆ‘ä»¬ä¼šæœ‰ 845 ä¸ªè¾¹ç•Œæ¡†ã€‚äº‹å®è¯æ˜ï¼Œå¤§éƒ¨åˆ†çš„æ¡†çš„ç¡®ä¿¡å€¼éƒ½å¾ˆä½ï¼Œæ‰€ä»¥æˆ‘ä»¬åªä¿ç•™é‚£äº›æœ€ç»ˆå¾—åˆ†åœ¨ 30% åŠä»¥ä¸Šçš„å€¼ï¼ˆä½ å¯ä»¥æ ¹æ®ä½ æ‰€éœ€è¦çš„ç²¾ç¡®ç¨‹åº¦æ¥ä¿®æ”¹è¿™ä¸ªä¸‹é™ï¼‰ã€‚

æ¥ä¸‹æ¥æ˜¯æœ€åçš„é¢„æµ‹ï¼š

[![The final prediction](http://machinethink.net/images/yolo/Prediction.png)](http://machinethink.net/images/yolo/Prediction@2x.png)

ä»æ€»å…± 845 çš„ä¸ªè¾¹ç•Œæ¡†ä¸­æˆ‘ä»¬åªä¿ç•™äº†è¿™ä¸‰ä¸ªï¼Œå› ä¸ºå®ƒä»¬ç»™å‡ºäº†æœ€å¥½çš„ç»“æœã€‚ä½†æ˜¯è¯·æ³¨æ„è™½ç„¶æ˜¯ 845 ä¸ªç‹¬ç«‹çš„é¢„æµ‹ï¼Œå®ƒä»¬éƒ½æ˜¯åŒæ—¶è¿è¡Œçš„ - ç¥ç»ç½‘ç»œåªä¼šè¿è¡Œä¸€æ¬¡ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ YOLO æ˜¯å¦‚æ­¤çš„å¼ºå¤§å’Œå¿«é€Ÿã€‚

*(ä¸Šå›¾æ¥è‡ª [pjreddie.com](https://pjreddie.com)ã€‚)*

## ç¥ç»ç½‘ç»œ ##

YOLO çš„æ¶æ„æ˜¯å¾ˆç®€å•çš„ï¼Œå®ƒå°±æ˜¯ä¸€ä¸ªå·ç§¯ç¥ç»ç½‘ç»œï¼š

```
Layer         kernel  stride  output shape
---------------------------------------------
Input                          (416, 416, 3)
Convolution    3Ã—3      1      (416, 416, 16)
MaxPooling     2Ã—2      2      (208, 208, 16)
Convolution    3Ã—3      1      (208, 208, 32)
MaxPooling     2Ã—2      2      (104, 104, 32)
Convolution    3Ã—3      1      (104, 104, 64)
MaxPooling     2Ã—2      2      (52, 52, 64)
Convolution    3Ã—3      1      (52, 52, 128)
MaxPooling     2Ã—2      2      (26, 26, 128)
Convolution    3Ã—3      1      (26, 26, 256)
MaxPooling     2Ã—2      2      (13, 13, 256)
Convolution    3Ã—3      1      (13, 13, 512)
MaxPooling     2Ã—2      1      (13, 13, 512)
Convolution    3Ã—3      1      (13, 13, 1024)
Convolution    3Ã—3      1      (13, 13, 1024)
Convolution    1Ã—1      1      (13, 13, 125)
---------------------------------------------

```

è¿™ç§ç¥ç»ç½‘ç»œåªä½¿ç”¨äº†æ ‡å‡†çš„å±‚ç±»å‹ï¼š3x3 æ ¸å¿ƒçš„å·ç§¯å±‚å’Œ 2x2 çš„æœ€å¤§å€¼æ± åŒ–å±‚ï¼Œæ²¡æœ‰å¤æ‚çš„äº‹åŠ¡ã€‚YOLOv2 ä¸­æ²¡æœ‰å…¨è¿æ¥å±‚ã€‚

**æ³¨æ„ï¼š** æˆ‘ä»¬å°†è¦ä½¿ç”¨çš„â€œè¿·ä½ â€ç‰ˆæœ¬çš„ YOLO åªæœ‰ 9 ä¸ªå·ç§¯å±‚å’Œ 6 ä¸ªæ± åŒ–å±‚ã€‚å®Œæ•´ç‰ˆçš„ YOLOv2 æ¨¡å‹çš„å±‚æ•°æ˜¯â€œè¿·ä½ â€ç‰ˆçš„ 3 å€ï¼Œå¹¶ä¸”æœ‰ä¸€ä¸ªç•¥å¾®å¤æ‚çš„å½¢çŠ¶ï¼Œä½†å®ƒä»ç„¶æ˜¯ä¸€ä¸ªå¸¸è§„çš„è½¬æ¢ã€‚

æœ€åçš„å·ç§¯å±‚æœ‰ä¸ª 1x1 çš„æ ¸å¿ƒç”¨äºé™ä½æ•°æ®åˆ° 13x13x125 çš„å°ºå¯¸ã€‚è¿™ä¸ª 13x13 çœ‹ä¸Šå»å¾ˆç†Ÿæ‚‰ï¼šè¿™æ­£æ˜¯å›¾åƒåŸæ¥åˆ†å‰²ä¹‹åçš„ç½‘æ ¼å°ºå¯¸ã€‚

æ‰€ä»¥æœ€ç»ˆæˆ‘ä»¬ç»™æ¯ä¸ªç½‘æ ¼å•å…ƒç”Ÿæˆäº† 125 ä¸ªé€šé“ã€‚è¿™ 125 ä¸ªæ•°å­—åŒ…å«äº†è¾¹ç•Œæ¡†ä¸­çš„æ•°æ®å’Œç±»å‹é¢„æµ‹ã€‚ä¸ºä»€ä¹ˆæ˜¯ 125 ä¸ªå‘¢ï¼Ÿæ©ï¼Œæ¯ä¸ªå•å…ƒæ ¼é¢„æµ‹ 5 ä¸ªè¾¹ç•Œæ¡†ï¼Œå¹¶ä¸”ä¸€ä¸ªè¾¹ç•Œæ¡†é€šè¿‡ 25 ä¸ªæ•°æ®å…ƒç´ æ¥æè¿°ï¼š

- è¾¹ç•Œæ¡†çš„çŸ©å½¢çš„ x è½´åæ ‡ï¼Œ y è½´åæ ‡ï¼Œå®½åº¦å’Œé«˜åº¦
- ç¡®ä¿¡å€¼
- 20 ä¸ªç±»å‹çš„å¯èƒ½æ€§åˆ†å¸ƒ

ä½¿ç”¨ YOLO å¾ˆç®€å•ï¼šä½ ç»™å®ƒä¸€ä¸ªè¾“å…¥å›¾åƒï¼ˆå°ºå¯¸è°ƒèŠ‚åˆ° 416x416 åƒç´ ï¼‰ï¼Œå®ƒåœ¨å•ä¸€ä¼ é€’ä¸‹é€šè¿‡å·ç§¯ç½‘ç»œï¼Œæœ€åè½¬å˜ä¸º 13x13x125 çš„å¼ é‡æ¥æè¿°è¿™äº›ç½‘æ ¼å•å…ƒçš„è¾¹ç•Œæ¡†ã€‚ä½ æ‰€éœ€è¦åšçš„åªæ˜¯è®¡ç®—è¿™äº›è¾¹ç•Œæ¡†çš„æœ€ç»ˆåˆ†æ•°ï¼Œå°†é‚£äº›å°äº 30% çš„åˆ†æ•°é—å¼ƒã€‚

**æç¤ºï¼š** ä¸ºäº†å­¦ä¹ æ›´å¤šå…³äº YOLO çš„å·¥ä½œåŸç†å’Œè®­ç»ƒæ–¹å¼ï¼Œçœ‹ä¸‹è¿™ä¸ªå…¶ä¸­ä¸€ä½å‘æ˜è€…çš„[ç²¾å½©çš„æ¼”è®²](https://www.youtube.com/watch?v=NM6lrxy0bxs)ã€‚è¿™ä¸ªè§†é¢‘å®é™…ä¸Šæè¿°çš„æ˜¯ YOLOv1ï¼Œä¸€ä¸ªåœ¨æ„å»ºæ–¹é¢ç•¥å¾®æœ‰ç‚¹ä¸åŒçš„è€ç‰ˆæœ¬ï¼Œä½†æ˜¯å…¶ä¸»è¦æ€æƒ³è¿˜æ˜¯ä¸€æ ·çš„ã€‚å€¼å¾—ä¸€çœ‹ï¼

## è½¬æ¢åˆ° Metal ##

æˆ‘åˆšåˆšæè¿°çš„æ¶æ„æ˜¯è¿·ä½  YOLO çš„ï¼Œæ­£æ˜¯æˆ‘ä»¬å°†åœ¨ iOS app ä¸­ä½¿ç”¨çš„é‚£ä¸ªã€‚å®Œæ•´çš„ YOLOv2 ç½‘ç»œåŒ…å« 3 å€çš„å±‚æ•°ï¼Œå¹¶ä¸”è¿™å¯¹äºç›®å‰çš„ iPhone æ¥è¯´æƒ³å¿«é€Ÿè¿è¡Œå®ƒï¼Œæœ‰ç‚¹å¤ªå¤§äº†ã€‚å› æ­¤ï¼Œè¿·ä½  YOLO ç”¨äº†æ›´å°‘çš„å±‚æ•°ï¼Œè¿™ä½¿å®ƒæ¯”å®ƒå“¥å“¥å¿«äº†ä¸å°‘ï¼Œä½†æ˜¯ä¹ŸæŸå¤±äº†ä¸€äº›ç²¾ç¡®åº¦ã€‚


[![](http://machinethink.net/images/yolo/CatOrDog.png) ](http://machinethink.net/images/yolo/CatOrDog@2x.png)

YOLO æ˜¯ç”¨ Darknet å†™çš„ï¼ŒYOLO ä½œè€…çš„ä¸€ä¸ªè‡ªå®šä¹‰æ·±åº¦å­¦ä¹ æ¡†æ¶ã€‚å¯ä¸‹è½½åˆ°çš„æƒé‡åªæœ‰ Darknet æ ¼å¼ã€‚è™½ç„¶ Darknet å·²ç»[å¼€æº](https://github.com/pjreddie/darknet)äº†ï¼Œä½†æ˜¯æˆ‘ä¸æ˜¯å¾ˆæ„¿æ„èŠ±å¤ªå¤šçš„æ—¶é—´æ¥å¼„æ¸…æ¥šå®ƒæ˜¯æ€ä¹ˆå·¥ä½œçš„ã€‚

å¹¸è¿çš„æ˜¯ï¼Œ[æœ‰äºº](https://github.com/allanzelener/YAD2K/)å·²ç»å°è¯•å¹¶æŠŠ Dardnet æ¨¡å‹è½¬æ¢ä¸º Kerasï¼Œæ°å¥½æ˜¯æˆ‘æ‰€ç”¨çš„æ·±åº¦å­¦ä¹ å·¥å…·ã€‚å› æ­¤æˆ‘å”¯ä¸€è¦åšçš„å°±æ˜¯æ‰§è¡Œè¿™ä¸ª â€YAD2Kâ€œ çš„è„šæœ¬æ¥æŠŠ Darknet æ ¼å¼çš„æƒé‡è½¬æ¢åˆ° Keras æ ¼å¼ï¼Œç„¶åå†å†™æˆ‘è‡ªå·±çš„è„šæœ¬ï¼ŒæŠŠ Keras æƒé‡è½¬æ¢åˆ° Metal çš„æ ¼å¼ã€‚

ä½†æ˜¯ï¼Œä»ç„¶æœ‰äº›å¥‡æ€ªâ€¦â€¦ YOLO åœ¨å·ç§¯å±‚ä¹‹åä½¿ç”¨çš„æ˜¯ä¸€ä¸ªå¸¸è§„çš„æŠ€æœ¯å«åš**æ‰¹é‡å½’ä¸€åŒ–**ã€‚

åœ¨â€æ‰¹é‡å½’ä¸€åŒ–â€œèƒŒåçš„æƒ³æ³•æ˜¯æ•°æ®å¹²å‡€çš„æ—¶å€™ç¥ç»ç½‘ç»œå·¥ä½œæ•ˆæœæœ€å¥½ã€‚ç†æƒ³æƒ…å†µä¸‹ï¼Œè¾“å…¥åˆ°å±‚çš„æ•°æ®çš„å‡å€¼æ˜¯ 0 å¹¶ä¸”æ²¡æœ‰å¤ªå¤šçš„åˆ†æ­§ã€‚ä»»ä½•åšè¿‡ä»»æ„æœºå™¨å­¦ä¹ çš„äººåº”è¯¥å¾ˆç†Ÿæ‚‰è¿™ä¸ªï¼Œå› ä¸ºæˆ‘ä»¬ç»å¸¸ä½¿ç”¨ä¸€ä¸ªå«åšâ€ç‰¹å¾ç¼©æ”¾â€œæˆ–è€…â€ç™½åŒ–â€œåœ¨æˆ‘ä»¬çš„è¾“å…¥æ•°æ®ä¸Šæ¥å®ç°è¿™ä¸€æ•ˆæœã€‚

æ‰¹é‡å½’ä¸€åŒ–åœ¨å±‚ä¸å±‚ä¹‹é—´å¯¹æ•°æ®åšäº†ä¸€ä¸ªç±»ä¼¼çš„ç‰¹å¾ç¼©æ”¾çš„å·¥ä½œã€‚è¿™ä¸ªæŠ€æœ¯è®©ç¥ç»ç½‘ç»œè¡¨ç°çš„æ›´å¥½å› ä¸ºå®ƒæš‚åœäº†æ•°æ®ç”±äºåœ¨ç½‘ç»œä¸­æµåŠ¨è€Œå¯¼è‡´çš„æ±¡æŸ“ã€‚

ä¸ºäº†è®©ä½ å¤§è‡´äº†è§£æ‰¹é‡å½’ä¸€çš„ä½œç”¨ï¼Œçœ‹ä¸€çœ‹ä¸‹é¢è¿™ä¸¤ä¸ªç›´æ–¹å›¾ï¼Œåˆ†åˆ«æ˜¯ç¬¬ä¸€æ¬¡åº”ç”¨å·ç§¯å±‚åè¿›è¡Œå½’ä¸€åŒ–ä¸ä¸è¿›è¡Œå½’ä¸€åŒ–çš„ä¸åŒç»“æœã€‚
[![](http://machinethink.net/images/yolo/BatchNorm.png)](http://machinethink.net/images/yolo/BatchNorm@2x.png)

åœ¨è®­ç»ƒæ·±åº¦ç½‘ç»œçš„æ—¶å€™ï¼Œæ‰¹é‡å½’ä¸€åŒ–å¾ˆé‡è¦ï¼Œä½†æ˜¯æˆ‘ä»¬è¯å®åœ¨æ¨æ–­æ—¶å¯ä»¥ä¸ç”¨è¿™ä¸ªæ“ä½œã€‚è¿™æ ·æ•ˆæœä¸é”™ï¼Œå› ä¸ºä¸åšæ‰¹é‡å½’ä¸€åŒ–çš„è®¡ç®—ä¼šè®©æˆ‘ä»¬çš„ app æ›´å¿«ã€‚è€Œä¸”ä»»ä½•æƒ…å†µä¸‹ï¼ŒMetal éƒ½æ²¡æœ‰ä¸€ä¸ª `MPSCNNBatchNormalization` å±‚ã€‚

æ‰¹é‡å½’ä¸€åŒ–é€šå¸¸åœ¨å·ç§¯å±‚ä¹‹åï¼Œåœ¨æ¿€æ´»å‡½æ•°ï¼ˆåœ¨ YOLO ä¸­å«åšâ€æ³„éœ²â€œçš„ Relu ï¼‰ç”Ÿæ•ˆä¹‹å‰ã€‚æ—¢ç„¶å·ç§¯å’Œæ‰¹é‡ç»Ÿä¸€éƒ½æ˜¯å¯¹æ•°æ®çš„çº¿æ€§è½¬æ¢ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠæ‰¹é‡ç»Ÿä¸€å±‚çš„å‚æ•°å’Œå·ç§¯çš„æƒé‡ç»„å’Œåˆ°ä¸€èµ·ã€‚è¿™å«åšæŠŠæ‰¹é‡ç»Ÿä¸€å±‚â€æŠ˜å â€œåˆ°å·ç§¯å±‚ã€‚

é•¿è¯çŸ­è¯´ï¼Œé€šè¿‡ä¸€äº›æ•°å­¦è¿ç®—ï¼Œæˆ‘ä»¬å¯ä»¥ç§»é™¤æ‰¹é‡å½’ä¸€å±‚ï¼Œä½†æ˜¯å¹¶ä¸æ„å‘³ç€æˆ‘ä»¬åœ¨å·ç§¯å±‚ä¹‹å‰å¿…é¡»å»æ”¹å˜æƒé‡ã€‚

å…³äºå·ç§¯å±‚è®¡ç®—å†…å®¹çš„å¿«é€Ÿæ€»ç»“ï¼šå¦‚æœ `x` æ˜¯è¾“å…¥å›¾åƒçš„åƒç´ ï¼Œ`w` æ˜¯è¿™å±‚çš„æƒé‡ï¼Œå·ç§¯æ ¹æœ¬ä¸Šæ¥è¯´å°±æ˜¯æŒ‰ä¸‹é¢çš„æ–¹å¼è®¡ç®—æ¯ä¸ªè¾“å‡ºåƒç´ ï¼š

```
out[j] = x[i]*w[0] + x[i+1]*w[1] + x[i+2]*w[2] + ... + x[i+k]*w[k] + b

```

è¿™æ˜¯è¾“å…¥åƒç´ å’Œå·ç§¯æƒé‡ç‚¹ç§¯å’ŒåŠ ä¸Šä¸€ä¸ªåç½®å€¼ `b`ï¼Œ

ä¸‹é¢è¿™æ˜¯æ‰¹é‡å½’ä¸€åŒ–å¯¹ä¸Šè¿°å·ç§¯è¾“å‡ºç»“æœè¿›è¡Œçš„è®¡ç®—æ“ä½œï¼š

```
        gamma * (out[j] - mean)
bn[j] = ---------------------- + beta
            sqrt(variance)

```

å®ƒå…ˆå‡å»äº†è¾“å‡ºåƒç´ çš„å¹³å‡å€¼ï¼Œé™¤ä»¥æ–¹å·®ï¼Œå†ä¹˜ä»¥ä¸€ä¸ªç¼©æ”¾å‚æ•° gammaï¼Œç„¶ååŠ ä¸Šåç§»é‡ betaã€‚è¿™å››ä¸ªå‚æ•° â€” `mean`ï¼Œ`variance`ï¼Œ `gamma`ï¼Œå’Œ `beta`ã€‚- æ­£æ˜¯æ‰¹é‡ç»Ÿä¸€å±‚éšç€ç½‘ç»œè®­ç»ƒä¹‹åå­¦åˆ°çš„å†…å®¹ã€‚

ä¸ºäº†ç§»é™¤æ‰¹é‡å½’ä¸€åŒ–ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠè¿™ä¸¤ä¸ªç­‰å¼è°ƒæ•´ä¸€ä¸‹æ¥ç»™å·ç§¯å±‚è®¡ç®—æ–°çš„æƒé‡å’Œåç½®é‡ï¼š

```
           gamma * w
w_new = --------------
        sqrt(variance)

        gamma*(b - mean)
b_new = ---------------- + beta
         sqrt(variance)

```

ç”¨è¿™ä¸ªåŸºäºè¾“å…¥ `x` çš„æ–°æƒé‡å’Œåç½®é¡¹æ¥è¿›è¡Œå·ç§¯æ“ä½œä¼šå¾—åˆ°å’Œä¹‹å‰å·ç§¯åŠ ä¸Šæ‰¹é‡å½’ä¸€åŒ–ä¸€æ ·çš„ç»“æœã€‚

ç°åœ¨æˆ‘ä»¬å¯ä»¥ç§»é™¤æ‰¹é‡å½’ä¸€åŒ–å±‚åªç”¨å·ç§¯å±‚äº†ï¼Œä½†æ˜¯ç”±äºè°ƒæ•´äº†æƒé‡å’Œæ–°çš„åç½®é¡¹ `w_new` å’Œ `b_new` ã€‚æˆ‘ä»¬è¦å¯¹ç½‘ç»œä¸­æ‰€æœ‰çš„å·ç§¯å±‚éƒ½é‡å¤è¿™ä¸ªæ“ä½œã€‚

**æ³¨æ„ï¼š** å®é™…ä¸Šåœ¨ YOLO ä¸­ï¼Œå·ç§¯å±‚å¹¶æ²¡æœ‰ä½¿ç”¨åç½®é‡ï¼Œæ‰€ä»¥ `b` åœ¨ä¸Šé¢çš„ç­‰å¼ä¸­å§‹ç»ˆæ˜¯ 0 ã€‚ä½†æ˜¯è¯·æ³¨æ„åœ¨æŠ˜å æ‰¹é‡å½’ä¸€åŒ–å‚æ•°çš„ä¹‹åï¼Œå·ç§¯å±‚**çœŸ**å¾—åˆ°äº†ä¸€ä¸ªåç½®é¡¹ã€‚

ä¸€æ—¦æˆ‘ä»¬æŠŠæ‰€æœ‰çš„æ‰¹é‡å½’ä¸€åŒ–å±‚éƒ½æŠ˜å åˆ°å®ƒä»¬çš„ä¹‹å‰å·ç§¯å±‚ä¸­æ—¶ï¼Œæˆ‘ä»¬å°±å¯ä»¥æŠŠæƒé‡è½¬æ¢åˆ° Metal äº†ã€‚è¿™æ˜¯ä¸€ä¸ªå¾ˆç®€å•çš„æ•°ç»„è½¬æ¢ï¼ˆKeras ä¸ Metal ç›¸æ¯”æ˜¯ç”¨ä¸åŒçš„é¡ºåºæ¥å­˜å‚¨ï¼‰ï¼Œç„¶åæŠŠå®ƒä»¬å†™å…¥åˆ°ä¸€ä¸ª 32 ä½æµ®ç‚¹æ•°çš„äºŒè¿›åˆ¶æ–‡ä»¶ä¸­ã€‚

å¦‚æœä½ å¥½å¥‡çš„è¯ï¼Œçœ‹ä¸‹è¿™ä¸ªè½¬æ¢è„šæœ¬ [yolo2metal.py](https://github.com/hollance/Forge/blob/master/Examples/YOLO/yolo2metal.py) å¯ä»¥äº†è§£æ›´å¤šã€‚ä¸ºäº†æµ‹è¯•è¿™ä¸ªæŠ˜å å·¥ä½œï¼Œè¿™ä¸ªè„šæœ¬ç”Ÿæˆäº†ä¸€ä¸ªæ–°çš„æ¨¡å‹ï¼Œè¿™ä¸ªæ¨¡å‹æ²¡æœ‰æ‰¹é‡å½’ä¸€åŒ–å±‚è€Œæ˜¯ç”¨äº†è°ƒæ•´ä¹‹åçš„æƒé‡ï¼Œç„¶åå’Œä¹‹å‰çš„æ¨¡å‹çš„æ¨æµ‹è¿›è¡Œä¸€ä¸ªæ¯”è¾ƒã€‚

## iOS åº”ç”¨ ##

æ¯‹åº¸ç½®ç–‘åœ°ï¼Œæˆ‘ç”¨äº† [Forge](https://github.com/hollance/Forge) æ¥æ„å»º iOS åº”ç”¨ã€‚
 ğŸ˜‚ ä½ å¯ä»¥åœ¨ [YOLO](https://github.com/hollance/Forge/tree/master/Examples/YOLO) çš„æ–‡ä»¶å¤¹ä¸­æ‰¾åˆ°ä»£ç ã€‚æƒ³è¯•çš„è¯ï¼šä¸‹è½½æˆ–è€… clone Forgeï¼Œåœ¨ Xcode 8.3 æˆ–è€…æ›´æ–°çš„ç‰ˆæœ¬ä¸­æ‰“å¼€ **Forge.xcworkspace** ï¼Œç„¶ååœ¨ iPhone 6 æˆ–è€…æ›´é«˜ç‰ˆæœ¬çš„æ‰‹æœºä¸Šè¿è¡Œ **YOLO** è¿™ä¸ª target ã€‚

æµ‹è¯•è¿™ä¸ªåº”ç”¨çš„æœ€ç®€å•çš„æ–¹æ³•æ˜¯æŠŠä½ çš„ iPhone å¯¹å‡†è¿™äº› [YouTube è§†é¢‘](https://www.youtube.com/watch?v=e_WBuBqS9h8)ä¸Š:

[![ç®€å•çš„åº”ç”¨](http://machinethink.net/images/yolo/App.png)](http://machinethink.net/images/yolo/App@2x.png)

æœ‰è¶£çš„ä»£ç æ˜¯åœ¨ **YOLO.swift** ä¸­ã€‚é¦–å…ˆå®ƒåˆå§‹åŒ–äº†å·ç§¯ç½‘ç»œï¼š

```
let leaky = MPSCNNNeuronReLU(device: device, a: 0.1)

let input = Input()

let output = input
         --> Resize(width: 416, height: 416)
         --> Convolution(kernel: (3, 3), channels: 16, padding: true, activation: leaky, name: "conv1")
         --> MaxPooling(kernel: (2, 2), stride: (2, 2))
         --> Convolution(kernel: (3, 3), channels: 32, padding: true, activation: leaky, name: "conv2")
         --> MaxPooling(kernel: (2, 2), stride: (2, 2))
         --> ...and so on...

```

å…ˆæŠŠæ¥è‡ªæ‘„åƒå¤´çš„è¾“å…¥ç¼©æ”¾è‡³ 416x416 åƒç´ ï¼Œç„¶åè¾“å…¥åˆ°å·ç§¯å’Œæœ€å¤§æ± åŒ–å±‚ä¸­ã€‚è¿™å’Œå…¶ä»–çš„è½¬æ¢æ“ä½œéƒ½éå¸¸ç›¸ä¼¼ã€‚

æœ‰è¶£çš„æ˜¯åœ¨è¾“å‡ºä¹‹åçš„æ“ä½œã€‚å›æƒ³ä¸€ä¸‹è¾“å‡ºçš„è½¬æ¢ä¹‹åæ˜¯ä¸€ä¸ª 13x13x125 çš„å¼ é‡ï¼šå›¾ç‰‡ä¸­çš„æ¯ä¸ªç½‘æ ¼çš„å•å…ƒéƒ½æœ‰ 125 ä¸ªé€šé“çš„æ•°æ®ã€‚è¿™ 125 æ•°æ®åŒ…å«äº†è¾¹ç•Œæ¡†å’Œç±»å‹çš„é¢„æµ‹ï¼Œç„¶åæˆ‘ä»¬éœ€è¦ä»¥æŸç§æ–¹å¼æŠŠè¾“å‡ºæ’åºã€‚è¿™äº›éƒ½åœ¨å‡½æ•° `fetchResult()` ä¸­è¿›è¡Œã€‚

**æ³¨æ„ï¼š** `fetchResult()` ä¸­çš„ä»£ç æ˜¯åœ¨ CPU ä¸­æ‰§è¡Œçš„ï¼Œä¸æ˜¯åœ¨ GPU ä¸­ã€‚è¿™æ ·çš„æ–¹å¼æ›´å®¹æ˜“å®ç°ã€‚è¯å¥è¯è¯´ï¼Œè¿™ä¸ªåµŒå¥—çš„å¾ªç¯åœ¨ GPU ä¸­å¹¶è¡Œæ‰§è¡Œå¯èƒ½æ•ˆæœä¼šæ›´å¥½ã€‚æœªæ¥æˆ‘ä¹Ÿè®¸ä¼šç ”ç©¶è¿™ä¸ªï¼Œç„¶åå†å†™ä¸€ä¸ª GPU çš„ç‰ˆæœ¬ã€‚


ä¸‹é¢ä»‹ç»äº† fetchResult() æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼š 

```
public func fetchResult(inflightIndex: Int) -> NeuralNetworkResult<Prediction> {
  let featuresImage = model.outputImage(inflightIndex: inflightIndex)
  let features = featuresImage.toFloatArray()

```

åœ¨å·ç§¯å±‚çš„è¾“å‡ºæ˜¯ä»¥ `MPSImage` çš„æ ¼å¼çš„ã€‚æˆ‘ä»¬å…ˆæŠŠå®ƒè½¬æ¢åˆ°ä¸€ä¸ªå«åš features çš„ Float å€¼ç±»å‹çš„æ•°ç»„ï¼Œä»¥ä¾¿æˆ‘ä»¬æ›´å¥½çš„ä½¿ç”¨å®ƒã€‚

`fetchResult()` çš„ä¸»ä½“æ˜¯ä¸€ä¸ªå¤§çš„åµŒå¥—å¾ªç¯ã€‚å®ƒåŒ…å«äº†æ‰€æœ‰çš„ç½‘æ ¼å•å…ƒå’Œæ¯ä¸ªå•å…ƒçš„äº”æ¬¡é¢„æµ‹ï¼š

```
for cy in0..<13 {
    for cx in0..<13 {
      for b in0..<5 {
         . . .
      }
    }
  }

```

åœ¨è¿™ä¸ªå¾ªç¯é‡Œé¢ï¼Œæˆ‘ä»¬ç»™ç½‘æ ¼å•å…ƒ `(cy, cx)` è®¡ç®—äº†è¾¹ç•Œæ¡† `b` ã€‚ 

é¦–å…ˆæˆ‘ä»¬ä» `features` æ•°ç»„ä¸­è¯»å–è¾¹ç•Œæ¡†çš„ xï¼Œ yï¼Œ width å’Œ height ï¼Œä¹ŸåŒ…æ‹¬ç¡®ä¿¡å€¼ã€‚

```
let channel = b*(numClasses + 5)
let tx = features[offset(channel, cx, cy)]
let ty = features[offset(channel + 1, cx, cy)]
let tw = features[offset(channel + 2, cx, cy)]
let th = features[offset(channel + 3, cx, cy)]
let tc = features[offset(channel + 4, cx, cy)]

```


å¸®åŠ©å‡½æ•° `offset()` ç”¨æ¥å®šä½æ•°ç»„ä¸­åˆé€‚çš„è¯»å–ä½ç½®ã€‚Metal ä»¥æ¯æ¬¡ 4 ä¸ªé€šé“ä¸€ç»„æ¥æŠŠæ•°æ®å­˜åœ¨çº¹ç†ç‰‡ä¸­ï¼Œè¿™æ„å‘³ç€ 125 ä¸ªé€šé“ä¸æ˜¯è¿ç»­å­˜å‚¨ï¼Œè€Œæ˜¯åˆ†æ•£å­˜å‚¨çš„ã€‚ï¼ˆæƒ³æ·±å…¥åˆ†æçš„è¯å¯ä»¥å»çœ‹æºç ï¼‰ã€‚

æˆ‘ä»¬ä»ç„¶éœ€è¦å¤„ç† `tx`ï¼Œ `ty`ï¼Œ `tw`ï¼Œ `th`ï¼Œ `tc` è¿™äº”ä¸ªå‚æ•° ï¼Œå› ä¸ºå®ƒä»¬çš„æ ¼å¼æœ‰ç‚¹å¥‡æ€ªã€‚å¦‚æœä½ ä¸çŸ¥é“è¿™äº›å¤„ç†æ–¹æ³•å“ªæ¥çš„è¯ï¼Œå¯ä»¥çœ‹ä¸‹è¿™ç¯‡[è®ºæ–‡](https://arxiv.org/abs/1612.08242) (è¿™æ˜¯è®­ç»ƒè¿™ä¸ªç¥ç»ç½‘ç»œçš„é™„åŠ äº§ç‰©ä¹‹ä¸€)ã€‚
>è¯‘è€…æ³¨ï¼šè¿™ç¯‡è®ºæ–‡å°±æ˜¯ YOLO çš„ä½œè€…å†™çš„ã€‚ä½œè€…åœ¨è®­ç»ƒçš„è¿‡ç¨‹ä¸­å½¢æˆäº†è¿™ç¯‡è®ºæ–‡ï¼Œå¹¶ä½œä¸ºè®­ç»ƒè¿‡ç¨‹çš„ä¸€ä¸ªæ›´è¯¦ç»†çš„æè¿°ã€‚

```
llet x = (Float(cx) + Math.sigmoid(tx)) * 32
let y = (Float(cy) + Math.sigmoid(ty)) * 32

let w = exp(tw) * anchors[2*b    ] * 32
let h = exp(th) * anchors[2*b + 1] * 32

let confidence = Math.sigmoid(tc)

```

ç°åœ¨ `x` å’Œ `y` ä»£è¡¨äº†åœ¨æˆ‘ä»¬ä½¿ç”¨çš„è¾“å…¥åˆ°ç¥ç»ç½‘ç»œçš„ 416x416 çš„å›¾åƒä¸­è¾¹ç•Œæ¡†çš„ä¸­å¿ƒï¼›
`w` å’Œ `h` åˆ™æ˜¯ä¸Šè¿°å›¾åƒç©ºé—´ä¸­è¾¹ç•Œæ¡†çš„å®½åº¦å’Œé«˜åº¦ã€‚è¾¹ç•Œæ¡†çš„ç¡®ä¿¡å€¼æ˜¯ `tc` ï¼Œæˆ‘ä»¬é€šè¿‡ sigmoid å‡½æ•°æŠŠå®ƒè½¬æ¢åˆ°ç™¾åˆ†æ¯”ã€‚

ç°åœ¨æˆ‘ä»¬æœ‰äº†æˆ‘ä»¬çš„è¾¹ç•Œæ¡†ï¼Œå¹¶ä¸”æˆ‘ä»¬çŸ¥é“äº† YOLO å¯¹è¿™ä¸ªæ¡†ä¸­æ˜¯å¦åŒ…å«ç€æŸä¸ªå¯¹è±¡çš„ç¡®ä¿¡åº¦ã€‚æ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬çœ‹ä¸‹ç±»å‹é¢„æµ‹ï¼Œæ¥çœ‹çœ‹ YOLO è®¤ä¸ºæ¡†ä¸­åˆ°åº•æ˜¯ä¸ªä»€ä¹ˆç±»å‹çš„ç‰©ä½“ï¼š

```
var classes = [Float](repeating: 0, count: numClasses)
for c in 0..< numClasses {
  classes[c] = features[offset(channel + 5 + c, cx, cy)]
}
classes = Math.softmax(classes)

let (detectedClass, bestClassScore) = classes.argmax()

```

é‡æ–°è°ƒç”¨ `features` æ•°ç»„ä¸­åŒ…å«ç€å¯¹è¾¹ç•Œæ¡†ä¸­ç‰©ä½“é¢„æµ‹çš„ 20 ä¸ªé€šé“ã€‚æˆ‘ä»¬è¯»å–åˆ°ä¸€ä¸ªæ–°çš„æ•°ç»„ `classes` ä¸­ã€‚å› ä¸ºæ˜¯ç”¨æ¥åšåˆ†ç±»å™¨çš„ï¼Œæˆ‘ä»¬é€šè¿‡ softmax æŠŠè¿™ä¸ªæ•°ç»„è½¬æ¢æˆå¯èƒ½çš„åˆ†é…æƒ…å†µï¼Œç„¶åæˆ‘ä»¬é€‰æ‹©æœ€é«˜åˆ†æ•°çš„ç±»ä½œä¸ºæœ€åçš„èƒœè€…ã€‚

ç°åœ¨æˆ‘ä»¬å¯ä»¥è®¡ç®—è¾¹ç•Œæ¡†çš„æœ€ç»ˆåˆ†æ•°äº† - ä¸¾ä¸ªä¾‹å­ï¼Œâ€œè¿™ä¸ªè¾¹ç•Œæ¡†æœ‰ 85% çš„æ¦‚ç‡åŒ…å«ä¸€æ¡ç‹—â€ã€‚ç”±äºä¸€å…±æœ‰ 845 ä¸ªè¾¹ç•Œæ¡†ï¼Œè€Œæˆ‘ä»¬åªæƒ³è¦é‚£äº›åˆ†æ•°é«˜äºæŸä¸ªå€¼çš„è¾¹ç•Œæ¡†ã€‚

```
let confidenceInClass = bestClassScore * confidence
if confidenceInClass > 0.3 {
  let rect = CGRect(x: CGFloat(x - w/2), y: CGFloat(y - h/2),
                    width: CGFloat(w), height: CGFloat(h))

  let prediction = Prediction(classIndex: detectedClass,
                              score: confidenceInClass,
                              rect: rect)
  predictions.append(prediction)
}

```

ä¸Šé¢çš„ä»£ç æ˜¯å¯¹ç½‘æ ¼å†…çš„æ¯ä¸ªå•å…ƒè¿›è¡Œå¾ªç¯ã€‚å½“å¾ªç¯ç»“æŸåï¼Œæˆ‘ä»¬é€šå¸¸ä¼šæœ‰äº†ä¸€ä¸ªåŒ…å«äº† 10 åˆ° 20 ä¸ªé¢„æµ‹ `predictions` æ•°ç»„ã€‚

æˆ‘ä»¬å·²ç»è¿‡æ»¤æ‰äº†é‚£äº›ä½åˆ†æ•°çš„è¾¹ç•Œæ¡†ï¼Œä½†æ˜¯ä»ç„¶æœ‰äº›æ¡†çš„å’Œå…¶ä»–çš„æ¡†æœ‰è¾ƒå¤šçš„é‡å ã€‚å› æ­¤ï¼Œåœ¨æœ€åä¸€æ­¥æˆ‘ä»¬éœ€è¦åœ¨ `fetchResult()` é‡Œé¢åšçš„äº‹å«åš *éæå¤§æŠ‘åˆ¶* ï¼Œç”¨æ¥å»æ‰é‚£äº›é‡å¤çš„æ¡†ã€‚

```
var result = NeuralNetworkResult<Prediction>()
  result.predictions = nonMaxSuppression(boxes: predictions,
                                         limit: 10, threshold: 0.5)
  return result
}

```

`nonMaxSuppression()` å‡½æ•°ä½¿ç”¨çš„ç®—æ³•å¾ˆç®€å•ï¼š

1. ä»é‚£ä¸ªæœ€é«˜åˆ†çš„è¾¹ç•Œæ¡†å¼€å§‹ã€‚
2. ç§»é™¤å‰©ä¸‹æ‰€æœ‰ä¸å®ƒé‡å éƒ¨åˆ†å¤§äºæœ€å°å€¼çš„è¾¹ç•Œæ¡†ï¼ˆæ¯”å¦‚ å¤§äº 50%ï¼‰ã€‚
3. å›åˆ°ç¬¬ä¸€æ­¥ç›´åˆ°æ²¡æœ‰æ›´å¤šçš„è¾¹ç•Œæ¡†ã€‚

è¿™ä¼šç§»é™¤é‚£äº›æœ‰é«˜åˆ†æ•°ä½†æ˜¯å’Œå…¶ä»–æ¡†æœ‰å¤ªå¤šé‡å¤éƒ¨åˆ†çš„æ¡†ã€‚åªä¼šä¿ç•™æœ€å¥½çš„é‚£äº›æ¡†ã€‚

ä¸Šé¢è¿™äº›å·®ä¸å¤šå°±æ˜¯è¿™ä¸ªæ„æ€ï¼šä¸€ä¸ªå¸¸è§„çš„å·ç§¯ç½‘ç»œåŠ ä¸Šå¯¹ç»“æœçš„ä¸€ç³»åˆ—å¤„ç†ã€‚


## å®ƒè¡¨ç°çš„æ•ˆæœæ€ä¹ˆæ ·ï¼Ÿ ##

[YOLO ç½‘ç«™](https://pjreddie.com/darknet/yolo/)å£°ç§°è¿·ä½ ç‰ˆæœ¬çš„ YOLO å¯ä»¥å®ç° 200 å¸§æ¯ç§’ã€‚ä½†æ˜¯å½“ç„¶è¿™æ˜¯åœ¨ä¸€ä¸ªæ¡Œé¢çº§çš„ GPU ä¸Šï¼Œä¸æ˜¯åœ¨ç§»åŠ¨è®¾å¤‡ä¸Šã€‚æ‰€ä»¥åœ¨ iPhone ä¸Šå®ƒèƒ½è·‘å¤šå¿«å‘¢ï¼Ÿ

åœ¨æˆ‘çš„ iPhone 6s ä¸Šé¢å¤„ç†ä¸€å¼ å›¾ç‰‡å¤§çº¦éœ€è¦ **0.15 ç§’** ã€‚å¸§ç‡åªæœ‰ 6 ï¼Œè¿™å¸§ç‡åŸºæœ¬æ»¡è¶³å®æ—¶çš„è°ƒç”¨ã€‚å¦‚æœä½ æŠŠä½ çš„æ‰‹æœºå¯¹ç€å¼€è¿‡çš„æ±½è½¦ï¼Œä½ å¯ä»¥çœ‹åˆ°æœ‰ä¸ªè¾¹ç•Œæ¡†åœ¨è½¦å­åé¢ä¸è¿œçš„åœ°æ–¹è·Ÿç€å®ƒã€‚å°½ç®¡å¦‚æ­¤ï¼Œæˆ‘è¿˜æ˜¯è¢«è¿™ä¸ªæŠ€æœ¯æ·±æ·±çš„éœ‡æƒŠäº†ã€‚ ğŸ˜

**æ³¨æ„ï¼š** æ­£å¦‚æˆ‘ä¸Šé¢æ‰€è§£é‡Šçš„ï¼Œè¾¹ç•Œæ¡†çš„å¤„ç†æ˜¯åœ¨ CPU è€Œä¸æ˜¯ GPU ä¸Šçš„ã€‚å¦‚æœå®Œå…¨åœ¨ GPU ä¸Šè¿è¡Œæ˜¯ä¸æ˜¯ä¼šæ›´å¿«å‘¢ï¼Ÿå¯èƒ½ï¼Œä½†æ˜¯ CPU çš„ä»£ç åªç”¨äº† 0.03 ç§’ï¼Œ 20% çš„è¿è¡Œæ—¶é—´ã€‚åœ¨ GPU ä¸Šå¤„ç†ä¸€éƒ¨åˆ†çš„å·¥ä½œæ˜¯å¯è¡Œçš„ï¼Œä½†æ˜¯æˆ‘ä¸ç¡®å®šè¿™æ ·æ˜¯å¦å€¼å¾—ï¼Œå› ä¸ºè½¬æ¢å±‚ä»ç„¶å ç”¨äº† 80% çš„æ—¶é—´ã€‚

æˆ‘è®¤ä¸ºæ…¢çš„ä¸»è¦åŸå› ä¹‹ä¸€æ˜¯ç”±äºå·ç§¯å±‚åŒ…å«äº† 512 å’Œ 1024 ä¸ªè¾“å‡ºé€šé“ã€‚åœ¨æˆ‘çš„å®éªŒä¸­ï¼Œä¼¼ä¹ `MPSCNNConvolution` åœ¨å¤„ç†å¤šé€šé“çš„å°å›¾ç‰‡æ¯”å°‘é€šé“çš„å¤§å›¾ç‰‡æ—¶æ›´åƒåŠ›ã€‚

ä¸€ä¸ªè®©æˆ‘æƒ³å»å°è¯•çš„æ˜¯é‡‡ç”¨ä¸åŒçš„ç½‘ç»œæ„å»ºæ–¹å¼ï¼Œæ¯”å¦‚ SqueezeNet ï¼Œç„¶åé‡æ–°è®­ç»ƒç½‘ç»œæ¥åœ¨æœ€åä¸€å±‚è¿›è¡Œè¾¹ç•Œæ¡†çš„é¢„æµ‹ã€‚æ¢å¥è¯è¯´ï¼Œé‡‡ç”¨ YOLO çš„æƒ³æ³•å¹¶å°†å®ƒåœ¨ä¸€ä¸ªæ›´å°æ›´å¿«çš„è½¬æ¢ä¹‹ä¸Šå®ç°ã€‚ç”¨å‡†ç¡®åº¦çš„ä¸‹é™æ¥æ¢å–é€Ÿåº¦çš„æå‡çš„åšæ³•æ˜¯å¦å€¼å¾—å‘¢ï¼Ÿ

**æ³¨æ„ï¼š** å¦å¤–ï¼Œæœ€è¿‘å‘å¸ƒçš„ [Caffe2](http://caffe2.ai/) æ¡†æ¶åŒæ ·æ˜¯é€šè¿‡ Metal æ¥å®ç°åœ¨ iOS ä¸Šè¿è¡Œçš„ã€‚[Caffe2-iOS é¡¹ç›®](https://github.com/KleinYuan/Caffe2-iOS)æ¥è‡ªäºè¿·ä½  YOLO çš„ä¸€ä¸ªç‰ˆæœ¬ã€‚å®ƒä¼¼ä¹æ¯”çº¯ Metal ç‰ˆæœ¬è¿è¡Œçš„æ…¢ 0.17 ç§’æ¯å¸§ã€‚


## é¸£è°¢ ##

æƒ³äº†è§£æ›´å¤šå…³äº YOLO çš„ä¿¡æ¯ï¼Œçœ‹ä¸‹ä»¥ä¸‹ç”±å®ƒçš„ä½œè€…ä»¬å†™çš„è®ºæ–‡å§ï¼š

- [You Only Look Once: Unified, Real-Time Object Detection](https://arxiv.org/abs/1506.02640) by Joseph Redmon, Santosh Divvala, Ross Girshick, Ali Farhadi (2015)
- [YOLO9000: Better, Faster, Stronger](https://arxiv.org/abs/1612.08242) by Joseph Redmon and Ali Farhadi (2016)

æˆ‘çš„å®ç°æ˜¯éƒ¨åˆ†åŸºäº TensorFlow çš„ Android demo [TF Detect](https://github.com/tensorflow/tensorflow/tree/master/tensorflow/examples/android)ï¼Œ Allan Zelener çš„[YAD2K](https://github.com/allanzelener/YAD2K/), å’Œ [Darknetçš„æºç ](https://github.com/pjreddie/darknet)ã€‚

---

> [æ˜é‡‘ç¿»è¯‘è®¡åˆ’](https://github.com/xitu/gold-miner) æ˜¯ä¸€ä¸ªç¿»è¯‘ä¼˜è´¨äº’è”ç½‘æŠ€æœ¯æ–‡ç« çš„ç¤¾åŒºï¼Œæ–‡ç« æ¥æºä¸º [æ˜é‡‘](https://juejin.im) ä¸Šçš„è‹±æ–‡åˆ†äº«æ–‡ç« ã€‚å†…å®¹è¦†ç›– [Android](https://github.com/xitu/gold-miner#android)ã€[iOS](https://github.com/xitu/gold-miner#ios)ã€[React](https://github.com/xitu/gold-miner#react)ã€[å‰ç«¯](https://github.com/xitu/gold-miner#å‰ç«¯)ã€[åç«¯](https://github.com/xitu/gold-miner#åç«¯)ã€[äº§å“](https://github.com/xitu/gold-miner#äº§å“)ã€[è®¾è®¡](https://github.com/xitu/gold-miner#è®¾è®¡) ç­‰é¢†åŸŸï¼Œæƒ³è¦æŸ¥çœ‹æ›´å¤šä¼˜è´¨è¯‘æ–‡è¯·æŒç»­å…³æ³¨ [æ˜é‡‘ç¿»è¯‘è®¡åˆ’](https://github.com/xitu/gold-miner)ã€‚
