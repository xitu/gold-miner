> * åŸæ–‡åœ°å€ï¼š[Performance-tuning a React application](https://codeburst.io/performance-tuning-a-react-application-f480f46dc1a2)
> * åŸæ–‡ä½œè€…ï¼š[Joshua Comeau](https://codeburst.io/@joshuawcomeau?source=post_header_lockup)
> * è¯‘æ–‡å‡ºè‡ªï¼š[æ˜é‡‘ç¿»è¯‘è®¡åˆ’](https://github.com/xitu/gold-miner)
> * æœ¬æ–‡æ°¸ä¹…é“¾æ¥ï¼š[https://github.com/xitu/gold-miner/blob/master/TODO/performance-tuning-a-react-application.md](https://github.com/xitu/gold-miner/blob/master/TODO/performance-tuning-a-react-application.md)
> * è¯‘è€…ï¼š[ZhangFe](https://github.com/ZhangFe)
> * æ ¡å¯¹è€…ï¼š[atuooo](https://github.com/atuooo), [jonjia](https://github.com/jonjia)

# React åº”ç”¨æ€§èƒ½è°ƒä¼˜

## æ¡ˆä¾‹ç ”ç©¶

æœ€è¿‘å‡ å‘¨ï¼Œæˆ‘ä¸€ç›´åœ¨ä¸º [**Tello**](https://tello.tv) å·¥ä½œï¼Œè¿™æ˜¯ä¸€ä¸ªè·Ÿè¸ªå’Œç®¡ç†ç”µè§†èŠ‚ç›®çš„ web appï¼š

![](https://cdn-images-1.medium.com/max/800/1*UfHV4_HWAK4I_yGl0wSq0Q.png)


ä½œä¸ºä¸€ä¸ª web app æ¥è¯´ï¼Œå®ƒçš„ä»£ç é‡æ˜¯éå¸¸å°çš„ï¼Œå¤§æ¦‚åªæœ‰ 10,000 è¡Œã€‚è¿™æ˜¯ä¸€ä¸ªåŸºäº Webpack çš„ React/Redux åº”ç”¨ï¼Œæœ‰ä¸€ä¸ªæ¯”è¾ƒè½»é‡çš„åç«¯ Node æœåŠ¡(åŸºäº Express å’Œ MongoDB)ã€‚æˆ‘ä»¬ 90% çš„ä»£ç éƒ½åœ¨å‰ç«¯ã€‚åœ¨ [**Github**](https://github.com/joshwcomeau/Tello) ä¸Šä½ å¯ä»¥çœ‹åˆ°æˆ‘ä»¬çš„æºç ã€‚

å‰ç«¯æ€§èƒ½å¯ä»¥ä»å¾ˆå¤šè§’åº¦æ¥è€ƒé‡ã€‚ä½†æ˜¯ä»å†å²è§’åº¦æ¥çœ‹ï¼Œæˆ‘æ›´æ³¨é‡äºé¡µé¢åŠ è½½åçš„ä¸€äº›ç‚¹ï¼šæ¯”å¦‚ç¡®ä¿æ»šåŠ¨çš„è¿è´¯æ€§ï¼Œä»¥åŠåŠ¨ç”»çš„æµç•…æ€§ã€‚

ç›¸æ¯”ä¹‹ä¸‹ï¼Œæˆ‘å¯¹äºé¡µé¢åŠ è½½æ—¶é—´çš„å…³æ³¨æ¯”è¾ƒå°‘ï¼Œè‡³å°‘åœ¨ä¸€äº›å°å‹é¡¹ç›®ä¸Šæ˜¯è¿™æ ·çš„ã€‚æ¯•ç«Ÿå®ƒå¹¶ä¸éœ€è¦ä¼ è¾“å¤ªå¤šçš„ä»£ç ï¼›å®ƒè‚¯å®šæ˜¯å¾ˆå¿«å°±èƒ½è¢«è®¿é—®å¹¶ä½¿ç”¨çš„ï¼Œå¯¹å§ï¼Ÿ

ç„¶è€Œï¼Œå½“æˆ‘åšäº†ä¸€äº›åŸºå‡†æµ‹è¯•åï¼Œæˆ‘æƒŠå¥‡åœ°å‘ç°æˆ‘è¿™ä¸ª 10k è¡Œä»£ç çš„å°åº”ç”¨åœ¨ 3G ç½‘ç»œä¸‹ç«Ÿå¦‚æ­¤çš„**æ…¢~~**ï¼Œå¤§çº¦ 5s åæ‰èƒ½æ˜¾ç¤ºä¸€äº›æœ‰æ„ä¹‰çš„å†…å®¹ï¼Œå¹¶ä¸”éœ€è¦ **15s** æ‰èƒ½è§£å†³æ‰€æœ‰çš„ç½‘ç»œè¯·æ±‚ã€‚

æˆ‘æ„è¯†åˆ°æˆ‘å¾—åœ¨è¿™ä¸ªé—®é¢˜ä¸ŠæŠ•å…¥ä¸€äº›æ—¶é—´å’Œç²¾åŠ›ã€‚å¦‚æœäººä»¬éœ€è¦ç›¯ç€ä¸€ä¸ªç©ºç™½çš„å±å¹•çœ‹ 5s çš„è¯ï¼Œé‚£æˆ‘çš„åŠ¨ç”»åšçš„å†æ¼‚äº®ä¹Ÿæ²¡ç”¨äº†ã€‚

æ€»è€Œè¨€ä¹‹ï¼Œæˆ‘åœ¨è¿™å‘¨æœ«å°è¯•äº† 6 ç§æŠ€æœ¯ï¼Œå¹¶ä¸”ç°åœ¨åªéœ€è¦ 2300ms å·¦å³å°±å¯ä»¥åœ¨é¡µé¢ä¸Šå±•ç¤ºä¸€äº›æœ‰æ„ä¹‰çš„å†…å®¹äº† â€”â€” å‡å°‘äº†å¤§çº¦ 50% çš„æ—¶é—´ï¼

è¿™ç¯‡åšå®¢æ˜¯æˆ‘å°è¯•çš„å…·ä½“æŠ€æœ¯çš„ç ”ç©¶æ¡ˆä¾‹ä»¥åŠä»–ä»¬çš„å·¥ä½œæƒ…å†µï¼Œæ›´å¹¿æ³›åœ°æ¥è¯´ï¼Œè¿™é‡Œè®°å½•äº†æˆ‘åœ¨è§£å†³é—®é¢˜æ—¶æ‰€å­¦åˆ°çš„çŸ¥è¯†ï¼Œä»¥åŠæˆ‘åœ¨æå‡ºè§£å†³æ–¹æ¡ˆæ—¶çš„ä¸€äº›æ€è·¯ã€‚

### æ–¹æ³•è®º

æ‰€æœ‰çš„åˆ†æéƒ½ä½¿ç”¨äº†ç›¸åŒçš„è®¾ç½®ï¼š

*   â€œFast 3Gâ€ çš„ç½‘é€Ÿã€‚
*   æ¡Œé¢ç«¯åˆ†è¾¨ç‡ã€‚
*   ç¦æ­¢ HTTP ç¼“å­˜ã€‚
*   å·²ç™»å½•ï¼Œå¹¶ä¸”è¿™ä¸ªè´¦æˆ·å…³æ³¨äº† 16 ä¸ªç”µè§†èŠ‚ç›®ã€‚

### åŸºå‡†å€¼

æˆ‘ä»¬éœ€è¦ä¸€ä¸ªå¯ä»¥ç”¨æ¥æ¯”è¾ƒç»“æœçš„åŸºå‡†å€¼ï¼

æˆ‘ä»¬æµ‹è¯•çš„é¡µé¢æ˜¯ä¸»ç™»å½•é¡µçš„æ‘˜è¦è§†å›¾ï¼Œè¿™æ˜¯æ•°æ®é‡æœ€å¤§çš„é¡µé¢ï¼Œå› æ­¤å®ƒä¹Ÿæœ‰æœ€å¤§çš„ä¼˜åŒ–ç©ºé—´

è¿™ä¸ªæ‘˜è¦éƒ¨åˆ†å°±åƒä¸‹é¢è¿™æ ·åŒ…å«äº†ä¸€ç»„å¡ç‰‡ï¼š

![](https://cdn-images-1.medium.com/max/800/1*cag88WlFXxx_I452R5PEUA.png)

æ¯ä¸ªèŠ‚ç›®éƒ½æœ‰è‡ªå·±çš„å¡ç‰‡ï¼Œå¹¶ä¸”æ¯ä¸€é›†éƒ½æœ‰è‡ªå·±çš„ä¸€ä¸ªå°æ–¹å—ï¼Œè“è‰²çš„æ–¹å—æ„å‘³ç€è¿™ä¸€é›†å·²ç»è¢«è§‚çœ‹äº†ã€‚

è¿™æ˜¯æˆ‘ä»¬åœ¨ 3G ç½‘ç»œä¸‹åšåŸºå‡†æµ‹è¯•çš„ profile è§†å›¾ï¼Œçœ‹èµ·æ¥æ€§èƒ½å°±ä¸æ€ä¹ˆæ ·ã€‚

![](https://cdn-images-1.medium.com/max/800/1*116YOrGo-_hRvGUjMCieSA.png)

é¦–æ¬¡æœ‰æ•ˆæ¸²æŸ“ï¼š~5000ms
é¦–å¼ å›¾ç‰‡åŠ è½½ï¼š~6500ms
æ‰€æœ‰è¯·æ±‚ç»“æŸï¼š>15,000ms

å¤©å“ªï¼Œç›´åˆ° 5s å·¦å³é¡µé¢æ‰å±•ç¤ºäº†ä¸€äº›æœ‰æ„ä¹‰çš„å†…å®¹ã€‚ç¬¬ä¸€å¼ å›¾ç‰‡åœ¨ 6.5s å·¦å³çš„æ—¶å€™åŠ è½½å®Œæˆï¼Œæ‰€æœ‰çš„ç½‘ç»œè¯·æ±‚è¶³è¶³èŠ±äº† 15s æ‰ç»“æŸã€‚

è¿™ä¸ªæ—¶é—´çº¿è§†å›¾æä¾›äº†ä¸€ç³»åˆ—çš„å†…å®¹ã€‚è®©æˆ‘ä»¬ä»”ç»†ç ”ç©¶ä¸€ä¸‹è¿™ä¹‹é—´ç©¶ç«Ÿå‘ç”Ÿäº†ä»€ä¹ˆï¼š

1. é¦–å…ˆï¼Œæœ€åˆçš„ HTML è¢«åŠ è½½ã€‚å› ä¸ºæˆ‘ä»¬çš„åº”ç”¨ä¸æ˜¯æœåŠ¡ç«¯æ¸²æŸ“çš„ï¼Œè¿™éƒ¨åˆ†éå¸¸çš„å¿«ã€‚
2. ä¹‹åï¼Œå¼€å§‹ä¸‹è½½æ•´ä¸ª JS bundleã€‚è¿™éƒ¨åˆ†èŠ±è´¹äº†å¾ˆä¹…çš„æ—¶é—´ã€‚ğŸš©
3. JSä¸‹è½½å®Œåï¼ŒReact å¼€å§‹éå†ç»„ä»¶æ ‘ï¼Œè®¡ç®—åˆå§‹åŒ–æ—¶æŒ‚è½½çš„çŠ¶æ€ï¼Œå¹¶ä¸”å°†å®ƒæ¨é€åˆ° DOM ä¸Šã€‚è¿™éƒ¨åˆ†æœ‰ä¸€ä¸ª headerï¼Œä¸€ä¸ª footerï¼Œå’Œä¸€å¤§ç‰‡çš„é»‘è‰²åŒºåŸŸã€‚ğŸš©
4. æŒ‚è½½ DOM åï¼Œè¿™ä¸ªåº”ç”¨å‘ç°å®ƒè¿˜éœ€è¦ä¸€äº›æ•°æ®ï¼Œå› æ­¤å®ƒå‘ _/me_ å‘èµ·äº†ä¸€ä¸ª GET è¯·æ±‚æ¥è·å–ç”¨æˆ·æ•°æ®ï¼Œä»¥åŠä»–ä»¬å…³å¿ƒçš„èŠ‚ç›®åˆ—è¡¨å’Œçœ‹è¿‡çš„å‰§é›†ã€‚
5. ä¸€æ—¦æˆ‘ä»¬æ‹¿åˆ°äº†å…³é”®çš„èŠ‚ç›®åˆ—è¡¨ï¼Œå°±å¯ä»¥å¼€å§‹è¯·æ±‚ä¸‹é¢çš„å†…å®¹ï¼š
	- æ¯ä¸ªèŠ‚ç›®çš„å›¾ç‰‡
	- æ¯ä¸ªèŠ‚ç›®çš„å‰§é›†åˆ—è¡¨

è¿™äº›æ•°æ®éƒ½æ¥è‡ª TV Maze çš„ [**API**](https://www.tvmaze.com/api)ã€‚

> * ä½ å¯èƒ½ä¼šæƒ³ä¸ºä»€ä¹ˆæˆ‘ä¸åœ¨æˆ‘çš„æ•°æ®åº“é‡Œå­˜å‚¨è¿™äº›å‰§é›†ä¿¡æ¯å‘¢ï¼Œè¿™æ ·æˆ‘å°±ä¸éœ€è¦è°ƒç”¨ TV Maze çš„æ¥å£äº†ã€‚å…¶å®åŸå› ä¸»è¦æ˜¯ TV Maze çš„æ•°æ®æ›´åŠ çœŸå®ï¼›å®ƒæœ‰æ‰€æœ‰æ–°çš„å‰§é›†çš„ä¿¡æ¯ã€‚å½“ç„¶ï¼Œæˆ‘ä¹Ÿå¯ä»¥åœ¨ç¬¬å››æ­¥çš„æ—¶å€™åœ¨æœåŠ¡ç«¯ä¸Šæ‹‰å–è¿™äº›æ•°æ®ï¼Œå¯æ˜¯è¿™ä¼šå¢åŠ è¿™ä¸€æ­¥çš„å“åº”æ—¶é—´ï¼Œå¦‚æ­¤ä¸€æ¥ç”¨æˆ·å°±åªèƒ½ç›¯ç€ä¸€å¤§ç‰‡ç©ºç™½çš„é»‘è‰²åŒºåŸŸäº†ã€‚å¦å¤–ï¼Œæˆ‘å–œæ¬¢æ¯”è¾ƒè½»é‡çš„æœåŠ¡ç«¯ã€‚
> 
> è¿˜æœ‰ä¸€ä¸ªå¯è¡Œæ–¹æ³•å°±æ˜¯è®¾ç½®ä¸€ä¸ªå®šæ—¶ä»»åŠ¡ï¼Œæ¯å¤©éƒ½å»åŒæ­¥ TV Maze çš„æ•°æ®ï¼Œå¹¶ä¸”åªåœ¨æˆ‘æ²¡æœ‰æœ€æ–°æ•°æ®çš„æ—¶å€™æ‰ä¼šå»æ‹‰å–ã€‚ä¸è¿‡æˆ‘è¿˜æ˜¯å–œæ¬¢å®æ—¶çš„æ•°æ®ï¼Œå› æ­¤è¿™ä¸ªæ–¹æ¡ˆä¸€ç›´éƒ½æ²¡æœ‰å®æ–½ã€‚

### ä¸€æ¬¡æ˜æ˜¾çš„æå‡

ç›®å‰æ¥çœ‹ï¼Œæœ€å¤§çš„ç“¶é¢ˆå°±æ˜¯åˆå§‹çš„ JS bundle ä½“ç§¯å¤ªå¤§äº†ï¼Œä¸‹è½½å®ƒè€—è´¹äº†å¤ªå¤šçš„æ—¶é—´ã€‚

bundle çš„ä½“ç§¯æœ‰ 526kbï¼Œè€Œä¸”ç›®å‰å®ƒè¿˜æ²¡æœ‰è¢«å‹ç¼©ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨ Gzip æ¥è§£æ•‘å®ƒã€‚

é€šè¿‡ Node/Express çš„æœåŠ¡ç«¯å¾ˆå®¹æ˜“å®ç° Gzipï¼›æˆ‘ä»¬åªéœ€è¦å®‰è£… [**compression**](https://www.npmjs.com/package/compression) æ¨¡å—å¹¶å°†å®ƒä½œä¸ºä¸€ä¸ª Express ä¸­é—´ä»¶ä½¿ç”¨å°±å¯ä»¥äº†ã€‚

```
const path = require('path');

const express = require('express');
const compression = require('compression');


const app = express();

// åªéœ€è¦å°† compression ä½œä¸ºä¸€ä¸ª Express ä¸­é—´ä»¶!
app.use(compression());

app.use(express.static(path.join(rootDir, 'build')));
```

é€šè¿‡ä½¿ç”¨è¿™ä¸ªéå¸¸ç®€å•çš„è§£å†³æ–¹æ¡ˆï¼Œè®©æˆ‘ä»¬çœ‹çœ‹æˆ‘ä»¬çš„æ—¶é—´çº¿æœ‰ä»€ä¹ˆå˜åŒ–ï¼š

![](https://cdn-images-1.medium.com/max/800/1*N1pczEBknaQ_P6u-1S_FQw.png)

é¦–æ¬¡æœ‰æ•ˆæ¸²æŸ“ï¼š5000ms -> **3100ms**
é¦–å¼ å›¾ç‰‡åŠ è½½ï¼š6500ms -> **4600ms
**æ‰€æœ‰æ•°æ®åŠ è½½å®Œæˆï¼š6500ms -> **4750ms
**æ‰€æœ‰å›¾ç‰‡åŠ è½½å®Œæˆï¼š~15,000ms -> ~13,000ms

ä»£ç ä½“ç§¯ä» 526kb å‹ç¼©åˆ°åªæœ‰ 156kbï¼Œå¹¶ä¸”å®ƒå¯¹é¡µé¢åŠ è½½é€Ÿåº¦é€ æˆäº†å·¨å¤§çš„å˜åŒ–ã€‚

### ä½¿ç”¨ LocalStorage ç¼“å­˜

å¸¦ç€å‰ä¸€æ­¥çš„æ˜æ˜¾è¿›æ­¥ï¼Œæˆ‘åˆå›è¿‡å¤´æ¥çœ‹äº†ä¸‹æ—¶é—´çº¿ã€‚é¦–æ¬¡æ¸²æŸ“æ—¶åœ¨ 2400ms æ—¶è§¦å‘çš„ï¼Œä½†è¿™æ¬¡å¹¶æ²¡æœ‰ä»€ä¹ˆæ„ä¹‰ã€‚3100 ms æ—¶æ‰çœŸæ­£æœ‰å†…å®¹å±•ç¤ºï¼Œä½†æ˜¯ç›´åˆ° 5000ms å·¦å³æ‰è·å–åˆ°æ‰€æœ‰çš„å‰§é›†æ•°æ®ã€‚

æˆ‘å¼€å§‹è€ƒè™‘ä½¿ç”¨æœåŠ¡ç«¯æ¸²æŸ“ï¼Œä½†æ˜¯è¿™ä¹Ÿè§£å†³ä¸äº†é—®é¢˜ã€‚æœåŠ¡ç«¯ä»éœ€è¦è°ƒç”¨æ•°æ®åº“ï¼Œç„¶åè°ƒç”¨ TV Maze çš„ APIã€‚æ›´ç³Ÿç³•çš„æ˜¯ï¼Œåœ¨è¿™æ®µæ—¶é—´é‡Œç”¨æˆ·åªèƒ½å‚»ç›¯ç€ç™½èŠ±èŠ±çš„å±å¹•ã€‚

å¦‚æœä½¿ç”¨ local-storage å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥æŠŠæ‰€æœ‰çš„çŠ¶æ€å˜æ›´éƒ½å­˜å‚¨åˆ°æµè§ˆå™¨ä¸Šï¼Œå¹¶åœ¨ç”¨æˆ·æ•°æ®è¿”å›çš„æ—¶å€™å¯¹è¿™ä¸ªæœ¬åœ°çŠ¶æ€è¿›è¡Œè¡¥å……ã€‚é¦–å±çš„æ•°æ®å¯èƒ½æ˜¯æ—§çš„ï¼Œä½†æ˜¯æ²¡å…³ç³»ï¼çœŸå®çš„æ•°æ®å¾ˆå¿«å°±èƒ½åŠ è½½å›æ¥ï¼Œå¹¶ä¸”è¿™ä¼šä½¿å¾—é¦–æ¬¡åŠ è½½çš„ä½“éªŒéå¸¸å¿«ã€‚

å› ä¸ºè¿™ä¸ª app ä½¿ç”¨äº† Reduxï¼Œæ‰€ä»¥æŒä¹…åŒ–æ•°æ®æ˜¯éå¸¸ç®€å•çš„ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ–¹æ¡ˆæ¥ä¿è¯ Redux çŠ¶æ€å˜åŒ–æ—¶æ›´æ–° localStorageï¼š

```
import { LOCAL_STORAGE_REDUX_DATA_KEY } from '../constants';
import { debounce } from '../utils'; // generic debounce util

// å½“æˆ‘ä»¬çš„é¡µé¢é¦–æ¬¡åŠ è½½æ—¶ï¼Œä¸€å † redux actions ä¼šè¿…é€Ÿè¢« dispatch
// æ¯ä¸ªèŠ‚ç›®éƒ½è¦è·å–å®ƒä»¬çš„å‰§é›†ï¼Œæ‰€ä»¥æœ€å°çš„ action æ•°é‡æ˜¯ 2n (n æ˜¯èŠ‚ç›®çš„æ•°é‡)
// æˆ‘ä»¬ä¸éœ€è¦å¤ªè¿‡äºé¢‘ç¹çš„æ›´æ–° localStorageï¼Œå¯ä»¥å¯¹ä»–åš debounce
// å¦‚æœä¼ å…¥ nullï¼Œæˆ‘ä»¬ä¼šæŠ¹å»æ•°æ®ï¼Œé€šå¸¸ç”¨æ¥åœ¨ç™»å½•ç™»å‡ºæ—¶æ¶ˆé™¤æŒä¹…çŠ¶æ€
const updateLocalStorage = debounce(
  value =>
    value !== null
      ? localStorage.setItem(LOCAL_STORAGE_REDUX_DATA_KEY, value)
      : localStorage.removeItem(LOCAL_STORAGE_REDUX_DATA_KEY),
  2500
);


// store æ›´æ–°æ—¶ï¼Œå°†ç›¸å…³éƒ¨åˆ†å­˜å‚¨åˆ° localStorage ä¸­
export const handleStoreUpdates = function handleStoreUpdates(store) {
  // å¿½ç•¥ modals å’Œ flash æ¶ˆæ¯ï¼Œä»–ä»¬ä¸éœ€è¦è¢«å­˜å‚¨
  const { modals, flash, ...relevantState} = store.getState();

  updateLocalStorage(JSON.stringify(relevantState));
}

// åœ¨é€€å‡ºç™»å½•æ—¶ç”¨æ¥æ¸…é™¤æ•°æ®çš„ä¸€ä¸ªå‡½æ•°
export const clearReduxData = () => {
  // ç«‹å³æ¸…é™¤å­˜å‚¨åœ¨ localStorage ä¸­çš„æ•°æ®
  window.localStorage.removeItem(LOCAL_STORAGE_REDUX_DATA_KEY);


  // å› ä¸ºåˆ é™¤æ˜¯åŒæ­¥çš„ï¼Œè€ŒæŒä¹…åŒ–æ•°æ®æ˜¯å¼‚æ­¥çš„ï¼Œå› æ­¤è¿™é‡Œä¼šå¯¼è‡´ä¸€ä¸ªå¾®å¦™çš„ bugï¼š
  // å­˜å‚¨çš„æ•°æ®ä¼šè¢«åˆ é™¤ï¼Œä½†æ˜¯ç¨ååˆä¼šè¢«å¡«å……ä¸Š
  // ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬ä¼šä¼ å…¥ä¸€ä¸ª nullï¼Œæ¥ç»ˆæ­¢å½“å‰é˜Ÿåˆ—æ‰€æœ‰çš„æ›´æ–°
 
  updateLocalStorage(null);
  
  // æˆ‘ä»¬éœ€è¦è§¦å‘å¼‚æ­¥å’ŒåŒæ­¥çš„æ“ä½œã€‚
  // åŒæ­¥æ“ä½œä¿è¯æ•°æ®å¯ä»¥ç«‹åˆ»è¢«åˆ é™¤ï¼Œæ‰€ä»¥å¦‚æœç”¨æˆ·ç‚¹å‡»é€€å‡ºåç«‹åˆ»å…³é—­é¡µé¢ï¼Œæ•°æ®ä¹Ÿèƒ½è¢«åˆ é™¤
};
```

ä¸‹ä¸€æ­¥ï¼Œæˆ‘ä»¬éœ€è¦è®© Redux store è®¢é˜…è¿™ä¸ªå‡½æ•°ï¼Œä»¥åŠç”¨å‰ä¸€æ¬¡ä¼šè¯çš„æ•°æ®å¯¹å®ƒè¿›è¡Œåˆå§‹åŒ–ã€‚

```
import { LOCAL_STORAGE_REDUX_DATA_KEY } from './constants';
import { handleStoreUpdates } from './helpers/local-storage.helpers';
import configureStore from './store';


const localState = JSON.parse(
  localStorage.getItem(LOCAL_STORAGE_REDUX_DATA_KEY) || '{}'
);

const store = configureStore(history, localState);

store.subscribe(() => {
  handleStoreUpdates(store);
});
```

è™½ç„¶è¿˜æœ‰å‡ ä¸ªé—ç•™çš„å°é—®é¢˜ï¼Œä½†æ˜¯å¾—ç›Šäº Redux æ¶æ„ï¼Œæˆ‘ä»¬åªåšäº†ä¸€äº›å¾ˆå°çš„æ”¹åŠ¨å°±å®Œæˆäº†å¤§éƒ¨åˆ†çš„åŠŸèƒ½ã€‚

è®©æˆ‘ä»¬å†æ¥çœ‹çœ‹æ–°çš„æ—¶é—´çº¿ï¼š

![](https://cdn-images-1.medium.com/max/800/1*wJ6uOFLCWUmhMpKtB7XuYw.png)

æ£’æäº†ï¼è™½ç„¶é€šè¿‡è¿™äº›å¾ˆå°çš„æˆªå±å¾ˆéš¾è¯´æ˜ä»€ä¹ˆï¼Œä½†æ˜¯æˆ‘ä»¬åœ¨ 2600ms æ—¶çš„é‚£æ¬¡æ¸²æŸ“å·²ç»å¯ä»¥å±•ç¤ºä¸€äº›å†…å®¹äº†ï¼›å®ƒåŒ…æ‹¬ä¸€ä¸ªå®Œæ•´çš„èŠ‚ç›®åˆ—è¡¨ä»¥åŠä»ä¹‹å‰çš„ä¼šè¯é‡Œä¿å­˜çš„å‰§é›†ä¿¡æ¯ã€‚

é¦–æ¬¡æœ‰æ•ˆæ¸²æŸ“ï¼š3100ms -> **2600ms
**è·å–å‰§é›†æ•°æ®ï¼š4750ms -> **2600ms (!)**

è™½ç„¶è¿™å¹¶æ²¡æœ‰å½±å“åˆ°å®é™…çš„åŠ è½½æ—¶é—´ï¼ˆæˆ‘ä»¬ä»ç„¶éœ€è¦è°ƒç”¨å“ªäº› APIï¼Œå¹¶ä¸”åœ¨è¿™ä¸Šé¢è€—æ—¶ï¼‰ï¼Œä½†æ˜¯ç”¨æˆ·å¯ä»¥ç›´æ¥æ‹¿åˆ°æ•°æ®ï¼Œæ‰€ä»¥**æ„ŸçŸ¥**é€Ÿåº¦çš„æå‡éå¸¸æ˜æ˜¾ã€‚

åœ¨å†…å®¹å·²ç»å‡ºç°çš„æƒ…å†µä¸‹ï¼Œé¡µé¢ä»åœ¨ç»§ç»­å˜åŒ–ï¼Œè¿™æ˜¯ä¸€ç§éå¸¸æµè¡Œçš„æŠ€æœ¯ï¼Œå¯ä»¥è®©é¡µé¢æ›´å¿«åœ°å±•ç°ï¼Œå¹¶ä¸”å½“æ–°çš„å†…å®¹å¯ç”¨æ—¶ï¼Œé¡µé¢å‘ç”Ÿæ›´æ–°ã€‚å¯æ˜¯æˆ‘æ›´å–œæ¬¢ç«‹å³å‘ˆç°æœ€ç»ˆçš„ UIã€‚

è¿™ä¸ªæ–¹æ¡ˆåœ¨ä¸€äº› non-perf çš„æƒ…å†µä¸‹æœ‰ä¸€äº›é¢å¤–çš„ä¼˜åŠ¿ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œç”¨æˆ·å¯ä»¥æ›´æ”¹èŠ‚ç›®çš„é¡ºåºï¼Œä½†å¯èƒ½ç”±äºä¼šè¯çš„ç»“æŸå¯¼è‡´æ•°æ®ä¸¢å¤±äº†ã€‚ç°åœ¨ï¼Œå½“ä»–ä»¬è¿”å›é¡µé¢æ—¶ï¼Œä¹‹å‰çš„åå¥½è¿˜æ˜¯è¢«ä¿å­˜äº†ä¸‹æ¥ï¼

> ä½†æ˜¯ï¼Œè¿™ä¹Ÿæœ‰ä¸€ä¸ªç¼ºç‚¹ï¼šæˆ‘ä¸æ¸…æ¥šä½ æ˜¯å¦åœ¨ç­‰å¾…æ–°çš„æ•°æ®åŠ è½½ã€‚æˆ‘è®¡åˆ’åœ¨è§’è½é‡Œæ·»åŠ ä¸€ä¸ªåŠ è½½æ¡†ä»¥æ˜¾ç¤ºæ˜¯å¦è¿˜æœ‰å…¶ä»–è¯·æ±‚æ­£åœ¨åŠ è½½ã€‚

> å¦å¤–ï¼Œä½ å¯èƒ½ä¼šæƒ³â€œè¿™å¯¹äºè€ç”¨æˆ·æ¥è¯´å¯èƒ½ä¸é”™ï¼Œä½†æ˜¯å¯¹äºæ–°ç”¨æˆ·å¹¶æ²¡æœ‰ä»€ä¹ˆç”¨å¤„ï¼â€ã€‚ä½ è¯´çš„æ²¡é”™ï¼Œä½†å®é™…ä¸Šï¼Œè¿™ä¹Ÿç¡®å®ä¸é€‚ç”¨äºæ–°ç”¨æˆ·ã€‚æ–°ç”¨æˆ·å¹¶æ²¡æœ‰å…³æ³¨çš„èŠ‚ç›®ï¼Œåªæœ‰ä¸€ä¸ªå¼•å¯¼ä»–ä»¬æ·»åŠ èŠ‚ç›®çš„æç¤ºï¼Œå› æ­¤ä»–ä»¬çš„é¡µé¢åŠ è½½çš„éå¸¸å¿«ã€‚æ‰€ä»¥ï¼Œå¯¹äºæ‰€æœ‰çš„ç”¨æˆ·æ¥è¯´ï¼Œä¸ç®¡æ˜¯æ–°ç”¨æˆ·è¿˜æ˜¯è€ç”¨æˆ·ï¼Œæˆ‘ä»¬éƒ½å·²ç»æœ‰æ•ˆé¿å…äº†é‚£ç§ä¸€ç›´ç›¯ç€é»‘å±çš„ä½“éªŒã€‚

### å›¾ç‰‡å’Œæ‡’åŠ è½½

å³ä½¿æœ‰äº†è¿™ä¸ªæœ€æ–°çš„æ”¹è¿›ï¼Œå›¾ç‰‡çš„åŠ è½½ä»ç„¶èŠ±è´¹äº†å¾ˆå¤šçš„æ—¶é—´ã€‚è¿™ä¸ªæ—¶é—´çº¿é‡Œæ²¡æœ‰å±•ç¤ºå‡ºæ¥ï¼Œä½†æ˜¯åœ¨ 3G ç½‘ç»œä¸‹ï¼Œæ‰€æœ‰çš„å›¾ç‰‡åŠ è½½ä¸€å…±è€—è´¹äº†è¶…è¿‡ 12 ç§’ã€‚

åŸå› å¾ˆç®€å•ï¼šTV Maze è¿”å›äº†ä¸€å¼ å·¨å¤§çš„ç”µå½±æµ·æŠ¥é£æ ¼çš„ç…§ç‰‡ï¼Œç„¶è€Œæˆ‘åªéœ€è¦ä¸€ä¸ªç‹­é•¿çš„æ¡çŠ¶å›¾ï¼Œç”¨äºå¸®åŠ©ç”¨æˆ·ä¸€çœ¼å°±èƒ½åˆ†è¾¨å‡ºèŠ‚ç›®ã€‚

![](https://cdn-images-1.medium.com/max/800/1*wIhn8j9QkPIBvxAA6ulTxQ.jpeg)

**å·¦è¾¹**ï¼šè¢«ä¸‹è½½çš„å›¾ç‰‡ Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â· **å³è¾¹**ï¼šçœŸæ­£ç”¨åˆ°çš„å›¾ç‰‡

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä¸€å¼€å§‹çš„æƒ³æ³•æ˜¯ä½¿ç”¨ä¸€ä¸ªç±»ä¼¼äº ImageMagick çš„ CLI å·¥å…·ï¼Œæˆ‘åœ¨åˆ¶ä½œ [**ColourMatch**](http://colourmatch.ca/) æ—¶ä½¿ç”¨è¿‡å®ƒã€‚

å½“ç”¨æˆ·æ·»åŠ ä¸€ä¸ªæ–°çš„èŠ‚ç›®æ—¶ï¼ŒæœåŠ¡ç«¯å°†è¯·æ±‚ä¸€ä¸ªå›¾ç‰‡çš„å‰¯æœ¬ï¼Œä½¿ç”¨ ImageMagick å°†å›¾ç‰‡çš„ä¸­é—´è£å‰ªå‡ºæ¥å¹¶å‘é€ç»™ S3ï¼Œç„¶åå®¢æˆ·ç«¯ä¼šä½¿ç”¨ S3 çš„ url è€Œé TV Maze çš„å›¾ç‰‡é“¾æ¥ã€‚

ä¸è¿‡ï¼Œæˆ‘å†³å®šä½¿ç”¨ [**Imgix**](https://www.imgix.com/) æ¥å®Œæˆè¿™ä¸ªåŠŸèƒ½ã€‚Imgix æ˜¯ä¸€ä¸ªåŸºäº S3(æˆ–è€…å…¶ä»–äº‘å­˜å‚¨æä¾›å•†) çš„å›¾ç‰‡æœåŠ¡ï¼Œå®ƒå…è®¸ä½ åŠ¨æ€åˆ›å»ºè£å‰ªè¿‡æˆ–è€…è°ƒæ•´äº†å¤§å°çš„å›¾ç‰‡ã€‚ä½ åªéœ€è¦ä½¿ç”¨ä¸‹é¢è¿™æ ·çš„é“¾æ¥ï¼Œå®ƒå°±ä¼šåˆ›å»ºå¹¶æä¾›åˆé€‚çš„å›¾ç‰‡ã€‚

```
https://tello.imgix.net/some_file?w=395&h=96&crop=faces
```

> å®ƒè¿˜æœ‰ä¸€ä¸ªä¼˜åŠ¿å°±æ˜¯èƒ½å¤Ÿæ‰¾åˆ°å›¾ç‰‡ä¸­æœ‰è¶£çš„åŒºåŸŸå¹¶åšè£å‰ªã€‚ä½ ä¼šæ³¨æ„åˆ°ï¼Œåœ¨ä¸Šé¢çš„å·¦/å³ç…§ç‰‡å¯¹æ¯”ä¸­ï¼Œå®ƒå°† 4 ä¸ªéª‘è½¦çš„å­©å­è£å‰ªäº†å‡ºæ¥ï¼Œè€Œéä»…ä»…è£å‰ªå‡ºå›¾ç‰‡çš„ä¸­å¿ƒ

ä¸ºäº†é…åˆ Imgix çš„å·¥ä½œï¼Œä½ çš„å›¾ç‰‡éœ€è¦èƒ½å¤Ÿé€šè¿‡ S3 æˆ–è€…ç±»ä¼¼çš„æœåŠ¡è¢«è·å–åˆ°ã€‚è¿™é‡Œæ˜¯ä¸€æ®µæˆ‘çš„åç«¯ä»£ç ç‰‡æ®µï¼Œå½“æ·»åŠ ä¸€ä¸ªæ–°çš„èŠ‚ç›®æ—¶ä¼šä¸Šä¼ ä¸€å¼ å›¾ç‰‡ï¼š

```
const ROOT_URL = 'https://tello.imgix.net';

const uploadImage = ({ key, url }) => (
  new Promise((resolve, reject) => {
    // æœ‰äº›æƒ…å†µä¸‹èŠ‚ç›®æ²¡æœ‰ä¸€ä¸ªé“¾æ¥ï¼Œè¿™æ—¶å€™è·³è¿‡è¿™ç§æƒ…å†µ
    if (!url) {
      resolve();
      return;
    }

    request({ url, encoding: null }, (err, res, body) => {
      if (err) {
        reject(err);
      }

      s3.putObject({
        Key: key,
        Bucket: BUCKET_NAME,
        Body: body,
      }, (...args) => {
        resolve(`${ROOT_URL}/${key}`);
      });
    });
  })
);
```


é€šè¿‡å¯¹æ¯ä¸ªæ–°çš„èŠ‚ç›®è°ƒç”¨è¿™ä¸ª Promiseï¼Œæˆ‘ä»¬è·å–äº†å¯ä»¥è¢«åŠ¨æ€è£å‰ªçš„å›¾ç‰‡ã€‚

åœ¨å®¢æˆ·ç«¯ï¼Œæˆ‘ä»¬ä½¿ç”¨ _srcset_ å’Œ _sizes_ è¿™ä¸¤ä¸ªå›¾ç‰‡å±æ€§æ¥ç¡®ä¿å›¾ç‰‡æ˜¯åŸºäºçª—å£å¤§å°å’Œåƒç´ æ¯”æ¥æä¾›çš„ï¼š

```
const dpr = window.devicePixelRatio;

const defaultImage = 'https://tello.imgix.net/placeholder.jpg';

const buildImageUrl = ({ image, width, height }) => (`
  ${image || defaultImage}?fit=crop&crop=entropy&h=${height}&w=${width}&dpr=${dpr} ${width * dpr}w
`);


// Later, in a render method:
<img
  srcSet={`
    ${buildImageUrl({
      image,
      width: 495,
      height: 128,
    })},
    ${buildImageUrl({
      image,
      width: 334,
      height: 96,
    })}
  `}
  sizes={`
    ${BREAKPOINTS.smMin} 334px,
    495px
  `}
/>
```

è¿™ç¡®ä¿äº†ç§»åŠ¨è®¾å¤‡èƒ½è·å–æ›´å¤§ç‰ˆæœ¬çš„å›¾åƒï¼ˆå› ä¸ºè¿™äº›å¡ç‰‡å æ®äº†æ•´ä¸ªè§†å£çš„å®½åº¦ï¼‰ï¼Œè€Œæ¡Œé¢å®¢æˆ·ç«¯å¾—åˆ°çš„æ˜¯ä¸€ä¸ªè¾ƒå°çš„ç‰ˆæœ¬ã€‚

#### æ‡’åŠ è½½

ç°åœ¨ï¼Œæ¯å¼ å›¾ç‰‡éƒ½å˜å°äº†ï¼Œä½†æ˜¯æˆ‘ä»¬è¿˜æ˜¯ä¸€æ¬¡æ€§åŠ è½½äº†æ•´ä¸ªé¡µé¢çš„å›¾ç‰‡ï¼åœ¨æˆ‘çš„å¤§å‹æ¡Œé¢çª—å£ä¸Šï¼Œæ¯æ¬¡åªèƒ½çœ‹åˆ° 6 ä¸ªèŠ‚ç›®ï¼Œä½†æ˜¯æˆ‘ä»¬åœ¨é¡µé¢åŠ è½½çš„æ—¶å€™ä¸€æ¬¡æ€§è·å–äº†å…¨éƒ¨çš„ 16 å¼ å›¾ç‰‡ã€‚

å€¼å¾—åº†å¹¸çš„æ˜¯ï¼Œæœ‰ä¸€ä¸ªå¾ˆæ£’çš„åº“ [**react-lazyload**](https://github.com/jasonslyvia/react-lazyload) æä¾›äº†éå¸¸ä¾¿åˆ©çš„æ‡’åŠ è½½åŠŸèƒ½ã€‚ä»£ç ç¤ºä¾‹å¦‚ä¸‹ï¼š

```
import LazyLoad from 'react-lazyload';

// In some render method somewhere:
<LazyLoad once height={UNITS_IN_PX[6]} offset={50}>
  <img
    srcSet={`...omitted`}
    sizes={`...omitted`}
  />
</LazyLoad>
```

æ¥å§ï¼Œè®©æˆ‘ä»¬å†æ¥çœ‹çœ‹æ—¶é—´çº¿ã€‚

![](https://cdn-images-1.medium.com/max/800/1*YLyKF1rKx1MMaLA-1jnZrg.png)

æˆ‘ä»¬çš„é¦–æ¬¡æœ‰æ•ˆæ¸²æŸ“æ—¶é—´æ²¡ä»€ä¹ˆå˜åŒ–ï¼Œä½†æ˜¯å›¾ç‰‡åŠ è½½çš„æ—¶é—´æœ‰äº†æ˜æ˜¾çš„é™ä½ï¼š

é¦–å¼ å›¾ç‰‡ï¼š4600ms -> **3900ms**
æ‰€æœ‰å¯è§èŒƒå›´å†…çš„å›¾ç‰‡ï¼š~9000ms -> **4100ms**

> çœ¼å°–çš„è¯»è€…å¯èƒ½å·²ç»æ³¨æ„åˆ°äº†ï¼Œè¿™ä¸ªæ—¶é—´çº¿ä¸Šåªä¸‹è½½äº† 6 é›†çš„æ•°æ®è€Œä¸æ˜¯å…¨éƒ¨çš„ 16é›†ã€‚å› ä¸ºæˆ‘æœ€åˆçš„å°è¯•ï¼ˆä¹Ÿæ˜¯æˆ‘è®°å¿†ä¸­å”¯ä¸€ä¸€ä¸ªå°è¯•ï¼‰å°±æ˜¯æ‡’åŠ è½½èŠ‚ç›®å¡ç‰‡ï¼Œè€Œå¹¶ä¸ä»…ä»…æ˜¯æ‡’åŠ è½½å›¾ç‰‡ã€‚

> ä¸è¿‡ï¼Œç›¸æ¯”æˆ‘è¿™å‘¨æœ«è§£å†³çš„é—®é¢˜ï¼Œå®ƒä¹Ÿå¼•å‘äº†æ›´å¤šçš„é—®é¢˜ï¼Œå› æ­¤æˆ‘å¯¹å®ƒè¿›è¡Œäº†ä¸€äº›ç®€åŒ–ã€‚ä½†æ˜¯è¿™å¹¶ä¸ä¼šå½±å“å›¾ç‰‡åŠ è½½æ—¶é—´çš„ä¼˜åŒ–ã€‚

### ä»£ç åˆ†å‰²

æˆ‘æ•¢è‚¯å®šï¼Œä»£ç åˆ†å‰²æ˜¯ä¸€ä¸ªéå¸¸æ˜æ™ºçš„å†³å®šã€‚

å› ä¸ºç°åœ¨æœ‰ä¸€ä¸ªæ˜¾è€Œæ˜“è§çš„é—®é¢˜ï¼Œæˆ‘ä»¬çš„ä»£ç  bundle åªæœ‰ä¸€ä¸ªã€‚è®©æˆ‘ä»¬ä½¿ç”¨ä»£ç åˆ†å‰²æ¥å‡å°‘ä¸€ä¸ªè¯·æ±‚æ‰€éœ€è¦çš„ä»£ç é‡ï¼

æˆ‘ä½¿ç”¨çš„è·¯ç”±æ–¹æ¡ˆæ˜¯ React Router 4ï¼Œ[**å®ƒçš„æ–‡æ¡£ä¸Š**](https://reacttraining.com/react-router/web/guides/code-splitting)æœ‰ä¸€ä¸ªå¾ˆç®€å•çš„åˆ›å»º `<Bundle />` ç»„ä»¶çš„ä¾‹å­ã€‚æˆ‘è®¾ç½®äº†å‡ ä¸ªä¸åŒçš„é…ç½®ï¼Œä½†æ˜¯æœ€ç»ˆä»£ç å¹¶æ²¡æœ‰æ¯”è¾ƒæœ‰æ•ˆçš„åˆ†å‰²ã€‚

æœ€åï¼Œæˆ‘å°†ç§»åŠ¨ç«¯å’Œæ¡Œé¢ç«¯çš„è§†å›¾åšäº†åˆ†ç¦»ã€‚ç§»åŠ¨ç‰ˆæœ‰è‡ªå·±çš„è§†å›¾ï¼Œå®ƒä½¿ç”¨äº†ä¸€ä¸ªæ»‘åŠ¨åº“ï¼Œä¸€äº›è‡ªå®šä¹‰çš„é™æ€èµ„æºå’Œå‡ ä¸ªé¢å¤–çš„ç»„ä»¶ã€‚ä»¤äººåƒæƒŠçš„æ˜¯ï¼Œè¿™ä¸ªåˆ†ç¦»å‡ºæ¥çš„ bundle éå¸¸çš„å° â€”â€” å‹ç¼©å‰å¤§æ¦‚åªæœ‰ 30kb â€”â€” ä½†æ˜¯å®ƒè¿˜æ˜¯å¸¦æ¥äº†ä¸€äº›æ˜¾è‘—çš„å½±å“ï¼š

![](https://cdn-images-1.medium.com/max/800/1*0eWlF3VGsWLqHulZtLzkDQ.png)

é¦–æ¬¡æœ‰æ•ˆæ¸²æŸ“ï¼š2600ms -> **2300ms**
é¦–å¼ å›¾ç‰‡åŠ è½½ï¼š3900ms -> **3700ms**

> é€šè¿‡è¿™æ¬¡å°è¯•è®©æˆ‘å­¦åˆ°äº†ä¸€ä»¶äº‹ï¼šä»£ç åˆ†å‰²çš„æ•ˆæœå¾ˆå¤§ç¨‹åº¦ä¸Šå–å†³äºä½ çš„åº”ç”¨ç±»å‹ã€‚åœ¨æˆ‘è¿™ä¸ª case é‡Œï¼Œæœ€å¤§çš„ä¾èµ–å°±æ˜¯ React å’Œå®ƒç”Ÿæ€ç³»ç»Ÿé‡Œçš„ä¸€äº›åº“ï¼Œç„¶è€Œè¿™äº›ä»£ç æ˜¯æ•´ç«™éƒ½éœ€è¦çš„å¹¶ä¸”ä¸éœ€è¦è¢«åˆ†ç¦»å‡ºæ¥
>
> åœ¨é¡µé¢åŠ è½½æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è·¯ç”±å±‚é¢å¯¹ç»„ä»¶è¿›è¡Œåˆ†å‰²ä»¥è·å¾—ä¸€äº›è¾¹é™…æ•ˆç›Šï¼Œä½†æ˜¯è¿™æ ·çš„è¯ï¼Œæ¯å½“è·¯ç”±å˜åŒ–æ—¶éƒ½ä¼šé€ æˆé¢å¤–çš„å»¶è¿Ÿï¼›å¤„å¤„éƒ½è¦å¤„ç†è¿™ç§å°é—®é¢˜å¹¶ä¸æœ‰è¶£ã€‚

* * *

### ä¸€äº›å…¶ä»–æ–¹æ³•çš„å°è¯•å’Œæ€è€ƒ
#### æœåŠ¡ç«¯æ¸²æŸ“

æˆ‘çš„æƒ³æ³•æ˜¯åœ¨æœåŠ¡ç«¯æ¸²æŸ“ä¸€ä¸ª "shell" â€”â€” ä¸€ä¸ªæœ‰æ­£ç¡®å¸ƒå±€çš„å ä½å›¾ï¼Œåªæ˜¯æ²¡æœ‰æ•°æ®ã€‚

ä½†æ˜¯æˆ‘é¢„è§åˆ°ä¸€ä¸ªé—®é¢˜ï¼Œå› ä¸ºå®¢æˆ·ç«¯å·²ç»é€šè¿‡ localStorage è·å–å‰ä¸€æ¬¡ä¼šè¯çš„æ•°æ®äº†ï¼Œå¹¶ä¸”å®ƒä½¿ç”¨è¿™ä¸ªæ•°æ®è¿›è¡Œäº†åˆå§‹åŒ–ã€‚ä½†æ˜¯æ­¤æ—¶æœåŠ¡ç«¯æ˜¯ä¸çŸ¥æƒ…çš„ï¼Œæ‰€ä»¥æˆ‘éœ€è¦å¤„ç†å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ä¹‹é—´çš„æ ‡è®°ä¸åŒ¹é…ã€‚

æˆ‘è®¤ä¸ºè™½ç„¶æˆ‘å¯ä»¥é€šè¿‡ SSR å°†æˆ‘çš„é¦–æ¬¡æœ‰æ•ˆæ¸²æŸ“æ—¶é—´å‡å°‘åŠç§’ï¼Œä½†æ˜¯åœ¨é‚£æ—¶æ•´ä¸ªç½‘ç«™éƒ½æ˜¯ä¸èƒ½äº¤äº’çš„ï¼›å½“ä¸€ä¸ªç½‘ç«™çœ‹èµ·æ¥å·²ç»å‡†å¤‡å¥½äº†ä½†å…¶å®ä¸æ˜¯çš„æ—¶å€™ï¼Œè®©äººè§‰å¾—éå¸¸å¥‡æ€ªã€‚

å¦å¤–ï¼ŒSSR ä¹Ÿä¼šå¢åŠ å¤æ‚æ€§ï¼Œå¹¶ä¸”é™ä½å¼€å‘é€Ÿåº¦ã€‚æ€§èƒ½å¾ˆé‡è¦ï¼Œä½†æ˜¯è¶³å¤Ÿå¥½å°±å¤Ÿäº†ã€‚

æœ‰ä¸€ä¸ªæˆ‘å¾ˆæ„Ÿå…´è¶£ä½†æ˜¯æ²¡æ—¶é—´ç ”ç©¶çš„é—®é¢˜æ˜¯ â€”â€” ç¼–è¯‘æ—¶ SSRã€‚å®ƒå¯èƒ½è¿™åªé€‚ç”¨äºä¸€äº›é™æ€é¡µé¢ï¼Œæ¯”å¦‚ç™»å‡ºé¡µï¼Œä½†æ˜¯æˆ‘è§‰å¾—å®ƒæ˜¯éå¸¸æœ‰æ•ˆçš„ã€‚ä½œä¸ºæˆ‘æ„å»ºè¿‡ç¨‹çš„ä¸€éƒ¨åˆ†ï¼Œæˆ‘ä¼šåˆ›å»ºå¹¶æŒä¹…åŒ–å­˜å‚¨ `index.html`ï¼Œå¹¶é€šè¿‡ Node æœåŠ¡å™¨å°†å®ƒä½œä¸ºä¸€ä¸ªçº¯ HTML æ–‡ä»¶æä¾›ç»™ç”¨æˆ·ã€‚å®¢æˆ·ç«¯ä»ç„¶ä¼šä¸‹è½½å¹¶è¿è¡Œ Reactï¼Œå› æ­¤é¡µé¢ä»ç„¶æ˜¯å¯äº¤äº’çš„ï¼Œä½†æ˜¯æœåŠ¡ç«¯ä¸éœ€è¦èŠ±æ—¶é—´å»æ„å»ºäº†ï¼Œå› ä¸ºæˆ‘å·²ç»åœ¨ä»£ç éƒ¨ç½²æ—¶ç›´æ¥å°†è¿™äº›é¡µé¢æ„å»ºå¥½äº†ã€‚

#### CDN çš„ä¾èµ–

è¿˜æœ‰ä¸€ä¸ªæˆ‘è®¤ä¸ºæœ‰å¾ˆå¤§æ½œåŠ›çš„æƒ³æ³•å°±æ˜¯å°† React å’Œ ReactDOM æ‰˜ç®¡åˆ° CDN ä¸Šã€‚

Webpack ä½¿å¾—è¿™å¾ˆå®¹æ˜“å®ç°ï¼›ä½ å¯ä»¥é€šè¿‡å®šä¹‰ _externals_ å…³é”®å­—é¿å…å°†å®ƒä»¬æ‰“åŒ…åˆ°ä½ çš„ bundle ä¸­ã€‚

```
// webpack.config.prod.js
{
  externals: {
    react: 'React',
    'react-dom': 'ReactDOM',
  },
}
```

è¿™ç§æ–¹æ³•æœ‰ä¸¤ä¸ªä¼˜åŠ¿ï¼š

* ä» CDN è·å–ä¸€ä¸ªæµè¡Œçš„åº“ï¼Œå®ƒæœ‰å¾ˆå¤§å¯èƒ½å·²ç»è¢«ç”¨æˆ·ç¼“å­˜äº†
* ä¾èµ–å…³ç³»å¯ä»¥è¢«å¹¶è¡ŒåŒ–ï¼Œå¯ä»¥åŒæ—¶ä¸‹è½½ä½ çš„ä»£ç ï¼Œè€Œä¸æ˜¯ä¸‹è½½ä¸€ä¸ªå¤§æ–‡ä»¶

æˆ‘å¾ˆæƒŠè®¶çš„å‘ç°ï¼Œè‡³å°‘åœ¨ CDN æœªç¼“å­˜çš„æœ€åæƒ…å†µä¸‹ï¼Œå°† React ç§»åˆ° CDN ä¸Šå¹¶æ²¡æœ‰ä»€ä¹ˆç›Šå¤„ï¼š

![](https://cdn-images-1.medium.com/max/800/1*JaujId8Or-HOxLuJGcKWSw.png)

é¦–æ¬¡æœ‰æ•ˆæ¸²æŸ“æ—¶é—´ï¼š**2300ms** -> 2650ms

ä½ å¯èƒ½ä¼šå‘ç° React å’Œ React DOM æ˜¯å’Œæˆ‘çš„ä¸»è¦è½¯ä»¶åŒ…å¹¶è¡Œä¸‹è½½çš„ï¼Œå¹¶ä¸”å®ƒç¡®å®æ‹–æ…¢äº†æ•´ä½“çš„æ—¶é—´ã€‚

> æˆ‘å¹¶ä¸æ˜¯æƒ³è¯´ä½¿ç”¨ CDN æ˜¯ä¸€ä¸ªåä¸»æ„ã€‚åœ¨è¿™æ–¹é¢æˆ‘å¹¶ä¸æ˜¯å¾ˆä¸“ä¸šå¹¶ä¸”å¾ˆå¯èƒ½æ˜¯æˆ‘åšé”™äº†ï¼Œè€Œä¸æ˜¯è¿™ä¸ªæƒ³æ³•çš„é—®é¢˜ï¼è‡³å°‘åœ¨æˆ‘çš„ case é‡Œå®ƒå¹¶æ²¡æœ‰ç”Ÿæ•ˆã€‚
	
> è¯‘è€…æ³¨ï¼š
> è¿™é‡Œå°† React æ”¾åœ¨ CDN ä¸Šçš„æ–¹æ¡ˆï¼Œåœ¨æœ¬åœ°æ— ç¼“å­˜çš„æƒ…å†µä¸‹å¾ˆæ˜æ˜¾æ²¡ä»€ä¹ˆä¼˜åŠ¿ï¼Œå› ä¸ºä½ çš„æ€»ä»£ç ä½“ç§¯ä¸ä¼šå‡å°‘ï¼Œä½ çš„å¸¦å®½æ²¡æœ‰å˜åŒ–ï¼ŒJSæ˜¯å¹¶è¡Œä¸‹è½½ä½†æ˜¯ä¸²è¡Œæ‰§è¡Œï¼Œæ‰€ä»¥æ€»çš„ä¸‹è½½æ—¶é—´å’Œæ‰§è¡Œæ—¶é—´å¹¶ä¸ä¼šæœ‰ä»€ä¹ˆä¼˜åŠ¿ï¼›åè€Œç”±äº http å»ºç«‹é“¾æ¥çš„æŸè€—å¯èƒ½ä¼šå‡æ…¢é€Ÿåº¦ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬è¯´è¦å°½å¯èƒ½å‡å°‘ http è¯·æ±‚çš„åŸå› ï¼›è€Œä¸”ç”±äºæ˜¯æœ¬åœ°æµ‹è¯•ï¼ŒCDN çš„ä¼˜åŠ¿å¯èƒ½å¹¶æ²¡æœ‰ä½“ç°ã€‚
> ä½†æ˜¯æˆ‘è§‰å¾—è¿™ç§æ–¹æ¡ˆè¿˜æ˜¯å¯å–çš„ï¼Œä¸»è¦æœ‰ä¸¤ç‚¹ï¼š1. å› ä¸ºæœ‰ CDNï¼Œå¯ä»¥ä¿è¯å¤§éƒ¨åˆ†äººçš„ä¸‹è½½é€Ÿåº¦ï¼Œè€Œæ”¾åœ¨ä½ çš„æœåŠ¡å™¨ä¸Šå…¶å®ç”±äºä¼ è¾“çš„é—®é¢˜å¾ˆå¤šäººä¸‹è½½ä¼šéå¸¸æ…¢ï¼›2. ç”±äºå°† React ç›¸å…³çš„åº“æŠ½ç¦»ï¼Œåç»­æ¯æ¬¡æ›´æ”¹ä»£ç å’Œå‘å¸ƒåè¿™éƒ¨åˆ†ä»£ç éƒ½æ˜¯èµ°çš„ç¼“å­˜ï¼Œå¯ä»¥å‡å°‘åç»­ç”¨æˆ·çš„åŠ è½½æ—¶é—´
* * *

###ç»“è®º

é€šè¿‡è¿™ç¯‡æ–‡ç« ï¼Œæˆ‘å¸Œæœ›ä¼ è¾¾å‡ºä¸¤ä¸ªè§‚ç‚¹ï¼š

1. å°å‹ç¨‹åºçš„å¼€ç®±å³ç”¨æ€§éå¸¸é«˜ï¼Œä½†æ˜¯ä¸€ä¸ªå‘¨æœ«å°±å¯ä»¥å¸¦æ¥ä¸€ä¸ªå·¨å¤§çš„æå‡ã€‚è¿™è¦æ„Ÿè°¢ Chrome å¼€å‘è€…å·¥å…·ï¼Œå®ƒå¯ä»¥å¸®ä½ å¿«é€Ÿç¡®è®¤é¡¹ç›®çš„ç“¶é¢ˆï¼Œå¹¶ä¸”è®©ä½ æƒŠè®¶çš„å‘ç°é¡¹ç›®é‡Œæœ‰å¦‚æ­¤å¤šçš„æ€§èƒ½æ´¼åœ°ã€‚ä¹Ÿå¯ä»¥å°†ä¸€äº›å¤æ‚çš„ä»»åŠ¡äº¤ç»™åƒ Imgix è¿™æ ·çš„ä½æˆæœ¬æˆ–è€…å…è´¹çš„æœåŠ¡å•†ã€‚
2. æ¯ä¸ªåº”ç”¨éƒ½æ˜¯ä¸åŒçš„ï¼Œè¿™ç¯‡æ–‡ç« è¯¦ç»†ä»‹ç»äº† Tello çš„ä¸€äº›æŠ€å·§ï¼Œä½†æ˜¯è¿™äº›æŠ€å·§çš„å…³æ³¨ç‚¹æ¯”è¾ƒç‰¹åˆ«ã€‚å³ä½¿è¿™äº›æŠ€å·§ä¸é€‚ç”¨äºä½ çš„åº”ç”¨ï¼Œä½†æˆ‘å¸Œæœ›æˆ‘å·²ç»æŠŠç†å¿µè¡¨è¾¾æ¸…æ¥šäº†ï¼šæ€§èƒ½å–å†³äº web å¼€å‘è€…çš„åˆ›é€ æ€§ã€‚


ä¸¾ä¸ªä¾‹å­ï¼Œåœ¨ä¸€äº›ä¼ ç»Ÿçš„è§‚å¿µçœ‹æ¥ï¼ŒæœåŠ¡ç«¯æ¸²æŸ“æ˜¯ä¸€ä¸ªå¿…ç»ä¹‹è·¯ã€‚ä½†æ˜¯æˆ‘åœ¨çš„åº”ç”¨é‡Œï¼ŒåŸºäº local-storage æˆ–è€… service-workers æ¥åšå‰ç«¯æ¸²æŸ“åˆ™æ˜¯ä¸€ä¸ªæ›´å¥½çš„é€‰æ‹©ï¼ä¹Ÿè®¸ä½ å¯ä»¥åœ¨ç¼–è¯‘æ—¶åšä¸€äº›å·¥ä½œï¼Œå‡å°‘ SSR çš„è€—æ—¶ï¼Œåˆæˆ–è€…å­¦ä¹  Netflixï¼Œ[å®Œå…¨ä¸å°† React ä¼ é€’ç»™å‰ç«¯](https://jakearchibald.com/2017/netflix-and-react/)ï¼
	
	å½“ä½ åšæ€§èƒ½ä¼˜åŒ–æ—¶ï¼Œä½ ä¼šå‘ç°è¿™éå¸¸éœ€è¦åˆ›é€ åŠ›å’Œå¼€é˜”çš„æ€è·¯ï¼Œè€Œè¿™ä¹Ÿæ˜¯å®ƒæœ€æœ‰è¶£çš„çš„åœ°æ–¹ã€‚

> éå¸¸æ„Ÿè°¢æ‚¨çš„é˜…è¯»ï¼æˆ‘å¸Œæœ›è¿™ç¯‡æ–‡ç« èƒ½ç»™æ‚¨å¸¦æ¥å¸®åŠ©:)ã€‚å¦‚æœæ‚¨æœ‰ä»€ä¹ˆæƒ³æ³•å¯ä»¥è”ç³»æˆ‘çš„
[Twitter](http://twitter.com/joshwcomeau) ã€‚

> **å¯ä»¥åœ¨** [**Github**](https://github.com/joshwcomeau/Tello) **ä¸ŠæŸ¥çœ‹ Tello çš„æºç ****ğŸŒŸ**


---

> [æ˜é‡‘ç¿»è¯‘è®¡åˆ’](https://github.com/xitu/gold-miner) æ˜¯ä¸€ä¸ªç¿»è¯‘ä¼˜è´¨äº’è”ç½‘æŠ€æœ¯æ–‡ç« çš„ç¤¾åŒºï¼Œæ–‡ç« æ¥æºä¸º [æ˜é‡‘](https://juejin.im) ä¸Šçš„è‹±æ–‡åˆ†äº«æ–‡ç« ã€‚å†…å®¹è¦†ç›– [Android](https://github.com/xitu/gold-miner#android)ã€[iOS](https://github.com/xitu/gold-miner#ios)ã€[å‰ç«¯](https://github.com/xitu/gold-miner#å‰ç«¯)ã€[åç«¯](https://github.com/xitu/gold-miner#åç«¯)ã€[åŒºå—é“¾](https://github.com/xitu/gold-miner#åŒºå—é“¾)ã€[äº§å“](https://github.com/xitu/gold-miner#äº§å“)ã€[è®¾è®¡](https://github.com/xitu/gold-miner#è®¾è®¡)ã€[äººå·¥æ™ºèƒ½](https://github.com/xitu/gold-miner#äººå·¥æ™ºèƒ½)ç­‰é¢†åŸŸï¼Œæƒ³è¦æŸ¥çœ‹æ›´å¤šä¼˜è´¨è¯‘æ–‡è¯·æŒç»­å…³æ³¨ [æ˜é‡‘ç¿»è¯‘è®¡åˆ’](https://github.com/xitu/gold-miner)ã€[å®˜æ–¹å¾®åš](http://weibo.com/juejinfanyi)ã€[çŸ¥ä¹ä¸“æ ](https://zhuanlan.zhihu.com/juejinfanyi)ã€‚


