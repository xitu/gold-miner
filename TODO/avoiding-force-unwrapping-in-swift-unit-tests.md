> * åŸæ–‡åœ°å€ï¼š[Avoiding force unwrapping in Swift unit tests](https://www.swiftbysundell.com/posts/avoiding-force-unwrapping-in-swift-unit-tests)
> * åŸæ–‡ä½œè€…ï¼š[John](https://twitter.com/johnsundell)
> * è¯‘æ–‡å‡ºè‡ªï¼š[æ˜é‡‘ç¿»è¯‘è®¡åˆ’](https://github.com/xitu/gold-miner)
> * æœ¬æ–‡æ°¸ä¹…é“¾æ¥ï¼š[https://github.com/xitu/gold-miner/blob/master/TODO/avoiding-force-unwrapping-in-swift-unit-tests.md](https://github.com/xitu/gold-miner/blob/master/TODO/avoiding-force-unwrapping-in-swift-unit-tests.md)
> * è¯‘è€…ï¼š[RickeyBoy](https://juejin.im/user/59c0ede76fb9a00a3d134e0b/posts)
> * æ ¡å¯¹è€…ï¼š[YinTokey](https://github.com/YinTokey)

# é¿å… Swift å•å…ƒæµ‹è¯•ä¸­çš„å¼ºåˆ¶è§£æ

å¼ºåˆ¶è§£æï¼ˆä½¿ç”¨ `!`ï¼‰æ˜¯ Swift è¯­è¨€ä¸­ä¸å¯æˆ–ç¼ºçš„ä¸€ä¸ªé‡è¦ç‰¹ç‚¹ï¼ˆç‰¹åˆ«æ˜¯å’Œ Objective-C çš„æ¥å£æ··åˆä½¿ç”¨æ—¶ï¼‰ã€‚å®ƒå›é¿äº†ä¸€äº›å…¶ä»–é—®é¢˜ï¼Œä½¿å¾— Swift è¯­è¨€å˜å¾—æ›´åŠ ä¼˜ç§€ã€‚æ¯”å¦‚ **[å¤„ç† Swift ä¸­éå¯é€‰çš„å¯é€‰å€¼ç±»å‹](https://www.swiftbysundell.com/posts/handling-non-optional-optionals-in-swift)** è¿™ç¯‡æ–‡ç« ä¸­ï¼Œåœ¨é¡¹ç›®é€»è¾‘éœ€è¦æ—¶ä½¿ç”¨å¼ºåˆ¶è§£æå»å¤„ç†å¯é€‰ç±»å‹ï¼Œå°†å¯¼è‡´ä¸€äº›ç¦»å¥‡çš„æƒ…å†µå’Œå´©æºƒã€‚

æ‰€ä»¥å°½å¯èƒ½åœ°é¿å…ä½¿ç”¨å¼ºåˆ¶è§£æï¼Œå°†æœ‰åŠ©äºæ­å»ºæ›´åŠ ç¨³å®šçš„åº”ç”¨ï¼Œå¹¶ä¸”åœ¨å‘ç”Ÿé”™è¯¯æ—¶æä¾›æ›´å¥½çš„æŠ¥é”™ä¿¡æ¯ã€‚é‚£ä¹ˆå¦‚æœæ˜¯ç¼–å†™æµ‹è¯•æ—¶ï¼Œæƒ…å†µä¼šæ€ä¹ˆæ ·å‘¢ï¼Ÿå®‰å…¨åœ°å¤„ç†å¯é€‰ç±»å‹å’ŒæœªçŸ¥ç±»å‹éœ€è¦å¤§é‡çš„ä»£ç ï¼Œé‚£ä¹ˆé—®é¢˜å°±åœ¨äºæˆ‘ä»¬æ˜¯å¦æ„¿æ„ä¸ºç¼–å†™æµ‹è¯•åšæ‰€æœ‰çš„é¢å¤–å·¥ä½œã€‚è¿™å°±æ˜¯æˆ‘ä»¬è¿™å‘¨å°†è¦æ¢è®¨çš„é—®é¢˜ï¼Œè®©æˆ‘ä»¬å¼€å§‹æ·±å…¥ç ”ç©¶å§ï¼

## æµ‹è¯•ä»£ç  vs äº§å“ä»£ç 

å½“ç¼–å†™æµ‹è¯•ä»£ç æ—¶ï¼Œæˆ‘ä»¬ç»å¸¸æ˜ç¡®åŒºåˆ†**æµ‹è¯•ä»£ç **å’Œ**äº§å“ä»£ç **ã€‚å°½ç®¡ä¿æŒè¿™ä¸¤éƒ¨åˆ†ä»£ç çš„åˆ†ç¦»ååˆ†é‡è¦ï¼ˆæˆ‘ä»¬ä¸å¸Œæœ›æ„å¤–åœ°è®©æˆ‘ä»¬çš„æ¨¡æ‹Ÿæµ‹è¯•å¯¹è±¡æˆä¸º App Store ä¸Šæ¶çš„éƒ¨åˆ†ğŸ˜…ï¼‰ï¼Œä½†å°±**ä»£ç è´¨é‡**æ¥è¯´ï¼Œæ²¡æœ‰å¿…è¦è¿›è¡Œæ˜æ˜¾åŒºåˆ†ã€‚

å¦‚æœä½ æ€è€ƒä¸€ä¸‹çš„è¯ï¼Œæˆ‘ä»¬æƒ³è¦å¯¹ç§»äº¤ç»™ä½¿ç”¨è€…çš„ä»£ç è¿›è¡Œé«˜æ ‡å‡†çš„è¦æ±‚ï¼ŒåŸå› æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ

* æˆ‘ä»¬æƒ³è¦æˆ‘ä»¬çš„ app ä¸ºä½¿ç”¨è€…ç¨³å®šã€æµç•…åœ°è¿è¡Œã€‚
* æˆ‘ä»¬æƒ³è¦æˆ‘ä»¬çš„ app åœ¨æœªæ¥æ˜“äºç»´æŠ¤å’Œä¿®æ”¹ã€‚
* æˆ‘ä»¬æƒ³è¦æ›´å®¹æ˜“è®©æ–°äººèå…¥æˆ‘ä»¬çš„å›¢é˜Ÿã€‚

ç°åœ¨å¦‚æœåè¿‡æ¥è€ƒè™‘æˆ‘ä»¬çš„æµ‹è¯•ï¼Œæˆ‘ä»¬æƒ³è¦é¿å…å“ªäº›äº‹æƒ…å‘¢ï¼Ÿ

* æµ‹è¯•ä¸ç¨³å®šã€è„†å¼±ã€éš¾äºè°ƒè¯•ã€‚
* å½“æˆ‘ä»¬çš„ app å¢åŠ äº†æ–°åŠŸèƒ½æ—¶ï¼Œæˆ‘ä»¬çš„æµ‹è¯•ä»£ç éœ€è¦èŠ±è´¹å¤§é‡æ—¶é—´æ¥ç»´æŠ¤å’Œå‡çº§ã€‚
* æµ‹è¯•ä»£ç å¯¹äºåŠ å…¥å›¢é˜Ÿçš„æ–°äººæ¥è¯´éš¾äºç†è§£ã€‚

ä½ å¯èƒ½å·²ç»ç†è§£æˆ‘æ‰€è®²çš„å†…å®¹äº† ğŸ˜‰ã€‚

ä¹‹å‰å¾ˆé•¿çš„æ—¶é—´ï¼Œæˆ‘æ›¾è®¤ä¸ºæµ‹è¯•ä»£ç åªæ˜¯ä¸€äº›æˆ‘å¿«é€Ÿå †ç Œçš„ä»£ç ï¼Œå› ä¸ºæœ‰äººå‘Šè¯‰æˆ‘å¿…é¡»è¦ç¼–å†™æµ‹è¯•ã€‚æˆ‘ä¸é‚£ä¹ˆåœ¨ä¹å®ƒä»¬çš„è´¨é‡ï¼Œå› ä¸ºæˆ‘å°†å®ƒè§†ä¸ºä¸€ä»¶çäº‹ï¼Œå¹¶ä¸å°†å®ƒæ”¾åœ¨é¦–ä½ã€‚ç„¶è€Œï¼Œä¸€æ—¦æˆ‘å› ä¸ºç¼–å†™æµ‹è¯•è€Œå‘ç°éªŒè¯è‡ªå·±çš„ä»£ç æœ‰å¤šä¹ˆå¿«ï¼Œä»¥åŠå¯¹è‡ªå·±æœ‰å¤šä¹ˆè‡ªä¿¡ â€”â€” æˆ‘å¯¹æµ‹è¯•çš„æ€åº¦å°±å¼€å§‹äº†è½¬å˜ã€‚

æ‰€ç°åœ¨æˆ‘ç›¸ä¿¡å¯¹äºæµ‹è¯•ä»£ç ï¼Œå’Œå°†è¦ç§»äº¤çš„äº§å“ä»£ç è¿›è¡ŒåŒç­‰çš„é«˜æ ‡å‡†è¦æ±‚æ˜¯éå¸¸é‡è¦çš„ã€‚å› ä¸ºæˆ‘ä»¬é…å¥—çš„æµ‹è¯•æ˜¯éœ€è¦æˆ‘ä»¬é•¿æœŸä½¿ç”¨ã€æ‹“å±•å’ŒæŒæ¡çš„ï¼Œæˆ‘ä»¬ç†åº”è®©è¿™äº›å·¥ä½œæ›´å®¹æ˜“å®Œæˆã€‚

## å¼ºåˆ¶è§£æçš„é—®é¢˜

é‚£ä¹ˆè¿™ä¸€åˆ‡ä¸ Swift ä¸­çš„å¼ºåˆ¶è§£ææœ‰ä»€ä¹ˆå…³ç³»å‘¢ï¼ŸğŸ¤”

æœ‰æ—¶å¿…é¡»è¦å¼ºåˆ¶è§£æï¼Œå¾ˆå®¹æ˜“ç¼–å†™ä¸€ä¸ª â€œgo-to solutionâ€ çš„æµ‹è¯•ã€‚è®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä¾‹å­ï¼Œæµ‹è¯• `UserService` å®ç°çš„ç™»é™†æœºåˆ¶æ˜¯å¦æ­£å¸¸å·¥ä½œï¼š

```
class UserServiceTests: XCTestCase {
    func testLoggingIn() {
        // ä¸ºäº†ç™»é™†ç»ˆç«¯
        // æ„å»ºä¸€ä¸ªæ°¸è¿œè¿”å›æˆåŠŸçš„æ¨¡æ‹Ÿå¯¹è±¡
        let networkManager = NetworkManagerMock()
        networkManager.mockResponse(forEndpoint: .login, with: [
            "name": "John",
            "age": 30
        ])

        // æ„å»º service å¯¹è±¡ä»¥åŠç™»å½•
        let service = UserService(networkManager: networkManager)
        service.login(withUsername: "john", password: "password")

        // ç°åœ¨æˆ‘ä»¬æƒ³è¦åŸºäºå·²ç™»é™†çš„ç”¨æˆ·è¿›è¡Œæ–­è¨€ï¼Œ
        // è¿™æ˜¯å¯é€‰ç±»å‹ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯¹å®ƒè¿›è¡Œå¼ºåˆ¶è§£æ
        let user = service.loggedInUser!
        XCTAssertEqual(user.name, "John")
        XCTAssertEqual(user.age, 30)
    }
}
```

å¦‚ä½ æ‰€è§ï¼Œåœ¨è¿›è¡Œæ–­è¨€ä¹‹å‰ï¼Œæˆ‘ä»¬å¼ºåˆ¶è§£æäº† service å¯¹è±¡çš„ `loggedInUser` å±æ€§ã€‚åƒä¸Šé¢è¿™æ ·çš„åšæ³•å¹¶ä¸æ˜¯ç»å¯¹æ„ä¹‰ä¸Šçš„é”™ï¼Œä½†æ˜¯å¦‚æœè¿™ä¸ªæµ‹è¯•å› ä¸ºä¸€äº›åŸå› å¼€å§‹å¤±è´¥ï¼Œå°±å¯èƒ½ä¼šå¯¼è‡´ä¸€äº›é—®é¢˜ã€‚

å‡è®¾æŸäººï¼ˆè®°ä½ï¼Œâ€œæŸäººâ€å¯èƒ½å°±æ˜¯â€œæœªæ¥çš„ä½ è‡ªå·±â€ğŸ˜‰ï¼‰æ”¹å˜äº†ç½‘ç»œéƒ¨åˆ†çš„ä»£ç ï¼Œå¯¼è‡´ä¸Šè¿°æµ‹è¯•å¼€å§‹å´©æºƒã€‚å¦‚æœè¿™æ ·çš„äº‹æƒ…å‘ç”Ÿäº†ï¼Œé”™è¯¯ä¿¡æ¯å¯èƒ½åªä¼šåƒä¸‹é¢è¿™æ ·ï¼š

```
Fatal error: Unexpectedly found nil while unwrapping an Optional value
```

å°½ç®¡ç”¨ Xcode æœ¬åœ°è¿è¡Œæ—¶è¿™ä¸æ˜¯ä¸ªå¤§é—®é¢˜ï¼ˆå› ä¸ºé”™è¯¯ä¼šè¢«å…³è”åœ°æ˜¾ç¤º â€”â€” è‡³å°‘åœ¨å¤§å¤šæ•°æ—¶å€™ ğŸ™ƒï¼‰ï¼Œä½†å½“è¿ç»­åœ°æ•´ä½“è¿è¡Œæ•´ä¸ªé¡¹ç›®æ—¶ï¼Œå®ƒå¯èƒ½é—®é¢˜é‡é‡ã€‚ä¸Šè¿°çš„é”™è¯¯ä¿¡æ¯å¯èƒ½å‡ºç°åœ¨å·¨å¤§çš„â€œæ–‡å­—å¢™â€ä¸­ï¼Œå¯¼è‡´éš¾ä»¥çœ‹å‡ºé”™è¯¯çš„æ¥æºã€‚æ›´ä¸¥é‡çš„æ˜¯ï¼Œå®ƒä¼š**é˜»æ­¢åç»­çš„æµ‹è¯•è¢«æ‰§è¡Œ**ï¼ˆå› ä¸ºæµ‹è¯•è¿›ç¨‹ä¼šå´©æºƒï¼‰ï¼Œè¿™å°†å¯¼è‡´ä¿®å¤å·¥ä½œè¿›å±•ç¼“æ…¢å¹¶ä¸”ä»¤äººçƒ¦èºã€‚

## Guard å’Œ XCTFail

ä¸€ä¸ªæ½œåœ¨çš„è§£å†³ä¸Šè¿°é—®é¢˜çš„æ–¹å¼æ˜¯ç®€å•åœ°ä½¿ç”¨ `guard` å£°æ˜ï¼Œä¼˜é›…åœ°è§£æé—®é¢˜ä¸­çš„å¯é€‰ç±»å‹ï¼Œå¦‚æœè§£æå¤±è´¥å†è°ƒç”¨ `XCTFail` å³å¯ï¼Œå°±åƒä¸‹é¢è¿™æ ·ï¼š

```
guard let user = service.loggedInUser else {
    XCTFail("Expected a user to be logged in at this point")
    return
}
```

å°½ç®¡ä¸Šè¿°åšæ³•åœ¨æŸäº›æƒ…å†µä¸‹æ˜¯æ­£ç¡®çš„åšæ³•ï¼Œä½†äº‹å®ä¸Šæˆ‘æ¨èé¿å…ä½¿ç”¨å®ƒ â€”â€” å› ä¸ºå®ƒå‘ä½ çš„æµ‹è¯•ä¸­å¢åŠ äº†æ§åˆ¶æµã€‚ä¸ºäº†ç¨³å®šæ€§å’Œå¯é¢„æµ‹æ€§ï¼Œä½ é€šå¸¸å¸Œæœ›æµ‹è¯•åªæ˜¯ç®€å•çš„éµå¾ª **givenï¼Œwhenï¼Œthen** ç»“æ„ï¼Œå¹¶ä¸”å¢åŠ æ§åˆ¶æµä¼šä½¿å¾—æµ‹è¯•ä»£ç éš¾äºç†è§£ã€‚å¦‚æœä½ çœŸçš„éå¸¸å€’éœ‰ï¼Œæ§åˆ¶æµå¯èƒ½æˆä¸ºè¯¯æŠ¥çš„èµ·æºï¼ˆå¯¹æ­¤ä¹‹åçš„æ–‡ç« ä¼šæœ‰æ›´å¤šçš„ç›¸å…³å†…å®¹ï¼‰ã€‚

## ä¿æŒå¯é€‰ç±»å‹

å¦ä¸€ä¸ªæ–¹æ³•æ˜¯è®©å¯é€‰ç±»å‹ä¸€ç›´ä¿æŒå¯é€‰ã€‚è¿™åœ¨æŸäº›ä½¿ç”¨æƒ…å†µä¸‹å®Œå…¨å¯ç”¨ï¼ŒåŒ…æ‹¬æˆ‘ä»¬ `UserManager` çš„ä¾‹å­ã€‚å› ä¸ºæˆ‘ä»¬å¯¹å·²ç»ç™»å½•çš„ user çš„ `name` å’Œ `age` å±æ€§ä½¿ç”¨äº†æ–­è¨€ï¼Œå¦‚æœä»»æ„ä¸€ä¸ªå±æ€§ä¸º `nil` ï¼Œæˆ‘ä»¬ä¼šè‡ªåŠ¨å¾—åˆ°é”™è¯¯æç¤ºã€‚åŒæ—¶å¦‚æœæˆ‘ä»¬å¯¹ user ä½¿ç”¨é¢å¤–çš„ `XCTAssertNotNil` æ£€æŸ¥ï¼Œæˆ‘ä»¬å°±èƒ½å¾—åˆ°ä¸€ä¸ªéå¸¸å®Œæ•´çš„è¯Šæ–­ä¿¡æ¯ã€‚

```
let user = service.loggedInUser
XCTAssertNotNil(user, "Expected a user to be logged in at this point")
XCTAssertEqual(user?.name, "John")
XCTAssertEqual(user?.age, 30)
```

ç°åœ¨å¦‚æœæˆ‘ä»¬çš„æµ‹è¯•å¼€å§‹å‡ºé”™äº†ï¼Œæˆ‘ä»¬å°±èƒ½å¾—åˆ°å¦‚ä¸‹ä¿¡æ¯ï¼š

```
XCTAssertNotNil failed - Expected a user to be logged in at this point
XCTAssertEqual failed: ("nil") is not equal to ("Optional("John")")
XCTAssertEqual failed: ("nil") is not equal to ("Optional(30)")
```

è¿™è®©æˆ‘ä»¬èƒ½å¤Ÿæ›´åŠ å®¹æ˜“åœ°çŸ¥é“å‘ç”Ÿé”™è¯¯çš„åœ°æ–¹ï¼Œä»¥åŠè¯¥ä»å“ªé‡Œå…¥æ‰‹å»è°ƒè¯•ã€è§£å†³è¿™ä¸ªé”™è¯¯ ğŸ‰ã€‚

## ä½¿ç”¨ throw çš„æµ‹è¯•

ç¬¬ä¸‰ä¸ªé€‰æ‹©åœ¨æŸäº›æƒ…å†µä¸‹æ˜¯éå¸¸æœ‰ç”¨çš„ï¼Œå°±æ˜¯å°†è¿”å›å¯é€‰ç±»å‹çš„ API æ›¿æ¢ä¸º throwing APIã€‚Swift ä¸­çš„ throwing API çš„ä¼˜é›…ä¹‹å¤„åœ¨äºï¼Œéœ€è¦æ—¶å®ƒèƒ½å¤Ÿéå¸¸å®¹æ˜“åœ°è¢«å½“æˆå¯é€‰ç±»å‹ä½¿ç”¨ã€‚æ‰€ä»¥å¾ˆå¤šæ—¶å€™é€‰æ‹©é‡‡ç”¨ throwing æ–¹æ³•ï¼Œä¸éœ€è¦ç‰ºç‰²ä»»ä½•çš„å¯ç”¨æ€§ã€‚æ¯”å¦‚è¯´ï¼Œå‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ª `EndpointURLFactory` ç±»ï¼Œè¢«ç”¨æ¥åœ¨æˆ‘ä»¬çš„ app ä¸­ç”Ÿæˆç‰¹å®šç»ˆç«¯çš„ URLï¼Œè¿™æ˜¾ç„¶ä¼šè¿”å›å¯é€‰ç±»å‹ï¼š

```
class EndpointURLFactory {
    func makeURL(for endpoint: Endpoint) -> URL? {
        ...
    }
}
```

ç°åœ¨æˆ‘ä»¬å°†å…¶è½¬æ¢ä¸ºé‡‡ç”¨ throwing APIï¼Œåƒè¿™æ ·ï¼š

```
class EndpointURLFactory {
    func makeURL(for endpoint: Endpoint) throws -> URL {
        ...
    }
}
```

å½“æˆ‘ä»¬ä»ç„¶æƒ³å¾—åˆ°ä¸€ä¸ªå¯é€‰ç±»å‹çš„ URL æ—¶ï¼Œæˆ‘ä»¬åªéœ€è¦ä½¿ç”¨ `try?` å‘½ä»¤å»è°ƒç”¨å®ƒï¼š

```
let loginEndpoint = try? urlFactory.makeURL(for: .login)
```

å°±æµ‹è¯•è€Œè¨€ï¼Œä¸Šè¿°è¿™ç§åšæ³•çš„æœ€å¤§å¥½å¤„åœ¨äºå¯ä»¥åœ¨æµ‹è¯•ä¸­è½»æ¾åœ°ä½¿ç”¨ `try`ï¼Œå¹¶ä¸”ä½¿ç”¨ XCTest runner å®Œå…¨å¯ä»¥æ¯«æ— ä»£ä»·åœ°å¤„ç†æ— æ•ˆå€¼ã€‚è¿™æ˜¯é²œä¸ºäººçŸ¥çš„ï¼Œä½†äº‹å®ä¸Š Swift æµ‹è¯•å¯ä»¥æ˜¯ throwing å‡½æ•°ï¼Œçœ‹çœ‹è¿™ä¸ªï¼š

```
class EndpointURLFactoryTests: XCTestCase {
    func testSearchURLContainsQuery() throws {
        let factory = EndpointURLFactory()
        let query = "Swift"

        // å› ä¸ºæˆ‘ä»¬çš„æµ‹è¯•å‡½æ•°æ˜¯ throwingï¼Œè¿™é‡Œæˆ‘ä»¬å¯ä»¥ç®€å•åœ°é‡‡ç”¨ 'try'
        let url = try factory.makeURL(for: .search(query))
        XCTAssertTrue(url.absoluteString.contains(query))
    }
}
```

æ²¡æœ‰å¯é€‰ç±»å‹ï¼Œæ²¡æœ‰å¼ºåˆ¶è§£æï¼ŒæŸäº›å‘ç”Ÿé”™è¯¯çš„æ—¶å€™ä¹Ÿèƒ½å®Œç¾åœ°åšå‡ºè¯Šæ–­ ğŸ‘ã€‚

## ä½¿ç”¨ require çš„å¯é€‰ç±»å‹

ç„¶è€Œï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰è¿”å›å¯é€‰ç±»å‹çš„ API éƒ½å¯ä»¥è¢«æ›¿æ¢ä¸º throwingã€‚ä¸è¿‡åœ¨å†™åŒ…å«å¯é€‰ç±»å‹çš„æµ‹è¯•æ—¶ï¼Œæœ‰ä¸€ä¸ªå’Œ throwing API åŒæ ·å¥½çš„æ–¹æ³•ã€‚

è®©æˆ‘ä»¬å›åˆ°æœ€å¼€å§‹ `UserManager` çš„ä¾‹å­ã€‚å¦‚æœæ—¢ä¸å¯¹ `loggedInUser` è¿›è¡Œå¼ºåˆ¶è§£æï¼Œåˆä¸æŠŠå®ƒçœ‹ä½œå¯é€‰ç±»å‹ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ç®€å•åœ°è¿™æ ·åšï¼š

```
let user = try require(service.loggedInUser)
XCTAssertEqual(user.name, "John")
XCTAssertEqual(user.age, 30)
```

è¿™å®åœ¨æ˜¯å¤ªé…·äº†ï¼ğŸ˜è¿™æ ·æˆ‘ä»¬å¯ä»¥æ‘†è„±å¤§é‡çš„å¼ºåˆ¶è§£æï¼ŒåŒæ—¶é¿å…è®©æˆ‘ä»¬çš„æµ‹è¯•ä»£ç éš¾äºç¼–å†™ã€éš¾äºä¸Šæ‰‹ã€‚é‚£ä¹ˆä¸ºäº†è¾¾åˆ°ä¸Šè¿°æ•ˆæœæˆ‘ä»¬åº”è¯¥æ€ä¹ˆåšå‘¢ï¼Ÿè¿™å¾ˆç®€å•ï¼Œæˆ‘ä»¬åªéœ€è¦å¯¹ `XCTestCase` å¢åŠ ä¸€ä¸ªæ‹“å±•ï¼Œè®©æˆ‘ä»¬åˆ†æä»»ä½•å¯é€‰ç±»å‹è¡¨è¾¾å¼ï¼Œå¹¶ä¸”è¿”å›éå¯é€‰çš„å€¼æˆ–è€…æŠ›å‡ºä¸€ä¸ªé”™è¯¯ï¼Œåƒè¿™æ ·ï¼š

```
extension XCTestCase {
    // ä¸ºäº†èƒ½å¤Ÿè¾“å‡ºä¼˜é›…çš„é”™è¯¯ä¿¡æ¯
    // æˆ‘ä»¬éµå¾ª LocallizedErrow
    private struct RequireError<T>: LocalizedError {
        let file: StaticString
        let line: UInt

        // å®ç°è¿™ä¸ªå±æ€§éå¸¸é‡è¦
        // å¦åˆ™æµ‹è¯•å¤±è´¥æ—¶æˆ‘ä»¬æ— æ³•åœ¨è®°å½•ä¸­ä¼˜é›…åœ°è¾“å‡ºé”™è¯¯ä¿¡æ¯
        var errorDescription: String? {
            return "ğŸ˜± Required value of type \(T.self) was nil at line \(line) in file \(file)."
        }
    }

    // ä½¿ç”¨ file å’Œ line ä½¿å¾—æˆ‘ä»¬èƒ½å¤Ÿè‡ªåŠ¨æ•è·
    // æºä»£ç ä¸­å‡ºç°çš„ç›¸å¯¹åº”çš„è¡¨è¾¾å¼
    func require<T>(_ expression: @autoclosure () -> T?,
                    file: StaticString = #file,
                    line: UInt = #line) throws -> T {
        guard let value = expression() else {
            throw RequireError<T>(file: file, line: line)
        }

        return value
    }
}
```

ç°åœ¨æœ‰äº†ä¸Šè¿°å†…å®¹ï¼Œå¦‚æœæˆ‘ä»¬ `UserManager` ç™»å½•æµ‹è¯•å‘ç”Ÿå¤±è´¥ï¼Œæˆ‘ä»¬ä¹Ÿèƒ½å¾—åˆ°ä¸€ä¸ªéå¸¸ä¼˜é›…çš„é”™è¯¯ä¿¡æ¯ï¼Œå‘Šè¯‰æˆ‘ä»¬é”™è¯¯å‘ç”Ÿçš„å‡†ç¡®ä½ç½®ã€‚

```
[UserServiceTests testLoggingIn] : failed: caught error: ğŸ˜± Required value of type User was nil at line 97 in file UserServiceTests.swift.
```

**ä½ å¯èƒ½æ„è¯†åˆ°è¿™ä¸ªæŠ€å·§æ¥æºäºæˆ‘çš„è¿·ä½ æ¡†æ¶ [Require](https://github.com/johnsundell/require), å®ƒå¯¹æ‰€æœ‰å¯é€‰ç±»å‹å¢åŠ äº†ä¸€ä¸ª require() æ–¹æ³•ï¼Œä»¥æé«˜å¯¹æ— æ³•é¿å…çš„å¼ºåˆ¶è§£æçš„è¯Šæ–­æ•ˆæœã€‚**

## æ€»ç»“

ä»¥åŒæ ·è°¨æ…çš„æ€åº¦å¯¹å¾…ä½ çš„åº”ç”¨ä»£ç å’Œæµ‹è¯•ä»£ç ï¼Œåœ¨æœ€å¼€å§‹å¯èƒ½æœ‰äº›ä¸é€‚åº”ï¼Œä½†å¯ä»¥è®©é•¿æœŸç»´æŠ¤æµ‹è¯•å˜çš„æ›´åŠ ç®€å• â€”â€” ä¸è®ºæ˜¯ç‹¬ç«‹å¼€å‘è¿˜æ˜¯å›¢é˜Ÿå¼€å‘ã€‚è‰¯å¥½çš„é”™è¯¯è¯Šæ–­å’Œé”™è¯¯ä¿¡æ¯æ˜¯å…¶ä¸­ç‰¹åˆ«é‡è¦çš„ä¸€éƒ¨åˆ†ï¼Œä½¿ç”¨æœ¬æ–‡ä¸­çš„ä¸€äº›æŠ€å·§æˆ–è®¸èƒ½å¤Ÿè®©ä½ åœ¨æœªæ¥é¿å…å¾ˆå¤šå¥‡æ€ªçš„é—®é¢˜ã€‚

æˆ‘åœ¨æµ‹è¯•ä»£ç ä¸­å”¯ä¸€ä½¿ç”¨å¼ºåˆ¶è§£æçš„æ—¶å€™ï¼Œå°±æ˜¯åœ¨æ„å»ºæµ‹è¯•æ¡ˆä¾‹çš„å±æ€§æ—¶ã€‚å› ä¸ºè¿™äº›æ€»æ˜¯åœ¨ `setUp` ä¸­è¢«åˆ›å»ºã€`tearDown` ä¸­è¢«é”€æ¯ï¼Œæˆ‘å¹¶ä¸æŠŠä»–ä»¬å½“ä½œçœŸæ­£çš„å¯é€‰ç±»å‹ã€‚æ­£å¦‚ä»¥å¾€ï¼Œä½ åŒæ ·éœ€è¦æŸ¥çœ‹ä½ è‡ªå·±çš„ä»£ç ï¼Œæ ¹æ®ä½ è‡ªå·±çš„å–œå¥½ï¼Œæ¥æƒè¡¡å†³å®šã€‚

æ‰€ä»¥ä½ è§‰å¾—å‘¢ï¼Ÿä½ ä¼šé‡‡ç”¨ä¸€äº›æœ¬æ–‡ä¸­çš„æŠ€å·§ï¼Œè¿˜æ˜¯ä½ å·²ç»ç”¨äº†ä¸€äº›ç›¸å…³çš„æ–¹å¼ï¼Ÿè¯·è®©æˆ‘çŸ¥é“ï¼ŒåŒ…æ‹¬ä½ å¯èƒ½æœ‰çš„ä»»ä½•çš„é—®é¢˜ã€è¯„ä»·å’Œåé¦ˆ â€”â€” å¯ä»¥åœ¨ä¸‹é¢å›å¤æ ç›´æ¥å›å¤æˆ–è€…åœ¨ [Twitter @johnsundell](https://twitter.com/johnsundell) ä¸Šå›å¤æˆ‘ã€‚

æ„Ÿè°¢é˜…è¯»ï¼ğŸš€

---

> [æ˜é‡‘ç¿»è¯‘è®¡åˆ’](https://github.com/xitu/gold-miner) æ˜¯ä¸€ä¸ªç¿»è¯‘ä¼˜è´¨äº’è”ç½‘æŠ€æœ¯æ–‡ç« çš„ç¤¾åŒºï¼Œæ–‡ç« æ¥æºä¸º [æ˜é‡‘](https://juejin.im) ä¸Šçš„è‹±æ–‡åˆ†äº«æ–‡ç« ã€‚å†…å®¹è¦†ç›– [Android](https://github.com/xitu/gold-miner#android)ã€[iOS](https://github.com/xitu/gold-miner#ios)ã€[å‰ç«¯](https://github.com/xitu/gold-miner#å‰ç«¯)ã€[åç«¯](https://github.com/xitu/gold-miner#åç«¯)ã€[åŒºå—é“¾](https://github.com/xitu/gold-miner#åŒºå—é“¾)ã€[äº§å“](https://github.com/xitu/gold-miner#äº§å“)ã€[è®¾è®¡](https://github.com/xitu/gold-miner#è®¾è®¡)ã€[äººå·¥æ™ºèƒ½](https://github.com/xitu/gold-miner#äººå·¥æ™ºèƒ½)ç­‰é¢†åŸŸï¼Œæƒ³è¦æŸ¥çœ‹æ›´å¤šä¼˜è´¨è¯‘æ–‡è¯·æŒç»­å…³æ³¨ [æ˜é‡‘ç¿»è¯‘è®¡åˆ’](https://github.com/xitu/gold-miner)ã€[å®˜æ–¹å¾®åš](http://weibo.com/juejinfanyi)ã€[çŸ¥ä¹ä¸“æ ](https://zhuanlan.zhihu.com/juejinfanyi)ã€‚
