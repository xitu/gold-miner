> * åŸæ–‡åœ°å€ï¼š[iOS 11: Machine Learning for everyone](http://machinethink.net/blog/ios-11-machine-learning-for-everyone/)
> * åŸæ–‡ä½œè€…ï¼šæœ¬æ–‡å·²è·åŸä½œè€… [Matthijs Hollemans](https://twitter.com/mhollemans) æˆæƒ
> * è¯‘æ–‡å‡ºè‡ªï¼š[æ˜é‡‘ç¿»è¯‘è®¡åˆ’](https://github.com/xitu/gold-miner)
> * è¯‘è€…ï¼š[Changkun Ou](https://github.com/changkun/)
> * æ ¡å¯¹è€…ï¼š[wilsonandusa](https://github.com/wilsonandusa) [atuooo](https://github.com/atuooo)

WWDC 2017 ä½¿ä¸€ä»¶äº‹æƒ…å˜å¾—éå¸¸æ¸…æ¥šï¼Œé‚£å°±æ˜¯ï¼šApple æ­£åœ¨å…¨åŠ›ä»¥èµ´åœ°æ”¯æŒã€Œ**è®¾å¤‡ä¸Šçš„æœºå™¨å­¦ä¹ **ã€äº†ã€‚

ä»–ä»¬å¸Œæœ› App çš„å¼€å‘è€…ä»¬èƒ½å¤Ÿå°½å¯èƒ½çš„ç®€å•çš„åŠ å…¥ä»–ä»¬çš„è¡Œåˆ—ä¸­ã€‚

Apple å»å¹´å‘å¸ƒäº†å¯ä»¥ç”¨äºåˆ›å»ºåŸºæœ¬çš„å·ç§¯ç¥ç»ç½‘çš„ Metal CNN å’Œ BNNS æ¡†æ¶ã€‚ä»Šå¹´ï¼ŒMetal å¾—åˆ°äº†è¿›ä¸€æ­¥æ‰©å±•ï¼Œå¢åŠ äº†ä¸€ä¸ªå…¨æ–°çš„è®¡ç®—æœºè§†è§‰æ¡†æ¶ï¼Œä»¥åŠ **Core ML**ï¼šä¸€ä¸ªèƒ½å¤Ÿè½»æ¾åœ°å°†æœºå™¨å­¦ä¹ é›†æˆåˆ° App ä¸­çš„å·¥å…·åŒ…ã€‚

[![Core ML framework](http://machinethink.net/images/ios11/CoreML.png)](http://machinethink.net/images/ios11/CoreML.png)

åœ¨è¿™ç‰‡æ–‡ç« ä¸­ï¼Œæˆ‘å°†å°± iOS 11 å’Œ macOS 10.13 ä¸­è¿™äº›æ–°æ¨å‡ºçš„æœºå™¨å­¦ä¹ çš„å†…å®¹ï¼Œåˆ†äº«æˆ‘è‡ªå·±çš„ä¸€äº›æƒ³æ³•å’Œç»éªŒã€‚

## Core ML

Core ML åœ¨ WWDC ä¸Šè·å¾—äº†æå¤§çš„å…³æ³¨åº¦ï¼ŒåŸå› å¾ˆç®€å•ï¼šå¤§éƒ¨åˆ†å¼€å‘è€…å¸Œæœ›èƒ½å¤Ÿåœ¨ä»–ä»¬çš„ App ä¸­ä½¿ç”¨è¿™ä¸ªæ¡†æ¶ã€‚

Core ML çš„ API éå¸¸ç®€å•ã€‚ä½ åªèƒ½ç”¨å®ƒåšè¿™äº›äº‹æƒ…ï¼š

1. åŠ è½½ä¸€ä¸ªè®­ç»ƒå¥½çš„æ¨¡å‹
2. åšå‡ºé¢„æµ‹
3. æ”¶ç›Šï¼ï¼ï¼

è¿™çœ‹èµ·æ¥å¥½åƒå¾ˆæœ‰é™ï¼Œä½†å®é™…ä¸Šä½ ä¸€èˆ¬åªä¼šåœ¨ App ä¸­åŠ è½½æ¨¡å‹å’Œåšå‡ºé¢„æµ‹è¿™ä¸¤ä»¶äº‹ã€‚

åœ¨ Core ML ä¹‹å‰ï¼ŒåŠ è½½è®­ç»ƒå¥½çš„æ¨¡å‹æ˜¯éå¸¸å›°éš¾çš„ â€”â€” å®é™…ä¸Šï¼Œæˆ‘å†™è¿‡[ä¸€ä¸ªæ¡†æ¶](http://github.com/hollance/Forge)æ¥å‡è½»è¿™ç§ç—›è‹¦ã€‚æ‰€ä»¥ç°åœ¨æˆ‘å¯¹è¿™ä¸€ä¸ªç®€å•çš„ä¸¤æ­¥è¿‡ç¨‹æ„Ÿåˆ°éå¸¸é«˜å…´ã€‚

æ¨¡å‹è¢«åŒ…å«åœ¨äº†ä¸€ä¸ª **.mlmodel** çš„æ–‡ä»¶ä¸­ã€‚è¿™æ˜¯ä¸€ç§æ–°çš„[å¼€æºæ–‡ä»¶æ ¼å¼](https://pypi.python.org/pypi/coremltools)ï¼Œç”¨äºæè¿°æ¨¡å‹ä¸­çš„ layerã€è¾“å…¥è¾“å‡ºã€æ ‡ç­¾ï¼Œä»¥åŠéœ€è¦åœ¨æ•°æ®ä¸Šäº§ç”Ÿçš„ä»»ä½•é¢„å¤„ç†è¿‡ç¨‹ã€‚å®ƒè¿˜åŒ…æ‹¬äº†æ‰€æœ‰çš„å­¦ä¹ å‚æ•°ï¼ˆæƒé‡å’Œåç½®ï¼‰ã€‚

ä½¿ç”¨æ¨¡å‹æ‰€éœ€çš„ä¸€åˆ‡éƒ½åœ¨è¿™ä¸€ä¸ªæ–‡ä»¶é‡Œé¢äº†ã€‚

ä½ åªéœ€è¦å°† mlmodel æ–‡ä»¶æ”¾å…¥ä½ çš„é¡¹ç›®ä¸­ï¼ŒXcode å°†ä¼šè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ª Swift æˆ– Objective-C çš„åŒ…è£…ç±»ï¼Œä½¿ä½ èƒ½ç®€å•çš„ä½¿ç”¨è¿™ä¸ªæ¨¡å‹ã€‚

ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æœä½ æŠŠæ–‡ä»¶ **ResNet50.mlmodel** æ·»åŠ åˆ°ä½ çš„ Xcode é¡¹ç›®ä¸­ï¼Œé‚£ä¹ˆä½ å°±å¯ä»¥è¿™ä¹ˆå†™æ¥å®ä¾‹åŒ–è¿™ä¸ªæ¨¡å‹ï¼š

```swift
let model = ResNet50()
```


ç„¶ååšå‡ºé¢„æµ‹ï¼š

```swift
let pixelBuffer: CVPixelBuffer = /* your image */if let prediction = try? model.prediction(image: pixelBuffer) {
  print(prediction.classLabel)
}
```


è¿™å·®ä¸å¤šå°±æ˜¯æ‰€æœ‰è¦å†™çš„ä¸œè¥¿äº†ã€‚ä½ ä¸éœ€è¦ç¼–å†™ä»»ä½•ä»£ç æ¥åŠ è½½æ¨¡å‹ï¼Œæˆ–è€…å°†å…¶è¾“å‡ºè½¬æ¢æˆå¯ä»¥ä» Swift ç›´æ¥ä½¿ç”¨çš„å†…å®¹ â€”â€” è¿™ä¸€åˆ‡éƒ½å°†ç”± Core ML å’Œ Xcode æ¥å¤„ç†ã€‚

**æ³¨æ„:** è¦äº†è§£èƒŒåå‘ç”Ÿäº†ä»€ä¹ˆï¼Œå¯ä»¥åœ¨ Project Navigator é‡Œé€‰æ‹© **mlmodel** æ–‡ä»¶ï¼Œç„¶åç‚¹å‡» Swift generated source å³è¾¹çš„ç®­å¤´æŒ‰é’®ï¼Œå°±èƒ½å¤ŸæŸ¥çœ‹ç”Ÿæˆçš„å¸®åŠ©ä»£ç äº†ã€‚

Core ML å°†å†³å®šè‡ªå·±åˆ°åº•æ˜¯åœ¨ CPU ä¸Šè¿è¡Œè¿˜æ˜¯ GPU ä¸Šè¿è¡Œã€‚è¿™ä½¿å¾—å®ƒèƒ½å¤Ÿå……åˆ†çš„åˆ©ç”¨å¯ä»¥ç”¨çš„èµ„æºã€‚Core ML ç”šè‡³å¯ä»¥å°†æ¨¡å‹åˆ†å‰²æˆä»…åœ¨ GPU ä¸Šæ‰§è¡Œçš„éƒ¨åˆ†ï¼ˆéœ€è¦å¤§é‡è®¡ç®—çš„ä»»åŠ¡ï¼‰ä»¥åŠ CPU ä¸Šçš„å…¶ä»–éƒ¨åˆ†ï¼ˆéœ€è¦å¤§é‡å†…å­˜çš„ä»»åŠ¡ï¼‰ã€‚

Core ML ä½¿ç”¨ CPU çš„èƒ½åŠ›å¯¹äºæˆ‘ä»¬å¼€å‘è€…æ¥è¯´å¦ä¸€ä¸ªå¾ˆå¤§çš„å¥½å¤„æ˜¯ï¼šä½ å¯ä»¥ä» iOS æ¨¡æ‹Ÿå™¨è¿è¡Œå®ƒï¼Œä»è€Œè¿è¡Œé‚£äº›å¯¹äº Metal æ¥è¯´åšä¸åˆ°ï¼ŒåŒæ—¶åœ¨å•å…ƒæµ‹è¯•ä¸­ä¹Ÿä¸å¤ªå¥½çš„ä»»åŠ¡ã€‚

### Core ML æ”¯æŒä»€ä¹ˆæ¨¡å‹ï¼Ÿ

ä¸Šé¢çš„ ResNet50 ä¾‹å­å±•ç¤ºçš„æ˜¯ä¸€ä¸ªå›¾åƒåˆ†ç±»å™¨ï¼Œä½†æ˜¯ Core ML å¯ä»¥å¤„ç†å‡ ç§ä¸åŒç±»å‹çš„æ¨¡å‹ï¼Œå¦‚ï¼š

- æ”¯æŒå‘é‡æœº SVM
- è¯¸å¦‚éšæœºæ£®æ—å’Œæå‡æ ‘çš„å†³ç­–æ ‘é›†æˆ
- çº¿æ€§å›å½’å’Œ logistic å›å½’
- å‰é¦ˆç¥ç»ç½‘ã€å·ç§¯ç¥ç»ç½‘ã€é€’å½’ç¥ç»ç½‘

æ‰€æœ‰è¿™äº›æ¨¡å‹éƒ½å¯ä»¥ç”¨äºå›å½’é—®é¢˜å’Œåˆ†ç±»é—®é¢˜ã€‚æ­¤å¤–ï¼Œä½ çš„æ¨¡å‹å¯ä»¥åŒ…å«è¿™äº›å…¸å‹çš„æœºå™¨å­¦ä¹ é¢„å¤„ç†æ“ä½œï¼Œä¾‹å¦‚ç‹¬çƒ­ç¼–ç ï¼ˆone-hot encodingï¼‰ã€ç‰¹å¾ç¼©æ”¾ï¼ˆfeature scalingï¼‰ã€ç¼ºå¤±å€¼å¤„ç†ç­‰ç­‰ã€‚

Apple æä¾›äº†å¾ˆå¤šå·²ç»è®­ç»ƒå¥½çš„æ¨¡å‹[å¯ä¾›ä¸‹è½½](http://developer.apple.com/machine-learning/)ï¼Œä¾‹å¦‚ Inception v3ã€ResNet50 å’Œ VGG16 ç­‰ï¼Œä½†ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ [Core ML Tools](https://pypi.python.org/pypi/coremltools) è¿™ä¸ª Python åº“æ¥è½¬æ¢è‡ªå·±çš„æ¨¡å‹ã€‚

ç›®å‰ï¼Œä½ å¯ä»¥è½¬æ¢ä½¿ç”¨ Kerasã€Caffeã€scikit-learnã€XGBoost å’Œ libSVM è®­ç»ƒçš„æ¨¡å‹ã€‚è½¬æ¢å·¥å…·åªä¼šæ”¯æŒå…·ä½“æŒ‡å®šçš„ç‰ˆæœ¬ï¼Œæ¯”å¦‚ Keras æ”¯æŒ 1.2.2 ä½†ä¸æ”¯æŒ 2.0ã€‚è¾›è¿çš„æ˜¯ï¼Œè¯¥å·¥å…·æ˜¯å¼€æºçš„ï¼Œæ‰€ä»¥æ¯«æ— ç–‘é—®å®ƒå°†æ¥ä¼šæ”¯æŒæ›´å¤šçš„è®­ç»ƒå·¥å…·åŒ…ã€‚

å¦‚æœè¿™äº›éƒ½ä¸è¡Œï¼Œä½ è¿˜æ˜¯å¯ä»¥éšæ—¶ç¼–å†™è‡ªå·±çš„è½¬æ¢å™¨ã€‚**mlmodel** æ–‡ä»¶æ ¼å¼æ˜¯å¼€æºä¸”å¯ä»¥ç›´æ¥ä½¿ç”¨çš„ï¼ˆç”± Apple åˆ¶å®šå‘å¸ƒçš„ä¸€ç§ protobuf æ ¼å¼ï¼‰

### å±€é™ 

å¦‚æœä½ æƒ³åœ¨ä½ çš„ App ä¸Šé©¬ä¸Šè¿è¡Œä¸€ä¸ªæ¨¡å‹ï¼Œ Core ML å¾ˆä¸é”™ã€‚ç„¶è€Œä½¿ç”¨è¿™æ ·ä¸€ä¸ªç®€å•çš„ API ä¸€å®šä¼šæœ‰ä¸€äº›é™åˆ¶ã€‚

- ä»…æ”¯æŒ**æœ‰ç›‘ç£**å­¦ä¹ çš„æ¨¡å‹ï¼Œæ— ç›‘ç£å­¦ä¹ å’Œå¢å¼ºå­¦ä¹ éƒ½æ˜¯ä¸è¡Œçš„ã€‚ï¼ˆä¸è¿‡æœ‰ä¸€ä¸ªã€Œé€šç”¨ã€çš„ç¥ç»ç½‘ç»œç±»å‹æ”¯æŒï¼Œå› æ­¤ä½ å¯ä»¥ä½¿ç”¨å®ƒï¼‰
- è®¾å¤‡ä¸Šä¸èƒ½è¿›è¡Œè®­ç»ƒã€‚ä½ éœ€è¦ä½¿ç”¨ç¦»çº¿å·¥å…·åŒ…æ¥è¿›è¡Œè®­ç»ƒï¼Œç„¶åå°†å®ƒä»¬è½¬æ¢åˆ° Core ML æ ¼å¼ã€‚
- å¦‚æœ Core ML ä¸æ”¯æŒæŸç§ç±»å‹çš„ layerï¼Œé‚£ä¹ˆä½ å°±ä¸èƒ½ä½¿ç”¨å®ƒã€‚åœ¨è¿™ä¸€ç‚¹ä¸Šï¼Œä½ **ä¸èƒ½**ä½¿ç”¨è‡ªå·±çš„ kernel æ¥æ‰©å±• Core MLã€‚åœ¨ä½¿ç”¨ TensorFlow è¿™æ ·çš„å·¥å…·æ¥æ„å»ºé€šç”¨è®¡ç®—å›¾æ¨¡å‹æ—¶ï¼Œmlmodel æ–‡ä»¶æ ¼å¼å¯èƒ½å°±ä¸é‚£ä¹ˆçµæ´»äº†ã€‚
- Core ML è½¬æ¢å·¥å…·åªæ”¯æŒ**ç‰¹å®šç‰ˆæœ¬**çš„æ•°é‡æœ‰é™çš„è®­ç»ƒå·¥å…·ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ åœ¨ TensorFLow ä¸­è®­ç»ƒäº†ä¸€ä¸ªæ¨¡å‹ï¼Œåˆ™æ— æ³•ä½¿ç”¨æ­¤å·¥å…·ï¼Œä½ å¿…é¡»ç¼–å†™è‡ªå·±çš„è½¬æ¢è„šæœ¬ã€‚æ­£å¦‚æˆ‘åˆšæ‰æåˆ°çš„ï¼šå¦‚æœä½ çš„ TensorFlow æ¨¡å‹å…·æœ‰ä¸€äº› mlmodel ä¸æ”¯æŒçš„ç‰¹æ€§ï¼Œé‚£ä¹ˆä½ å°±ä¸èƒ½åœ¨ Core ML ä¸Šä½¿ç”¨ä½ çš„æ¨¡å‹ã€‚
- ä½ ä¸èƒ½æŸ¥çœ‹**ä¸­é—´å±‚**çš„è¾“å‡ºï¼Œåªèƒ½è·å¾—æœ€åä¸€å±‚ç½‘ç»œçš„é¢„æµ‹å€¼ã€‚
- æˆ‘æ„Ÿè§‰ä¸‹è½½æ¨¡å‹æ›´æ–°ä¼šé€ æˆä¸€äº›é—®é¢˜ï¼Œå¦‚æœä½ ä¸æƒ³æ¯æ¬¡é‡æ–°è®­ç»ƒæ¨¡å‹çš„æ—¶å€™éƒ½é‡å†™ä¸€ä¸ªæ–°ç‰ˆæœ¬çš„ Appï¼Œé‚£ä¹ˆ Core ML ä¸é€‚åˆä½ ã€‚
- Core ML å¯¹å¤–å±è”½äº†å®ƒæ˜¯è¿è¡Œåœ¨ CPU ä¸Šè¿˜æ˜¯ GPU ä¸Šçš„ç»†èŠ‚ â€”â€” è¿™å¾ˆæ–¹ä¾¿ â€”â€” ä½†ä½ å¿…é¡»ç›¸ä¿¡å®ƒå¯¹ä½ çš„ App èƒ½åšå‡ºæ­£ç¡®çš„äº‹æƒ…ã€‚å³ä¾¿ä½ çœŸçš„éœ€è¦ï¼Œä½ ä¹Ÿä¸èƒ½å¼ºè¿« Core ML è¿è¡Œåœ¨ GPU ä¸Šã€‚

å¦‚æœä½ èƒ½å¤Ÿå¿å—è¿™äº›é™åˆ¶ï¼Œé‚£ä¹ˆ Core ML å¯¹ä½ æ¥è¯´å°±æ˜¯æ­£ç¡®çš„é€‰æ‹©ã€‚

å¦åˆ™çš„è¯ï¼Œå¦‚æœä½ æƒ³è¦å®Œå…¨çš„æ§åˆ¶æƒï¼Œé‚£ä¹ˆä½ å¿…é¡»ä½¿ç”¨ Metal Performance Shader æˆ– Accelerate æ¡†æ¶ â€”â€” ç”šè‡³ä¸€èµ·ä½¿ç”¨ â€”â€” æ¥é©±åŠ¨ä½ çš„æ¨¡å‹äº†ï¼

å½“ç„¶ï¼ŒçœŸæ­£çš„é»‘é­”æ³•ä¸æ˜¯ Core MLï¼Œè€Œæ˜¯ä½ çš„æ¨¡å‹ã€‚**å¦‚æœä½ è¿æ¨¡å‹éƒ½æ²¡æœ‰ï¼ŒCore ML æ˜¯æ²¡æœ‰ç”¨çš„**ã€‚è€Œè®¾è®¡å’Œè®­ç»ƒä¸€ä¸ªæ¨¡å‹å°±æ˜¯æœºå™¨å­¦ä¹ çš„éš¾ç‚¹æ‰€åœ¨â€¦â€¦

### ä¸€ä¸ªå¿«é€Ÿç¤ºä¾‹ç¨‹åº

æˆ‘å†™äº†ä¸€ä¸ªä½¿ç”¨äº† Core ML çš„ç®€å•çš„ç¤ºä¾‹é¡¹ç›®ï¼Œå’Œå¾€å¸¸ä¸€æ ·ï¼Œä½ å¯ä»¥åœ¨ GitHub ä¸Šæ‰¾åˆ°[æºç ](https://github.com/hollance/MobileNet-CoreML)ã€‚

[![The demo app in action](http://machinethink.net/images/ios11/Demo@2x.png)](http://machinethink.net/images/ios11/Demo@2x.png)

è¿™ä¸ªç¤ºä¾‹ç¨‹åºä½¿ç”¨äº† [MobileNet](https://arxiv.org/abs/1704.04861v1) æ¶æ„æ¥åˆ†ç±»å›¾ç‰‡ä¸­çš„çŒ«ã€‚

æœ€åˆè¿™ä¸ªæ¨¡å‹æ˜¯[ç”¨ Caffe è®­ç»ƒ](https://github.com/shicai/MobileNet-Caffe)å¾—å‡ºçš„ã€‚æˆ‘èŠ±äº†ä¸€ç‚¹æ—¶é—´æ¥ææ¸…æ¥šå¦‚ä½•å°†å®ƒè½¬æ¢åˆ°ä¸€ä¸ª mlmodel æ–‡ä»¶ï¼Œä½†æ˜¯ä¸€æ—¦æˆ‘æœ‰äº†è¿™ä¸ªè½¬æ¢å¥½çš„æ¨¡å‹ï¼Œä¾¿å¾ˆå®¹æ˜“é›†æˆåˆ° App ä¸­äº†ï¼ˆ[è½¬æ¢è„šæœ¬](https://github.com/hollance/MobileNet-CoreML/blob/master/Convert/coreml.py)åŒ…å«åœ¨ GitHub ä¸­ï¼‰ã€‚

è™½ç„¶è¿™ä¸ª App ä¸æ˜¯å¾ˆæœ‰è¶£ â€”â€” å®ƒåªè¾“å‡ºäº†ä¸€å¼ é™æ€å›¾ç‰‡çš„å‰äº”ä¸ªé¢„æµ‹å€¼ â€”â€” ä½†å´å±•ç¤ºäº†ä½¿ç”¨ Core ML æ˜¯å¤šä¹ˆçš„ç®€å•ã€‚å‡ è¡Œä»£ç å°±å¤Ÿäº†ã€‚

**æ³¨æ„:** ç¤ºä¾‹ç¨‹åºåœ¨æ¨¡æ‹Ÿå™¨ä¸Šå·¥ä½œæ­£å¸¸ï¼Œä½†æ˜¯è®¾å¤‡ä¸Šè¿è¡Œå°±ä¼šå´©æºƒã€‚ç»§ç»­é˜…è¯»æ¥çœ‹çœ‹ä¸ºä»€ä¹ˆä¼šå‘ç”Ÿè¿™ç§æƒ…å†µ ;-)

å½“ç„¶ï¼Œæˆ‘æƒ³çŸ¥é“å‘ç”Ÿäº†ä»€ä¹ˆäº‹æƒ…ã€‚äº‹å®è¯æ˜ **mlmodel** å®é™…ä¸Šè¢«ç¼–è¯‘è¿›åº”ç”¨ç¨‹åº bundle çš„ **mlmodelc** æ–‡ä»¶å¤¹ä¸­äº†ã€‚è¿™ä¸ªæ–‡ä»¶å¤¹é‡ŒåŒ…å«äº†ä¸€å †ä¸åŒçš„æ–‡ä»¶ï¼Œä¸€äº›äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œä¸€äº› JSONæ–‡ä»¶ã€‚æ‰€ä»¥ä½ ä½ å¯ä»¥çœ‹åˆ° Core ML æ˜¯å¦‚ä½•å°† mlmodel åœ¨å®é™…éƒ¨ç½²åˆ°åº”ç”¨ä¸­ä¹‹å‰è¿›è¡Œè½¬æ¢çš„ã€‚

ä¾‹å¦‚ï¼ŒMobileNet Caffe æ¨¡å‹ä½¿ç”¨äº†æ‰¹é‡å½’ä¸€åŒ–ï¼ˆBatch Normalizationï¼‰å±‚ï¼Œæˆ‘éªŒè¯äº†è¿™äº›è½¬æ¢ä¹Ÿå­˜åœ¨äº **mlmodel** æ–‡ä»¶ä¸­ã€‚ä½†æ˜¯åœ¨ç¼–è¯‘çš„ mlmodelc ä¸­ï¼Œè¿™äº›æ‰¹é‡å½’ä¸€åŒ– layer ä¼¼ä¹å°±è¢«ç§»é™¤äº†ã€‚è¿™æ˜¯ä¸ªå¥½æ¶ˆæ¯ï¼šCore ML ä¼˜åŒ–äº†è¯¥æ¨¡å‹ã€‚

å°½ç®¡å¦‚æ­¤ï¼Œå®ƒä¼¼ä¹å¯ä»¥æ›´å¥½çš„ä¼˜åŒ–è¯¥æ¨¡å‹çš„ç»“æ„ï¼Œå› ä¸º **mlmodelc** ä»ç„¶åŒ…å«ä¸€äº›ä¸å¿…è¦çš„ scaling layerã€‚

å½“ç„¶ï¼Œæˆ‘ä»¬è¿˜å¤„åœ¨ iOS 11 beta 1 çš„ç‰ˆæœ¬ï¼ŒCore ML å¯èƒ½è¿˜ä¼šæ”¹è¿›ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨åº”ç”¨åˆ° Core ML ä¹‹å‰ï¼Œè¿˜æ˜¯å€¼å¾—å¯¹æ¨¡å‹è¿›ä¸€æ­¥ä¼˜åŒ–çš„ â€”â€” ä¾‹å¦‚ï¼Œ[é€šè¿‡ã€Œfoldingã€æ“ä½œå¯¹ layer è¿›è¡Œæ‰¹é‡å½’ä¸€åŒ–ï¼ˆBatch Normalizationï¼‰](http://machinethink.net/blog/object-detection-with-yolo/#converting-to-metal)  â€”â€” ä½†è¿™æ˜¯ä½ å¿…é¡»å¯¹ä½ çš„ç‰¹æ€§æ¨¡å‹è¿›è¡Œæµ‹é‡å’Œæ¯”è¾ƒçš„ä¸œè¥¿ã€‚

è¿˜æœ‰å…¶ä»–ä¸€äº›ä½ å¿…é¡»æ£€æŸ¥çš„ï¼šä½ çš„æ¨¡å‹æ˜¯å¦åœ¨ CPU å’Œ GPU ä¸Šè¿è¡Œç›¸åŒã€‚æˆ‘æåˆ° Core ML å°†é€‰æ‹©æ˜¯å¦åœ¨ CPU ä¸Šè¿è¡Œæ¨¡å‹ï¼ˆä½¿ç”¨ Accelerate æ¡†æ¶ï¼‰æˆ– GPUï¼ˆä½¿ç”¨ Metal ï¼‰ã€‚äº‹å®è¯æ˜ï¼Œè¿™ä¸¤ä¸ªå®ç°å¯èƒ½ä¼šæœ‰æ‰€ä¸åŒ â€”â€” æ‰€ä»¥ä½ ä¸¤ä¸ªéƒ½éœ€è¦æµ‹è¯•ï¼

ä¾‹å¦‚ï¼ŒMobileNet ä½¿ç”¨æ‰€è°“çš„ã€Œdepthwiseã€å·ç§¯å±‚ã€‚åŸå§‹æ¨¡å‹åœ¨ Caffe ä¸­è¿›è¡Œè®­ç»ƒï¼ŒCaffe é€šè¿‡ä½¿æ­£å¸¸å·ç§¯çš„ `groups` å±æ€§ç­‰äºè¾“å‡ºé€šé“çš„æ•°é‡æ¥æ”¯æŒ depthwise å·ç§¯ã€‚æ‰€å¾—åˆ°çš„ **MobileNet.mlmodel** æ–‡ä»¶ä¹Ÿä¸€æ ·ã€‚è¿™åœ¨ iOS æ¨¡æ‹Ÿå™¨ä¸­å·¥ä½œæ­£å¸¸ï¼Œä½†å®ƒåœ¨è®¾å¤‡ä¸Šå°±ä¼šå´©æºƒï¼

å‘ç”Ÿè¿™ä¸€åˆ‡çš„åŸå› æ˜¯ï¼šæ¨¡æ‹Ÿå™¨ä½¿ç”¨çš„æ˜¯ Accelerate æ¡†æ¶ï¼Œä½†æ˜¯è¯¥è®¾å¤‡ä¸Šä½¿ç”¨çš„å´æ˜¯ Metal Performance Shadersã€‚ç”±äº Metal å¯¹æ•°æ®è¿›è¡Œç¼–ç æ–¹å¼çš„ç‰¹æ®Šæ€§ï¼Œ `MPSCNNConvolution` å†…æ ¸é™åˆ¶äº†ï¼šä¸èƒ½ä½¿ groups æ•°ç­‰äºè¾“å‡ºé€šé“çš„æ•°é‡ã€‚å™¢åš¯ï¼ 

æˆ‘å‘ Apple æäº¤äº†ä¸€ä¸ª bugï¼Œä½†æ˜¯æˆ‘æƒ³è¯´çš„æ˜¯ï¼šæ¨¡å‹èƒ½åœ¨æ¨¡æ‹Ÿå™¨ä¸Šè¿è¡Œæ­£å¸¸å¹¶ä¸æ„å‘³ç€å®ƒåœ¨è®¾å¤‡ä¸Šè¿è¡Œæ­£å¸¸ã€‚**ä¸€å®šè¦æµ‹è¯•ï¼**

### æœ‰å¤šå¿«ï¼Ÿ

æˆ‘æ²¡æœ‰åŠæ³•æµ‹è¯• Core ML çš„é€Ÿåº¦ï¼Œå› ä¸ºæˆ‘çš„å…¨æ–° 10.5 å¯¸ iPad Pro ä¸‹ä¸ªæ˜ŸæœŸæ‰èƒ½åˆ°ï¼ˆå‘µå‘µï¼‰ã€‚

æˆ‘æ„Ÿå…´è¶£çš„æ˜¯æˆ‘è‡ªå·±å†™çš„ [Forge åº“](https://github.com/hollance/Forge)å’Œ Core ML ï¼ˆè€ƒè™‘åˆ°æˆ‘ä»¬éƒ½æ˜¯ä¸€ä¸ªæ—©æœŸçš„æµ‹è¯•ç‰ˆï¼‰ä¹‹é—´è¿è¡Œ MobileNets ä¹‹é—´çš„æ€§èƒ½å·®å¼‚ã€‚

æ•¬è¯·å…³æ³¨ï¼å½“æˆ‘æœ‰æ•°æ®å¯ä»¥åˆ†äº«æ—¶ï¼Œæˆ‘ä¼šæ›´æ–°è¿™ä¸€èŠ‚å†…å®¹ã€‚

## Vision

ä¸‹ä¸€ä¸ªè¦è®¨è®ºçš„äº‹æƒ…å°±æ˜¯å…¨æ–°çš„ **Vision** æ¡†æ¶ã€‚

ä½ å¯èƒ½å·²ç»ä»å®ƒçš„åå­—ä¸­çŒœåˆ°äº†ï¼ŒVision å¯ä»¥è®©ä½ æ‰§è¡Œ**è®¡ç®—æœºè§†è§‰**ä»»åŠ¡ã€‚åœ¨ä»¥å‰ä½ å¯èƒ½ä¼šä½¿ç”¨ [OpenCV](http://opencv.org/)ï¼Œä½†ç°åœ¨ iOS æœ‰è‡ªå·±çš„ API äº†ã€‚

[![Happy people with square faces](http://machinethink.net/images/ios11/Vision@2x.png)](http://machinethink.net/images/ios11/Vision@2x.png)

Vision å¯ä»¥æ‰§è¡Œçš„ä»»åŠ¡æœ‰ä»¥ä¸‹å‡ ç§ï¼š

- åœ¨å›¾åƒä¸­å¯»æ‰¾äººè„¸ã€‚ç„¶åå¯¹æ¯ä¸ªè„¸ç»™å‡ºä¸€ä¸ªçŸ©å½¢æ¡†ã€‚
- å¯»æ‰¾é¢éƒ¨çš„è¯¦ç»†ç‰¹å¾ï¼Œæ¯”å¦‚çœ¼ç›å’Œå˜´å·´çš„ä½ç½®ï¼Œå¤´éƒ¨çš„å½¢çŠ¶ç­‰ç­‰ã€‚
- å¯»æ‰¾çŸ©å½¢å½¢çŠ¶çš„å›¾åƒï¼Œæ¯”å¦‚è·¯æ ‡ã€‚
- è¿½è¸ªè§†é¢‘ä¸­ç§»åŠ¨çš„å¯¹è±¡ã€‚
- ç¡®å®šåœ°å¹³çº¿çš„è§’åº¦ã€‚
- è½¬æ¢ä¸¤ä¸ªå›¾åƒï¼Œä½¿å…¶å†…å®¹å¯¹é½ã€‚è¿™å¯¹äºæ‹¼æ¥ç…§ç‰‡éå¸¸æœ‰ç”¨ã€‚
- æ£€æµ‹åŒ…å«æ–‡æœ¬çš„å›¾åƒä¸­çš„åŒºåŸŸã€‚
- æ£€æµ‹å’Œè¯†åˆ«æ¡å½¢ç ã€‚

Core Image å’Œ AVFoundation å·²ç»å¯ä»¥å®ç°å…¶ä¸­çš„ä¸€äº›ä»»åŠ¡ï¼Œä½†ç°åœ¨ä»–ä»¬éƒ½é›†æˆåœ¨ä¸€ä¸ªå…·æœ‰ä¸€è‡´æ€§ API çš„æ¡†æ¶å†…äº†ã€‚

å¦‚æœä½ çš„åº”ç”¨ç¨‹åºéœ€è¦æ‰§è¡Œè¿™äº›è®¡ç®—æœºè§†è§‰ä»»åŠ¡ä¹‹ä¸€ï¼Œå†ä¹Ÿä¸ç”¨è·‘å»è‡ªå·±å®ç°æˆ–ä½¿ç”¨åˆ«äººçš„åº“äº† - åªéœ€ä½¿ç”¨ Vision æ¡†æ¶ã€‚ä½ è¿˜å¯ä»¥å°†å…¶ä¸ Core Image æ¡†æ¶ç›¸ç»“åˆï¼Œä»¥è·å¾—æ›´å¤šçš„å›¾åƒå¤„ç†èƒ½åŠ›ã€‚

æ›´å¥½çš„æ˜¯ï¼š**ä½ å¯ä»¥ä½¿ç”¨ Vision é©±åŠ¨ Core ML**ï¼Œè¿™å…è®¸ä½ ä½¿ç”¨è¿™äº›è®¡ç®—æœºè§†è§‰æŠ€æœ¯ä½œä¸ºç¥ç»ç½‘ç»œçš„é¢„å¤„ç†æ­¥éª¤ã€‚ä¾‹å¦‚ï¼Œä½ å¯ä»¥ä½¿ç”¨ Vision æ¥æ£€æµ‹äººè„¸çš„ä½ç½®å’Œå¤§å°ï¼Œå°†è§†é¢‘å¸§è£å‰ªåˆ°è¯¥åŒºåŸŸï¼Œç„¶ååœ¨è¿™éƒ¨åˆ†çš„é¢éƒ¨å›¾åƒä¸Šè¿è¡Œç¥ç»ç½‘ç»œã€‚

äº‹å®ä¸Šï¼Œä»»ä½•æ—¶å€™å½“ä½ ç»“åˆå›¾åƒæˆ–è€…è§†é¢‘ä½¿ç”¨ Core ML æ—¶ï¼Œä½¿ç”¨ Vision éƒ½æ˜¯åˆç†çš„ã€‚åŸå§‹çš„ Core ML éœ€è¦ä½ ç¡®ä¿è¾“å…¥å›¾åƒæ˜¯æ¨¡å‹æ‰€æœŸæœ›çš„æ ¼å¼ã€‚å¦‚æœä½¿ç”¨ Vision æ¡†æ¶æ¥è´Ÿè´£è°ƒæ•´å›¾åƒå¤§å°ç­‰ï¼Œè¿™ä¼šä¸ºä½ èŠ‚çœä¸å°‘åŠ›æ°”ã€‚

ä½¿ç”¨ Vision æ¥é©±åŠ¨ Core ML çš„ä»£ç é•¿è¿™ä¸ªæ ·å­ï¼š

```swift
// Core ML çš„æœºå™¨å­¦ä¹ æ¨¡å‹
let modelCoreML = ResNet50()
```

```swift
// å°† Core ML é“¾æ¥åˆ° Vision
let visionModel = try? VNCoreMLModel(for: modelCoreML.model)
```

```swift
let classificationRequest = VNCoreMLRequest(model: visionModel) {
  request, error iniflet observations = request.results as? [VNClassificationObservation] {
    /* è¿›è¡Œé¢„æµ‹ */
  }
}

let handler = VNImageRequestHandler(cgImage: yourImage)
try? handler.perform([classificationRequest])
```


è¯·æ³¨æ„ï¼Œ`VNImageRequestHandler` æ¥å—ä¸€ä¸ªè¯·æ±‚å¯¹è±¡æ•°ç»„ï¼Œå…è®¸ä½ å°†å¤šä¸ªè®¡ç®—æœºè§†è§‰ä»»åŠ¡é“¾æ¥åœ¨ä¸€èµ·ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```swift
try? handler.perform([faceDetectionRequest, classificationRequest])
```


Vision ä½¿è®¡ç®—æœºè§†è§‰å˜å¾—éå¸¸å®¹æ˜“ä½¿ç”¨ã€‚ ä½†å¯¹æˆ‘ä»¬æœºå™¨å­¦ä¹ äººå‘˜å¾ˆé…·çš„äº‹æƒ…æ˜¯ï¼Œä½ å¯ä»¥å°†è¿™äº›è®¡ç®—æœºè§†è§‰ä»»åŠ¡çš„è¾“å‡ºè¾“å…¥åˆ°ä½ çš„ Core ML æ¨¡å‹ä¸­ã€‚ ç»“åˆ Core Image çš„åŠ›é‡ï¼Œæ‰¹é‡å›¾åƒå¤„ç†å°±è·Ÿç©å„¿ä¸€æ ·ï¼

## Metal Performance Shaders

æˆ‘æœ€åä¸€ä¸ªæƒ³è¦è®¨è®ºçš„è¯é¢˜å°±æ˜¯ **Metal** â€”â€” Apple çš„ GPU ç¼–ç¨‹ APIã€‚

æˆ‘ä»Šå¹´ä¸ºå®¢æˆ·æä¾›çš„å¾ˆå¤šå·¥ä½œæ¶‰åŠåˆ°ä½¿ç”¨ [Metal Performance Shaders (MPS)](http://machinethink.net/blog/convolutional-neural-networks-on-the-iphone-with-vggnet/) æ¥æ„å»ºç¥ç»ç½‘ç»œï¼Œå¹¶å¯¹å…¶è¿›è¡Œä¼˜åŒ–ï¼Œä»è€Œè·å¾—æœ€ä½³æ€§èƒ½ã€‚ä½†æ˜¯ iOS 10 åªæä¾›äº†å‡ ä¸ªç”¨äºåˆ›å»ºç¥ç»ç½‘ç»œçš„åŸºæœ¬ kernelã€‚é€šå¸¸éœ€è¦ç¼–å†™è‡ªå®šä¹‰çš„ kernel æ¥å¼¥è¡¥è¿™ä¸ªç¼ºé™·ã€‚

æ‰€ä»¥æˆ‘å¾ˆå¼€å¿ƒä½¿ç”¨ iOS 11ï¼Œå¯ç”¨çš„ kernel å·²ç»å¢é•¿äº†è®¸å¤šï¼Œæ›´å¥½çš„æ˜¯ï¼šæˆ‘ä»¬ç°åœ¨æœ‰ä¸€ä¸ªç”¨äºæ„å»ºå›¾çš„ API äº†ï¼

[![Metal Performance Shaders](http://machinethink.net/images/ios11/Metal@2x.png)](http://machinethink.net/images/ios11/Metal@2x.png)

**æ³¨æ„:** ä¸ºä»€ä¹ˆè¦ä½¿ç”¨ MPS è€Œä¸æ˜¯ Core MLï¼Ÿå¥½é—®é¢˜ï¼æœ€å¤§çš„åŸå› æ˜¯å½“ Core ML ä¸æ”¯æŒä½ æƒ³è¦åšçš„äº‹æƒ…æ—¶ï¼Œæˆ–è€…å½“ä½ æƒ³è¦å®Œå…¨çš„æ§åˆ¶æƒå¹¶è·å¾—æœ€å¤§è¿è¡Œé€Ÿåº¦æ—¶ã€‚

MPS ä¸­å¯¹äºæœºå™¨å­¦ä¹ æ¥è¯´çš„æœ€å¤§çš„å˜åŒ–æ˜¯ï¼š

**é€’å½’ç¥ç»ç½‘ç»œ**ã€‚ä½ ç°åœ¨å¯ä»¥åˆ›å»º RNNï¼ŒLSTMï¼ŒGRU å’Œ MGU å±‚äº†ã€‚è¿™äº›å·¥ä½œåœ¨ `MPSImage` å¯¹è±¡çš„åºåˆ—ä¸Šï¼Œä½†ä¹Ÿé€‚ç”¨äº `MPSMatrix` å¯¹è±¡çš„åºåˆ—ã€‚è¿™å¾ˆæœ‰è¶£ï¼Œå› ä¸ºæ‰€æœ‰å…¶ä»– MPS layer ä»…å¤„ç†å›¾åƒ â€”â€” ä½†æ˜¾ç„¶ï¼Œå½“ä½ ä½¿ç”¨æ–‡æœ¬æˆ–å…¶ä»–éå›¾åƒæ•°æ®æ—¶ï¼Œè¿™ä¸æ˜¯å¾ˆæ–¹ä¾¿ã€‚

**æ›´å¤šæ•°æ®ç±»å‹**ã€‚ä»¥å‰çš„æƒé‡åº”è¯¥æ˜¯ 32 ä½æµ®ç‚¹æ•°ï¼Œä½†ç°åœ¨å¯ä»¥æ˜¯ 16 ä½æµ®ç‚¹æ•°ï¼ˆåŠç²¾åº¦ï¼‰ï¼Œ8 ä½æ•´æ•°ï¼Œç”šè‡³æ˜¯ 2 è¿›åˆ¶æ•°ã€‚å·ç§¯å’Œ fully-connected çš„ layer å¯ä»¥ç”¨ 2 è¿›åˆ¶æƒé‡å’Œ 2 è¿›åˆ¶åŒ–è¾“å…¥æ¥å®Œæˆã€‚

**æ›´å¤šçš„å±‚**ã€‚åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬ä¸å¾—ä¸é‡‡ç”¨æ™®é€šçš„å¸¸è§„å·ç§¯ã€æœ€å¤§æ± åŒ–å’Œå¹³å‡æ± åŒ–ï¼Œä½†æ˜¯åœ¨ iOS 11 MPS ä¸­ï¼Œä½ å¯ä»¥è¿›è¡Œæ‰©å¼ å·ç§¯ï¼ˆDilated Convolutionï¼‰ã€å­åƒç´ å·ç§¯ï¼ˆSubpixel Convolutionï¼‰ã€è½¬ç½®å·ç§¯ï¼ˆTransposed Convolutionï¼‰ã€ä¸Šé‡‡æ ·ï¼ˆUpsamplingï¼‰å’Œé‡é‡‡æ ·ï¼ˆResamplingï¼‰ã€L2 èŒƒæ•°æ± åŒ–ï¼ˆL2-norm poolingï¼‰ã€æ‰©å¼ æœ€å¤§æ± åŒ–ï¼ˆdilated max poolingï¼‰ï¼Œè¿˜æœ‰ä¸€äº›æ–°çš„æ¿€æ´»å‡½æ•°ã€‚ MPS è¿˜æ²¡æœ‰æ‰€æœ‰çš„ Keras æˆ– Caffe layer ç±»å‹ï¼Œä½†å·®è·æ­£åœ¨ç¼©å°...

**æ›´æ–¹ä¾¿**ã€‚ä½¿ç”¨ `MPSImages` æ€»æ˜¯æœ‰ç‚¹å¥‡æ€ªï¼Œå› ä¸º Metal æ¯æ¬¡ä»¥ 4 ä¸ªé€šé“çš„ç‰‡æ®µç»„ç»‡æ•°æ®ï¼ˆå› ä¸ºå›¾åƒç”± `MTLTexture` å¯¹è±¡æ”¯æŒï¼‰ã€‚ä½†æ˜¯ç°åœ¨ï¼Œ`MPSImage` æœ‰ç”¨äºè¯»å–å’Œå†™å…¥æ•°æ®çš„æ–¹æ³•ï¼Œè¿™äº›æ•°æ®ä¸ä¼šè®©ä½ æ„Ÿåˆ°å›°æƒ‘ã€‚

`MPSCNNConvolutionDescriptor` è¿˜æœ‰ä¸€ä¸ªæ–°æ–¹æ³•ï¼Œå¯ä»¥è®©ä½ åœ¨ layer ä¸Šè®¾ç½®æ‰¹é‡å½’ä¸€åŒ–å‚æ•°ã€‚è¿™æ„å‘³ç€ä½ ä¸å†éœ€è¦å°†æ‰¹é‡å½’ä¸€åŒ–åˆ°å·ç§¯å±‚ä¸­ï¼Œè€Œ MPS ä¼šä¸ºä½ å¤„ç†è¿™äº›äº‹æƒ…ã€‚éå¸¸æ–¹ä¾¿ï¼

**æ€§èƒ½æ”¹è¿›**ã€‚ç°æœ‰çš„å†…æ ¸å˜å¾—æ›´å¿«ã€‚è¿™æ€»æ˜¯å¥½æ¶ˆæ¯ã€‚ ğŸ

**å›¾ API**ã€‚è¿™æ˜¯æˆ‘æœ€å…³å¿ƒçš„æ¶ˆæ¯ã€‚æ‰‹åŠ¨åˆ›å»ºæ‰€æœ‰ layer å’Œï¼ˆä¸´æ—¶ï¼‰å›¾åƒæ€»æ˜¯ä»¤äººè®¨åŒçš„ã€‚ç°åœ¨ä½ å¯ä»¥æè¿°ä¸€ä¸ªå›¾ï¼Œå°±åƒä½ åœ¨Keras ä¸­ä¸€æ ·ã€‚ MPS å°†è‡ªåŠ¨è®¡ç®—å‡ºå›¾åƒéœ€è¦å¤šå¤§ï¼Œå¦‚ä½•å¤„ç†å¡«å……ï¼Œå¦‚ä½•è®¾ç½® MPS å†…æ ¸çš„ `offset` ç­‰ç­‰ã€‚ç”šè‡³å¯ä»¥é€šè¿‡èåˆä¸åŒçš„ layer æ¥ä¼˜åŒ–æ•´ä¸ªå›¾ã€‚

çœ‹èµ·æ¥æ‰€æœ‰çš„ MPS å†…æ ¸éƒ½å¯ä»¥ä½¿ç”¨ `NSSecureCoding` è¿›è¡Œåºåˆ—åŒ–ï¼Œè¿™æ„å‘³ç€ä½ å¯ä»¥å°†å›¾ä¿å­˜åˆ°æ–‡ä»¶ä¸­ï¼Œç„¶åå°†å…¶è¿˜åŸã€‚å¹¶ä¸”ä½¿ç”¨è¿™ä¸ªå›¾æ¥æ¨æ–­ç°åœ¨åªæ˜¯ä¸€ä¸ªå•ä¸€çš„æ–¹æ³•è°ƒç”¨ã€‚å®ƒä¸åƒ Core ML é‚£ä¹ˆç®€å•ï¼Œä½†ä½¿ç”¨ MPS ç»å¯¹æ¯”ä»¥å‰å¥½ç”¨å¾—å¤šã€‚

æœ‰ä¸€ä»¶äº‹æƒ…æˆ‘ç›®å‰è¿˜ä¸å¤ªæ¸…æ¥šï¼Œé‚£å°±æ˜¯æˆ‘ä¸çŸ¥é“ä½ æ˜¯å¦å¯ä»¥ç¼–å†™è‡ªå·±çš„ kernel å¹¶åœ¨è¿™ä¸ªå›¾ä¸­ä½¿ç”¨ã€‚åœ¨æˆ‘å®¢æˆ·çš„å·¥ä½œä¸­ï¼Œæˆ‘å‘ç°é€šå¸¸éœ€è¦ä½¿ç”¨ Metel Shading è¯­è¨€ç¼–å†™çš„è‡ªå®šä¹‰ç€è‰²å™¨æ¥è¿›è¡Œé¢„å¤„ç†æ­¥éª¤ã€‚æ®æˆ‘æ‰€çŸ¥ï¼Œä¼¼ä¹æ²¡æœ‰ä¸€ä¸ªã€Œ`MPSNNCustomKernelNode`ã€ç±»ã€‚è¿™è¿˜è¦å†å¤šç ”ç©¶ä¸€ä¸‹ï¼

ç»“è®ºï¼šç”¨äºæœºå™¨å­¦ä¹ çš„ Metal Performance Shaders å·²ç»åœ¨ iOS 11 ä¸­å˜å¾—æ›´åŠ å¼ºå¤§ï¼Œä½†æ˜¯å¤§å¤šæ•°å¼€å‘äººå‘˜åº”è¯¥è½¬è€Œä½¿ç”¨ Core MLï¼ˆå¯¹äºé‚£äº›ä½¿ç”¨MPSçš„æ¥è¯´ï¼‰ã€‚

**æ³¨æ„**ï¼šæ–°çš„å›¾ API ä½¿æˆ‘çš„ [Forge åº“](http://github.com/hollance/Forge)åŸºæœ¬ä¸Šè¿‡æ—¶äº†ï¼Œé™¤éä½ å¸Œæœ›åœ¨ App ä¸­ç»§ç»­æ”¯æŒ iOS 10ã€‚æˆ‘å°†å°½å¿«å°†ç¤ºä¾‹åº”ç”¨ç§»æ¤åˆ°æ–°çš„å›¾ API ä¸Šï¼Œç„¶åå°†å†™ä¸€ä¸ªæ›´è¯¦ç»†çš„åšå®¢æ–‡ç« ã€‚

## æ‚é¡¹

è¿˜æœ‰ä¸€äº›å…¶ä»–çš„æ›´æ–°ï¼š

**Accelerate æ¡†æ¶:** ä¼¼ä¹ [Accelerate æ¡†æ¶ä¸­çš„ BNNS](http://machinethink.net/blog/apple-deep-learning-bnns-versus-metal-cnn/) å¹¶æ²¡æœ‰è·å¾—å¤ªå¤šåŠŸèƒ½ä¸Šçš„æ›´æ–°ã€‚å®ƒç»ˆäºæœ‰äº† Softmax å±‚ï¼Œä½† MPS å´æ²¡æœ‰æ–°çš„ layer ç±»å‹ã€‚ä¹Ÿè®¸æ— å…³ç´§è¦ï¼šä½¿ç”¨ CPU è¿›è¡Œæ·±å±‚ç¥ç»ç½‘ç»œå¯èƒ½ä¸æ˜¯ä¸€ä¸ªå¥½ä¸»æ„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘å–œæ¬¢ Accelerateï¼Œå®ƒæœ‰å¾ˆå¤šå¥½ç©çš„ä¸œè¥¿ã€‚è€Œä»Šå¹´ï¼Œå®ƒç¡®å®è·å¾—äº†å¯¹ç¨€ç–çŸ©é˜µçš„æ›´å¤šæ”¯æŒï¼Œå¾ˆæ£’ã€‚

**è‡ªç„¶è¯­è¨€å¤„ç†:** Core MLä¸ä»…ä»…åªèƒ½å¤„ç†å›¾åƒï¼Œå®ƒè¿˜å¯ä»¥å¤„ç†å¤§é‡ä¸åŒç±»å‹çš„æ•°æ®ï¼ŒåŒ…æ‹¬æ–‡æœ¬ã€‚ ä½¿ç”¨çš„ API `NSLinguisticTagger` ç±»å·²ç»å­˜åœ¨äº†ä¸€æ®µæ—¶é—´ï¼Œä½†æ˜¯ä¸ iOS 11 ç›¸æ¯”å˜å¾—æ›´åŠ æœ‰æ•ˆäº†ã€‚`NSLinguisticTagger` ç°åœ¨å·²ç»èƒ½è¿›è¡Œè¯­è¨€é‰´åˆ«ï¼Œè¯æ³•åˆ†æï¼Œè¯æ€§æ ‡æ³¨ï¼Œè¯å¹²æå–å’Œå‘½åå®ä½“è¯†åˆ«ã€‚

æˆ‘æ²¡æœ‰ä»€ä¹ˆ NLP çš„ç»éªŒï¼Œæ‰€ä»¥æˆ‘æ²¡åŠæ³•æ¯”è¾ƒå®ƒä¸å…¶ä»– NLP æ¡†æ¶çš„åŒºåˆ«ï¼Œä½†`NSLinguisticTagger` çœ‹èµ·æ¥ç›¸å½“å¼ºå¤§ã€‚ å¦‚æœè¦å°† NLP æ·»åŠ åˆ° App ä¸­ï¼Œæ­¤ API ä¼¼ä¹æ˜¯ä¸€ä¸ªå¥½çš„èµ·ç‚¹ã€‚

## éƒ½æ˜¯å¥½æ¶ˆæ¯å—?

Apple å‘æˆ‘ä»¬å¼€å‘è€…æä¾›æ‰€æœ‰çš„è¿™äº›æ–°å·¥å…·éƒ½éå¸¸çš„å¥½ï¼Œä½†æ˜¯å¤§å¤šæ•° Apple API éƒ½æœ‰ä¸€äº›å¾ˆé‡è¦çš„é—®é¢˜ï¼š

1. é—­æº
2. æœ‰å±€é™
3. åªæœ‰åœ¨æ–° OS å‘å¸ƒæ—¶å€™æ‰ä¼šæ›´æ–°

è¿™ä¸‰ä¸ªä¸œè¥¿åŠ åœ¨ä¸€èµ·æ„å‘³ç€è‹¹æœçš„ API **æ€»ä¼šè½å**äºå…¶ä»–å·¥å…·ã€‚å¦‚æœ Keras å¢åŠ äº†ä¸€ä¸ªå¾ˆç‚«é…·çš„æ–°çš„ layer ç±»å‹ï¼Œé‚£ä¹ˆåœ¨ Apple æ›´æ–°å…¶æ¡†æ¶å’Œæ“ä½œç³»ç»Ÿä¹‹å‰ï¼Œä½ éƒ½æ²¡åŠæ³•å°†å®ƒå’Œ Core ML ä¸€èµ·ä½¿ç”¨äº†ã€‚

å¦‚æœæŸäº› API å¾—åˆ°çš„è®¡ç®—ç»“æœå¹¶ä¸æ˜¯ä½ æƒ³è¦çš„ï¼Œä½ æ²¡åŠæ³•ç®€å•çš„è¿›å»çœ‹çœ‹åˆ°åº•æ˜¯ Core ML çš„é—®é¢˜è¿˜æ˜¯æ¨¡å‹çš„é—®é¢˜ï¼Œå†å»ä¿®å¤å®ƒ â€”â€” ä½ å¿…é¡»ç»•å¼€ Core ML æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼ˆå¹¶ä¸æ€»æ˜¯å¯èƒ½çš„ï¼‰ï¼›è¦ä¹ˆå°±åªèƒ½ç­‰åˆ°ä¸‹ä¸€ä¸ª OS å‘å¸ƒäº†ï¼ˆéœ€è¦ä½ æ‰€æœ‰çš„ç”¨æˆ·è¿›è¡Œå‡çº§ï¼‰ã€‚

å½“ç„¶æˆ‘ä¸å¸Œæœ› Apple æ”¾å¼ƒä»–ä»¬çš„ç§˜å¯†æ­¦å™¨ï¼Œä½†æ˜¯å°±åƒå…¶ä»–å¤§å¤šæ•°æœºå™¨å­¦ä¹ å·¥å…·å¼€æºä¸€æ ·ï¼Œä¸ºä»€ä¹ˆä¸è®© Core ML ä¹Ÿå¼€æºå‘¢ï¼Ÿ ğŸ™

æˆ‘çŸ¥é“è¿™å¯¹äº Apple æ¥è¯´ä¸å¯èƒ½é©¬ä¸Šå‘ç”Ÿï¼Œä½†å½“ä½ å†³å®šåœ¨ App ä¸­ä½¿ç”¨æœºå™¨å­¦ä¹ æ—¶ï¼Œè¦è®°ä½ä¸Šé¢çš„è¿™äº›å†…å®¹ã€‚



**Matthijs Hollemans** äº 2017 å¹´ 6 æœˆ 11 æ—¥

æˆ‘å¸Œæœ›è¿™ç¯‡æ–‡ç« å¯¹ä½ æœ‰æ‰€å¸®åŠ©ï¼æ¬¢è¿é€šè¿‡ Twitter [@mhollemans](https://twitter.com/mhollemans) æˆ– Email [matt@machinethink.net](mailto:matt@machinethink.net) è”ç³»æˆ‘ã€‚

---

> [æ˜é‡‘ç¿»è¯‘è®¡åˆ’](https://github.com/xitu/gold-miner) æ˜¯ä¸€ä¸ªç¿»è¯‘ä¼˜è´¨äº’è”ç½‘æŠ€æœ¯æ–‡ç« çš„ç¤¾åŒºï¼Œæ–‡ç« æ¥æºä¸º [æ˜é‡‘](https://juejin.im) ä¸Šçš„è‹±æ–‡åˆ†äº«æ–‡ç« ã€‚å†…å®¹è¦†ç›– [Android](https://github.com/xitu/gold-miner#android)ã€[iOS](https://github.com/xitu/gold-miner#ios)ã€[React](https://github.com/xitu/gold-miner#react)ã€[å‰ç«¯](https://github.com/xitu/gold-miner#å‰ç«¯)ã€[åç«¯](https://github.com/xitu/gold-miner#åç«¯)ã€[äº§å“](https://github.com/xitu/gold-miner#äº§å“)ã€[è®¾è®¡](https://github.com/xitu/gold-miner#è®¾è®¡) ç­‰é¢†åŸŸï¼Œæƒ³è¦æŸ¥çœ‹æ›´å¤šä¼˜è´¨è¯‘æ–‡è¯·æŒç»­å…³æ³¨ [æ˜é‡‘ç¿»è¯‘è®¡åˆ’](https://github.com/xitu/gold-miner)ã€‚
