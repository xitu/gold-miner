> * åŸæ–‡åœ°å€ï¼š[Node.js Streams: Everything you need to know](https://medium.freecodecamp.com/node-js-streams-everything-you-need-to-know-c9141306be93)
> * åŸæ–‡ä½œè€…ï¼šæœ¬æ–‡å·²è·åŸä½œè€… [Samer Buna](https://medium.freecodecamp.com/@samerbuna) æˆæƒ
> * è¯‘æ–‡å‡ºè‡ªï¼š[æ˜é‡‘ç¿»è¯‘è®¡åˆ’](https://github.com/xitu/gold-miner)
> * è¯‘è€…ï¼š[loveky](https://github.com/loveky)
> * æ ¡å¯¹è€…ï¼š[zaraguo](https://github.com/zaraguo) [Aladdin-ADD](https://github.com/Aladdin-ADD)

# Node.js æµ: ä½ éœ€è¦çŸ¥é“çš„ä¸€åˆ‡ #

![](https://img30.360buyimg.com/uba/jfs/t6076/25/1691927562/1083199/d5be5c18/59357a9dNffac5f58.jpg)

[å›¾ç‰‡æ¥æº](https://commons.wikimedia.org/wiki/File:Urban_stream_in_park.jpg)

Node.js ä¸­çš„æµæœ‰ç€éš¾ä»¥ä½¿ç”¨ï¼Œæ›´éš¾ä»¥ç†è§£çš„åå£°ã€‚ç°åœ¨æˆ‘æœ‰ä¸€ä¸ªå¥½æ¶ˆæ¯å‘Šè¯‰ä½ ï¼šäº‹æƒ…å·²ç»ä¸å†æ˜¯è¿™æ ·äº†ã€‚

å¾ˆé•¿æ—¶é—´ä»¥æ¥ï¼Œå¼€å‘äººå‘˜åˆ›é€ äº†è®¸è®¸å¤šå¤šçš„è½¯ä»¶åŒ…ä¸ºçš„å°±æ˜¯å¯ä»¥æ›´ç®€å•çš„ä½¿ç”¨æµã€‚ä½†æ˜¯åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä¼šæŠŠé‡ç‚¹æ”¾åœ¨åŸç”Ÿçš„ [Node.js æµ API](https://nodejs.org/api/stream.html)ä¸Šã€‚

> â€œæµæ˜¯ Node ä¸­æœ€æ£’çš„ï¼ŒåŒæ—¶ä¹Ÿæ˜¯æœ€è¢«äººè¯¯è§£çš„æƒ³æ³•ã€‚â€

> â€” Dominic Tarr

### æµåˆ°åº•æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ ###

æµæ˜¯æ•°æ®çš„é›†åˆ â€”â€” å°±åƒæ•°ç»„æˆ–å­—ç¬¦ä¸²ä¸€æ ·ã€‚åŒºåˆ«åœ¨äºæµä¸­çš„æ•°æ®å¯èƒ½ä¸ä¼šç«‹åˆ»å°±å…¨éƒ¨å¯ç”¨ï¼Œå¹¶ä¸”ä½ æ— éœ€ä¸€æ¬¡æ€§åœ°æŠŠè¿™äº›æ•°æ®å…¨éƒ¨æ”¾å…¥å†…å­˜ã€‚è¿™ä½¿å¾—æµåœ¨æ“ä½œå¤§é‡æ•°æ®æˆ–æ˜¯æ•°æ®ä»å¤–éƒ¨æ¥æºé€**æ®µ**å‘é€è¿‡æ¥çš„æ—¶å€™å˜å¾—éå¸¸æœ‰ç”¨ã€‚

ç„¶è€Œï¼Œæµçš„ä½œç”¨å¹¶ä¸ä»…é™äºæ“ä½œå¤§é‡æ•°æ®ã€‚å®ƒè¿˜å¸¦ç»™æˆ‘ä»¬ç»„åˆä»£ç çš„èƒ½åŠ›ã€‚å°±åƒæˆ‘ä»¬å¯ä»¥é€šè¿‡ç®¡é“è¿æ¥å‡ ä¸ªç®€å•çš„ Linux å‘½ä»¤ä»¥ç»„åˆå‡ºå¼ºå¤§çš„åŠŸèƒ½ä¸€æ ·ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨æµåœ¨ Node ä¸­åšåŒæ ·çš„äº‹ã€‚

![](https://img13.360buyimg.com/uba/jfs/t5605/188/2846141474/21851/33e5d376/59357acdN88421e7c.png)

Linux å‘½ä»¤çš„ç»„åˆæ€§

```bash
const grep = ... // ä¸€ä¸ª grep å‘½ä»¤è¾“å‡ºçš„ stream
const wc = ... // ä¸€ä¸ª wc å‘½ä»¤è¾“å…¥çš„ stream

grep.pipe(wc)
```

Node ä¸­è®¸å¤šå†…å»ºçš„æ¨¡å—éƒ½å®ç°äº†æµæ¥å£ï¼š

![](https://img20.360buyimg.com/uba/jfs/t5737/26/2964786637/95062/83389b23/59357af3N88fa9f2d.png)

æˆªå±æ¥è‡ªäºæˆ‘çš„ Pluralsight è¯¾ç¨‹ â€”â€” é«˜çº§ Node.js

ä¸Šè¾¹çš„åˆ—è¡¨ä¸­æœ‰ä¸€äº› Node.js åŸç”Ÿçš„å¯¹è±¡ï¼Œè¿™äº›å¯¹è±¡ä¹Ÿæ˜¯å¯ä»¥è¯»å†™çš„æµã€‚è¿™äº›å¯¹è±¡ä¸­çš„ä¸€éƒ¨åˆ†æ˜¯æ—¢å¯è¯»ã€åˆå¯å†™çš„æµï¼Œä¾‹å¦‚ TCP socketsï¼Œzlib ä»¥åŠ cryptoã€‚

éœ€è¦æ³¨æ„çš„æ˜¯è¿™äº›å¯¹è±¡æ˜¯ç´§å¯†å…³è”çš„ã€‚è™½ç„¶ä¸€ä¸ª HTTP å“åº”åœ¨å®¢æˆ·ç«¯æ˜¯ä¸€ä¸ªå¯è¯»æµï¼Œä½†åœ¨æœåŠ¡å™¨ç«¯å®ƒå´æ˜¯ä¸€ä¸ªå¯å†™æµã€‚è¿™æ˜¯å› ä¸ºåœ¨ HTTP çš„æƒ…å†µä¸­ï¼Œæˆ‘ä»¬åŸºæœ¬ä¸Šæ˜¯ä»ä¸€ä¸ªå¯¹è±¡ï¼ˆ`http.IncomingMessage`ï¼‰è¯»å–æ•°æ®ï¼Œå‘å¦ä¸€ä¸ªå¯¹è±¡ï¼ˆ`http.ServerResponse`ï¼‰å†™å…¥æ•°æ®ã€‚

è¿˜éœ€è¦æ³¨æ„çš„æ˜¯ `stdio` æµï¼ˆ`stdin`ï¼Œ`stdout`ï¼Œ`stderr`ï¼‰åœ¨å­è¿›ç¨‹ä¸­æœ‰ç€ä¸çˆ¶è¿›ç¨‹ä¸­ç›¸åçš„ç±»å‹ã€‚è¿™ä½¿å¾—åœ¨å­è¿›ç¨‹ä¸­ä»çˆ¶è¿›ç¨‹çš„ `stdio` æµä¸­è¯»å–æˆ–å†™å…¥æ•°æ®å˜å¾—éå¸¸ç®€å•ã€‚

### ä¸€ä¸ªæµçš„çœŸå®ä¾‹å­ ###

ç†è®ºæ˜¯ä¼Ÿå¤§çš„ï¼Œå½“å¾€å¾€æ²¡æœ‰ 100% çš„è¯´æœåŠ›ã€‚ä¸‹é¢è®©æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªä¾‹å­æ¥çœ‹çœ‹æµåœ¨èŠ‚çœå†…å­˜æ¶ˆè€—æ–¹é¢å¯ä»¥èµ·åˆ°çš„ä½œç”¨ã€‚

é¦–å…ˆè®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªå¤§æ–‡ä»¶ï¼š

```js
const fs = require('fs');
const file = fs.createWriteStream('./big.file');

for(let i=0; i<= 1e6; i++) {
  file.write('Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.\n');
}

file.end();
```

çœ‹çœ‹åœ¨åˆ›å»ºè¿™ä¸ªå¤§æ–‡ä»¶æ—¶æˆ‘ç”¨åˆ°äº†ä»€ä¹ˆã€‚ä¸€ä¸ªå¯å†™æµï¼

é€šè¿‡ `fs` æ¨¡å—ä½ å¯ä»¥ä½¿ç”¨ä¸€ä¸ªæµæ¥å£è¯»å–æˆ–å†™å…¥æ–‡ä»¶ã€‚åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡ä¸€ä¸ªå¯å†™æµå‘ `big.file` å†™å…¥äº† 100 ä¸‡è¡Œæ•°æ®ã€‚

æ‰§è¡Œè¿™æ®µè„šæœ¬ä¼šç”Ÿæˆä¸€ä¸ªçº¦ 400MB å¤§å°çš„æ–‡ä»¶ã€‚

ä»¥ä¸‹æ˜¯ä¸€ä¸ªç”¨æ¥å‘é€ `big.file` æ–‡ä»¶çš„ Node web æœåŠ¡å™¨ï¼š

```js
const fs = require('fs');
const server = require('http').createServer();

server.on('request', (req, res) => {
  fs.readFile('./big.file', (err, data) => {
    if (err) throw err;

    res.end(data);
  });
});

server.listen(8000);
```

å½“æœåŠ¡å™¨æ”¶åˆ°è¯·æ±‚æ—¶ï¼Œå®ƒä¼šé€šè¿‡å¼‚æ­¥æ–¹æ³• `fs.readFile` è¯»å–æ–‡ä»¶å†…å®¹å‘é€ç»™å®¢æˆ·ç«¯ã€‚çœ‹èµ·æ¥æˆ‘ä»¬å¹¶æ²¡æœ‰é˜»å¡äº‹ä»¶å¾ªç¯ã€‚ä¸€åˆ‡çœ‹èµ·æ¥è¿˜ä¸é”™ï¼Œæ˜¯å§ï¼Ÿæ˜¯å—ï¼Ÿ

è®©æˆ‘ä»¬æ¥çœ‹çœ‹çœŸå®çš„æƒ…å†µå§ã€‚æˆ‘ä»¬å¯åŠ¨æœåŠ¡å™¨ï¼Œå‘èµ·è¿æ¥ï¼Œå¹¶ç›‘æ§å†…å­˜çš„ä½¿ç”¨æƒ…å†µã€‚

å½“æˆ‘å¯åŠ¨æœåŠ¡å™¨çš„æ—¶å€™ï¼Œå®ƒå ç”¨äº†ä¸€ä¸ªæ­£å¸¸å¤§å°çš„å†…å­˜ç©ºé—´ï¼Œ8.7MBï¼š

![](https://img11.360buyimg.com/uba/jfs/t5623/215/2967958024/56361/da4fbfad/59357b1bNeb053c07.png)

å½“æˆ‘è¿æ¥åˆ°æœåŠ¡å™¨çš„æ—¶å€™ã€‚è¯·æ³¨æ„å†…å­˜æ¶ˆè€—çš„å˜åŒ–ï¼š

![](https://img13.360buyimg.com/uba/jfs/t5683/37/2987262957/2500112/2678603c/59357b56N5fb2b483.gif)

å“‡ â€”â€” å†…å­˜æ¶ˆè€—æš´å¢åˆ° 434.8MBã€‚

åœ¨æˆ‘ä»¬å°†å…¶å†™å…¥å“åº”å¯¹è±¡ä¹‹å‰ï¼Œæˆ‘ä»¬åŸºæœ¬ä¸ŠæŠŠ `big.file` çš„å…¨éƒ¨å†…å®¹éƒ½è½½å…¥åˆ°å†…å­˜ä¸­äº†ã€‚è¿™æ˜¯éå¸¸ä½æ•ˆçš„ã€‚

HTTP å“åº”å¯¹è±¡ä¹Ÿæ˜¯ä¸€ä¸ªå¯å†™æµã€‚è¿™æ„å‘³ç€å¦‚æœæˆ‘ä»¬æœ‰ä¸€ä¸ªä»£è¡¨äº† `big.file` å†…å®¹çš„å¯è¯»æµï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡å°†ä¸¤ä¸ªæµè¿æ¥èµ·æ¥ä»¥å®ç°ç›¸åŒçš„åŠŸèƒ½è€Œä¸å¿…æ¶ˆè€—çº¦ 400MB çš„å†…å­˜ã€‚

Node `fs` æ¨¡å—ä¸­çš„ `createReadStream` æ–¹æ³•å¯ä»¥é’ˆå¯¹ä»»ä½•æ–‡ä»¶ç»™æˆ‘ä»¬è¿”å›ä¸€ä¸ªå¯è¯»æµã€‚æˆ‘ä»¬å¯ä»¥æŠŠå®ƒå’Œå“åº”å¯¹è±¡è¿æ¥èµ·æ¥ï¼š

```js
const fs = require('fs');
const server = require('http').createServer();

server.on('request', (req, res) => {
  const src = fs.createReadStream('./big.file');
  src.pipe(res);
});

server.listen(8000);
```

ç°åœ¨ï¼Œå½“ä½ å†æ¬¡è¿æ¥åˆ°æœåŠ¡å™¨æ—¶ï¼Œç¥å¥‡çš„äº‹æƒ…å‘ç”Ÿäº†ï¼ˆè¯·æ³¨æ„å†…å­˜æ¶ˆè€—ï¼‰ï¼š

![](https://cloud.githubusercontent.com/assets/1198651/26791059/85afb648-4a48-11e7-917c-48415d8737ee.gif)

**å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ**

å½“å®¢æˆ·ç«¯è¯·æ±‚è¿™ä¸ªå¤§æ–‡ä»¶æ—¶ï¼Œæˆ‘ä»¬é€šè¿‡æµé€å—çš„å‘é€æ•°æ®ã€‚è¿™æ„å‘³ç€æˆ‘ä»¬ä¸éœ€è¦æŠŠæ–‡ä»¶çš„å…¨éƒ¨å†…å®¹ç¼“å­˜åˆ°å†…å­˜ä¸­ã€‚å†…å­˜æ¶ˆè€—åªå¢é•¿äº†å¤§çº¦ 25MBã€‚

ä½ å¯ä»¥æŠŠè¿™ä¸ªä¾‹å­æ¨å‘æç«¯ã€‚é‡æ–°ç”Ÿæˆä¸€ä¸ª 500 ä¸‡è¡Œè€Œä¸æ˜¯ 100 ä¸‡è¡Œçš„ `big.file` æ–‡ä»¶ã€‚å®ƒå¤§æ¦‚æœ‰ 2GB é‚£ä¹ˆå¤§ã€‚è¿™å·²ç»è¶…è¿‡äº† Node ä¸­é»˜è®¤çš„ç¼“å†²åŒºå¤§å°çš„ä¸Šé™ã€‚

å¦‚æœä½ å°è¯•é€šè¿‡ `fs.readFile` è¯»å–é‚£ä¸ªæ–‡ä»¶ï¼Œé»˜è®¤æƒ…å†µä¸‹ä¼šå¤±è´¥ï¼ˆå½“ç„¶ä½ å¯ä»¥ä¿®æ”¹ç¼“å†²åŒºå¤§å°ä¸Šé™ï¼‰ã€‚ä½†æ˜¯é€šè¿‡ä½¿ç”¨ `fs.createReadStream`ï¼Œå‘å®¢æˆ·ç«¯å‘é€ä¸€ä¸ª 2GB çš„æ–‡ä»¶å°±æ²¡æœ‰ä»»ä½•é—®é¢˜ã€‚æ›´æ£’çš„æ˜¯ï¼Œè¿›ç¨‹çš„å†…å­˜æ¶ˆè€—å¹¶ä¸ä¼šå› æ–‡ä»¶å¢å¤§è€Œå¢é•¿ã€‚

å‡†å¤‡å¥½å­¦ä¹ æµäº†å—ï¼Ÿ

> è¿™ç¯‡æ–‡ç« æ˜¯[æˆ‘çš„ Pluralsight è¯¾å ‚ä¸Š Node.js è¯¾ç¨‹](https://www.pluralsight.com/courses/nodejs-advanced)ä¸­çš„ä¸€éƒ¨åˆ†ã€‚ä½ å¯ä»¥é€šè¿‡è¿™ä¸ªé“¾æ¥æ‰¾åˆ°è¿™éƒ¨åˆ†å†…å®¹çš„è§†é¢‘ç‰ˆã€‚

### æµå¿«é€Ÿå…¥é—¨ ###

åœ¨ Node.js ä¸­æœ‰å››ç§åŸºæœ¬ç±»å‹çš„æµï¼šå¯è¯»æµï¼Œå¯å†™æµï¼ŒåŒå‘æµä»¥åŠå˜æ¢æµã€‚

- å¯è¯»æµæ˜¯å¯¹ä¸€ä¸ªå¯ä»¥è¯»å–æ•°æ®çš„æºçš„æŠ½è±¡ã€‚`fs.createReadStream` æ–¹æ³•æ˜¯ä¸€ä¸ªå¯è¯»æµçš„ä¾‹å­ã€‚
- å¯å†™æµæ˜¯å¯¹ä¸€ä¸ªå¯ä»¥å†™å…¥æ•°æ®çš„ç›®æ ‡çš„æŠ½è±¡ã€‚`fs.createWriteStream` æ–¹æ³•æ˜¯ä¸€ä¸ªå¯å†™æµçš„ä¾‹å­ã€‚
- åŒå‘æµæ—¢æ˜¯å¯è¯»çš„ï¼Œåˆæ˜¯å¯å†™çš„ã€‚TCP socket å°±å±äºè¿™ç§ã€‚
- å˜æ¢æµæ˜¯ä¸€ç§ç‰¹æ®Šçš„åŒå‘æµï¼Œå®ƒä¼šåŸºäºå†™å…¥çš„æ•°æ®ç”Ÿæˆå¯ä¾›è¯»å–çš„æ•°æ®ã€‚ä¾‹å¦‚ä½¿ç”¨ `zlib.createGzip` æ¥å‹ç¼©æ•°æ®ã€‚ä½ å¯ä»¥æŠŠä¸€ä¸ªå˜æ¢æµæƒ³è±¡æˆä¸€ä¸ªå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°çš„è¾“å…¥éƒ¨åˆ†å¯¹åº”å¯å†™æµï¼Œè¾“å‡ºéƒ¨åˆ†å¯¹åº”å¯è¯»æµã€‚ä½ ä¹Ÿå¯èƒ½å¬è¯´è¿‡å˜æ¢æµæœ‰æ—¶è¢«ç§°ä¸º â€œ**thought streams**â€ã€‚

æ‰€æœ‰çš„æµéƒ½æ˜¯ `EventEmitter` çš„å®ä¾‹ã€‚å®ƒä»¬å‘å‡ºå¯ç”¨äºè¯»å–æˆ–å†™å…¥æ•°æ®çš„äº‹ä»¶ã€‚ç„¶è€Œï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨ `pipe` æ–¹æ³•ä»¥ä¸€ç§æ›´ç®€å•çš„æ–¹å¼ä½¿ç”¨æµä¸­çš„æ•°æ®ã€‚

#### pipe æ–¹æ³• ####

ä»¥ä¸‹è¿™è¡Œä»£ç å°±æ˜¯ä½ è¦è®°ä½çš„é­”æ³•ï¼š

```js
readableSrc.pipe(writableDest)
```

åœ¨è¿™è¡Œç®€å•çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬ä»¥ç®¡é“çš„æ–¹å¼æŠŠä¸€ä¸ªå¯è¯»æµçš„è¾“å‡ºè¿æ¥åˆ°äº†ä¸€ä¸ªå¯å†™æµçš„è¾“å…¥ã€‚ç®¡é“çš„ä¸Šæ¸¸ï¼ˆsourceï¼‰å¿…é¡»æ˜¯ä¸€ä¸ªå¯è¯»æµï¼Œä¸‹æ¸¸ï¼ˆdestinationï¼‰å¿…é¡»æ˜¯ä¸€ä¸ªå¯å†™æµã€‚å½“ç„¶ï¼Œå®ƒä»¬ä¹Ÿå¯ä»¥æ˜¯åŒå‘æµ/å˜æ¢æµã€‚äº‹å®ä¸Šï¼Œå¦‚æœæˆ‘ä»¬ä½¿ç”¨ç®¡é“è¿æ¥çš„æ˜¯åŒå‘æµï¼Œæˆ‘ä»¬å°±å¯ä»¥åƒ Linux ç³»ç»Ÿé‡Œé‚£æ ·è¿æ¥å¤šä¸ªæµï¼š

```js
readableSrc
  .pipe(transformStream1)
  .pipe(transformStream2)
  .pipe(finalWrtitableDest)
```

`pipe` æ–¹æ³•ä¼šè¿”å›æœ€åä¸€ä¸ªæµï¼Œè¿™ä½¿å¾—æˆ‘ä»¬å¯ä»¥ä¸²è”å¤šä¸ªæµã€‚å¯¹äºæµ `a` ï¼ˆå¯è¯»ï¼‰ï¼Œ`b` å’Œ `c` ï¼ˆåŒå‘ï¼‰ï¼Œä»¥åŠ `d`ï¼ˆå¯å†™ï¼‰ã€‚æˆ‘ä»¬å¯ä»¥è¿™æ ·ï¼š

```js
a.pipe(b).pipe(c).pipe(d)

# ç­‰ä»·äº:
a.pipe(b)
b.pipe(c)
c.pipe(d)

# åœ¨ Linux ä¸­ï¼Œç­‰ä»·äºï¼š
$ a | b | c | d
```

`pipe` æ–¹æ³•æ˜¯ä½¿ç”¨æµæœ€ç®€å•çš„æ–¹å¼ã€‚é€šå¸¸çš„å»ºè®®æ˜¯è¦ä¹ˆä½¿ç”¨ `pipe` æ–¹æ³•ã€è¦ä¹ˆä½¿ç”¨äº‹ä»¶æ¥è¯»å–æµï¼Œè¦é¿å…æ··åˆä½¿ç”¨ä¸¤è€…ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ä½¿ç”¨ `pipe` æ–¹æ³•æ—¶ä½ å°±ä¸å¿…å†ä½¿ç”¨äº‹ä»¶äº†ã€‚ä½†å¦‚æœä½ æƒ³ä»¥ä¸€ç§æ›´åŠ è‡ªå®šä¹‰çš„æ–¹å¼ä½¿ç”¨æµï¼Œå°±è¦ç”¨åˆ°äº‹ä»¶äº†ã€‚

#### æµäº‹ä»¶ ####

é™¤äº†ä»å¯è¯»æµä¸­è¯»å–æ•°æ®å†™å…¥å¯å†™æµä»¥å¤–ï¼Œ`pipe` æ–¹æ³•è¿˜è‡ªåŠ¨å¸®ä½ å¤„ç†äº†ä¸€äº›å…¶ä»–æƒ…å†µã€‚ä¾‹å¦‚ï¼Œé”™è¯¯å¤„ç†ï¼Œæ–‡ä»¶ç»“å°¾ï¼Œä»¥åŠä¸¤ä¸ªæµè¯»å–/å†™å…¥é€Ÿåº¦ä¸ä¸€è‡´çš„æƒ…å†µã€‚

ç„¶è€Œï¼Œæµä¹Ÿå¯ä»¥ç›´æ¥é€šè¿‡äº‹ä»¶è¯»å–ã€‚ä»¥ä¸‹æ˜¯ä¸€æ®µç®€åŒ–çš„ä½¿ç”¨äº‹ä»¶æ¥æ¨¡æ‹Ÿ `pipe` è¯»å–ã€å†™å…¥æ•°æ®çš„ä»£ç ï¼š

```js
# readable.pipe(writable)

readable.on('data', (chunk) => {
  writable.write(chunk);
});

readable.on('end', () => {
  writable.end();
});
```

ä»¥ä¸‹æ˜¯ä¸€äº›ä½¿ç”¨å¯è¯»æµæˆ–å¯å†™æµæ—¶ç”¨åˆ°çš„äº‹ä»¶å’Œæ–¹æ³•ï¼š

![](https://img12.360buyimg.com/uba/jfs/t5761/104/2911588509/94847/ca85cce7/59357be5Nfc521b48.png)

æˆªå±æ¥è‡ªäºæˆ‘çš„ Pluralsight è¯¾ç¨‹ - é«˜çº§ Node.js

è¿™äº›äº‹ä»¶å’Œå‡½æ•°æ˜¯ç›¸å…³çš„ï¼Œå› ä¸ºæˆ‘ä»¬æ€»æ˜¯æŠŠå®ƒä»¬ç»„åˆåœ¨ä¸€èµ·ä½¿ç”¨ã€‚

ä¸€ä¸ªå¯è¯»æµä¸Šæœ€é‡è¦çš„ä¸¤ä¸ªäº‹ä»¶æ˜¯ï¼š

- `data` äº‹ä»¶ï¼Œä»»ä½•æ—¶å€™å½“å¯è¯»æµå‘é€æ•°æ®ç»™å®ƒçš„æ¶ˆè´¹è€…æ—¶ï¼Œä¼šè§¦å‘æ­¤äº‹ä»¶
- `end` äº‹ä»¶ï¼Œå½“å¯è¯»æµæ²¡æœ‰æ›´å¤šçš„æ•°æ®è¦å‘é€ç»™æ¶ˆè´¹è€…æ—¶ï¼Œä¼šè§¦å‘æ­¤äº‹ä»¶

ä¸€ä¸ªå¯å†™æµä¸Šæœ€é‡è¦çš„ä¸¤ä¸ªäº‹ä»¶æ˜¯ï¼š

- `drain` äº‹ä»¶ï¼Œè¿™æ˜¯ä¸€ä¸ªè¡¨ç¤ºå¯å†™æµå¯ä»¥æ¥å—æ›´å¤šæ•°æ®çš„ä¿¡å·.
- `finish` äº‹ä»¶ï¼Œå½“æ‰€æœ‰æ•°æ®éƒ½è¢«å†™å…¥åº•å±‚ç³»ç»Ÿåä¼šè§¦å‘æ­¤äº‹ä»¶ã€‚

äº‹ä»¶å’Œå‡½æ•°å¯ä»¥ç»„åˆèµ·æ¥ä½¿ç”¨ï¼Œä»¥æ›´åŠ å®šåˆ¶ï¼Œä¼˜åŒ–çš„æ–¹å¼ä½¿ç”¨æµã€‚å¯¹äºå¯è¯»æµï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `pipe`/`unpipe` æ–¹æ³•ï¼Œæˆ–æ˜¯ `read`ï¼Œ`unshift`ï¼Œ`resume`æ–¹æ³•ã€‚å¯¹äºå¯å†™æµï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå®ƒè®¾ç½®ä¸º `pipe`/`unpipe` æ–¹æ³•çš„ä¸‹æ¸¸ï¼Œäº¦æˆ–æ˜¯ä½¿ç”¨ `write` æ–¹æ³•å†™å…¥æ•°æ®å¹¶åœ¨å†™å…¥å®Œæˆåè°ƒç”¨ `end` æ–¹æ³•ã€‚

#### å¯è¯»æµçš„æš‚åœå’ŒæµåŠ¨æ¨¡å¼ ####

å¯è¯»æµæœ‰ä¸¤ç§ä¸»è¦çš„æ¨¡å¼ï¼Œå½±å“æˆ‘ä»¬ä½¿ç”¨å®ƒçš„æ–¹å¼ï¼š

- å®ƒè¦ä¹ˆå¤„äº**æš‚åœ**æ¨¡å¼
- è¦ä¹ˆå°±æ˜¯å¤„äº**æµåŠ¨**æ¨¡å¼

è¿™äº›æ¨¡å¼æœ‰æ—¶ä¹Ÿè¢«æˆä¸ºæ‹‰å–å’Œæ¨é€æ¨¡å¼ã€‚

æ‰€æœ‰çš„å¯è¯»æµé»˜è®¤éƒ½å¤„äºæš‚åœæ¨¡å¼ã€‚ä½†å®ƒä»¬å¯ä»¥æŒ‰éœ€åœ¨æµåŠ¨æ¨¡å¼å’Œæš‚åœæ¨¡å¼é—´åˆ‡æ¢ã€‚è¿™ç§åˆ‡æ¢æœ‰æ—¶ä¼šè‡ªåŠ¨å‘ç”Ÿã€‚

å½“ä¸€ä¸ªå¯è¯»æµå¤„äºæš‚åœæ¨¡å¼æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `read()` æ–¹æ³•æŒ‰éœ€çš„è¯»å–æ•°æ®ã€‚è€Œå¯¹äºä¸€ä¸ªå¤„äºæµåŠ¨æ¨¡å¼çš„å¯è¯»æµï¼Œæ•°æ®ä¼šæºæºä¸æ–­çš„æµåŠ¨ï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡äº‹ä»¶ç›‘å¬æ¥å¤„ç†æ•°æ®ã€‚

åœ¨æµåŠ¨æ¨¡å¼ä¸­ï¼Œå¦‚æœæ²¡æœ‰æ¶ˆè´¹è€…ç›‘å¬äº‹ä»¶é‚£ä¹ˆæ•°æ®å°±ä¼šä¸¢å¤±ã€‚è¿™å°±æ˜¯ä¸ºä½•åœ¨å¤„ç†æµåŠ¨æ¨¡å¼çš„å¯è¯»æµæ—¶æˆ‘ä»¬éœ€è¦ä¸€ä¸ª `data` äº‹ä»¶å›è°ƒå‡½æ•°ã€‚äº‹å®ä¸Šï¼Œé€šè¿‡å¢åŠ ä¸€ä¸ª `data` äº‹ä»¶å›è°ƒå°±å¯ä»¥æŠŠå¤„äºæš‚åœæ¨¡å¼çš„æµåˆ‡æ¢åˆ°æµåŠ¨æ¨¡å¼ï¼›åŒæ ·çš„ï¼Œç§»é™¤ `data` äº‹ä»¶å›è°ƒä¼šæŠŠæµåˆ‡å›åˆ°æš‚åœæ¨¡å¼ã€‚è¿™ä¹ˆåšçš„ä¸€éƒ¨åˆ†åŸå› æ˜¯ä¸ºäº†å’Œæ—§çš„ Node æµæ¥å£å…¼å®¹ã€‚

è¦æ‰‹åŠ¨åœ¨è¿™ä¸¤ä¸ªæ¨¡å¼é—´åˆ‡æ¢ï¼Œä½ å¯ä»¥ä½¿ç”¨ `resume()` å’Œ `pause()` æ–¹æ³•ã€‚

![](https://img10.360buyimg.com/uba/jfs/t5713/301/2899078962/40099/a3c38f7d/59357c0dN8df8e18c.png)

æˆªå±æ¥è‡ªäºæˆ‘çš„ Pluralsight è¯¾ç¨‹ - é«˜çº§ Node.js

å½“ä½¿ç”¨ `pipe` æ–¹æ³•æ—¶ï¼Œå®ƒä¼šè‡ªåŠ¨å¸®ä½ å¤„ç†å¥½è¿™äº›æ¨¡å¼ä¹‹é—´çš„åˆ‡æ¢ï¼Œå› æ­¤ä½ æ— é¡»å…³å¿ƒè¿™äº›ç»†èŠ‚ã€‚

### å®ç°æµæ¥å£ ###

å½“æˆ‘ä»¬è®¨è®º Node.js ä¸­çš„æµæ—¶ï¼Œä¸»è¦æ˜¯è®¨è®ºä¸¤é¡¹ä»»åŠ¡ï¼š

- ä¸€ä¸ªæ˜¯**å®ç°**æµã€‚
- ä¸€ä¸ªæ˜¯**ä½¿ç”¨**æµã€‚

åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬åªè®¨è®ºäº†å¦‚ä½•ä½¿ç”¨æµã€‚æ¥ä¸‹æ¥è®©æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•å®ç°å®ƒï¼

æµçš„å®ç°è€…é€šå¸¸éƒ½ä¼š `require` `stream` æ¨¡å—ã€‚

#### å®ç°ä¸€ä¸ªå¯å†™æµ ####

è¦å®ç°ä¸€ä¸ªå¯å†™æµï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨æ¥è‡ª stream æ¨¡å—çš„ `Writable` ç±»ã€‚

```js
const { Writable } = require('streams');
```

å®ç°ä¸€ä¸ªå¯å†™æµæœ‰å¾ˆå¤šç§æ–¹æ³•ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥ç»§æ‰¿ `Writable` ç±»ï¼š

```js
class myWritableStream extends Writable {
}
```

ç„¶è€Œï¼Œæˆ‘å€¾å‘äºæ›´ç®€å•çš„æ„é€ æ–¹æ³•ã€‚æˆ‘ä»¬å¯ä»¥ç›´æ¥ç»™ `Writable` æ„é€ å‡½æ•°ä¼ å…¥é…ç½®é¡¹æ¥åˆ›å»ºä¸€ä¸ªå¯¹è±¡ã€‚å”¯ä¸€å¿…é¡»çš„é…ç½®é¡¹æ˜¯ä¸€ä¸ª `write` å‡½æ•°ï¼Œå®ƒç”¨äºæš´éœ²ä¸€ä¸ªå†™å…¥æ•°æ®çš„æ¥å£ã€‚

```js
const { Writable } = require('stream');
const outStream = new Writable({
  write(chunk, encoding, callback) {
    console.log(chunk.toString());
    callback();
  }
});

process.stdin.pipe(outStream);
```

write æ–¹æ³•æ¥å—ä¸‰ä¸ªå‚æ•°ã€‚

- **chunk** é€šå¸¸æ˜¯ä¸€ä¸ª bufferï¼Œé™¤éæˆ‘ä»¬å¯¹æµè¿›è¡Œäº†ç‰¹æ®Šé…ç½®ã€‚
- **encoding** é€šå¸¸å¯ä»¥å¿½ç•¥ã€‚é™¤é chunk è¢«é…ç½®ä¸ºä¸æ˜¯ bufferã€‚
- **callback** æ–¹æ³•æ˜¯ä¸€ä¸ªåœ¨æˆ‘ä»¬å®Œæˆæ•°æ®å¤„ç†åè¦æ‰§è¡Œçš„å›è°ƒå‡½æ•°ã€‚å®ƒç”¨æ¥è¡¨ç¤ºæ•°æ®æ˜¯å¦æˆåŠŸå†™å…¥ã€‚è‹¥æ˜¯å†™å…¥å¤±è´¥ï¼Œåœ¨æ‰§è¡Œè¯¥å›è°ƒå‡½æ•°æ—¶éœ€è¦ä¼ å…¥ä¸€ä¸ªé”™è¯¯å¯¹è±¡ã€‚

åœ¨ `outStream` ä¸­ï¼Œæˆ‘ä»¬åªæ˜¯å•çº¯çš„æŠŠæ”¶åˆ°çš„æ•°æ®å½“åšå­—ç¬¦ä¸² `console.log` å‡ºæ¥ï¼Œå¹¶é€šè¿‡æ‰§è¡Œ `callback` æ—¶ä¸ä¼ å…¥é”™è¯¯å¯¹è±¡ä»¥è¡¨ç¤ºå†™å…¥æˆåŠŸã€‚è¿™æ˜¯ä¸€ä¸ªéå¸¸ç®€å•ä¸”æ²¡ä»€ä¹ˆç”¨å¤„çš„**å›ä¼ **æµã€‚å®ƒä¼šå›ä¼ ä»»ä½•æ”¶åˆ°çš„æ•°æ®ã€‚

è¦ä½¿ç”¨è¿™ä¸ªæµï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå®ƒå’Œå¯è¯»æµ `process.stdin` é…åˆä½¿ç”¨ã€‚åªéœ€æŠŠ `process.stdin` é€šè¿‡ç®¡é“è¿æ¥åˆ° `outStream`ã€‚

å½“æˆ‘ä»¬è¿è¡Œä¸Šé¢çš„ä»£ç æ—¶ï¼Œä»»ä½•è¾“å…¥åˆ° `process.stdin` ä¸­çš„å­—ç¬¦éƒ½ä¼šè¢« `outStream` ä¸­çš„ `console.log` è¾“å‡ºå›æ¥ã€‚

è¿™ä¸æ˜¯ä¸€ä¸ªéå¸¸å®ç”¨çš„æµå®ç°ï¼Œå› ä¸º Node å·²ç»å†…ç½®äº†å®ƒçš„å®ç°ã€‚å®ƒå‡ ä¹ç­‰åŒäº `process.stdout`ã€‚é€šè¿‡æŠŠ `stdin` å’Œ `stdout` è¿æ¥èµ·æ¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡ä¸€è¡Œä»£ç å¾—åˆ°å®Œå…¨ç›¸åŒçš„å›ä¼ æ•ˆæœï¼š

```js
process.stdin.pipe(process.stdout);
```

#### å®ç°ä¸€ä¸ªå¯è¯»æµ ####

è¦å®ç°å¯è¯»æµï¼Œæˆ‘ä»¬éœ€è¦å¼•å…¥ `Readable` æ¥å£å¹¶é€šè¿‡å®ƒåˆ›å»ºå¯¹è±¡ï¼š

```js
const { Readable } = require('stream');

const inStream = new Readable({});
```

è¿™æ˜¯ä¸€ä¸ªéå¸¸ç®€å•çš„å¯è¯»æµå®ç°ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ `push` æ–¹æ³•å‘ä¸‹æ¸¸æ¨é€æ•°æ®ã€‚

```js
const { Readable } = require('stream');  

const inStream = new Readable();

inStream.push('ABCDEFGHIJKLM');
inStream.push('NOPQRSTUVWXYZ');

inStream.push(null); // æ²¡æœ‰æ›´å¤šæ•°æ®äº†

inStream.pipe(process.stdout);
```

å½“æˆ‘ä»¬ `push` ä¸€ä¸ª `null` å€¼ï¼Œè¿™è¡¨ç¤ºè¯¥æµåç»­ä¸ä¼šå†æœ‰ä»»ä½•æ•°æ®äº†ã€‚

è¦ä½¿ç”¨è¿™ä¸ªå¯è¯»æµï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå®ƒè¿æ¥åˆ°å¯å†™æµ `process.stdout`ã€‚

å½“æˆ‘ä»¬æ‰§è¡Œä»¥ä¸Šä»£ç æ—¶ï¼Œæ‰€æœ‰è¯»å–è‡ª `inStream` çš„æ•°æ®éƒ½ä¼šè¢«æ˜¾ç¤ºåˆ°æ ‡å‡†è¾“å‡ºä¸Šã€‚éå¸¸ç®€å•ï¼Œä½†å¹¶ä¸é«˜æ•ˆã€‚

åœ¨æŠŠè¯¥æµè¿æ¥åˆ° `process.stdout` ä¹‹å‰ï¼Œæˆ‘ä»¬å°±å·²ç»æ¨é€äº†æ‰€æœ‰æ•°æ®ã€‚æ›´å¥½çš„æ–¹å¼æ˜¯åªåœ¨ä½¿ç”¨è€…è¦æ±‚æ—¶**æŒ‰éœ€**æ¨é€æ•°æ®ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡åœ¨å¯è¯»æµé…ç½®ä¸­å®ç° `read()` æ–¹æ³•æ¥è¾¾æˆè¿™ä¸€ç›®çš„ï¼š

```js
const inStream = new Readable({
  read(size) {
    // æŸäººæƒ³è¦è¯»å–æ•°æ®
  }
});
```

å½“å¯è¯»æµä¸Šçš„ read æ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼Œæµå®ç°å¯ä»¥å‘é˜Ÿåˆ—ä¸­æ¨é€éƒ¨åˆ†æ•°æ®ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥ä»å­—ç¬¦ç¼–ç  65ï¼ˆè¡¨ç¤ºå­—æ¯ Aï¼‰ å¼€å§‹ï¼Œä¸€æ¬¡æ¨é€ä¸€ä¸ªå­—æ¯ï¼Œæ¯æ¬¡éƒ½æŠŠå­—ç¬¦ç¼–ç åŠ  1ï¼š

```js
const inStream = new Readable({
  read(size) {
    this.push(String.fromCharCode(this.currentCharCode++));
    if (this.currentCharCode > 90) {
      this.push(null);
    }
  }
});

inStream.currentCharCode = 65

inStream.pipe(process.stdout);
```



å½“ä½¿ç”¨è€…è¯»å–è¯¥å¯è¯»æµæ—¶ï¼Œ`read` æ–¹æ³•ä¼šæŒç»­è¢«è§¦å‘ï¼Œæˆ‘ä»¬ä¸æ–­æ¨é€å­—æ¯ã€‚æˆ‘ä»¬éœ€è¦åœ¨æŸå¤„åœæ­¢è¯¥å¾ªç¯ï¼Œè¿™å°±æ˜¯ä¸ºä½•æˆ‘ä»¬æ”¾ç½®äº†ä¸€ä¸ª if è¯­å¥ä»¥ä¾¿åœ¨ currentCharCode å¤§äº 90ï¼ˆä»£è¡¨ Zï¼‰ æ—¶æ¨é€ä¸€ä¸ª null å€¼ã€‚

è¿™æ®µä»£ç ç­‰ä»·äºä¹‹å‰çš„æˆ‘ä»¬å¼€å§‹æ—¶ç¼–å†™çš„é‚£æ®µç®€å•ä»£ç ï¼Œä½†æˆ‘ä»¬å·²æ”¹ä¸ºåœ¨ä½¿ç”¨è€…éœ€è¦æ—¶æ¨é€æ•°æ®ã€‚ä½ å§‹ç»ˆåº”è¯¥è¿™æ ·åšã€‚

#### å®ç°åŒå‘/å˜æ¢æµ ####

å¯¹äºåŒå‘æµï¼Œæˆ‘ä»¬è¦åœ¨åŒä¸€ä¸ªå¯¹è±¡ä¸ŠåŒæ—¶ç°å®å¯è¯»æµå’Œå¯å†™æµã€‚å°±å¥½åƒæ˜¯æˆ‘ä»¬ç»§æ‰¿äº†ä¸¤ä¸ªæ¥å£ã€‚

ä»¥ä¸‹çš„ä¾‹å­å®ç°äº†ä¸€ä¸ªç»¼åˆäº†å‰é¢æåˆ°çš„å¯è¯»æµä¸å¯å†™æµåŠŸèƒ½çš„åŒå‘æµï¼š

```js
const { Duplex } = require('stream');

const inoutStream = new Duplex({
  write(chunk, encoding, callback) {
    console.log(chunk.toString());
    callback();
  },

  read(size) {
    this.push(String.fromCharCode(this.currentCharCode++));
    if (this.currentCharCode > 90) {
      this.push(null);
    }
  }
});

inoutStream.currentCharCode = 65;

process.stdin.pipe(inoutStream).pipe(process.stdout);
```

é€šè¿‡ç»„åˆè¿™äº›æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è¯¥åŒå‘æµè¯»å–ä» A åˆ° Z çš„å­—æ¯è¿˜å¯ä»¥åˆ©ç”¨å®ƒçš„å›ä¼ ç‰¹æ€§ã€‚æˆ‘ä»¬æŠŠå¯è¯»çš„ `stdin` æµæ¥å…¥è¿™ä¸ªåŒå‘æµä»¥åˆ©ç”¨å®ƒçš„å›ä¼ ç‰¹æ€§åŒæ—¶åˆæŠŠå®ƒæ¥å…¥å¯å†™çš„ `stdout` æµä»¥æŸ¥çœ‹å­—æ¯ A åˆ° Zã€‚

ç†è§£åŒå‘æµçš„è¯»å–å’Œå†™å…¥éƒ¨åˆ†æ˜¯å®Œå…¨ç‹¬ç«‹çš„è¿™ä¸€ç‚¹éå¸¸é‡è¦ã€‚å®ƒåªä¸è¿‡æ˜¯æŠŠä¸¤ç§ç‰¹æ€§åœ¨åŒä¸€ä¸ªå¯¹è±¡ä¸Šå®ç°ç½¢äº†ã€‚

å˜æ¢æµæ˜¯ä¸€ç§æ›´æœ‰è¶£çš„åŒå‘æµï¼Œå› ä¸ºå®ƒçš„è¾“å‡ºæ˜¯åŸºäºè¾“å…¥è¿ç®—å¾—åˆ°çš„ã€‚

å¯¹äºä¸€ä¸ªå˜æ¢æµï¼Œæˆ‘ä»¬ä¸éœ€è¦å®ç° `read` æˆ– `write` æ–¹æ³•ï¼Œè€Œæ˜¯åªéœ€è¦å®ç°ä¸€ä¸ª `transform` æ–¹æ³•å³å¯ï¼Œå®ƒç»“åˆäº†äºŒè€…çš„åŠŸèƒ½ã€‚å®ƒçš„å‡½æ•°ç­¾åå’Œ `write` æ–¹æ³•ä¸€è‡´ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡å®ƒ `push` æ•°æ®ã€‚

ä»¥ä¸‹æ˜¯ä¸€ä¸ªæŠŠä½ è¾“å…¥çš„ä»»ä½•å†…å®¹è½¬æ¢ä¸ºå¤§å†™å­—æ¯çš„å˜æ¢æµï¼š

```js
const { Transform } = require('stream');

const upperCaseTr = new Transform({
  transform(chunk, encoding, callback) {
    this.push(chunk.toString().toUpperCase());
    callback();
  }
});

process.stdin.pipe(upperCaseTr).pipe(process.stdout);
```

åœ¨è¿™ä¸ªå˜æ¢æµä¸­ï¼Œæˆ‘ä»¬åªå®ç°äº† `transform()` æ–¹æ³•ï¼Œå´è¾¾åˆ°äº†å‰é¢åŒå‘æµä¾‹å­çš„æ•ˆæœã€‚åœ¨è¯¥æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬æŠŠ `chunk` è½¬æ¢ä¸ºå¤§å†™ç„¶åé€šè¿‡ `push` æ–¹æ³•ä¼ é€’ç»™ä¸‹æ¸¸ã€‚

#### æµå¯¹è±¡æ¨¡å¼ ####

é»˜è®¤æƒ…å†µä¸‹ï¼Œæµæ¥æ”¶çš„å‚æ•°ç±»å‹ä¸º Buffer/Stringã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡è®¾ç½® `objectMode` å‚æ•°ä½¿å¾—æµå¯ä»¥æ¥å—ä»»ä½• JavaScript å¯¹è±¡ã€‚

ä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€å•çš„æ¼”ç¤ºã€‚ä»¥ä¸‹å˜æ¢æµçš„ç»„åˆç”¨äºæŠŠä¸€ä¸ªé€—å·åˆ†å‰²çš„å­—ç¬¦ä¸²è½¬å˜æˆä¸ºä¸€ä¸ª JavaScript å¯¹è±¡ã€‚ä¼ å…¥ "a,b,c,d" å°±å˜æˆäº† `{a: b, c: d}`ã€‚

```js
const { Transform } = require('stream');
const commaSplitter = new Transform({
  readableObjectMode: true,
  transform(chunk, encoding, callback) {
    this.push(chunk.toString().trim().split(','));
    callback();
  }
});
const arrayToObject = new Transform({
  readableObjectMode: true,
  writableObjectMode: true,
  transform(chunk, encoding, callback) {
    const obj = {};
    for(let i=0; i < chunk.length; i+=2) {
      obj[chunk[i]] = chunk[i+1];
    }
    this.push(obj);
    callback();
  }
});
const objectToString = new Transform({
  writableObjectMode: true,
  transform(chunk, encoding, callback) {
    this.push(JSON.stringify(chunk) + '\n');
    callback();
  }
});
process.stdin
  .pipe(commaSplitter)
  .pipe(arrayToObject)
  .pipe(objectToString)
  .pipe(process.stdout)
```

æˆ‘ä»¬ç»™ `commaSplitter` ä¼ å…¥ä¸€ä¸ªå­—ç¬¦ä¸²ï¼ˆå‡è®¾æ˜¯ `"a,b,c,d"`ï¼‰ï¼Œå®ƒä¼šè¾“å‡ºä¸€ä¸ªæ•°ç»„ä½œä¸ºå¯è¯»æ•°æ®ï¼ˆ`[â€œaâ€, â€œbâ€, â€œcâ€, â€œdâ€]`ï¼‰ã€‚åœ¨è¯¥æµä¸Šå¢åŠ  `readableObjectMode` æ ‡è®°æ˜¯å¿…é¡»çš„ï¼Œå› ä¸ºæˆ‘ä»¬åœ¨ç»™ä¸‹æ¸¸æ¨é€ä¸€ä¸ªå¯¹è±¡ï¼Œè€Œä¸æ˜¯å­—ç¬¦ä¸²ã€‚

æˆ‘ä»¬æ¥ç€æŠŠ `commaSplitter` è¾“å‡ºçš„æ•°ç»„ä¼ é€’ç»™äº† `arrayToObject` æµã€‚æˆ‘ä»¬éœ€è¦è®¾ç½® `writableObjectModel` ä»¥ä¾¿è®©è¯¥æµå¯ä»¥æ¥æ”¶ä¸€ä¸ªå¯¹è±¡ã€‚å®ƒè¿˜ä¼šå¾€ä¸‹æ¸¸æ¨é€ä¸€ä¸ªå¯¹è±¡ï¼ˆè¾“å…¥çš„æ•°æ®è¢«è½¬æ¢æˆå¯¹è±¡ï¼‰ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬è¿˜éœ€è¦é…ç½® `readableObjectMode` æ ‡å¿—ä½ã€‚æœ€åçš„ `objectToString` æµæ¥æ”¶ä¸€ä¸ªå¯¹è±¡ä½†å´è¾“å‡ºä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå› æ­¤æˆ‘ä»¬åªéœ€é…ç½® `writableObjectMode` å³å¯ã€‚ä¼ é€’ç»™ä¸‹æ¸¸çš„åªæ˜¯ä¸€ä¸ªæ™®é€šå­—ç¬¦ä¸²ã€‚

![](https://img11.360buyimg.com/uba/jfs/t5704/241/2983971686/10498/24064b45/59357c3aN4d192424.png)

ä»¥ä¸Šå®ä¾‹ä»£ç çš„ä½¿ç”¨æ–¹æ³•

#### Node å†…ç½®çš„å˜æ¢æµ ####

Node å†…ç½®äº†ä¸€äº›éå¸¸æœ‰ç”¨çš„å˜æ¢æµã€‚è¿™å°±æ˜¯ zlib å’Œ crypto æµã€‚

ä¸‹é¢æ˜¯ä¸€ä¸ªç»„åˆäº† `zlib.createGzip()` å’Œ `fs` å¯è¯»/å¯å†™æµæ¥å‹ç¼©æ–‡ä»¶çš„è„šæœ¬ï¼š

```js
const fs = require('fs');
const zlib = require('zlib');
const file = process.argv[2];

fs.createReadStream(file)
  .pipe(zlib.createGzip())
  .pipe(fs.createWriteStream(file + '.gz'));
```

ä½ å¯ä»¥é€šè¿‡è¯¥è„šæœ¬ç»™ä»»ä½•å‚æ•°ä¸­ä¼ å…¥çš„æ–‡ä»¶è¿›è¡Œ gzip å‹ç¼©ã€‚æˆ‘ä»¬é€šè¿‡å¯è¯»æµè¯»å–æ–‡ä»¶å†…å®¹ä¼ é€’ç»™ zlib å†…ç½®çš„å˜æ¢æµï¼Œç„¶åé€šè¿‡ä¸€ä¸ªå¯å†™æµæ¥å†™å…¥æ–°æ–‡ä»¶ã€‚å¾ˆç®€å•å§ã€‚

ä½¿ç”¨ç®¡é“å¾ˆæ£’çš„ä¸€ç‚¹åœ¨äºï¼Œå¦‚æœæœ‰å¿…è¦ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå®ƒå’Œäº‹ä»¶ç»„åˆä½¿ç”¨ã€‚ä¾‹å¦‚ï¼Œæˆ‘å¸Œæœ›åœ¨è„šæœ¬æ‰§è¡Œè¿‡ç¨‹ä¸­ç»™ç”¨æˆ·ä¸€äº›è¿›åº¦æç¤ºï¼Œåœ¨è„šæœ¬æ‰§è¡Œå®Œæˆåæ˜¾ç¤ºä¸€æ¡å®Œæˆæ¶ˆæ¯ã€‚æ—¢ç„¶ `pipe` æ–¹æ³•ä¼šè¿”å›ä¸‹æ¸¸æµï¼Œæˆ‘ä»¬å°±å¯ä»¥æŠŠæ³¨å†Œäº‹ä»¶å›è°ƒçš„æ“ä½œçº§è”åœ¨ä¸€èµ·ï¼š

```js
const fs = require('fs');
const zlib = require('zlib');
const file = process.argv[2];

fs.createReadStream(file)
  .pipe(zlib.createGzip())
  .on('data', () => process.stdout.write('.'))
  .pipe(fs.createWriteStream(file + '.zz'))
  .on('finish', () => console.log('Done'));
```

æ‰€ä»¥ä½¿ç”¨ `pipe` æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆç®€å•çš„ä½¿ç”¨æµã€‚å½“éœ€è¦æ—¶ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡äº‹ä»¶æ¥è¿›ä¸€æ­¥å®šåˆ¶å’Œæµçš„äº¤äº’ã€‚

`pipe` æ–¹æ³•çš„å¥½å¤„åœ¨äºï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ä¸€ç§æ›´åŠ å¯è¯»çš„æ–¹å¼é€šè¿‡è‹¥å¹²ç‰‡æ®µ**ç»„åˆ**æˆ‘ä»¬çš„ç¨‹åºã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡åˆ›å»ºä¸€ä¸ªå˜æ¢æµæ¥æ˜¾ç¤ºè¿›åº¦ï¼Œè€Œä¸æ˜¯ç›´æ¥ç›‘å¬ `data` äº‹ä»¶ã€‚æŠŠ `.on()` è°ƒç”¨æ¢æˆå¦ä¸€ä¸ª `.pipe()` è°ƒç”¨ï¼š

```js
const fs = require('fs');
const zlib = require('zlib');
const file = process.argv[2];

const { Transform } = require('stream');

const reportProgress = new Transform({
  transform(chunk, encoding, callback) {
    process.stdout.write('.');
    callback(null, chunk);
  }
});

fs.createReadStream(file)
  .pipe(zlib.createGzip())
  .pipe(reportProgress)
  .pipe(fs.createWriteStream(file + '.zz'))
  .on('finish', () => console.log('Done'));
```

è¿™ä¸ª `reportProgress` æµæ˜¯ä¸€ä¸ªç®€å•çš„ç›´é€šæµï¼Œä½†åŒæ—¶æŠ¥å‘Šäº†è¿›åº¦ä¿¡æ¯ã€‚è¯·æ³¨æ„æˆ‘æ˜¯å¦‚ä½•åœ¨ `transform()` æ–¹æ³•ä¸­åˆ©ç”¨ `callback()` çš„ç¬¬äºŒä¸ªå‚æ•°ä¼ é€’æ•°æ®çš„ã€‚å®ƒç­‰ä»·äºä½¿ç”¨ push æ–¹æ³•æ¨é€æ•°æ®ã€‚

ç»„åˆæµçš„åº”ç”¨æ˜¯æ— æ­¢å¢ƒçš„ã€‚ä¾‹å¦‚ï¼Œå‡è®¾æˆ‘ä»¬éœ€è¦åœ¨å‹ç¼©æ–‡ä»¶ä¹‹å‰æˆ–ä¹‹ååŠ å¯†å®ƒï¼Œæˆ‘ä»¬è¦åšçš„åªä¸è¿‡æ˜¯åœ¨æ­£ç¡®çš„ä½ç½®å¼•å…¥ä¸€ä¸ªæ–°çš„å˜æ¢æµã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Node å†…ç½®çš„ `crypto` æ¨¡å—ï¼š

```
**const crypto = require('crypto');
**// ...
```

```js
const crypto = require('crypto');
// ...
fs.createReadStream(file)
  .pipe(zlib.createGzip())
  .pipe(crypto.createCipher('aes192', 'a_secret'))
  .pipe(reportProgress)
  .pipe(fs.createWriteStream(file + '.zz'))
  .on('finish', () => console.log('Done'));

```

ä»¥ä¸Šçš„è„šæœ¬å¯¹ç»™å®šçš„æ–‡ä»¶å…ˆå‹ç¼©å†åŠ å¯†ï¼Œåªæœ‰çŸ¥é“ç§˜é’¥çš„äººæ‰èƒ½åˆ©ç”¨ç”Ÿæˆçš„æ–‡ä»¶ã€‚æˆ‘ä»¬ä¸èƒ½åˆ©ç”¨æ™®é€šçš„è§£å‹å·¥å…·è§£å‹è¯¥æ–‡ä»¶ï¼Œå› ä¸ºå®ƒè¢«åŠ å¯†äº†ã€‚

è¦èƒ½çœŸæ­£çš„è§£å‹ä»»ä½•ä½¿ç”¨ä»¥ä¸Šè„šæœ¬å‹ç¼©è¿‡çš„æ–‡ä»¶ï¼Œæˆ‘ä»¬éœ€è¦ä»¥ç›¸åçš„é¡ºåºåˆ©ç”¨ crypto å’Œ zlibï¼š

```js
fs.createReadStream(file)
  .pipe(crypto.createDecipher('aes192', 'a_secret'))
  .pipe(zlib.createGunzip())
  .pipe(reportProgress)
  .pipe(fs.createWriteStream(file.slice(0, -3)))
  .on('finish', () => console.log('Done'));
```

å‡è®¾ä¼ å…¥çš„æ–‡ä»¶æ˜¯å‹ç¼©åçš„ç‰ˆæœ¬ï¼Œä»¥ä¸Šçš„è„šæœ¬ä¼šåˆ›å»ºä¸€ä¸ªé’ˆå¯¹è¯¥æ–‡ä»¶çš„è¯»å–æµï¼Œè¿æ¥åˆ°ä¸€ä¸ª crypto æ¨¡å—çš„ `createDecipher()` æµï¼ˆä½¿ç”¨ç›¸åŒçš„å¯†é’¥ï¼‰ï¼Œä¹‹åå°†è¾“å‡ºä¼ é€’ç»™ä¸€ä¸ª zlib æ¨¡å—çš„ `createGunzip()` æµï¼Œæœ€åå°†å¾—åˆ°çš„æ•°æ®å†™å…¥ä¸€ä¸ªæ²¡æœ‰å‹ç¼©æ–‡ä»¶æ‰©å±•åçš„æ–‡ä»¶ã€‚

ä»¥ä¸Šå°±æ˜¯æˆ‘å…³äºæœ¬ä¸»é¢˜è¦è®¨è®ºçš„å…¨éƒ¨å†…å®¹äº†ã€‚æ„Ÿè°¢é˜…è¯»ï¼ä¸‹æ¬¡å†è§ï¼

**å¦‚æœä½ è®¤ä¸ºè¿™ç¯‡æ–‡ä»¶å¯¹ä½ æœ‰å¸®åŠ©ï¼Œè¯·ç‚¹å‡»ä¸‹æ–¹çš„ğŸ’šã€‚å…³æ³¨æˆ‘ä»¥è·å–æ›´å¤šå…³äº Node.js å’Œ JavaScript çš„æ–‡ç« ã€‚**

æˆ‘ä¸º [Pluralsight](https://www.pluralsight.com/search?q=samer+buna&amp;categories=course) å’Œ [Lynda](https://www.lynda.com/Samer-Buna/7060467-1.html) åˆ¶ä½œåœ¨çº¿è¯¾ç¨‹ã€‚æˆ‘æœ€è¿‘çš„è¯¾ç¨‹æ˜¯ [React.js å…¥é—¨](https://www.pluralsight.com/courses/react-js-getting-started), [é«˜çº§ Node.js](https://www.pluralsight.com/courses/nodejs-advanced), å’Œ[å­¦ä¹ å…¨æ ˆ JavaScript](https://www.lynda.com/Express-js-tutorials/Learning-Full-Stack-JavaScript-Development-MongoDB-Node-React/533304-2.html)ã€‚

æˆ‘è¿˜è¿›è¡Œ**çº¿ä¸Šä¸ç°åœºåŸ¹è®­**ï¼Œå†…å®¹æ¶µç›– JavaScriptï¼ŒNode.jsï¼ŒReact.js å’Œ GraphQL ä»åˆçº§åˆ°é«˜çº§çš„å…¨éƒ¨èŒƒå›´ã€‚å¦‚æœä½ åœ¨å¯»æ‰¾ä¸€åè®²å¸ˆï¼Œ[è¯·è”ç³»æˆ‘](mailto:samer@jscomplete.com)ã€‚æˆ‘å°†åœ¨ä»Šå¹´ä¸ƒæœˆä»½çš„ Foward.js ä¸Šè¿›è¡Œ 6 åœºç°åœºè®²ä¹ ç­ï¼Œå…¶ä¸­ä¸€åœºæ˜¯ [Node.js è¿›é˜¶](https://forwardjs.com/#node-js-deep-dive)

å¦‚æœå…³äºæœ¬æ–‡æˆ–ä»»ä½•æˆ‘çš„å…¶ä»–æ–‡ç« æœ‰ç–‘é—®ï¼Œä½ å¯ä»¥é€šè¿‡[è¿™ä¸ª **slack** è´¦å·](https://slack.jscomplete.com/)æ‰¾åˆ°æˆ‘å¹¶åœ¨ #questions æˆ¿é—´é‡Œæé—®ã€‚

---

> [æ˜é‡‘ç¿»è¯‘è®¡åˆ’](https://github.com/xitu/gold-miner) æ˜¯ä¸€ä¸ªç¿»è¯‘ä¼˜è´¨äº’è”ç½‘æŠ€æœ¯æ–‡ç« çš„ç¤¾åŒºï¼Œæ–‡ç« æ¥æºä¸º [æ˜é‡‘](https://juejin.im) ä¸Šçš„è‹±æ–‡åˆ†äº«æ–‡ç« ã€‚å†…å®¹è¦†ç›– [Android](https://github.com/xitu/gold-miner#android)ã€[iOS](https://github.com/xitu/gold-miner#ios)ã€[React](https://github.com/xitu/gold-miner#react)ã€[å‰ç«¯](https://github.com/xitu/gold-miner#å‰ç«¯)ã€[åç«¯](https://github.com/xitu/gold-miner#åç«¯)ã€[äº§å“](https://github.com/xitu/gold-miner#äº§å“)ã€[è®¾è®¡](https://github.com/xitu/gold-miner#è®¾è®¡) ç­‰é¢†åŸŸï¼Œæƒ³è¦æŸ¥çœ‹æ›´å¤šä¼˜è´¨è¯‘æ–‡è¯·æŒç»­å…³æ³¨ [æ˜é‡‘ç¿»è¯‘è®¡åˆ’](https://github.com/xitu/gold-miner)ã€‚
